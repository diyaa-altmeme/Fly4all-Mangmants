"use strict";exports.id=2430,exports.ids=[2430],exports.modules={41163:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{C4:()=>q,EL:()=>s,Mo:()=>v,Op:()=>p,PL:()=>w,SD:()=>t,Vo:()=>r,rQ:()=>u});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(62641),i=c(7879),j=c(54756),k=c(29631),l=c(58749),m=c(2992),n=c(40410),o=a([f,h,i,j,k,l,m]);async function p(a=!1){let b=await (0,j.mt)();if(!b.databaseStatus?.isDatabaseConnected)return console.log("Database connection is disabled in settings. Skipping getVisaBookings fetch."),[];let c=await (0,f.Lf)();if(!c)return[];try{let b=c.collection("visaBookings");b=a?b.where("isDeleted","==",!0):b.where("isDeleted","==",!1);let d=await b.orderBy("submissionDate","desc").get();if(d.empty)return[];return d.docs.map(a=>{let b=a.data();return{id:a.id,...b,isDeleted:b.isDeleted||!1,passengers:b.passengers||[]}})}catch(a){return console.error("Error getting visa bookings from Firestore: ",String(a)),[]}}async function q(a){let b=await (0,h.$T)();if(!b)return{success:!1,error:"User not authenticated."};let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=c.collection("visaBookings").doc();try{let e=await (0,k.tu)("VS"),f={...a,invoiceNumber:e,supplierId:a.supplierId||"",clientId:a.clientId||"",boxId:a.boxId||"",currency:a.currency||"USD",submissionDate:a.submissionDate||new Date().toISOString(),notes:a.notes||"",passengers:a.passengers.map(a=>({...a})),isEntered:!0,isAudited:!1,isDeleted:!1,enteredBy:b.name,enteredAt:new Date().toISOString(),updatedAt:new Date().toISOString()},h=f.passengers.reduce((a,b)=>a+b.salePrice,0),j=f.passengers.reduce((a,b)=>a+b.purchasePrice,0);await d.set(f),await (0,m.T)({sourceType:"visas",sourceId:d.id,date:f.submissionDate,currency:f.currency,amount:h-j,clientId:f.clientId}),j>0&&await (0,m.C)({costKey:"cost_visas",sourceType:"visas",sourceId:d.id,date:f.submissionDate,currency:f.currency,amount:j,supplierId:f.supplierId});let n=c.batch();n.update(c.collection("clients").doc(f.clientId),{useCount:i.FieldValue.increment(1)}),f.supplierId&&n.update(c.collection("clients").doc(f.supplierId),{useCount:i.FieldValue.increment(1)}),f.boxId&&n.update(c.collection("boxes").doc(f.boxId),{useCount:i.FieldValue.increment(1)}),await n.commit(),await (0,l.iL)({userId:b.uid,userName:b.name,action:"CREATE",targetType:"BOOKING",description:`أنشأ طلب فيزا جديدًا برقم فاتورة: ${e}`}),(0,g.revalidatePath)("/visas"),(0,g.revalidatePath)("/accounts/vouchers/list");let o={id:d.id,...f};return{success:!0,newBooking:o}}catch(a){return console.error("Error adding visa booking: ",String(a)),{success:!1,error:"Failed to add visa booking."}}}async function r(a){let b=await (0,h.$T)();if(!b)return{success:!1,count:0,error:"User not authenticated."};let c=await (0,f.Lf)();if(!c)return{success:!1,count:0,error:"Database not available."};let d=[],e=[];for(let f of a){let a=c.batch(),g=await (0,k.tu)("VS"),h=c.collection("visaBookings").doc(),j={...f,invoiceNumber:g,isEntered:!0,isAudited:!1,isDeleted:!1,enteredBy:b.name,enteredAt:new Date().toISOString(),updatedAt:new Date().toISOString()};a.set(h,j);let l=j.passengers.reduce((a,b)=>a+b.salePrice,0),n=j.passengers.reduce((a,b)=>a+b.purchasePrice,0),o=l-n;await (0,m.T)({sourceType:"visas",sourceId:h.id,date:j.submissionDate,currency:j.currency,amount:o,clientId:j.clientId}),n>0&&await (0,m.C)({costKey:"cost_visas",sourceType:"visas",sourceId:h.id,date:j.submissionDate,currency:j.currency,amount:n,supplierId:j.supplierId}),a.update(c.collection("clients").doc(j.clientId),{useCount:i.FieldValue.increment(1)}),a.update(c.collection("clients").doc(j.supplierId),{useCount:i.FieldValue.increment(1)}),j.boxId&&a.update(c.collection("boxes").doc(j.boxId),{useCount:i.FieldValue.increment(1)}),d.push({id:h.id,...j}),e.push(g),await a.commit()}try{return d.length>0&&(await (0,l.iL)({userId:b.uid,userName:b.name,action:"CREATE",targetType:"BOOKING",description:`أضاف ${d.length} طلبات فيزا بشكل جماعي: ${e.join(", ")}.`}),(0,g.revalidatePath)("/visas"),(0,g.revalidatePath)("/accounts/vouchers/list")),{success:!0,count:d.length,newBookings:d}}catch(a){return console.error("Error committing batch for multiple visa bookings:",a),{success:!1,count:0,error:"Failed to save visa bookings in batch."}}}async function s(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,h.$T)();if(!d)return{success:!1,error:"User not authenticated."};try{let e={...b,updatedAt:new Date().toISOString()};"id"in e&&delete e.id,e.passengers&&(e.passengers=e.passengers.map(a=>({...a}))),await c.collection("visaBookings").doc(a).update(e),await (0,l.iL)({userId:d.uid,userName:d.name,action:"UPDATE",targetType:"BOOKING",description:`عدل بيانات طلب الفيزا رقم: ${b.invoiceNumber||a}`}),(0,g.revalidatePath)("/visas"),(0,g.revalidatePath)("/accounts/vouchers/list");let f=await c.collection("visaBookings").doc(a).get(),h={id:f.id,...f.data()};return{success:!0,updatedBooking:h}}catch(a){return console.error("Error updating visa booking: ",String(a)),{success:!1,error:"Failed to update visa booking."}}}async function t(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"User not authenticated."};try{return await b.collection("visaBookings").doc(a).update({isDeleted:!0,deletedAt:new Date().toISOString()}),await (0,l.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"BOOKING",description:`حذف طلب الفيزا (حذف ناعم) رقم: ${a}`}),(0,g.revalidatePath)("/visas"),(0,g.revalidatePath)("/visas/deleted-visas"),{success:!0}}catch(a){return console.error("Error soft-deleting visa booking: ",String(a)),{success:!1,error:"Failed to delete visa booking."}}}async function u(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"User not authenticated."};try{return await b.collection("visaBookings").doc(a).update({isDeleted:!1,deletedAt:i.FieldValue.delete()}),await (0,l.iL)({userId:c.uid,userName:c.name,action:"UPDATE",targetType:"BOOKING",description:`استعاد طلب الفيزا المحذوف رقم: ${a}`}),(0,g.revalidatePath)("/visas"),(0,g.revalidatePath)("/visas/deleted-visas"),{success:!0}}catch(a){return console.error("Error restoring visa booking: ",String(a)),{success:!1,error:"Failed to restore visa booking."}}}async function v(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};let d=b.batch();try{let e=await b.collection("journal-vouchers").where("originalData.visaBookingId","==",a).limit(1).get();if(!e.empty){let a=e.docs[0];d.delete(a.ref)}return d.delete(b.collection("visaBookings").doc(a)),await d.commit(),await (0,l.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"BOOKING",description:`حذف طلب الفيزا بشكل نهائي رقم: ${a}`}),(0,g.revalidatePath)("/visas/deleted-visas"),(0,g.revalidatePath)("/accounts/vouchers/list"),{success:!0}}catch(a){return console.error("Error permanently deleting visa booking: ",String(a)),{success:!1,error:"Failed to permanently delete visa booking."}}}async function w(a){return null}[f,h,i,j,k,l,m]=o.then?(await o)():o,(0,n.D)([p,q,r,s,t,u,v,w]),(0,e.A)(p,"40274c0e2d9380168c8904f238346316bf9eb85c5d",null),(0,e.A)(q,"409ab5f3a1d5afb4b4634875b66bd6864afda3323f",null),(0,e.A)(r,"40d6d1ef497e31912306b58c3358994aab72657361",null),(0,e.A)(s,"60562fa6e2acf835f7f484086ad9e3f76c9be2ca55",null),(0,e.A)(t,"404ea7d8eef7c5fae0a7015cbd83317df47c440b3b",null),(0,e.A)(u,"40ab8ba6feefb8bef18a049b39c08ecc0f412b245a",null),(0,e.A)(v,"4000af43939789af61ade174f4258f9348ff45dc8b",null),(0,e.A)(w,"4003d79e56aa7f3ece852d1ba7ff3516e60cce27d6",null),d()}catch(a){d(a)}})},60150:(a,b,c)=>{c.d(b,{A:()=>J});var d=c(21124),e=c(38301),f=c.n(e),g=c(31980),h=c(50937),i=c(99546),j=c(35284),k=c(93758),l=c(68120),m=c(45608),n=c(79202),o=c(40822),p=c(10656),q=c(38692),r=c(34118),s=c(11943),t=c(49113),u=c(49566),v=c(85708);let w=(0,v.createServerReference)("60562fa6e2acf835f7f484086ad9e3f76c9be2ca55",v.callServer,void 0,v.findSourceMapURL,"updateVisaBooking"),x=(0,v.createServerReference)("409ab5f3a1d5afb4b4634875b66bd6864afda3323f",v.callServer,void 0,v.findSourceMapURL,"addVisaBooking");var y=c(21853),z=c(44943),A=c(37448),B=c(68254),C=c(5488),D=c(97802),E=c(63009),F=c(40068),G=c(25456);let H=i.Ik({id:i.Yj().optional(),name:i.Yj().min(1,"الاسم الكامل مطلوب"),passportNumber:i.Yj().optional(),applicationNumber:i.Yj().min(1,"رقم الطلب مطلوب"),visaType:i.Yj().min(1,"نوع الفيزا مطلوب"),bk:i.Yj().optional(),purchasePrice:i.Yj().or(i.ai()).transform(a=>Number(String(a).replace(/,/g,""))).refine(a=>a>=0,{message:"سعر الشراء يجب أن يكون 0 أو أكثر."}),salePrice:i.Yj().or(i.ai()).transform(a=>Number(String(a).replace(/,/g,""))).refine(a=>a>=0,{message:"سعر البيع يجب أن يكون 0 أو أكثر."})}),I=i.Ik({id:i.Yj().optional(),supplierId:i.Yj().min(1,"المورد مطلوب"),clientId:i.Yj().min(1,"العميل مطلوب"),submissionDate:i.p6({required_error:"تاريخ التقديم مطلوب"}),boxId:i.Yj().min(1,"الصندوق مطلوب"),currency:i.k5(["USD","IQD"]),notes:i.Yj().optional(),passengers:i.YO(H).min(1,"يجب إضافة مسافر واحد على الأقل")});function J({isEditing:a=!1,initialData:b,onBookingAdded:c,onBookingUpdated:e}){let{toast:i}=(0,A.dj)(),{data:v}=(0,D.Z)(),{user:H}=(0,E.A)(),J=f().useMemo(()=>(v?.clients||[]).map(a=>({value:a.id,label:a.name})),[v?.clients]),K=f().useMemo(()=>(v?.suppliers||[]).map(a=>({value:a.id,label:a.name})),[v?.suppliers]),L=(0,g.mN)({resolver:(0,h.u)(I),defaultValues:a?b:{supplierId:"",clientId:"",submissionDate:new Date,boxId:"",currency:"USD",notes:"",passengers:[{name:"",passportNumber:"",applicationNumber:"",visaType:"",bk:"",purchasePrice:0,salePrice:0}]}}),{control:M,handleSubmit:N,formState:{errors:O,isSubmitting:P},setValue:Q,watch:R}=L,{fields:S,append:T,remove:U}=(0,g.jz)({control:M,name:"passengers"}),V=f().useMemo(()=>{let a=L.watch("boxId");return v?.boxes?.find(b=>b.id===a)?.name||"غير محدد"},[L,v?.boxes]),W=async b=>{let d=v?.clients?.find(a=>a.id===b.clientId),f=v?.suppliers?.find(a=>a.id===b.supplierId),g={supplierId:b.supplierId,clientId:b.clientId,supplierName:f?.name||b.supplierId,clientName:d?.name||b.clientId,boxId:b.boxId,currency:b.currency,submissionDate:b.submissionDate.toISOString(),notes:b.notes||"",passengers:b.passengers.map(a=>({id:a.id||`temp-${Math.random()}`,name:a.name,passportNumber:a.passportNumber||"",applicationNumber:a.applicationNumber,visaType:a.visaType,bk:a.bk||"",purchasePrice:a.purchasePrice,salePrice:a.salePrice}))};if(a&&b.id){let a=await w(b.id,g);a.success&&a.updatedBooking?(i({title:"تم تحديث الطلب بنجاح"}),e&&e(a.updatedBooking)):i({title:"خطأ في التحديث",description:a.error,variant:"destructive"})}else{let a=await x(g);a.success&&a.newBooking?(i({title:"تمت إضافة طلب الفيزا بنجاح"}),L.reset(),c&&c(a.newBooking)):i({title:"خطأ في الإضافة",description:a.error,variant:"destructive"})}};return(0,d.jsxs)("form",{onSubmit:N(W),className:"space-y-4",children:[(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start p-4 border rounded-lg bg-muted/30",children:[(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"supplierId",children:"المورد"}),(0,d.jsx)(g.xI,{name:"supplierId",control:M,render:({field:a})=>(0,d.jsx)(y.j,{options:K,value:a.value,onValueChange:a.onChange,placeholder:"اختر موردًا..."})}),O.supplierId&&(0,d.jsx)("p",{className:"text-sm text-destructive h-4",children:O.supplierId.message})]}),(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"clientId",children:"العميل"}),(0,d.jsx)(g.xI,{name:"clientId",control:M,render:({field:a})=>(0,d.jsx)(y.j,{options:J,value:a.value,onValueChange:a.onChange,placeholder:"اختر عميلاً..."})}),O.clientId&&(0,d.jsx)("p",{className:"text-sm text-destructive h-4",children:O.clientId.message})]}),(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"submissionDate",children:"تاريخ التقديم"}),(0,d.jsx)(g.xI,{name:"submissionDate",control:M,render:({field:a})=>(0,d.jsx)(C.K,{date:a.value,setDate:a.onChange})}),O.submissionDate&&(0,d.jsx)("p",{className:"text-sm text-destructive h-4",children:O.submissionDate.message})]}),(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"currency",children:"العملة"}),(0,d.jsx)(g.xI,{name:"currency",control:M,render:({field:a})=>(0,d.jsxs)(m.l6,{onValueChange:a.onChange,value:a.value,children:[(0,d.jsx)(m.bq,{children:(0,d.jsx)(m.yv,{})}),(0,d.jsxs)(m.gC,{children:[(0,d.jsx)(m.eb,{value:"USD",children:"USD"}),(0,d.jsx)(m.eb,{value:"IQD",children:"IQD"})]})]})})]}),(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"boxId",children:"الصندوق"}),(0,d.jsx)(g.xI,{name:"boxId",control:M,render:({field:a})=>(0,d.jsxs)(m.l6,{onValueChange:a.onChange,value:a.value,children:[(0,d.jsx)(m.bq,{children:(0,d.jsx)(m.yv,{placeholder:"اختر صندوق..."})}),(0,d.jsx)(m.gC,{children:(v?.boxes||[]).map(a=>(0,d.jsx)(m.eb,{value:a.id,children:a.name},a.id))})]})}),O.boxId&&(0,d.jsx)("p",{className:"text-sm text-destructive mt-1",children:O.boxId.message})]}),(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)(l.J,{htmlFor:"notes",children:"ملاحظات"}),(0,d.jsx)(g.xI,{name:"notes",control:M,render:({field:a})=>(0,d.jsx)(B.T,{...a})})]})]}),(0,d.jsxs)("div",{className:"overflow-x-auto border rounded-lg",children:[(0,d.jsxs)(n.XI,{children:[(0,d.jsx)(n.A0,{children:(0,d.jsxs)(n.Hj,{className:"bg-muted/50",children:[(0,d.jsx)(n.nd,{className:"p-2",children:"الاسم الكامل"}),(0,d.jsx)(n.nd,{className:"p-2",children:"رقم الجواز"}),(0,d.jsx)(n.nd,{className:"p-2",children:"رقم الطلب"}),(0,d.jsx)(n.nd,{className:"p-2",children:"نوع الفيزا"}),(0,d.jsx)(n.nd,{className:"p-2",children:"BK"}),(0,d.jsx)(n.nd,{className:"p-2",children:"سعر الشراء"}),(0,d.jsx)(n.nd,{className:"p-2",children:"سعر البيع"}),(0,d.jsx)(n.nd,{className:"p-2 w-[50px]"})]})}),(0,d.jsx)(n.BF,{children:S.map((a,b)=>{let c=R("currency");return(0,d.jsxs)(n.Hj,{children:[(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(k.p,{...L.register(`passengers.${b}.name`)})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(k.p,{...L.register(`passengers.${b}.passportNumber`)})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(k.p,{...L.register(`passengers.${b}.applicationNumber`)})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(k.p,{...L.register(`passengers.${b}.visaType`)})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(k.p,{...L.register(`passengers.${b}.bk`)})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(g.xI,{name:`passengers.${b}.purchasePrice`,control:M,render:({field:a})=>(0,d.jsx)(G.O,{currency:c,currencyClassName:(0,z.cn)("USD"===c?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...a,onValueChange:a.onChange})})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(g.xI,{name:`passengers.${b}.salePrice`,control:M,render:({field:a})=>(0,d.jsx)(G.O,{currency:c,currencyClassName:(0,z.cn)("USD"===c?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...a,onValueChange:a.onChange})})}),(0,d.jsx)(n.nA,{className:"p-1",children:(0,d.jsx)(j.$,{variant:"ghost",size:"icon",onClick:()=>U(b),disabled:S.length<=1,children:(0,d.jsx)(o.A,{className:"h-4 w-4 text-destructive"})})})]},a.id)})})]}),O.passengers&&"object"==typeof O.passengers&&"message"in O.passengers&&(0,d.jsx)("p",{className:"text-sm text-destructive mt-2 p-2",children:O.passengers.message})]}),(0,d.jsx)("div",{className:"flex justify-between items-center mt-4",children:(0,d.jsxs)(j.$,{type:"button",variant:"outline",onClick:()=>T({name:"",passportNumber:"",applicationNumber:"",visaType:"",bk:"",purchasePrice:0,salePrice:0}),children:[(0,d.jsx)(p.A,{className:"me-2 h-4 w-4"})," إضافة مسافر"]})}),(0,d.jsxs)(F.Es,{className:"flex-row items-center justify-between sticky bottom-0 bg-background border-t p-2 -mx-6 -mb-6",children:[(0,d.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(q.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:H?.name||"..."})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(r.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:V})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(s.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(j.$,{type:"button",variant:"ghost",onClick:()=>L.reset(),children:"إلغاء"}),(0,d.jsxs)(j.$,{type:"submit",disabled:P,children:[P&&(0,d.jsx)(t.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,d.jsx)(u.A,{className:"me-2 h-4 w-4"}),a?"حفظ التعديلات":"حفظ الطلب"]})]})]})]})}}};