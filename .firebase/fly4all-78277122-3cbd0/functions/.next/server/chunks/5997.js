"use strict";exports.id=5997,exports.ids=[5997],exports.modules={37874:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("Percent",[["line",{x1:"19",x2:"5",y1:"5",y2:"19",key:"1x9vlm"}],["circle",{cx:"6.5",cy:"6.5",r:"2.5",key:"4mh3h7"}],["circle",{cx:"17.5",cy:"17.5",r:"2.5",key:"1mdrzq"}]])},48129:(a,b,c)=>{c.d(b,{r:()=>e});var d=c(85708);let e=(0,d.createServerReference)("00beab53bcd9d8a0cef48ee7d49a696a6b49c5158c",d.callServer,void 0,d.findSourceMapURL,"getMonthlyProfits")},51273:(a,b,c)=>{c.d(b,{D:()=>e});var d=c(85708);let e=(0,d.createServerReference)("4069a40cc94c9c768076ac567a47af44840a78e5d3",d.callServer,void 0,d.findSourceMapURL,"deleteManualProfitPeriod")},65451:(a,b,c)=>{c.d(b,{A:()=>Q});var d=c(21124),e=c(38301),f=c(35284),g=c(40068),h=c(37448),i=c(85708);let j=(0,i.createServerReference)("60f9db623aad45da0d17997927476e2546d7abaf38",i.callServer,void 0,i.findSourceMapURL,"updateManualProfitDistribution"),k=(0,i.createServerReference)("4083526305c1d3a15b3807660974edd0049aa8620e",i.callServer,void 0,i.findSourceMapURL,"saveManualProfitDistribution");var l=c(98341),m=c(37874),n=c(49566),o=c(10656),p=c(84407),q=c(34118),r=c(5239),s=c(27810),t=c(40822),u=c(38692),v=c(11943),w=c(49113),x=c(31980),y=c(99546),z=c(50937),A=c(27186),B=c(21853),C=c(77837),D=c(27410);c(25054);var E=c(63822),F=c(44943),G=c(79202),H=c(45608),I=c(68120),J=c(97802),K=c(63009),L=c(25456),M=c(6471);let N=y.Ik({id:y.Yj(),partnerId:y.Yj().min(1,"اختر شريكاً."),partnerName:y.Yj(),percentage:y.au.number().min(0,"النسبة يجب أن تكون موجبة.").max(100,"النسبة لا تتجاوز 100."),amount:y.au.number()}),O=y.Ik({fromDate:y.p6({required_error:"تاريخ البدء مطلوب"}),toDate:y.p6({required_error:"تاريخ الانتهاء مطلوب"}),sourceAccountId:y.Yj().min(1,{message:"مصدر الأرباح مطلوب."}),profit:y.au.number().positive("الربح يجب أن يكون أكبر من صفر"),currency:y.k5(["USD","IQD"]),alrawdatainSharePercentage:y.au.number().min(0).max(100).default(50),partners:y.YO(N).optional()}),P=({title:a,value:b,currency:c,className:e})=>(0,d.jsxs)("div",{className:(0,F.cn)("p-2 rounded-lg text-center border",e),children:[(0,d.jsx)("p",{className:"text-xs font-semibold text-muted-foreground",children:a}),(0,d.jsxs)("p",{className:"font-mono font-bold text-lg",children:[b.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",c]})]});function Q({partners:a,onSuccess:b,isEditing:c=!1,period:i,children:y}){let[N,Q]=(0,e.useState)(!1),{toast:R}=(0,h.dj)(),{user:S}=(0,K.A)(),{data:T}=(0,J.Z)(),[U,V]=(0,e.useState)(null),[W,X]=(0,e.useState)(""),[Y,Z]=(0,e.useState)(""),$=(0,x.mN)({resolver:(0,z.u)(O)}),{control:_,handleSubmit:aa,watch:ab,setValue:ac,formState:{isSubmitting:ad,errors:ae},trigger:af,reset:ag,getValues:ah}=$,{fields:ai,append:aj,remove:ak,update:al}=(0,x.jz)({control:_,name:"partners"}),am=(0,e.useMemo)(()=>T?[...(T.clients||[]).map(a=>({value:a.id,label:`عميل: ${a.name}`})),...(T.suppliers||[]).map(a=>({value:a.id,label:`مورد: ${a.name}`}))]:[],[T]),an=ab("partners"),ao=ab("profit"),ap=ab("currency"),aq=ab("alrawdatainSharePercentage"),ar=(0,e.useMemo)(()=>S&&"role"in S&&T?.boxes?.find(a=>a.id===S.boxId)?.name||"غير محدد",[S,T?.boxes]),{totalPartnerPercentage:as,amountForPartners:at,alrawdatainShareAmount:au,distributedToPartners:av,remainderForPartners:aw}=(0,e.useMemo)(()=>{let a=Number(ao)||0,b=a*(Number(aq)||0)/100,c=a-b,d=(an||[]).reduce((a,b)=>a+(Number(b.percentage)||0),0),e=(an||[]).reduce((a,b)=>a+c*(b.percentage||0)/100,0);return{totalPartnerPercentage:d,amountForPartners:c,alrawdatainShareAmount:b,distributedToPartners:e,remainderForPartners:c-e}},[ao,aq,an]),ax=(0,e.useMemo)(()=>{let a=(an||[]).map(a=>({...a,amount:at*(a.percentage||0)/100}));return a.push({id:"alrawdatain_share",partnerId:"alrawdatain_share",partnerName:"حصة الروضتين",percentage:aq,amount:au}),a},[an,at,aq,au]),ay=async a=>{if(Math.abs(as-100)>.01)return void R({title:"خطأ في التوزيع",description:"مجموع نسب الشركاء يجب أن يكون 100% تمامًا من المبلغ المتاح لهم.",variant:"destructive"});let d={fromDate:(0,E.GP)(a.fromDate,"yyyy-MM-dd"),toDate:(0,E.GP)(a.toDate,"yyyy-MM-dd"),sourceAccountId:a.sourceAccountId,profit:a.profit,currency:a.currency,partners:ax.map(({partnerId:a,partnerName:b,percentage:c,amount:d})=>({partnerId:a,partnerName:b,percentage:c,amount:d}))},e=c&&i?await j(i.id,d):await k(d);e.success?(R({title:`تم ${c?"تحديث":"حفظ"} توزيع الأرباح بنجاح`}),ag(),b(),Q(!1)):R({title:"خطأ",description:e.error,variant:"destructive"})},az=(0,e.useMemo)(()=>(Number(Y)||0)/100*at,[Y,at]);return(0,d.jsxs)(g.lG,{open:N,onOpenChange:Q,children:[(0,d.jsx)(g.zM,{asChild:!0,children:y}),(0,d.jsxs)(g.Cf,{className:"max-w-4xl max-h-[90vh] flex flex-col",children:[(0,d.jsxs)(g.c7,{children:[(0,d.jsx)(g.L3,{children:c?"تعديل فترة توزيع أرباح":"إضافة توزيع أرباح يدوي"}),(0,d.jsx)(g.rr,{children:"أدخل تفاصيل الفترة وصافي الربح ثم وزع الحصص على الشركاء."})]}),(0,d.jsx)(A.lV,{...$,children:(0,d.jsxs)("form",{onSubmit:aa(ay),className:"flex-grow overflow-y-auto -mx-6 px-6 space-y-6",children:[(0,d.jsxs)("div",{className:"p-4 border rounded-lg grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,d.jsx)(A.zB,{control:_,name:"fromDate",render:({field:a})=>(0,d.jsxs)(A.eI,{children:[(0,d.jsx)(A.lR,{children:"من تاريخ"}),(0,d.jsxs)(C.AM,{children:[(0,d.jsx)(C.Wv,{asChild:!0,children:(0,d.jsx)(A.MJ,{children:(0,d.jsxs)(f.$,{variant:"outline",className:(0,F.cn)("w-full justify-start text-left font-normal",!a.value&&"text-muted-foreground"),children:[a.value?(0,E.GP)(a.value,"yyyy-MM-dd"):(0,d.jsx)("span",{children:"اختر تاريخاً"}),(0,d.jsx)(l.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,d.jsx)(C.hl,{className:"w-auto p-0",children:(0,d.jsx)(D.V,{mode:"single",selected:a.value,onSelect:a.onChange})})]}),(0,d.jsx)(A.C5,{})]})}),(0,d.jsx)(A.zB,{control:_,name:"toDate",render:({field:a})=>(0,d.jsxs)(A.eI,{children:[(0,d.jsx)(A.lR,{children:"إلى تاريخ"}),(0,d.jsxs)(C.AM,{children:[(0,d.jsx)(C.Wv,{asChild:!0,children:(0,d.jsx)(A.MJ,{children:(0,d.jsxs)(f.$,{variant:"outline",className:(0,F.cn)("w-full justify-start text-left font-normal",!a.value&&"text-muted-foreground"),children:[a.value?(0,E.GP)(a.value,"yyyy-MM-dd"):(0,d.jsx)("span",{children:"اختر تاريخاً"}),(0,d.jsx)(l.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,d.jsx)(C.hl,{className:"w-auto p-0",children:(0,d.jsx)(D.V,{mode:"single",selected:a.value,onSelect:a.onChange})})]}),(0,d.jsx)(A.C5,{})]})}),(0,d.jsx)(A.zB,{control:_,name:"profit",render:({field:a})=>(0,d.jsxs)(A.eI,{children:[(0,d.jsx)(A.lR,{children:"صافي الربح للفترة"}),(0,d.jsx)(A.MJ,{children:(0,d.jsx)(L.O,{currency:ap,...a,onValueChange:b=>a.onChange(b||0)})}),(0,d.jsx)(A.C5,{})]})}),(0,d.jsx)(A.zB,{control:_,name:"currency",render:({field:a})=>(0,d.jsxs)(A.eI,{children:[(0,d.jsx)(A.lR,{children:"العملة"}),(0,d.jsxs)(H.l6,{onValueChange:a.onChange,value:a.value,children:[(0,d.jsx)(A.MJ,{children:(0,d.jsx)(H.bq,{children:(0,d.jsx)(H.yv,{})})}),(0,d.jsx)(H.gC,{children:(T?.settings.currencySettings?.currencies||[]).map(a=>(0,d.jsxs)(H.eb,{value:a.code,children:[a.name," (",a.symbol,")"]},a.code))})]}),(0,d.jsx)(A.C5,{})]})}),(0,d.jsx)("div",{className:"md:col-span-2",children:(0,d.jsx)(A.zB,{control:_,name:"sourceAccountId",render:({field:a})=>(0,d.jsxs)(A.eI,{children:[(0,d.jsx)(A.lR,{children:"مصدر الأرباح"}),(0,d.jsx)(A.MJ,{children:(0,d.jsx)(B.j,{options:am,value:a.value,onValueChange:a.onChange,placeholder:"اختر حساب المصدر..."})}),(0,d.jsx)(A.C5,{})]})})})]}),(0,d.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,d.jsxs)("div",{className:"grid grid-cols-2 lg:grid-cols-5 gap-2 mb-4",children:[(0,d.jsx)(P,{title:"صافي الربح",value:ao||0,currency:ap}),(0,d.jsx)(P,{title:"حصة الروضتين",value:au,currency:ap,className:"bg-green-50 dark:bg-green-950/30 border-green-500/30 text-green-700 dark:text-green-300"}),(0,d.jsx)(P,{title:"المتاح للشركاء",value:at,currency:ap,className:"bg-purple-50 dark:bg-purple-950/30 border-purple-500/30 text-purple-700 dark:text-purple-300"}),(0,d.jsx)(P,{title:"الموزع للشركاء",value:av,currency:ap}),(0,d.jsx)(P,{title:"المتبقي للتوزيع",value:aw,currency:ap,className:(0,F.cn)(Math.abs(aw)>.01&&"bg-destructive/10 text-destructive")})]}),(0,d.jsx)(M.Separator,{}),(0,d.jsx)("h3",{className:"font-semibold text-lg my-2",children:"إضافة شريك وتحديد حصته"}),(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 items-end p-2 rounded-lg bg-muted/50",children:[(0,d.jsxs)("div",{className:"space-y-1.5",children:[(0,d.jsx)(I.J,{className:"text-xs",children:"الشريك"}),(0,d.jsx)(B.j,{options:a.map(a=>({value:a.id,label:a.name})),value:W,onValueChange:X,placeholder:"اختر شريكًا..."})]}),(0,d.jsxs)("div",{className:"w-40 space-y-1.5",children:[(0,d.jsx)(I.J,{className:"text-xs",children:"النسبة (%)"}),(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)(L.O,{value:Y,onValueChange:Z,className:"h-9 pe-7"}),(0,d.jsx)(m.A,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"})]})]}),(0,d.jsxs)("div",{className:"flex items-end gap-2",children:[(0,d.jsxs)("div",{className:"flex-grow",children:[(0,d.jsx)(I.J,{className:"text-xs",children:"الحصة المستلمة"}),(0,d.jsx)("div",{className:"h-9 flex items-center justify-center font-bold text-blue-600 font-mono p-2 bg-blue-50 rounded-md",children:az.toFixed(2)})]}),(0,d.jsx)(f.$,{type:"button",size:"icon",className:"shrink-0 h-9 w-9",onClick:()=>{if(!W||!Y)return void R({title:"الرجاء تحديد الشريك والنسبة",variant:"destructive"});let b=Number(Y);if(isNaN(b)||b<=0)return void R({title:"النسبة يجب أن تكون رقمًا موجبًا",variant:"destructive"});let c=ah("partners")||[],d=null!==U&&c[U]?.percentage||0,e=c.reduce((a,b)=>a+b.percentage,0)-d;if(e+b>100.01)return void R({title:"لا يمكن تجاوز 100%",description:`إجمالي النسب الحالية: ${e.toFixed(2)}%`,variant:"destructive"});let f=a.find(a=>a.id===W);if(!f)return void R({title:"الشريك المختار غير صالح",variant:"destructive"});let g={id:null!==U?ai[U].id:`new-${Date.now()}`,partnerId:f.id,partnerName:f.label,percentage:b,amount:at*b/100};null!==U?(al(U,g),V(null)):aj(g),X(""),Z("")},disabled:at<=0||!W||!Y,children:null!==U?(0,d.jsx)(n.A,{className:"h-5 w-5"}):(0,d.jsx)(o.A,{className:"h-5 w-5"})})]})]})]}),(0,d.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,d.jsx)("h3",{className:"font-semibold text-lg mb-2",children:"ملخص التوزيع"}),(0,d.jsxs)(G.XI,{children:[(0,d.jsx)(G.A0,{children:(0,d.jsxs)(G.Hj,{children:[(0,d.jsxs)(G.nd,{children:[(0,d.jsx)(p.A,{className:"inline-block me-2 h-4 w-4"}),"الشريك"]}),(0,d.jsxs)(G.nd,{className:"text-center",children:[(0,d.jsx)(m.A,{className:"inline-block me-2 h-4 w-4"}),"النسبة"]}),(0,d.jsxs)(G.nd,{className:"text-right",children:[(0,d.jsx)(q.A,{className:"inline-block me-2 h-4 w-4"}),"المبلغ"]}),(0,d.jsx)(G.nd,{className:"w-24 text-center",children:"الإجراءات"})]})}),(0,d.jsxs)(G.BF,{children:[(0,d.jsxs)(G.Hj,{className:"bg-green-50 dark:bg-green-900/20",children:[(0,d.jsxs)(G.nA,{className:"font-semibold flex items-center gap-2",children:[(0,d.jsx)(r.A,{className:"h-4 w-4 text-green-600"}),"حصة الروضتين"]}),(0,d.jsx)(G.nA,{className:"text-center",children:(0,d.jsxs)("div",{className:"relative w-24 mx-auto",children:[(0,d.jsx)(x.xI,{control:_,name:"alrawdatainSharePercentage",render:({field:a})=>(0,d.jsx)(L.O,{...a,onValueChange:b=>a.onChange(b||0),className:"pe-7 text-center h-8"})}),(0,d.jsx)(m.A,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"})]})}),(0,d.jsxs)(G.nA,{className:"text-right font-mono font-bold",children:[au.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",ap]}),(0,d.jsx)(G.nA,{})]}),ai.map((a,b)=>{let c=at*(a.percentage||0)/100;return(0,d.jsxs)(G.Hj,{children:[(0,d.jsx)(G.nA,{className:"font-semibold",children:a.partnerName}),(0,d.jsxs)(G.nA,{className:"text-center font-mono",children:[Number(a.percentage).toFixed(2),"%"]}),(0,d.jsxs)(G.nA,{className:"text-right font-mono font-bold",children:[c.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",ap]}),(0,d.jsxs)(G.nA,{className:"text-center",children:[(0,d.jsx)(f.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",onClick:()=>(a=>{let b=ai[a];V(a),X(b.partnerId),Z(b.percentage),ak(a)})(b),children:(0,d.jsx)(s.A,{className:"h-4 w-4"})}),(0,d.jsx)(f.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>ak(b),children:(0,d.jsx)(t.A,{className:"h-4 w-4"})})]})]},a.id)})]})]})]})]})}),(0,d.jsx)(g.Es,{className:"pt-4 border-t",children:(0,d.jsxs)("div",{className:"flex justify-between w-full",children:[(0,d.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(u.A,{className:"h-4 w-4"})," ",(0,d.jsx)("span",{children:S?.name||"..."})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(q.A,{className:"h-4 w-4"})," ",(0,d.jsx)("span",{children:ar})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(v.A,{className:"h-4 w-4"})," ",(0,d.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,d.jsx)("div",{className:"flex items-center gap-2",children:(0,d.jsxs)(f.$,{onClick:aa(ay),disabled:ad||Math.abs(as-100)>.01,children:[ad&&(0,d.jsx)(w.A,{className:"me-2 h-4 w-4 animate-spin"}),c?"حفظ التعديلات":"حفظ بيانات الفترة"]})})]})})]})]})}},67094:(a,b,c)=>{c.d(b,{Ke:()=>g,Nt:()=>e,R6:()=>f});var d=c(59147);let e=d.bL,f=d.R6,g=d.Ke},68573:(a,b,c)=>{c.d(b,{A:()=>I});var d=c(21124),e=c(79202),f=c(35284),g=c(5239),h=c(90023),i=c(27810),j=c(40822),k=c(11563),l=c(38301),m=c.n(l),n=c(40068),o=c(37448),p=c(85708);let q=(0,p.createServerReference)("604fb3a1ef837e6a7a065873d775be374a0f72a2db",p.callServer,void 0,p.findSourceMapURL,"updateProfitShare"),r=(0,p.createServerReference)("40f181e9098475e67731ac48410c45825fc0109dc4",p.callServer,void 0,p.findSourceMapURL,"saveProfitShare");var s=c(37874),t=c(49113),u=c(31980),v=c(99546),w=c(50937),x=c(27186),y=c(93758),z=c(68254),A=c(21853);let B=v.Ik({partnerId:v.Yj().min(1,"اسم الشريك مطلوب."),percentage:v.au.number().min(0,"النسبة يجب أن تكون موجبة.").max(100,"النسبة لا يمكن أن تتجاوز 100."),notes:v.Yj().optional()});function C({isEditing:a=!1,share:b,monthId:c,totalProfit:e,partners:g,onSuccess:h,children:i,disabled:j}){let[k,m]=(0,l.useState)(!1),{toast:p}=(0,o.dj)(),v=g.map(a=>({value:a.id,label:a.name})),C=(0,u.mN)({resolver:(0,w.u)(B),defaultValues:a?{partnerId:b?.partnerId,percentage:b?.percentage,notes:b?.notes}:{partnerId:"",percentage:0,notes:""}}),{isSubmitting:D}=C.formState,E=async d=>{let f=e*d.percentage/100,i=g.find(a=>a.id===d.partnerId);if(!i)return void p({title:"خطأ",description:"الشريك المختار غير صحيح.",variant:"destructive"});let j={profitMonthId:c,partnerId:i.id,partnerName:i.name,percentage:d.percentage,amount:f,notes:d.notes},k=a&&b?await q(b.id,j):await r(j);k.success?(p({title:`تم ${a?"تحديث":"إضافة"} الحصة بنجاح`}),h(),m(!1)):p({title:"خطأ",description:k.error,variant:"destructive"})};return(0,d.jsxs)(n.lG,{open:k,onOpenChange:m,children:[(0,d.jsx)(n.zM,{asChild:!0,disabled:j,children:i}),(0,d.jsx)(n.Cf,{className:"sm:max-w-md",children:(0,d.jsx)(x.lV,{...C,children:(0,d.jsxs)("form",{onSubmit:C.handleSubmit(E),children:[(0,d.jsx)(n.c7,{children:(0,d.jsx)(n.L3,{children:a?"تعديل حصة الشريك":"إضافة توزيع جديد"})}),(0,d.jsxs)("div",{className:"py-4 grid gap-4",children:[(0,d.jsx)(x.zB,{control:C.control,name:"partnerId",render:({field:a})=>(0,d.jsxs)(x.eI,{children:[(0,d.jsx)(x.lR,{children:"الشريك"}),(0,d.jsx)(x.MJ,{children:(0,d.jsx)(A.j,{options:v,value:a.value,onValueChange:a.onChange,placeholder:"اختر شريكًا..."})}),(0,d.jsx)(x.C5,{})]})}),(0,d.jsx)(x.zB,{control:C.control,name:"percentage",render:({field:a})=>(0,d.jsxs)(x.eI,{children:[(0,d.jsx)(x.lR,{children:"النسبة المئوية"}),(0,d.jsxs)("div",{className:"relative",children:[(0,d.jsx)(x.MJ,{children:(0,d.jsx)(y.p,{type:"text",inputMode:"decimal",...a,className:"pe-7"})}),(0,d.jsx)(s.A,{className:"absolute right-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"})]}),(0,d.jsx)(x.C5,{})]})}),(0,d.jsx)(x.zB,{control:C.control,name:"notes",render:({field:a})=>(0,d.jsxs)(x.eI,{children:[(0,d.jsx)(x.lR,{children:"ملاحظات (اختياري)"}),(0,d.jsx)(x.MJ,{children:(0,d.jsx)(z.T,{...a})}),(0,d.jsx)(x.C5,{})]})})]}),(0,d.jsx)(n.Es,{children:(0,d.jsxs)(f.$,{type:"submit",disabled:D,children:[D&&(0,d.jsx)(t.A,{className:"me-2 h-4 w-4 animate-spin"}),a?"حفظ التعديلات":"إضافة الحصة"]})})]})})})]})}let D=(0,p.createServerReference)("405e6c6834ade94ce373dbb51567a4895d801220df",p.callServer,void 0,p.findSourceMapURL,"deleteProfitShare");var E=c(12439),F=c(44943),G=c(3991),H=c.n(G);function I({shares:a,partners:b,totalProfit:c,onDataChange:l,currency:n,isManual:p,monthId:q}){let{toast:r}=(0,o.dj)(),s=async a=>{let b=await D(a);b.success?(r({title:"تم حذف الحصة بنجاح"}),l()):r({title:"خطأ",description:b.error,variant:"destructive"})},{partnerShares:t,companyShare:u}=m().useMemo(()=>{let d=0,e=a.map(a=>{d+=a.percentage;let c=b.find(b=>b.id===a.partnerId);return{...a,partnerName:c?.name||a.partnerName}}),f=100-d,g=f/100*c;return{partnerShares:e,companyShare:{id:"company-share",profitMonthId:q,partnerId:"alrawdatain",partnerName:"حصالة الشركة",percentage:f>.001?f:0,amount:g>.001?g:0,notes:"الحصة المتبقية للشركة",invoiceNumber:a.find(a=>"alrawdatain_share"===a.partnerId)?.invoiceNumber}}},[a,b,c,q]),v=[u,...t].filter(a=>a.percentage>.001);return v.reduce((a,b)=>a+b.amount,0),(0,d.jsx)("div",{className:"border rounded-lg overflow-x-auto bg-background text-xs",children:(0,d.jsxs)(e.XI,{children:[(0,d.jsx)(e.A0,{children:(0,d.jsxs)(e.Hj,{children:[(0,d.jsx)(e.nd,{className:"font-bold p-2 text-right",children:"الشريك"}),(0,d.jsx)(e.nd,{className:"font-bold p-2 text-right",children:"رقم الفاتورة"}),(0,d.jsx)(e.nd,{className:"text-center font-bold p-2",children:"النسبة"}),(0,d.jsx)(e.nd,{className:"text-right font-bold p-2",children:"المبلغ"}),(0,d.jsx)(e.nd,{className:"font-bold text-right p-2",children:"ملاحظات"}),(0,d.jsx)(e.nd,{className:"text-center font-bold p-2",children:(0,d.jsx)(C,{monthId:q,totalProfit:c,partners:b,onSuccess:l,disabled:!p,children:(0,d.jsx)(f.$,{variant:"ghost",size:"sm",disabled:!p,children:"إضافة"})})})]})}),(0,d.jsx)(e.BF,{children:0===v.length?(0,d.jsxs)(e.Hj,{children:[(0,d.jsxs)(e.nA,{className:"font-semibold p-2 text-right flex items-center gap-2",children:[(0,d.jsx)(g.A,{className:"h-4 w-4 text-green-600"}),"حصالة الشركة"]}),(0,d.jsx)(e.nA,{className:"text-center font-mono p-2",children:"-"}),(0,d.jsx)(e.nA,{className:"text-center font-mono p-2",children:"100.00%"}),(0,d.jsxs)(e.nA,{className:"text-right font-mono font-bold p-2",children:[c.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",n]}),(0,d.jsx)(e.nA,{className:"text-right p-2",children:" كامل الربح للشركة "}),(0,d.jsx)(e.nA,{className:"text-center p-2"})]}):v.map((a,m)=>(0,d.jsxs)(e.Hj,{className:"company-share"===a.id?"bg-green-50 dark:bg-green-900/20":"",children:[(0,d.jsxs)(e.nA,{className:"font-semibold p-2 text-right flex items-center gap-2",children:["company-share"===a.id&&(0,d.jsx)(g.A,{className:"h-4 w-4 text-green-600"}),a.partnerName]}),(0,d.jsx)(e.nA,{className:"text-center font-mono p-2 text-xs",children:a.invoiceNumber?(0,d.jsx)(f.$,{asChild:!0,variant:"link",className:"p-0 h-auto text-xs",children:(0,d.jsx)(H(),{href:"/accounts/vouchers/list",children:a.invoiceNumber})}):"-"}),(0,d.jsxs)(e.nA,{className:"text-center font-mono p-2",children:[a.percentage.toFixed(2),"%"]}),(0,d.jsxs)(e.nA,{className:"text-right font-mono font-bold p-2",children:[a.amount.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",n]}),(0,d.jsx)(e.nA,{className:"text-right p-2",children:a.notes||"-"}),(0,d.jsx)(e.nA,{className:"text-center p-2",children:"company-share"!==a.id&&(0,d.jsxs)(k.rI,{children:[(0,d.jsx)(k.ty,{asChild:!0,children:(0,d.jsx)(f.$,{variant:"ghost",size:"icon",disabled:!p,children:(0,d.jsx)(h.A,{className:"h-4 w-4"})})}),(0,d.jsxs)(k.SQ,{children:[(0,d.jsx)(C,{isEditing:!0,share:a,monthId:a.profitMonthId,totalProfit:c,partners:b,onSuccess:l,disabled:!p,children:(0,d.jsxs)(k._2,{onSelect:a=>a.preventDefault(),disabled:!p,children:[(0,d.jsx)(i.A,{className:"me-2 h-4 w-4"})," تعديل"]})}),(0,d.jsxs)(E.Lt,{children:[(0,d.jsx)(E.tv,{asChild:!0,children:(0,d.jsxs)(k._2,{onSelect:a=>a.preventDefault(),className:"text-destructive focus:text-destructive",disabled:!p,children:[(0,d.jsx)(j.A,{className:"me-2 h-4 w-4"})," حذف"]})}),(0,d.jsxs)(E.EO,{children:[(0,d.jsxs)(E.wd,{children:[(0,d.jsx)(E.r7,{children:"هل أنت متأكد؟"}),(0,d.jsx)(E.$v,{children:"هذا الإجراء سيحذف الحصة بشكل دائم."})]}),(0,d.jsxs)(E.ck,{children:[(0,d.jsx)(E.Zr,{children:"إلغاء"}),(0,d.jsx)(E.Rx,{onClick:()=>s(a.id),className:(0,F.cn)((0,f.r)({variant:"destructive"})),children:"حذف"})]})]})]})]})]})})]},a.id))}),(0,d.jsx)(e.Gg,{children:(0,d.jsxs)(e.Hj,{children:[(0,d.jsx)(e.nA,{colSpan:2,className:"font-bold",children:"المجموع"}),(0,d.jsx)(e.nA,{className:"text-center font-bold font-mono",children:"100.00%"}),(0,d.jsxs)(e.nA,{className:"text-right font-bold font-mono",children:[c.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",n]}),(0,d.jsx)(e.nA,{colSpan:2})]})})]})})}},75818:(a,b,c)=>{c.d(b,{k:()=>e});var d=c(85708);let e=(0,d.createServerReference)("4046cdf80f265cc319f18857ca91015363a6f55f47",d.callServer,void 0,d.findSourceMapURL,"getProfitSharesForMonth")},79930:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{$_:()=>w,Ao:()=>s,DS:()=>v,QS:()=>r,by:()=>u,k_:()=>p,lU:()=>n,lc:()=>t,ly:()=>q,rE:()=>o});var e=c(91488);c(27806);var f=c(2992),g=c(80446),h=c(91837),i=c(63097),j=c(29631),k=c(62641),l=c(40410),m=a([f,g,j,k]);async function n(a,b,c){if(c<=0)return;let d=await (0,f.getFinanceMap)(),e=d.defaultBankId||d.defaultCashId||null;if(!e)throw Error("No retained earnings (or cash/bank) account configured");await (0,f.postJournalEntries)({sourceType:"profit_sharing",sourceId:a,entries:[{accountId:e,debit:c,credit:0,description:"تسوية ربح/أرباح مرحلة"},{accountId:b,debit:0,credit:c,description:"ذمم دائنة - حصة شريك"}]})}async function o(){let a=await (0,g.Lf)();if(!a)return[];try{let[b,c]=await Promise.all([a.collection("monthly_profits").orderBy("id","desc").get(),a.collection("manual_monthly_profits").orderBy("toDate","desc").get()]),d=b.docs.map(a=>({id:a.id,...a.data(),fromSystem:!0})),e=c.docs.map(a=>{let b=a.data();return{id:a.id,invoiceNumber:b.invoiceNumber,totalProfit:b.profit,createdAt:b.createdAt,createdBy:b.createdBy,userName:b.userName,fromSystem:!1,notes:`أرباح يدوية للفترة من ${b.fromDate} إلى ${b.toDate}`,currency:b.currency,partners:b.partners,fromDate:b.fromDate,toDate:b.toDate,sourceAccountId:b.sourceAccountId}}),f=[...d,...e];return f.sort((a,b)=>{let c=7===a.id.length?(0,i.H)(`${a.id}-01`):(0,i.H)(a.createdAt);return(7===b.id.length?(0,i.H)(`${b.id}-01`):(0,i.H)(b.createdAt)).getTime()-c.getTime()}),f}catch(a){return console.error("Error fetching monthly profits:",a),[]}}async function p(a){let b=await (0,g.Lf)();if(!b)return[];try{let c=await b.collection("manual_monthly_profits").doc(a).get();if(c.exists){let d=c.data(),e=d?.partners||[],f=await b.collection("journal-vouchers").where("originalData.manualProfitId","==",a).get(),g={};return f.forEach(a=>{let b=a.data(),c=b.originalData?.partnerId;c&&(g[c]=b.invoiceNumber),b.creditEntries?.some(a=>"revenue_profit_distribution"===a.accountId)&&(g.alrawdatain_share=b.invoiceNumber)}),e.map((b,c)=>({...b,id:b.id||`${a}-${c}`,profitMonthId:a,invoiceNumber:g[b.partnerId]||null,notes:"حصة من توزيع يدوي"}))}return(await b.collection("profit_shares").where("profitMonthId","==",a).get()).docs.map(a=>({id:a.id,...a.data()}))}catch(a){return console.error("Error fetching profit shares for month:",a),[]}}async function q(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available"};try{return await b.collection("profit_shares").add(a),(0,h.revalidatePath)("/profit-sharing"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function r(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available"};let c=await (0,k.$T)();if(!c||!("role"in c)||!c.boxId)return{success:!1,error:"User not authenticated or box not assigned."};let d=b.batch(),e=b.collection("manual_monthly_profits").doc();try{let f=await (0,j.tu)("RC"),g=`للفترة من ${a.fromDate} إلى ${a.toDate}`;d.set(e,{...a,invoiceNumber:f,createdBy:c.uid,userName:c.name,createdAt:new Date().toISOString()});let i=b.collection("journal-vouchers").doc();for(let h of(d.set(i,{invoiceNumber:f,date:new Date().toISOString(),currency:a.currency,notes:`استلام أرباح السكمنت ${g} من المصدر`,createdBy:c.uid,officer:c.name,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),voucherType:"journal_from_standard_receipt",debitEntries:[{accountId:c.boxId,amount:a.profit,description:`إيداع أرباح ${g}`}],creditEntries:[{accountId:a.sourceAccountId,amount:a.profit,description:`سحب أرباح ${g}`}],isAudited:!0,isConfirmed:!0,originalData:{...a,manualProfitId:e.id}}),a.partners.filter(a=>"alrawdatain_share"!==a.partnerId))){let f=await (0,j.tu)("PV"),i=b.collection("journal-vouchers").doc();d.set(i,{invoiceNumber:f,date:new Date().toISOString(),currency:a.currency,notes:`دفع حصة الشريك ${h.partnerName} عن أرباح ${g}`,createdBy:c.uid,officer:c.name,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),voucherType:"journal_from_payment",debitEntries:[{accountId:h.partnerId,amount:h.amount,description:`إيداع حصة أرباح ${g}`}],creditEntries:[{accountId:c.boxId,amount:h.amount,description:`دفع حصة أرباح للشريك ${h.partnerName}`}],isAudited:!0,isConfirmed:!0,originalData:{...a,manualProfitId:e.id,partnerId:h.partnerId}})}let k=a.partners.find(a=>"alrawdatain_share"===a.partnerId);if(k&&k.amount>0){let f=await (0,j.tu)("JE"),h=b.collection("journal-vouchers").doc();d.set(h,{invoiceNumber:f,date:new Date().toISOString(),currency:a.currency,notes:`إثبات حصة الشركة من أرباح السكمنت ${g}`,createdBy:c.uid,officer:c.name,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),voucherType:"journal_voucher",debitEntries:[{accountId:c.boxId,amount:k.amount,description:`سحب حصة الشركة من الصندوق`}],creditEntries:[{accountId:"revenue_profit_distribution",amount:k.amount,description:`تسجيل إيراد حصة الشركة ${g}`}],isAudited:!0,isConfirmed:!0,originalData:{...a,manualProfitId:e.id,partnerId:"alrawdatain_share"}})}return await d.commit(),(0,h.revalidatePath)("/profit-sharing"),(0,h.revalidatePath)("/reports/account-statement"),{success:!0}}catch(a){return console.error("Error saving manual profit distribution:",a),{success:!1,error:a.message}}}async function s(a,b){let c=await (0,g.Lf)();if(!c)return{success:!1,error:"Database not available"};try{return await c.collection("manual_monthly_profits").doc(a).update({...b,updatedAt:new Date().toISOString()}),(0,h.revalidatePath)("/profit-sharing"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function t(a,b){let c=await (0,g.Lf)();if(!c)return{success:!1,error:"Database not available"};try{return await c.collection("profit_shares").doc(a).update(b),(0,h.revalidatePath)("/profit-sharing"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function u(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available"};try{return await b.collection("profit_shares").doc(a).delete(),(0,h.revalidatePath)("/profit-sharing"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function v(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available"};try{return await b.collection("manual_monthly_profits").doc(a).delete(),(0,h.revalidatePath)("/profit-sharing"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function w(a,b){let c=await (0,g.Lf)();if(!c)return;let d=c.collection("monthly_profits").doc(a);await d.set({id:a,totalProfit:b,createdAt:new Date().toISOString(),fromSystem:!0,notes:`أرباح شهر ${a}`},{merge:!0}),(0,h.revalidatePath)("/profit-sharing")}[f,g,j,k]=m.then?(await m)():m,(0,l.D)([n,o,p,q,r,s,t,u,v,w]),(0,e.A)(n,"706bdd6f0c1abe3898269e2663bbc2e1dea121ea92",null),(0,e.A)(o,"00beab53bcd9d8a0cef48ee7d49a696a6b49c5158c",null),(0,e.A)(p,"4046cdf80f265cc319f18857ca91015363a6f55f47",null),(0,e.A)(q,"40f181e9098475e67731ac48410c45825fc0109dc4",null),(0,e.A)(r,"4083526305c1d3a15b3807660974edd0049aa8620e",null),(0,e.A)(s,"60f9db623aad45da0d17997927476e2546d7abaf38",null),(0,e.A)(t,"604fb3a1ef837e6a7a065873d775be374a0f72a2db",null),(0,e.A)(u,"405e6c6834ade94ce373dbb51567a4895d801220df",null),(0,e.A)(v,"4069a40cc94c9c768076ac567a47af44840a78e5d3",null),(0,e.A)(w,"6045ac6dac1f25bff52ae0af9917c893a50210ef7f",null),d()}catch(a){d(a)}})},90023:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]])},94340:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]])}};