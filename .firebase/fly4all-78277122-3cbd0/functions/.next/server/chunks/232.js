"use strict";exports.id=232,exports.ids=[232],exports.modules={31407:(a,b,c)=>{c.d(b,{A:()=>R});var d=c(21124),e=c(38301),f=c.n(e),g=c(35284),h=c(40068),i=c(37448),j=c(10656),k=c(90447),l=c(22741),m=c(49113),n=c(40822),o=c(38692),p=c(34118),q=c(11943),r=c(49566),s=c(85708);let t=(0,s.createServerReference)("403853799c99974381aed2d752ac232c7cabeb7c0b",s.callServer,void 0,s.findSourceMapURL,"addSubscription");var u=c(27186),v=c(93758),w=c(68254),x=c(21853),y=c(5488),z=c(25456),A=c(63009),B=c(97802),C=c(50937),D=c(99546),E=c(95366),F=c(31980),G=c(44943),H=c(10923),I=c(62186),J=c(6471),K=c(68120),L=c(74053),M=c(79202),N=c(1420);let O=D.Ik({dueDate:D.p6({required_error:"تاريخ الاستحقاق مطلوب."}),amount:D.au.number().positive("المبلغ يجب أن يكون أكبر من صفر.")}),P=D.Ik({supplierId:D.Yj().optional(),serviceName:D.Yj().min(2,{message:"اسم الاشتراك مطلوب."}),purchaseDate:D.p6({required_error:"تاريخ الشراء مطلوب."}),clientId:D.Yj().min(1,"الرجاء اختيار عميل."),currency:D.k5(["USD","IQD"]),quantity:D.au.number().int().min(1,"الكمية يجب أن تكون 1 على الأقل.").default(1),purchasePrice:D.au.number().min(0,"سعر شراء الوحدة يجب ان يكون صفرا أو أكثر.").default(0),unitPrice:D.au.number().min(0,"سعر بيع الوحدة يجب أن يكون أكبر من صفر").default(0),discount:D.au.number().min(0,"الخصم لا يمكن أن يكون سالبًا.").default(0).optional(),startDate:D.p6({required_error:"تاريخ بدء الاشتراك مطلوب."}),installmentMethod:D.k5(["upfront","deferred","installments"]).default("upfront"),deferredDueDate:D.p6().optional(),installments:D.YO(O).optional(),boxId:D.Yj().optional(),notes:D.Yj().optional(),hasPartner:D.zM().default(!1),partnerId:D.Yj().optional(),partnerSharePercentage:D.au.number().min(0).max(100).optional()}),Q=({title:a,children:b,className:c})=>(0,d.jsx)(I.Zp,{className:(0,G.cn)("shadow-sm",c),children:(0,d.jsxs)(I.Wu,{className:"pt-6 space-y-4",children:[(0,d.jsx)("h3",{className:"font-bold text-primary mb-3",children:a}),b]})});function R({onSubscriptionAdded:a,children:b}){let[c,s]=(0,e.useState)(!1),{toast:D}=(0,i.dj)(),{user:I}=(0,A.A)(),{data:O,loaded:R,fetchData:S}=(0,B.Z)(),[T,U]=(0,e.useState)(!1),[V,W]=(0,e.useState)({width:"1024px",height:"90vh"}),[X,Y]=(0,e.useState)(2);O?.settings?.subscriptionSettings,O?.settings.currencySettings?.defaultCurrency;let Z=(0,F.mN)({resolver:(0,C.u)(P)}),{control:$,handleSubmit:_,watch:aa,setValue:ab,formState:{errors:ac},trigger:ad,reset:ae}=Z,{fields:af,append:ag,remove:ah,replace:ai}=(0,F.jz)({control:$,name:"installments"}),aj=aa("currency"),ak=aa("installmentMethod"),al=aa("quantity"),am=aa("purchasePrice"),an=aa("unitPrice"),ao=aa("discount"),ap=aa("installments"),aq=aa("startDate"),ar=aa("hasPartner"),as=aa("partnerSharePercentage"),at=(al||0)*(am||0),au=(al||0)*(an||0)-(ao||0),av=au-at,aw=ar&&as?as/100*av:0,ax=av-aw,ay=(ap||[]).reduce((a,b)=>a+Number(b.amount||0),0),az=au-ay,aA="USD"===aj?"hsl(var(--accent))":"hsl(var(--primary))",aB=(0,e.useMemo)(()=>{let a=aa("boxId");return O?.boxes?.find(b=>b.id===a)?.name||"غير محدد"},[aa,O?.boxes]),aC=f().useMemo(()=>(O?.suppliers||[]).map(a=>({value:a.id,label:a.name})),[O?.suppliers]),aD=f().useMemo(()=>(O?.clients||[]).map(a=>({value:a.id,label:`${a.name} ${a.code?`(${a.code})`:""}`})),[O?.clients]),aE=f().useMemo(()=>O?[...O.clients||[],...O.suppliers||[]].map(a=>({value:a.id,label:a.name})):[],[O]),aF=(0,e.useCallback)(()=>{if(X>0&&au>0){let a=parseFloat((au/X).toFixed(2)),b=Array.from({length:X},(b,c)=>({dueDate:(0,E.P)(aq,c),amount:a})),c=au-b.reduce((a,b)=>a+b.amount,0);b.length>0&&(b[b.length-1].amount+=c),ai(b)}else ai([])},[X,au,aq,ai]),aG=async b=>{if(U(!0),"installments"===b.installmentMethod&&Math.abs(az)>.01){D({title:"خطأ في التوزيع",description:"مجموع مبالغ الدفعات لا يساوي إجمالي البيع بعد الخصم.",variant:"destructive"}),U(!1);return}try{let c=O?.clients?.find(a=>a.id===b.clientId),d=O?.suppliers?.find(a=>a.id===b.supplierId);if(!c){D({title:"العميل غير موجود",variant:"destructive"}),U(!1);return}let e={...b,purchaseDate:b.purchaseDate.toISOString(),startDate:b.startDate.toISOString(),deferredDueDate:b.deferredDueDate?b.deferredDueDate.toISOString():void 0,installments:(b.installments||[]).map(a=>({...a,dueDate:a.dueDate.toISOString()})),clientName:c.name,supplierName:d?.name},f=await t(e);if(f.success&&f.id)a&&a(),D({title:"تمت إضافة الاشتراك بنجاح"}),s(!1);else throw Error(f.error||"Failed to add subscription")}catch(a){D({title:"خطأ",description:a.message||"حدث خطأ أثناء إضافة الاشتراك.",variant:"destructive"})}finally{U(!1)}};return(0,d.jsxs)(h.lG,{open:c,onOpenChange:s,children:[(0,d.jsx)(h.zM,{asChild:!0,children:b||(0,d.jsxs)(g.$,{children:[(0,d.jsx)(j.A,{className:"me-2 h-4 w-4"})," إضافة اشتراك"]})}),(0,d.jsxs)(h.Cf,{showCloseButton:!1,className:"p-0 flex flex-col",style:{maxWidth:V.width,width:"95vw",height:V.height},children:[(0,d.jsxs)(h.c7,{className:"p-4 rounded-t-lg flex flex-row justify-between items-center",style:{backgroundColor:aA,color:"white"},children:[(0,d.jsx)(h.HM,{asChild:!0,children:(0,d.jsx)(g.$,{variant:"ghost",size:"icon",className:"text-primary-foreground hover:bg-white/20 h-7 w-7 rounded-full",children:(0,d.jsx)(k.A,{className:"h-4 w-4"})})}),(0,d.jsx)("div",{children:(0,d.jsx)(h.L3,{className:"text-white",children:"إضافة اشتراك جديد"})}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(O?.settings?.currencySettings?.currencies||[]).map(a=>(0,d.jsx)(g.$,{type:"button",onClick:()=>Z.setValue("currency",a.code),className:(0,G.cn)("text-white h-8",aj===a.code?"bg-white/30":"bg-transparent border border-white/50"),children:a.code},a.code)),(0,d.jsx)(H.A,{dialogKey:"add_subscription",onDimensionsChange:W,children:(0,d.jsx)(g.$,{type:"button",variant:"ghost",size:"icon",className:"text-white hover:bg-white/20 h-8 w-8",children:(0,d.jsx)(l.A,{className:"h-5 w-5"})})})]})]}),(0,d.jsx)(F.Op,{...Z,children:(0,d.jsxs)("form",{onSubmit:Z.handleSubmit(aG),className:"flex flex-col flex-grow overflow-hidden",children:[(0,d.jsx)("div",{className:"px-6 py-4 flex-grow overflow-y-auto space-y-4",children:R?(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,d.jsxs)(Q,{title:"المعلومات الأساسية",children:[(0,d.jsx)(u.zB,{control:$,name:"serviceName",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"اسم الاشتراك / الخدمة"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(v.p,{placeholder:"مثال: اشتراك إنترنت شهري",...a})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,d.jsx)(u.zB,{control:$,name:"supplierId",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"المورد (المصدر)"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(x.j,{searchAction:"suppliers",options:aC,value:a.value,onValueChange:a.onChange,placeholder:"اختياري"})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsx)(u.zB,{control:$,name:"clientId",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"العميل (المستفيد)"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(x.j,{searchAction:"clients",options:aD,value:a.value,onValueChange:a.onChange,placeholder:"ابحث عن عميل..."})}),(0,d.jsx)(u.C5,{})]})})]}),(0,d.jsx)(u.zB,{control:$,name:"purchaseDate",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"تاريخ الشراء"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(y.K,{date:a.value,setDate:a.onChange})}),(0,d.jsx)(u.C5,{})]})})]}),(0,d.jsxs)(Q,{title:"التفاصيل المالية وتوزيع الأرباح",children:[(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,d.jsx)(u.zB,{control:$,name:"quantity",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"الكمية"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(z.O,{onValueChange:b=>a.onChange(b||0),value:a.value,placeholder:"أدخل الكمية"})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsx)(u.zB,{control:$,name:"discount",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"الخصم"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(z.O,{currency:aj,onValueChange:b=>a.onChange(b||0),value:a.value,placeholder:"أدخل الخصم"})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsx)(u.zB,{control:$,name:"purchasePrice",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"الكلفة"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(z.O,{currency:aj,onValueChange:b=>a.onChange(b||0),value:a.value,placeholder:"أدخل سعر الشراء"})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsx)(u.zB,{control:$,name:"unitPrice",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"البيع"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(z.O,{currency:aj,onValueChange:b=>a.onChange(b||0),value:a.value,placeholder:"أدخل سعر البيع"})}),(0,d.jsx)(u.C5,{})]})})]}),(0,d.jsx)(J.Separator,{className:"my-4"}),(0,d.jsxs)("div",{className:"space-y-3",children:[(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-2 text-center",children:[(0,d.jsxs)("div",{className:"bg-red-50 p-2 rounded-md",children:[(0,d.jsx)("p",{className:"text-xs font-semibold text-muted-foreground",children:"إجمالي الكلفة"}),(0,d.jsxs)("p",{className:"font-bold",children:[at.toLocaleString()," ",aj]})]}),(0,d.jsxs)("div",{className:"bg-blue-50 p-2 rounded-md",children:[(0,d.jsx)("p",{className:"text-xs font-semibold text-muted-foreground",children:"إجمالي المبيع"}),(0,d.jsxs)("p",{className:"font-bold",children:[au.toLocaleString()," ",aj]})]}),(0,d.jsxs)("div",{className:"bg-green-50 p-2 rounded-md",children:[(0,d.jsx)("p",{className:"text-xs font-semibold text-muted-foreground",children:"إجمالي الربح"}),(0,d.jsxs)("p",{className:"font-bold",children:[av.toLocaleString()," ",aj]})]})]}),(0,d.jsx)(u.zB,{control:$,name:"hasPartner",render:({field:a})=>(0,d.jsxs)(u.eI,{className:"flex flex-row items-center justify-between rounded-lg border p-3",children:[(0,d.jsx)(K.J,{className:"font-semibold",children:"هل يوجد شريك في الربح؟"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(N.d,{checked:a.value,onCheckedChange:a.onChange})})]})}),ar&&(0,d.jsxs)("div",{className:"grid grid-cols-3 gap-2 text-center p-2 border rounded-lg",children:[(0,d.jsx)(u.zB,{control:$,name:"partnerId",render:({field:a})=>(0,d.jsxs)(u.eI,{className:"col-span-1 text-right space-y-1",children:[(0,d.jsx)(u.lR,{className:"text-xs",children:"الشريك"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(x.j,{options:aE,value:a.value,onValueChange:a.onChange,placeholder:"اختر شريك"})})]})}),(0,d.jsx)(u.zB,{control:$,name:"partnerSharePercentage",render:({field:a})=>(0,d.jsxs)(u.eI,{className:"col-span-2 text-right space-y-1",children:[(0,d.jsx)(u.lR,{className:"text-xs",children:"حصة الشريك من الربح (%)"}),(0,d.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,d.jsx)(z.O,{value:a.value,onValueChange:b=>a.onChange(b||0)}),(0,d.jsxs)("div",{className:"font-bold p-2 rounded-md bg-blue-50 text-blue-800",children:[aw.toLocaleString()," ",aj]})]})]})}),(0,d.jsxs)("div",{className:"col-span-3 bg-green-50 p-2 rounded-md font-bold text-green-800",children:["حصة الروضتين: ",ax.toLocaleString()," ",aj]})]})]})]}),(0,d.jsxs)(Q,{title:"جدولة الدفعات",className:"md:col-span-2",children:[(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 items-end",children:[(0,d.jsx)(u.zB,{name:"installmentMethod",control:$,render:({field:a})=>(0,d.jsxs)(u.eI,{className:"space-y-2",children:[(0,d.jsx)(u.lR,{className:"font-bold text-base",children:"طريقة السداد"}),(0,d.jsx)(u.MJ,{children:(0,d.jsxs)(L.z,{onValueChange:a.onChange,value:a.value,className:"grid grid-cols-3 gap-2",children:[(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.MJ,{children:(0,d.jsx)(L.C,{value:"upfront",id:"upfront",className:"sr-only peer"})}),(0,d.jsx)(K.J,{htmlFor:"upfront",className:"flex h-10 items-center justify-center rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary peer-data-[state=checked]:text-primary-foreground font-bold text-sm cursor-pointer",children:"دفعة مقدمًا"})]}),(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.MJ,{children:(0,d.jsx)(L.C,{value:"deferred",id:"deferred",className:"sr-only peer"})}),(0,d.jsx)(K.J,{htmlFor:"deferred",className:"flex h-10 items-center justify-center rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary peer-data-[state=checked]:text-primary-foreground font-bold text-sm cursor-pointer",children:"دفع بالأجل"})]}),(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.MJ,{children:(0,d.jsx)(L.C,{value:"installments",id:"installments",className:"sr-only peer"})}),(0,d.jsx)(K.J,{htmlFor:"installments",className:"whitespace-nowrap flex h-10 items-center justify-center rounded-md border-2 border-muted bg-popover p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary peer-data-[state=checked]:text-primary-foreground font-bold text-sm cursor-pointer",children:"على شكل دفعات"})]})]})}),(0,d.jsx)(u.C5,{})]})}),(0,d.jsx)(u.zB,{control:$,name:"startDate",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"تاريخ بدء الاشتراك"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(y.K,{date:a.value,setDate:a.onChange})}),(0,d.jsx)(u.C5,{})]})})]}),(0,d.jsxs)("div",{className:"pt-4 space-y-4",children:[("upfront"===ak||"deferred"===ak)&&(0,d.jsx)(u.zB,{control:$,name:"deferredDueDate",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"تاريخ استحقاق الدفعة"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(y.K,{date:a.value,setDate:a.onChange})}),(0,d.jsx)(u.C5,{})]})}),"installments"===ak&&(0,d.jsxs)("div",{className:"space-y-4 pt-4 border-t",children:[(0,d.jsxs)("div",{className:"flex items-center gap-4",children:[(0,d.jsxs)("div",{className:"space-y-1.5 w-48",children:[(0,d.jsx)(K.J,{className:"font-bold",children:"عدد الدفعات"}),(0,d.jsx)(z.O,{value:X,onValueChange:a=>Y(a||0),min:1,placeholder:"أدخل العدد"})]}),(0,d.jsx)(g.$,{type:"button",onClick:aF,className:"mt-6",children:"توليد الأقساط"})]}),(0,d.jsx)("h4",{className:"font-bold",children:"إدارة الدفعات"}),(0,d.jsx)("div",{className:"border rounded-lg",children:(0,d.jsxs)(M.XI,{children:[(0,d.jsx)(M.A0,{children:(0,d.jsxs)(M.Hj,{children:[(0,d.jsx)(M.nd,{children:"#"}),(0,d.jsx)(M.nd,{children:"تاريخ الاستحقاق"}),(0,d.jsx)(M.nd,{children:"المبلغ"}),(0,d.jsx)(M.nd,{className:"w-12"})]})}),(0,d.jsx)(M.BF,{children:af.map((a,b)=>(0,d.jsxs)(M.Hj,{children:[(0,d.jsx)(M.nA,{children:b+1}),(0,d.jsx)(M.nA,{children:(0,d.jsx)(u.zB,{control:$,name:`installments.${b}.dueDate`,render:({field:a})=>(0,d.jsx)(y.K,{date:a.value,setDate:a.onChange})})}),(0,d.jsx)(M.nA,{children:(0,d.jsx)(u.zB,{control:$,name:`installments.${b}.amount`,render:({field:a})=>(0,d.jsx)(z.O,{currency:aj,onValueChange:b=>a.onChange(b||0),value:a.value,placeholder:"أدخل المبلغ"})})}),(0,d.jsx)(M.nA,{children:(0,d.jsx)(g.$,{type:"button",variant:"ghost",size:"icon",className:"text-destructive h-8 w-8",onClick:()=>ah(b),children:(0,d.jsx)(n.A,{className:"h-4 w-4"})})})]},a.id))})]})}),(0,d.jsxs)("div",{className:"flex justify-between items-center",children:[(0,d.jsxs)(g.$,{type:"button",variant:"outline",size:"sm",onClick:()=>ag({dueDate:(0,E.P)(af[af.length-1]?.dueDate||new Date,1),amount:0}),children:[(0,d.jsx)(j.A,{className:"me-2 h-4 w-4"})," إضافة دفعة يدوية"]}),(0,d.jsxs)("div",{className:"space-x-4 font-mono text-sm",children:[(0,d.jsxs)("span",{className:"font-bold",children:["الموزع: ",(0,d.jsx)("span",{className:"text-blue-600",children:ay.toLocaleString()})]}),(0,d.jsxs)("span",{className:(0,G.cn)("font-bold",0!==az&&"text-destructive"),children:["المتبقي: ",(0,d.jsx)("span",{className:(0,G.cn)(0!==az&&"text-destructive"),children:az.toLocaleString()})]})]})]})]})]})]}),(0,d.jsx)("div",{className:"md:col-span-2",children:(0,d.jsx)(u.zB,{control:$,name:"notes",render:({field:a})=>(0,d.jsxs)(u.eI,{children:[(0,d.jsx)(u.lR,{className:"font-bold",children:"ملاحظات (اختياري)"}),(0,d.jsx)(u.MJ,{children:(0,d.jsx)(w.T,{...a})}),(0,d.jsx)(u.C5,{})]})})})]}):(0,d.jsx)("div",{className:"flex justify-center items-center h-full",children:(0,d.jsx)(m.A,{className:"animate-spin h-8 w-8"})})}),(0,d.jsxs)(h.Es,{className:"p-4 border-t flex-row items-center justify-between sticky bottom-0 bg-background mt-auto",children:[(0,d.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(o.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:I?.name||"..."})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(p.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:aB})]}),(0,d.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,d.jsx)(q.A,{className:"h-4 w-4 text-primary"})," ",(0,d.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,d.jsx)("div",{className:"flex items-center gap-2",children:(0,d.jsxs)(g.$,{type:"submit",disabled:T,children:[T&&(0,d.jsx)(m.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,d.jsx)(r.A,{className:"me-2 h-4 w-4"}),"حفظ الاشتراك"]})})]})]})})]})]})}},74053:(a,b,c)=>{c.d(b,{C:()=>j,z:()=>i});var d=c(21124),e=c(38301),f=c(64450),g=c(46171),h=c(44943);let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)(f.bL,{className:(0,h.cn)("grid gap-2",a),...b,ref:c}));i.displayName=f.bL.displayName;let j=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)(f.q7,{ref:c,className:(0,h.cn)("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",a),...b,children:(0,d.jsx)(f.C1,{className:"flex items-center justify-center",children:(0,d.jsx)(g.A,{className:"h-2.5 w-2.5 fill-current text-current"})})}));j.displayName=f.q7.displayName},79202:(a,b,c)=>{c.d(b,{A0:()=>h,BF:()=>i,Gg:()=>j,Hj:()=>k,XI:()=>g,nA:()=>m,nd:()=>l});var d=c(21124),e=c(38301),f=c(44943);let g=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{className:"relative w-full overflow-auto",children:(0,d.jsx)("table",{ref:c,className:(0,f.cn)("w-full caption-bottom text-sm",a),...b})}));g.displayName="Table";let h=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("thead",{ref:c,className:(0,f.cn)("[&_tr]:border-b",a),...b}));h.displayName="TableHeader";let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tbody",{ref:c,className:(0,f.cn)("[&_tr:last-child]:border-0",a),...b}));i.displayName="TableBody";let j=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tfoot",{ref:c,className:(0,f.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...b}));j.displayName="TableFooter";let k=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tr",{ref:c,className:(0,f.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...b}));k.displayName="TableRow";let l=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("th",{ref:c,className:(0,f.cn)("h-12 px-4 text-right align-middle font-bold text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...b}));l.displayName="TableHead";let m=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("td",{ref:c,className:(0,f.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...b}));m.displayName="TableCell",e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("caption",{ref:c,className:(0,f.cn)("mt-4 text-sm text-muted-foreground",a),...b})).displayName="TableCaption"},95378:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{DI:()=>m,EP:()=>q,EZ:()=>o,KB:()=>t,Lf:()=>n,d5:()=>p,zO:()=>r,zZ:()=>s});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(62641),i=c(58749),j=c(29631),k=c(40410),l=a([f,h,i,j]);async function m(a){let{clients:b}=await n({...a,all:!0});return b.map(a=>({value:a.id,label:`${a.name} ${a.code?`(${a.code})`:""}`,relationType:a.relationType,paymentType:a.paymentType}))}async function n(a={}){let{all:b=!1,limit:c=15,page:d=1,searchTerm:e,relationType:g,paymentType:h,status:i,country:j,province:k,sortBy:l="useCount_desc"}=a,m=await (0,f.Lf)();if(!m)return{clients:[],total:0};try{let f,n=m.collection("clients");g&&"all"!==g&&(n=n.where("relationType","in","client"===g?["client","both"]:"supplier"===g?["supplier","both"]:[g])),h&&"all"!==h&&(n=n.where("paymentType","==",h)),i&&"all"!==i&&(n=n.where("status","==",i)),!0===a.includeInactive||i||(n=n.where("status","==","active")),j&&"all"!==j&&(n=n.where("country","==",j)),k&&"all"!==k&&(n=n.where("province","==",k));let o=(await n.get()).docs;if(e){let a=e.toLowerCase();o=o.filter(b=>{let c=b.data();return c.name&&c.name.toLowerCase().includes(a)||c.phone&&String(c.phone).includes(a)||c.code&&c.code.toLowerCase().includes(a)})}let p=o.length;if(l){let[a,b]=l.split("_");o.sort((c,d)=>{let e=c.data(),f=d.data(),g=e[a],h=f[a];if(null==g)return 1;if(null==h)return -1;let i=0;return"string"==typeof g&&"string"==typeof h?i=g.localeCompare(h):g>h?i=1:g<h&&(i=-1),"desc"===b?-1*i:i})}if(b)f=o;else{let a=(d-1)*c;f=o.slice(a,a+c)}if(0===f.length)return{clients:[],total:0};return{clients:f.map(a=>{let b=a.data();return{...JSON.parse(JSON.stringify(b,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),id:a.id}}),total:p}}catch(a){return console.error("Error getting clients from Firestore: ",String(a)),{clients:[],total:0}}}async function o(a){let b=await (0,f.Lf)();if(!b)return null;try{let c=await b.collection("clients").doc(a).get();if(!c.exists)return null;let d=c.data(),e=JSON.parse(JSON.stringify(d,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b));return{id:c.id,...e}}catch(b){return console.error(`Error getting client by ID ${a}:`,String(b)),null}}async function p(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=c.name,e=await (0,j.tu)("CL"),f={...a,code:e,createdAt:new Date().toISOString(),createdBy:d,balance:{USD:0,IQD:0},lastTransaction:null,useCount:0};f.password&&f.password.length>=6||delete f.password;let h=await b.collection("clients").add(f);await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:`أنشأ علاقة جديدة باسم: ${f.name} (ID: ${h.id})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts");let k={...f,id:h.id};return{success:!0,client:k}}catch(a){return console.error("Error adding client:",a),{success:!1,error:a.message}}}async function q(a){let b=await (0,f.Lf)();if(!b)return{success:!1,count:0,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,count:0,error:"Unauthorized"};try{for(let d of a){let a=b.batch(),e=b.collection("clients").doc(),f=await (0,j.tu)("CL"),g={...d,code:f,createdAt:new Date().toISOString(),createdBy:`مستورد بواسطة ${c.name}`,type:d.type||"individual",relationType:d.relationType||"client",status:d.status||"active",balance:{USD:0,IQD:0},lastTransaction:null,useCount:0,avatarUrl:""};g.password||delete g.password,a.set(e,g),await a.commit()}return await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:`استورد ${a.length} علاقات جديدة من ملف.`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/relations/settings"),(0,g.revalidatePath)("/reports/debts"),{success:!0,count:a.length}}catch(a){return console.error("Error adding multiple clients: ",String(a)),{success:!1,count:0,error:"Failed to add clients."}}}async function r(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,h.$T)();if(!d)return{success:!1,error:"Unauthorized"};try{let e=JSON.parse(JSON.stringify(b));(""===b.password||void 0===b.password||null===b.password)&&delete e.password,await c.collection("clients").doc(a).update(e),await (0,i.iL)({userId:d.uid,userName:d.name,action:"UPDATE",targetType:"CLIENT",description:`عدل بيانات العلاقة (ID: ${a})`});let f=await c.collection("clients").doc(a).get(),h=JSON.parse(JSON.stringify(f.data(),(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),j={id:f.id,...h};return(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0,updatedClient:j}}catch(a){return console.error("Error updating client:",a),{success:!1,error:a.message}}}async function s(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=(await b.collection("clients").doc(a).get()).data();if(d?.useCount&&d.useCount>0)return{success:!1,error:"لا يمكن حذف هذه العلاقة لوجود معاملات مالية مرتبطة بها."};let e=d?.name||"unknown";return await b.collection("clients").doc(a).delete(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:`حذف العلاقة: ${e} (ID: ${a})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function t(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=b.batch();return a.forEach(a=>{let c=b.collection("clients").doc(a);d.delete(c)}),await d.commit(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:`حذف ${a.length} علاقات بشكل جماعي.`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}[f,h,i,j]=l.then?(await l)():l,(0,k.D)([m,n,o,p,q,r,s,t]),(0,e.A)(m,"405872236907704344162aca1c38160d1eac727fe8",null),(0,e.A)(n,"400e621b7f78c4800cffc85d668ca10cd73eb6853c",null),(0,e.A)(o,"408c94c431661ae65070856bc4a78d84f2cbfcba1c",null),(0,e.A)(p,"403331dfc341d9a7f9cbe156b5d10cfd49a20be531",null),(0,e.A)(q,"408c54ad33973364b68d8475849f76b4a4ca590722",null),(0,e.A)(r,"6023146a7bfefc423ba02712c56694a31432de707c",null),(0,e.A)(s,"4085652545b10cc37283ef55992935bd43a8ce947e",null),(0,e.A)(t,"40f4619201eea9704cbf15357e730e9458fc66e834",null),d()}catch(a){d(a)}})},98411:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{BT:()=>u,GB:()=>H,Ie:()=>G,Lm:()=>A,P2:()=>D,Sw:()=>B,UB:()=>x,X4:()=>F,_$:()=>y,bY:()=>w,cJ:()=>I,hO:()=>v,hf:()=>t,hv:()=>z,j_:()=>C,tg:()=>J});var e=c(91488);c(27806);var f=c(2992),g=c(80446),h=c(91837),i=c(7879),j=c(54756),k=c(41925),l=c(62641),m=c(58749),n=c(29631),o=c(46204),p=c(15105),q=c(82357),r=c(40410),s=a([f,g,i,j,k,l,m,n,p]);async function t(a){await (0,f.T)({sourceType:"subscriptions",sourceId:a.id,date:new Date,currency:a.currency||"USD",amount:a.total,clientId:void 0})}async function u(a,b,d){let{getFinanceMap:e,postJournalEntries:f}=await Promise.resolve().then(c.bind(c,2992)),g=await e(),h=g.receivableAccountId,i=d||g.defaultCashId;if(!h||!i)throw Error("AR or cash account not configured");let j=[{accountId:i,debit:b,credit:0,currency:"USD",description:`استلام دفعة اشتراك`},{accountId:h,debit:0,credit:b,currency:"USD",description:`استلام دفعة اشتراك`}];await f({sourceType:"subscriptions",sourceId:a,entries:j,date:Date.now()})}[f,g,i,j,k,l,m,n,p]=s.then?(await s)():s;let E=a=>{let b=a.data();if(!b)return null;let c={...b,id:a.id};for(let a in c)c[a]&&"function"==typeof c[a].toDate&&(c[a]=c[a].toDate().toISOString());return c},F=(0,o.cache)(async(a=!1)=>{let b=await (0,g.Lf)();if(!b)return console.error("Database not available, returning empty subscriptions list."),[];let c=await (0,j.mt)();if(!c.databaseStatus?.isDatabaseConnected)return console.log("Database connection is disabled in settings. Skipping getSubscriptions fetch."),[];try{let c=b.collection("subscriptions").orderBy("purchaseDate","desc"),d=await c.get();if(d.empty)return[];let e=d.docs.map(a=>E(a)),f=[...new Set(e.map(a=>a.clientId))];if(f.length>0){let a=await b.collection("clients").where(i.FieldPath.documentId(),"in",f).get(),c=new Map(a.docs.map(a=>[a.id,a.data()]));e.forEach(a=>{c.has(a.clientId)&&(a.client=c.get(a.clientId))})}if(a)return e.filter(a=>a.isDeleted);return e.filter(a=>!a.isDeleted)}catch(a){return console.error("Error getting subscriptions from Firestore: ",String(a)),[]}}),G=(0,o.cache)(async a=>{let b=await (0,g.Lf)();if(!b)return null;try{let c=await b.collection("subscriptions").doc(a).get();if(!c.exists)return null;let d=E(c),e=await b.collection("clients").doc(d.clientId).get();return e.exists&&(d.client=e.data()),d}catch(b){return console.error(`Error getting subscription by ID ${a}:`,b),null}});async function v(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,l.$T)();if(!c)return{success:!1,error:"User not authenticated"};let d=await (0,j.mt)();if((0,q.uJ)(d.financeAccounts).preventDirectCashRevenue&&a.boxId)throw Error("❌ غير مسموح بتسجيل الإيرادات مباشرة في الصندوق. استخدم حساب الإيراد أولًا.");d.subscriptionSettings;let e=b.batch(),f=b.collection("subscriptions").doc();try{let d=(a.quantity||1)*(a.purchasePrice||0),g=(a.quantity||1)*(a.unitPrice||0)-(a.discount||0),j=g-d,l=await (0,n.tu)("SUB"),{installments:o,deferredDueDate:q,...r}=a,s={...r,purchaseDate:new Date(a.purchaseDate).toISOString(),startDate:new Date(a.startDate).toISOString(),invoiceNumber:l,purchasePrice:d,salePrice:g,profit:j,paidAmount:0,status:"Active",isDeleted:!1,updatedAt:new Date().toISOString()};e.set(f,s);let t=[];switch(a.installmentMethod){case"upfront":t.push({subscriptionId:f.id,clientName:s.clientName,serviceName:s.serviceName,amount:g,currency:s.currency,dueDate:s.startDate,status:"Unpaid",paidAmount:0,discount:0});break;case"deferred":if(!q)throw Error("Deferred due date is required for deferred payment method.");t.push({subscriptionId:f.id,clientName:s.clientName,serviceName:s.serviceName,amount:g,currency:s.currency,dueDate:new Date(q).toISOString(),status:"Unpaid",paidAmount:0,discount:0});break;case"installments":if(!o||0===o.length)throw Error("Installments data is required for installments payment method.");o.forEach(a=>{t.push({subscriptionId:f.id,clientName:s.clientName,serviceName:s.serviceName,amount:a.amount,currency:s.currency,dueDate:a.dueDate,status:"Unpaid",paidAmount:0,discount:0})})}return t.forEach(a=>{let c=b.collection("subscription_installments").doc();e.set(c,a)}),await (0,p.a)({sourceType:"subscription",sourceId:f.id,description:`إيراد اشتراك خدمة ${s.serviceName}`,amount:g,currency:s.currency,date:new Date(s.purchaseDate),userId:c.uid,creditAccountId:s.clientId}),e.update(b.collection("clients").doc(s.clientId),{useCount:i.FieldValue.increment(1)}),s.supplierId&&e.update(b.collection("clients").doc(s.supplierId),{useCount:i.FieldValue.increment(1)}),s.boxId&&e.update(b.collection("boxes").doc(s.boxId),{useCount:i.FieldValue.increment(1)}),await e.commit(),await (0,m.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"SUBSCRIPTION",description:`أنشأ اشتراكًا جديدًا: "${s.serviceName}" للعميل ${s.clientName}.`,targetId:f.id}),await (0,k.UI)({userId:c.uid,title:"تم إنشاء اشتراك جديد",body:`تم إنشاء اشتراك "${s.serviceName}" للعميل ${s.clientName}.`,type:"system",link:"/subscriptions"}),(0,h.revalidatePath)("/subscriptions"),{success:!0,id:f.id}}catch(a){return console.error("Error adding subscription: ",String(a)),{success:!1,error:"Failed to add subscription."}}}let H=(0,o.cache)(async a=>{let b=await (0,g.Lf)();if(!b)return console.error("Database not available, returning empty installments list."),[];try{let c=await b.collection("subscription_installments").where("subscriptionId","==",a).orderBy("dueDate","asc").get();if(c.empty)return[];return c.docs.map(a=>E(a))}catch(a){throw console.error("Error getting subscription installments: ",String(a)),Error("Failed to fetch subscription installments.")}}),I=(0,o.cache)(async()=>{let a=await (0,g.Lf)();if(!a)return console.error("Database not available, returning empty installments list."),[];let b=await (0,j.mt)();if(!b.databaseStatus?.isDatabaseConnected)return console.log("Database connection is disabled in settings. Skipping getSubscriptionInstallmentsForAll fetch."),[];try{let b=await a.collection("subscription_installments").orderBy("dueDate","asc").get();if(b.empty)return[];return b.docs.map(a=>E(a))}catch(a){return console.error("Error getting all subscription installments: ",String(a)),[]}}),J=(0,o.cache)(async a=>{let b=await (0,g.Lf)();if(!b)return[];try{let c=await b.collection("payments").where("subscriptionInstallmentId","==",a).get();if(c.empty)return[];let d=c.docs.map(a=>E(a));return d.sort((a,b)=>new Date(b.date).getTime()-new Date(a.date).getTime()),d}catch(b){return console.error(`Error getting payments for installment ${a}:`,b),[]}});async function w(a,b,c,d,e,f){let h=await (0,g.Lf)();if(!h)return{success:!1,error:"Database not available."};let j=await (0,l.$T)();if(!j)return{success:!1,error:"User not authenticated."};let k=h.collection("subscription_installments").doc(a);try{return await h.runTransaction(async e=>{let g=await e.get(k);if(!g.exists)throw Error("Installment not found!");let l={id:g.id,...g.data()},m=h.collection("subscriptions").doc(l.subscriptionId),n=await e.get(m);if(!n.exists)throw Error("Subscription not found!");let o=n.data(),q=await e.get(h.collection("subscription_installments").where("subscriptionId","==",l.subscriptionId)),r=f||0,s=c+r,t=await (0,p.a)({sourceType:"journal_from_installment",sourceId:a,description:`سداد دفعة اشتراك خدمة: ${o.serviceName}`,amount:s,currency:d,date:new Date,userId:j.uid,debitAccountId:b,creditAccountId:o.clientId}),u=c,v=r;for(let a of q.docs.map(a=>({id:a.id,...a.data()})).filter(a=>"Unpaid"===a.status).sort((a,b)=>new Date(a.dueDate).getTime()-new Date(b.dueDate).getTime())){if(u<=0&&v<=0)break;let b=h.collection("subscription_installments").doc(a.id),c=(a.amount||0)-(a.paidAmount||0)-(a.discount||0);if(c<=0)continue;let d=Math.min(u,c),f=Math.min(v,c-d);d>0&&e.update(b,{paidAmount:i.FieldValue.increment(d)}),f>0&&e.update(b,{discount:i.FieldValue.increment(f)}),u-=d,v-=f;let g=(a.paidAmount||0)+d,k=(a.discount||0)+f;if(g+k>=a.amount-.01&&e.update(b,{status:"Paid",paidAt:new Date().toISOString()}),d+f>0){let b=h.collection("payments").doc();e.set(b,{subscriptionInstallmentId:a.id,amount:d,discount:f,currency:a.currency,date:new Date().toISOString(),journalVoucherId:t,paidBy:j.name})}}return e.update(m,{paidAmount:i.FieldValue.increment(s)}),u>.01&&await (0,p.a)({sourceType:"overpayment",sourceId:l.subscriptionId,description:`رصيد إضافي بعد سداد كل الدفعات لـ ${o.clientName}`,amount:u,currency:d,date:new Date,userId:j.uid,debitAccountId:b,creditAccountId:o.clientId}),(o.paidAmount||0)+s>=o.salePrice-.01&&e.update(m,{status:"Paid"}),{success:!0}})}catch(a){return console.error("Error paying subscription installment:",String(a)),{success:!1,error:a.message||"Failed to process payment."}}}async function x(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,l.$T)();if(!c)return{success:!1,error:"User not authenticated."};try{let d=b.collection("payments").doc(a);return await b.runTransaction(async a=>{let e=await a.get(d);if(!e.exists)throw Error("Payment not found.");let f=e.data(),g=b.collection("subscription_installments").doc(f.subscriptionInstallmentId),h=await a.get(g);if(!h.exists)throw Error("Installment not found.");let j=h.data(),k=b.collection("subscriptions").doc(j.subscriptionId),l=b.collection("journal-vouchers").doc(f.journalVoucherId),m=await a.get(l);if(!m.exists)throw Error("Original journal voucher not found.");let n=m.data();await (0,p.a)({sourceType:"reversal",sourceId:f.journalVoucherId,description:`عكس قيد سداد دفعة رقم: ${n.invoiceNumber}`,amount:f.amount+(f.discount||0),currency:f.currency,date:new Date,userId:c.uid,debitAccountId:n.creditEntries[0].accountId,creditAccountId:n.debitEntries[0].accountId});let o=f.amount+(f.discount||0);return a.update(k,{paidAmount:i.FieldValue.increment(-o),status:"Active"}),a.update(g,{paidAmount:i.FieldValue.increment(-f.amount),discount:i.FieldValue.increment(-(f.discount||0)),status:"Unpaid"}),a.delete(d),{success:!0}})}catch(a){return console.error("Error deleting payment:",a),{success:!1,error:a.message}}}async function y(a,b){let c=await (0,g.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,l.$T)();if(!d)return{success:!1,error:"User not authenticated."};let e=c.collection("payments").doc(a);try{return await c.runTransaction(async f=>{let g=await f.get(e);if(!g.exists)throw Error("Payment not found.");let h=g.data(),j=c.collection("subscription_installments").doc(h.subscriptionInstallmentId),k=await f.get(j);if(!k.exists)throw Error("Installment not found.");let l=k.data(),m=c.collection("subscriptions").doc(l.subscriptionId),n=c.collection("journal-vouchers").doc(h.journalVoucherId),o=(b.amount??h.amount)-h.amount;if(Math.abs(o)>.01){let b=(await f.get(n)).data(),c=`تعديل دفعة اشتراك: ${h.id}`;await (0,p.a)({sourceType:"adjustment",sourceId:a,description:c,amount:Math.abs(o),currency:h.currency,date:new Date,userId:d.uid,debitAccountId:o>0?b.debitEntries[0].accountId:b.creditEntries[0].accountId,creditAccountId:o>0?b.creditEntries[0].accountId:b.debitEntries[0].accountId})}let q={...b};return b.date&&(q.date=new Date(b.date).toISOString()),f.update(e,q),0!==o&&(f.update(j,{paidAmount:i.FieldValue.increment(o)}),f.update(m,{paidAmount:i.FieldValue.increment(o)})),{success:!0}})}catch(a){return console.error("Error updating payment:",a),{success:!1,error:a.message}}}async function z(a,b,c){let d=await (0,g.Lf)();if(!d)return{success:!1,error:"Database not available."};let e=await (0,l.$T)();if(!e)return{success:!1,error:"User not authenticated."};let f=d.collection("subscriptions").doc(a);try{let d={status:b,updatedAt:new Date().toISOString()};return"Cancelled"===b||"Suspended"===b?(d.cancellationDate=new Date().toISOString(),d.cancellationReason=c||"لا يوجد سبب محدد"):"Active"===b&&(d.cancellationDate=i.FieldValue.delete(),d.cancellationReason=i.FieldValue.delete()),await f.update(d),await (0,m.iL)({userId:e.uid,userName:e.name,action:"UPDATE",targetType:"SUBSCRIPTION",description:`غير حالة الاشتراك (ID: ${a}) إلى ${b}`}),(0,h.revalidatePath)("/subscriptions"),(0,h.revalidatePath)(`/subscriptions/${a}`),{success:!0}}catch(a){return console.error("Error updating subscription status:",String(a)),{success:!1,error:a.message||"Failed to update status."}}}async function A(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};if(!await (0,l.$T)())return{success:!1,error:"User not authenticated."};try{return await b.collection("subscriptions").doc(a).update({isDeleted:!0,deletedAt:new Date().toISOString()}),(0,h.revalidatePath)("/subscriptions"),(0,h.revalidatePath)("/subscriptions/deleted-subscriptions"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function B(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};if(!await (0,l.$T)())return{success:!1,error:"User not authenticated."};try{return await b.collection("subscriptions").doc(a).update({isDeleted:!1,deletedAt:i.FieldValue.delete()}),(0,h.revalidatePath)("/subscriptions"),(0,h.revalidatePath)("/subscriptions/deleted-subscriptions"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function C(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,l.$T)();if(!c)return{success:!1,error:"Unauthorized"};let d=b.batch();try{let e=b.collection("subscriptions").doc(a);return d.delete(e),(await b.collection("subscription_installments").where("subscriptionId","==",a).get()).forEach(a=>d.delete(a.ref)),(await b.collection("journal-vouchers").where("originalData.subscriptionId","==",a).get()).forEach(a=>d.delete(a.ref)),await d.commit(),await (0,m.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"SUBSCRIPTION",description:`حذف الاشتراك بالكامل (ID: ${a})`}),(0,h.revalidatePath)("/subscriptions"),(0,h.revalidatePath)("/subscriptions/deleted-subscriptions"),(0,h.revalidatePath)("/accounts/vouchers/list"),{success:!0}}catch(a){return console.error("Error deleting subscription:",String(a)),{success:!1,error:"Failed to delete subscription and related data."}}}async function D(){(0,h.revalidatePath)("/subscriptions")}(0,r.D)([t,u,F,G,v,H,I,J,w,x,y,z,A,B,C,D]),(0,e.A)(t,"40f8aa2891259d90b9487e388b3405df3c3e200aeb",null),(0,e.A)(u,"709feea95dd92012fa4ddb7ae17c30c3338b04e65a",null),(0,e.A)(F,"7f7228b058474be00c09729ab715fa20e010333dfa",null),(0,e.A)(G,"7f156258846f24d01f7193780d90bff0896769f3dc",null),(0,e.A)(v,"403853799c99974381aed2d752ac232c7cabeb7c0b",null),(0,e.A)(H,"7fbd1dd6c8c8f0af7b61f3a67d5d04b01b5dd3fc37",null),(0,e.A)(I,"7f59f3075656a91b7ed27ed0deb8f239c13fb4a30e",null),(0,e.A)(J,"7f29b1f619814d2bb347b7568d9fef0db3672866b7",null),(0,e.A)(w,"7ea99aecbe6da08b740bfa589a23855143625f516a",null),(0,e.A)(x,"400839afac1c721e8a0733096582359b8356e40214",null),(0,e.A)(y,"60ac99fd5fe70fb62fed80f68193cb25204f5a2c28",null),(0,e.A)(z,"70a1966b164872145df93c00584df7a0b9768aea98",null),(0,e.A)(A,"40fb273cfe11e3acbfaa3953430203de2db167f95f",null),(0,e.A)(B,"4037c6ea7b2487342669aecdc2a7174064cd6c84fe",null),(0,e.A)(C,"403921c096e7cdc87c12bd704541e2db9fad4db939",null),(0,e.A)(D,"00b878a0ae60d2d2540f863a4367bd50a6144d83f1",null),d()}catch(a){d(a)}})}};