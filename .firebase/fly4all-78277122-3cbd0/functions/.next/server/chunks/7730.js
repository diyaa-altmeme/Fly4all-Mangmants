"use strict";exports.id=7730,exports.ids=[7730],exports.modules={7730:(a,b,c)=>{c.d(b,{A:()=>L});var d=c(21124),e=c(38301),f=c(35284),g=c(37448),h=c(97752),i=c(11134),j=c(9517),k=c(90447),l=c(85846),m=c(44943);function n({onDataReady:a}){let[b,c]=(0,e.useState)(null),{toast:n}=(0,g.dj)(),o=(0,e.useCallback)(b=>{c(b);let d=new FileReader;d.onload=b=>{try{let c=new Uint8Array(b.target?.result),d=h.LF(c,{type:"array"}),e=d.Sheets[d.SheetNames[0]],f=h.Wp.sheet_to_json(e,{defval:""});a(f),n({title:`تم تحميل ${f.length} سجل بنجاح`,description:"انتقِل للخطوة التالية لربط الحقول."})}catch(a){n({title:"خطأ في قراءة الملف",description:"تعذر تحليل ملف Excel. الرجاء التأكد من أنه بالتنسيق الصحيح.",variant:"destructive"})}},d.readAsArrayBuffer(b)},[a,n]),p=(0,e.useCallback)(a=>{a&&a.length>0&&o(a[0])},[o]),{getRootProps:q,getInputProps:r,isDragActive:s}=(0,i.VB)({onDrop:p,accept:{"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]},maxFiles:1});return(0,d.jsxs)("div",{...q(),className:(0,m.cn)("border-2 border-dashed rounded-lg p-10 text-center cursor-pointer relative flex flex-col justify-center items-center h-64 hover:border-primary transition-colors",s&&"border-primary bg-primary/10"),children:[(0,d.jsx)("input",{...r(),id:"excel-upload"}),b?(0,d.jsxs)("div",{className:"flex flex-col items-center justify-center h-full",children:[(0,d.jsx)(j.A,{className:"h-12 w-12 text-green-500"}),(0,d.jsxs)("p",{className:"mt-4 font-semibold text-lg",children:["تم تحميل الملف: ",b.name]}),(0,d.jsx)("p",{className:"text-sm text-muted-foreground",children:"جاهز للانتقال للخطوة التالية."}),(0,d.jsxs)(f.$,{variant:"ghost",size:"sm",onClick:b=>{b.stopPropagation(),c(null),a([])},className:"mt-2 text-destructive hover:text-destructive",children:[(0,d.jsx)(k.A,{className:"me-1 h-4 w-4"}),"إزالة الملف"]})]}):(0,d.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[(0,d.jsx)(l.A,{className:"h-12 w-12"}),(0,d.jsx)("h3",{className:"mt-4 font-semibold text-lg",children:"اسحب وأفلت ملف Excel هنا"}),(0,d.jsx)("p",{className:"mt-2 text-sm",children:"أو انقر لاختيار ملف من جهازك"})]})]})}var o=c(45608),p=c(10656);function q({headers:a,relationFields:b,importFieldsSettings:c,onMappingDone:h}){let[i,j]=(0,e.useState)({}),[k,l]=(0,e.useState)([]),{toast:m}=(0,g.dj)(),n=(0,e.useMemo)(()=>b?[...b,...k]:k,[b,k]),q=(0,e.useCallback)(()=>{if(!b)return;let d={};b.forEach(b=>{let e=c[b.id],f=Array.from(new Set([b.label.toLowerCase().trim(),b.id.toLowerCase().trim(),...(e?.aliases||[]).map(a=>a.toLowerCase().trim())])),g=a.find(a=>f.includes(a.toLowerCase().trim()));g&&!Object.values(d).includes(b.id)&&(d[g]=b.id)}),j(d),m({title:"تم الربط التلقائي",description:`تم ربط ${Object.keys(d).length} حقلاً تلقائيًا. الرجاء مراجعة النتائج.`})},[a,b,m,c]);return e.useEffect(()=>{q()},[]),(0,d.jsxs)("div",{className:"space-y-4",children:[(0,d.jsx)("div",{className:"flex justify-end",children:(0,d.jsx)(f.$,{onClick:q,variant:"outline",children:"إعادة الربط التلقائي"})}),(0,d.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(a=>(0,d.jsxs)("div",{className:"space-y-1",children:[(0,d.jsx)("label",{className:"block font-medium text-sm",children:a}),(0,d.jsxs)(o.l6,{onValueChange:b=>((a,b)=>{if("__create_new__"===b){let b=`custom_${a.toLowerCase().replace(/\s+/g,"_")}`;if(n.some(a=>a.id===b))return void m({title:"الحقل موجود بالفعل",description:"يوجد حقل مخصص بنفس الاسم.",variant:"destructive"});let c={id:b,label:a,type:"text",required:!1,visible:!0,deletable:!0,aliases:[a.toLowerCase()],appliesTo:["individual","company"]};l(a=>[...a,c]),j(c=>({...c,[a]:b}))}else j(c=>({...c,[a]:b}))})(a,b),value:i[a]||"__ignore__",children:[(0,d.jsx)(o.bq,{children:(0,d.jsx)(o.yv,{placeholder:"-- اختر الحقل المناسب --"})}),(0,d.jsxs)(o.gC,{children:[(0,d.jsx)(o.eb,{value:"__ignore__",children:"-- تجاهل هذا الحقل --"}),(0,d.jsx)(o.eb,{value:"__create_new__",className:"text-green-600 font-bold",children:(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsx)(p.A,{className:"h-4 w-4"}),(0,d.jsxs)("span",{children:['إنشاء حقل جديد باسم "',a,'"']})]})}),n.map(a=>(0,d.jsx)(o.eb,{value:a.id,className:k.some(b=>b.id===a.id)?"text-green-600":"",children:a.label},a.id))]})]})]},a))}),(0,d.jsx)("div",{className:"flex justify-center pt-4",children:(0,d.jsx)(f.$,{onClick:()=>{if(!Object.values(i).includes("name")&&b.some(a=>"name"===a.id))return void m({title:"حقل الاسم مطلوب",description:"الرجاء ربط أحد أعمدة ملف Excel مع حقل 'الاسم الكامل' للمتابعة.",variant:"destructive"});h(i,k)},size:"lg",children:"معالجة البيانات والانتقال للمعاينة"})})]})}var r=c(79202),s=c(93758),t=c(40822);function u({rows:a,onRowUpdate:b,onDeleteRow:c,fieldMap:g,relationFields:h}){if(0===a.length)return(0,d.jsx)("p",{className:"text-center text-muted-foreground p-8",children:"لا توجد بيانات لعرضها."});let i=e.useMemo(()=>Object.values(g).filter(a=>"__ignore__"!==a),[g]);return(0,d.jsx)("div",{className:"overflow-auto max-h-[500px] border rounded-lg",children:(0,d.jsxs)(r.XI,{children:[(0,d.jsx)(r.A0,{className:"sticky top-0 bg-muted/80",children:(0,d.jsxs)(r.Hj,{children:[i.map(a=>(0,d.jsx)(r.nd,{children:h.find(b=>b.id===a)?.label||a},a)),(0,d.jsx)(r.nd,{className:"text-center",children:"حذف"})]})}),(0,d.jsx)(r.BF,{children:a.map((a,e)=>(0,d.jsxs)(r.Hj,{children:[i.map(c=>(0,d.jsx)(r.nA,{className:"p-1",children:(0,d.jsx)(s.p,{value:a[c]||"",onChange:d=>b(e,{...a,[c]:d.target.value}),className:"h-8"})},c)),(0,d.jsx)(r.nA,{className:"text-center p-1",children:(0,d.jsx)(f.$,{variant:"ghost",size:"icon",className:"text-destructive h-8 w-8",onClick:()=>c(e),children:(0,d.jsx)(t.A,{className:"h-4 w-4"})})})]},e))})]})})}var v=c(62186),w=c(49113),x=c(85708);let y=(0,x.createServerReference)("40d0448bacb32a373d23394258f9e7de4aa7fd38a9",x.callServer,void 0,x.findSourceMapURL,"addMultipleClients");var z=c(42378);function A({data:a,onSaveComplete:b}){let{toast:c}=(0,g.dj)(),h=(0,z.useRouter)(),[i,k]=(0,e.useState)(!1),l=async()=>{k(!0);try{let d=await y(a);if(d.success)c({title:`تم حفظ ${d.count} سجل بنجاح!`,description:"سيتم تحديث قائمة العلاقات."}),await b(),h.refresh();else throw Error(d.error)}catch(a){c({title:"فشل الحفظ",description:a.message||"حدث خطأ أثناء الحفظ",variant:"destructive"})}finally{k(!1)}};return(0,d.jsxs)(v.Zp,{className:"max-w-md mx-auto",children:[(0,d.jsxs)(v.aR,{children:[(0,d.jsxs)(v.ZB,{className:"flex items-center gap-2",children:[(0,d.jsx)(j.A,{className:"h-6 w-6 text-green-500"}),"جاهز للحفظ"]}),(0,d.jsx)(v.BT,{children:"تمت معالجة البيانات وهي جاهزة للحفظ في النظام."})]}),(0,d.jsxs)(v.Wu,{className:"text-center",children:[(0,d.jsx)("p",{className:"text-4xl font-bold",children:a.length}),(0,d.jsx)("p",{className:"text-muted-foreground",children:"سجلًا سيتم استيراده."})]}),(0,d.jsx)(v.wL,{children:(0,d.jsx)(f.$,{className:"w-full",size:"lg",onClick:l,disabled:i,children:i?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(w.A,{className:"me-2 h-4 w-4 animate-spin"}),"جاري الحفظ..."]}):"تأكيد وحفظ البيانات"})})]})}var B=c(42329),C=c(92242);let D=(0,c(8808).A)("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]);var E=c(86159),F=c(49566),G=c(83557),H=c(66782),I=c(65409),J=c(72001);let K=[{label:"رفع الملف",icon:(0,d.jsx)(C.A,{})},{label:"ربط الحقول",icon:(0,d.jsx)(D,{})},{label:"معاينة وتعديل",icon:(0,d.jsx)(E.A,{})},{label:"الحفظ",icon:(0,d.jsx)(F.A,{})}];function L({settings:a}){let[b,c]=(0,e.useState)([]),[h,i]=(0,e.useState)([]),[j,k]=(0,e.useState)([]),[l,m]=(0,e.useState)({}),[o,p]=(0,e.useState)([]),{toast:r}=(0,g.dj)(),{activeStep:s,goToNextStep:t,goToPreviousStep:v,isLastStep:w}=(0,B.lE)({initialStep:0,steps:K}),x=a=>{if(0===a.length)return void r({title:"الملف فارغ أو غير صالح",variant:"destructive"});c(a),i(Object.keys(a[0])),t()},y=(c,d)=>{if(!a?.importLogicSettings||!a?.relationSections)return void r({title:"خطأ",description:"لم يتم تحميل إعدادات النظام بشكل صحيح.",variant:"destructive"});m(c),p(d);let e=[...a.relationSections.flatMap(a=>a.fields),...d];k(b.map(b=>((a,b,c,d)=>{let e={};for(let c in d.forEach(a=>{e[a.id]=a.defaultValue||""}),b){let f,g=b[c];if("__ignore__"===g)continue;let h=a[c],i=d.find(a=>a.id===g);f=null==h||""===String(h).trim()?i?.defaultValue||"":"string"==typeof h?h.trim():h,e[g]=f}let f=String(e.paymentType).toLowerCase();c.creditKeywords.map(a=>a.toLowerCase()).includes(f)?e.paymentType="credit":(c.cashKeywords.map(a=>a.toLowerCase()).includes(f),e.paymentType="cash");let g=String(e.type).toLowerCase();"company"===g||"شركة"===g?e.type="company":e.type="individual";let h=String(e.relationType).toLowerCase();return["supplier","مورد"].includes(h)?e.relationType="supplier":["both","كلاهما","عميل ومورد"].includes(h)?e.relationType="both":e.relationType="client",e.status=["active","نشط"].includes(String(e.status).toLowerCase())?"active":"inactive",e})(b,c,a.importLogicSettings,e))),t()},z=(a,b)=>{let c=[...j];c[a]=b,k(c)},C=a=>{k(j.filter((b,c)=>c!==a))},D=async()=>{if(!a.relationSections)return;let b=(0,J.jM)(a.relationSections,a=>{let b=a.flatMap(a=>a.fields).filter(a=>"select"===a.type);j.forEach(a=>{b.forEach(b=>{let c=a[b.id];c&&!b.options?.some(a=>a.label===c||a.value===c)&&(b.options||(b.options=[]),b.options.push({value:c,label:c}))})})}),c=(0,J.jM)(b,a=>{let b=a.find(a=>"sec_other"===a.id);if(b&&o.length>0){let a=new Set(b.fields.map(a=>a.id)),c=o.filter(b=>!a.has(b.id));b.fields.push(...c)}else!b&&o.length>0&&a.push({id:"sec_other",title:"تفاصيل أخرى",description:"حقول إضافية وتفاصيل.",deletable:!0,fields:o})});JSON.stringify(c)!==JSON.stringify(a.relationSections)&&(await (0,I.X)({relationSections:c}),r({title:"تم تحديث إعدادات الحقول",description:"تمت إضافة الخيارات والحقول الجديدة من بياناتك المستوردة."}))};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("div",{className:"mb-8",children:(0,d.jsx)(B.C1,{activeStep:s,children:K.map((a,b)=>(0,d.jsx)(B.LB,{label:a.label,icon:a.icon,isCompleted:s>b,isActive:s===b,isLast:b===K.length-1},a.label))})}),(0,d.jsx)("div",{children:(()=>{switch(s){case 0:return(0,d.jsx)(n,{onDataReady:x});case 1:return(0,d.jsx)(q,{headers:h,onMappingDone:y,relationFields:a.relationSections.flatMap(a=>a.fields),importFieldsSettings:a.importFieldsSettings||{}});case 2:return(0,d.jsx)(u,{rows:j,onRowUpdate:z,onDeleteRow:C,fieldMap:l,relationFields:[...a.relationSections.flatMap(a=>a.fields),...o]});case 3:return(0,d.jsx)(A,{data:j,onSaveComplete:D});default:return null}})()}),(0,d.jsxs)("div",{className:"flex justify-between mt-8",children:[(0,d.jsxs)(f.$,{variant:"outline",onClick:v,disabled:0===s,children:[(0,d.jsx)(G.A,{className:"me-2 h-4 w-4"}),"السابق"]}),(0,d.jsxs)(f.$,{onClick:t,disabled:!!w||0===s&&0===b.length||1===s||2===s&&0===j.length,children:[w?"إنهاء":"التالي",(0,d.jsx)(H.A,{className:"ms-2 h-4 w-4"})]})]})]})}},9517:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},79202:(a,b,c)=>{c.d(b,{A0:()=>h,BF:()=>i,Gg:()=>j,Hj:()=>k,XI:()=>g,nA:()=>m,nd:()=>l});var d=c(21124),e=c(38301),f=c(44943);let g=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{className:"relative w-full overflow-auto",children:(0,d.jsx)("table",{ref:c,className:(0,f.cn)("w-full caption-bottom text-sm",a),...b})}));g.displayName="Table";let h=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("thead",{ref:c,className:(0,f.cn)("[&_tr]:border-b",a),...b}));h.displayName="TableHeader";let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tbody",{ref:c,className:(0,f.cn)("[&_tr:last-child]:border-0",a),...b}));i.displayName="TableBody";let j=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tfoot",{ref:c,className:(0,f.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...b}));j.displayName="TableFooter";let k=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tr",{ref:c,className:(0,f.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...b}));k.displayName="TableRow";let l=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("th",{ref:c,className:(0,f.cn)("h-12 px-4 text-right align-middle font-bold text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...b}));l.displayName="TableHead";let m=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("td",{ref:c,className:(0,f.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...b}));m.displayName="TableCell",e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("caption",{ref:c,className:(0,f.cn)("mt-4 text-sm text-muted-foreground",a),...b})).displayName="TableCaption"},85846:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("CloudUpload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]])},86159:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("List",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]])},92242:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]])}};