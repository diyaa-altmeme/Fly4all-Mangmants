"use strict";exports.id=4799,exports.ids=[4799],exports.modules={2992:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{C:()=>s,T:()=>r,getFinanceMap:()=>q,postJournalEntries:()=>p});var e=c(91488);c(27806);var f=c(80446),g=c(62641),h=c(82357),i=c(7879),j=c(29631),k=c(21096),l=c(40410),m=a([f,g,i,j]);async function n(a,b){let c=Array.from(new Set(b.map(a=>a.accountId).filter(Boolean)));if(0===c.length)return;let d=c.map(b=>a.collection("chart_of_accounts").doc(b)),e=(await Promise.all(d.map(a=>a.get()))).map((a,b)=>a.exists?null:c[b]).filter(Boolean);if(e.length)throw Error("Accounts not found: "+e.join(", "))}function o(a){let b=a.find(a=>!!a.currency);return b?.currency||"USD"}async function p(a,b){let c=await (0,f.Lf)();if(!a.entries||!Array.isArray(a.entries)||0===a.entries.length)throw Error("No entries provided");let d=null;if(!a.meta||!a.meta.system){let a=await (0,g.$T)();if(!a)throw Error("Authentication required to post journal entries");if("isClient"in a&&a.isClient)throw Error("Insufficient permissions");if(!("admin"===a.role||a.permissions&&a.permissions.includes("vouchers:create")))throw Error("User lacks vouchers:create permission");d={uid:a.uid,name:a.name}}if(!function(a){let b=a.reduce((a,b)=>a+(b.debit||0),0),c=a.reduce((a,b)=>a+(b.credit||0),0);return 1e-4>Math.abs(b-c)}(a.entries))throw Error("Entries are not balanced (debit != credit)");if(await n(c,a.entries),!b)try{b=await q()}catch(a){}let e=b;if(e?.preventDirectCashRevenue){let b=e.defaultCashId;if(b){for(let c of a.entries)if(c.accountId===b)throw Error("Direct cash posting is disabled by finance settings")}}let h=i.Timestamp.now(),l=c.collection("journal-vouchers").doc(),m=await (0,j.tu)(a.sourceType.toUpperCase()),p=o(a.entries),r=a.entries.map(a=>{let b=Number(a.debit)||0,c=Number(a.credit)||0,d=a.note??a.description,f=(0,k.Um)(a.accountId,e||null);return{...a,debit:b,credit:c,amount:b>0?b:c,currency:a.currency||p,description:d,accountType:f}}),{debitEntries:s,creditEntries:t}=function(a){let b=[],c=[];for(let d of a)d.debit>0&&b.push({accountId:d.accountId,amount:d.debit,description:d.description??d.note,currency:d.currency,relationId:d.relationId,companyId:d.companyId,accountType:d.accountType}),d.credit>0&&c.push({accountId:d.accountId,amount:d.credit,description:d.description??d.note,currency:d.currency,relationId:d.relationId,companyId:d.companyId,accountType:d.accountType});return{debitEntries:b,creditEntries:c}}(r),u=a.date instanceof Date?a.date.toISOString():a.date?new Date(a.date).toISOString():new Date().toISOString(),v=a.meta?.createdBy||d?.uid||"system",w=a.meta?.officer||d?.name||"system";return await l.set({id:l.id,invoiceNumber:m,date:u,currency:o(a.entries),notes:a.description||"",createdBy:v,officer:w,createdAt:h,updatedAt:h,voucherType:`journal_from_${a.sourceType}`,sourceType:a.sourceType,sourceId:a.sourceId,debitEntries:s,creditEntries:t,isAudited:!1,isConfirmed:!0,meta:a.meta||null,entries:r.map(a=>({accountId:a.accountId,debit:a.debit,credit:a.credit,amount:a.amount,description:a.description??a.note,currency:a.currency,relationId:a.relationId,companyId:a.companyId,accountType:a.accountType,type:a.debit>0?"debit":"credit"})),originalData:{sourceType:a.sourceType,sourceId:a.sourceId,meta:a.meta||null}}),l.id}[f,g,i,j]=m.then?(await m)():m;let t={at:0,map:null};async function q(){let a=Date.now();if(t.map&&a-t.at<15e3)return t.map;let b=(await (0,f.Lf)()).collection("settings").doc("app_settings"),c=await b.get(),d=c.data()?.financeAccounts||{},e=(0,h.uJ)(d);return t={at:a,map:e},e}async function r({sourceType:a,sourceId:b,date:c,currency:d,amount:e,clientId:f}){if(e<=0)return;let g=await q(),h=g.revenueMap?.[a]||g.generalRevenueId,i=g.receivableAccountId;if(!h||!i)throw Error(`Missing mapping: revenue=${h} or AR=${i}`);let j=g.preventDirectCashRevenue&&g.defaultCashId,k=[{accountId:j?i:g.defaultCashId||i,debit:e,credit:0,currency:d,note:j?"إثبات إيراد آجل":"إثبات إيراد نقدي",relationId:f},{accountId:h,debit:0,credit:e,currency:d,note:"قيد الإيراد",relationId:f}];return p({sourceType:a,sourceId:b,date:"string"==typeof c?Date.parse(c):c.getTime(),entries:k,meta:{clientId:f,directCash:!j},description:j?"قيد إيراد آجل":"قيد إيراد نقدي"},g)}async function s({costKey:a,sourceType:b,sourceId:c,date:d,currency:e,amount:f,supplierId:g}){if(f<=0)return;let h=await q(),i=h.expenseMap?.[a]||h.generalExpenseId,j=h.payableAccountId;if(!i||!j)throw Error(`Missing mapping: expense=${i} or AP=${j}`);let k=[{accountId:i,debit:f,credit:0,currency:e,note:"تسجيل مصروف",relationId:g},{accountId:j,debit:0,credit:f,currency:e,note:"تسجيل ذمم دائنة للمورد",relationId:g}];return p({sourceType:b,sourceId:c,date:"string"==typeof d?Date.parse(d):d.getTime(),entries:k,meta:{supplierId:g},description:"قيد مصروف"},h)}(0,l.D)([p,q,r,s]),(0,e.A)(p,"60f0caf2093b9fcfdd71247bdb544c4372ceacd6c0",null),(0,e.A)(q,"00e358f3436e9739dfe740f6be22aedc1117f6422a",null),(0,e.A)(r,"409c8a7c4192cd1e36809ce6ea14b1b4ba417e8767",null),(0,e.A)(s,"4012e9d0afaf5977818266842659883d1e03e6c32f",null),d()}catch(a){d(a)}})},24799:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{AZ:()=>u,I0:()=>x,Kq:()=>B,LD:()=>D,LQ:()=>I,Nb:()=>A,f9:()=>J,k5:()=>z,nX:()=>v,rC:()=>C,ro:()=>G,vL:()=>w,xo:()=>y});var e=c(91488);c(27806);var f=c(2992),g=c(80446),h=c(91837),i=c(46204),j=c(62641),k=c(7879),l=c(14738),m=c(67132),n=c(41331),o=c(84835),p=c(63097),q=c(29631),r=c(41925),s=c(40410),t=a([f,g,j,k,q,r]);async function u(a,b,c,d,e,g){if(!b||!c)throw Error("Both account ids are required");await (0,f.postJournalEntries)({sourceType:"exchanges",sourceId:a,date:Date.now(),entries:[{accountId:c,debit:d,credit:0,currency:e,note:g||"تحويل إلى"},{accountId:b,debit:0,credit:d,currency:e,note:g||"تحويل من"}]})}[f,g,j,k,q,r]=t.then?(await t)():t;let E="exchanges",F=a=>{let b=a.data();if(!b)return null;let c={...b,id:a.id};for(let a in c)c[a]&&"function"==typeof c[a].toDate&&(c[a]=c[a].toDate().toISOString());return c},G=(0,i.cache)(async()=>{let a=await (0,g.Lf)();return a?{accounts:(await a.collection(E).orderBy("name").get()).docs.map(a=>F(a))}:{error:"Database not available."}});async function v(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available"};let c=await (0,j.$T)();if(!c)throw Error("User not authenticated.");let d=await b.collection(E).add({...a,createdAt:k.FieldValue.serverTimestamp(),createdBy:c.uid});return(0,h.revalidatePath)("/exchanges"),{success:!0,newExchange:{id:d.id,...a,createdAt:new Date().toISOString()}}}async function w(a,b){let c=await (0,g.Lf)();return c?(await c.collection(E).doc(a).update(b),(0,h.revalidatePath)("/exchanges"),{success:!0}):{success:!1,error:"Database not available"}}async function x(a,b,c){let d=await (0,g.Lf)();if(!d)return[];let e=d.collection("transactions").where("exchangeId","==",a);return b&&(e=e.where("date",">=",(0,l.GP)((0,m.o)(b),"yyyy-MM-dd"))),c&&(e=e.where("date","<=",(0,l.GP)((0,n.D)(c),"yyyy-MM-dd"))),e=e.orderBy("date","desc"),(await e.get()).docs.map(a=>F(a))}let H=async(a,b)=>{let c=await (0,g.Lf)();if(!c)return;let d=(await c.collection(E).doc(a).get()).data();if(!d||!d.thresholdAlertUSD)return;let e=await I(a),f=e.length>0&&e[0]?.balance||0;Math.abs(f)>d.thresholdAlertUSD&&await (0,r.UI)({userId:b.uid,title:`تنبيه رصيد البورصة: ${d.name}`,body:`تجاوز رصيد البورصة الحد المحدد. الرصيد الحالي: ${f.toFixed(2)} USD`,type:"warning",link:`/exchanges/report?exchangeId=${a}`})};async function y(a,b,c){let d=await (0,g.Lf)();if(!d)return{success:!1,error:"Database not available"};let e=await (0,j.$T)();if(!e)throw Error("User not authenticated.");let f=!!c,i={};if(f){let a=await d.collection("exchange_transaction_batches").doc(c).get();a.exists&&(i=a.data())}let l=f?d.collection("exchange_transaction_batches").doc(c):d.collection("exchange_transaction_batches").doc(),m=d.batch();f&&(await d.collection("transactions").where("batchId","==",c).get()).forEach(a=>m.delete(a.ref));let n=0,o=b.map(b=>{let c=d.collection("transactions").doc(),f=Number(b.rate)||1,g="USD"===b.originalCurrency?b.originalAmount:b.originalAmount/f,h=-Math.abs(g);n+=h;let i={id:c.id,...b,exchangeId:a,batchId:l.id,amountInUSD:h,remainingUSD:Math.abs(h),status:"open",linkedPaymentIds:[],createdAt:new Date().toISOString(),createdBy:e.uid,userName:e.name};return m.set(c,{...i,createdAt:k.FieldValue.serverTimestamp()}),i}),p=f&&i.invoiceNumber?i.invoiceNumber:await (0,q.tu)("EXT"),s={exchangeId:a,invoiceNumber:p,createdAt:f&&i.createdAt?"function"==typeof i.createdAt.toDate?i.createdAt.toDate().toISOString():new Date(i.createdAt).toISOString():new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:f&&i.createdBy?i.createdBy:e.uid,userName:f&&i.userName?i.userName:e.name,count:b.length,totalAmount:n,isConfirmed:i.isConfirmed||!1,date:b[0]?.date||new Date().toISOString().slice(0,10),auditLog:i.auditLog||[]},t={action:f?"UPDATE":"CREATE",userId:e.uid,userName:e.name,timestamp:new Date().toISOString()};s.auditLog.push(t),m.set(l,{...s,updatedAt:k.FieldValue.serverTimestamp(),createdAt:f?s.createdAt:k.FieldValue.serverTimestamp()},{merge:!0}),await m.commit(),await (0,r.UI)({userId:e.uid,title:"تم تسجيل دفعة معاملات",body:`تم تسجيل ${b.length} معاملات جديدة للبورصة بفاتورة ${p}`,type:"voucher",link:`/exchanges/report?exchangeId=${a}`}),await H(a,e),(0,h.revalidatePath)("/exchanges/report");let u={id:l.id,...s,description:"",entryType:"transaction",details:o};return{success:!0,batch:u}}async function z(a,b,c){let d=await (0,g.Lf)();if(!d)return[];let e=d.collection("payments").where("exchangeId","==",a);return b&&(e=e.where("date",">=",(0,l.GP)((0,m.o)(b),"yyyy-MM-dd"))),c&&(e=e.where("date","<=",(0,l.GP)((0,n.D)(c),"yyyy-MM-dd"))),e=e.orderBy("date","desc"),(await e.get()).docs.map(a=>F(a))}async function A(a,b,c){let d=await (0,g.Lf)();if(!d)return{success:!1,error:"Database not available"};let e=await (0,j.$T)();if(!e)throw Error("User not authenticated.");let f=!!c,i={};if(f){let a=await d.collection("exchange_payment_batches").doc(c).get();a.exists&&(i=a.data())}let l=f?d.collection("exchange_payment_batches").doc(c):d.collection("exchange_payment_batches").doc(),m=d.batch();f&&(await d.collection("payments").where("batchId","==",c).get()).forEach(a=>m.delete(a.ref));let n=0,o=b.map(b=>{let c=d.collection("payments").doc(),f=Number(b.rate)||1,g="USD"===b.originalCurrency?b.originalAmount:b.originalAmount/f,h="payment"===b.type?Math.abs(g):-Math.abs(g);n+=h;let i={id:c.id,...b,exchangeId:a,batchId:l.id,amountInUSD:h,appliedTxns:[],createdAt:new Date().toISOString(),createdBy:e.uid,userName:e.name};return m.set(c,{...i,createdAt:k.FieldValue.serverTimestamp()}),i}),p=f&&i.invoiceNumber?i.invoiceNumber:await (0,q.tu)("EXP"),s={exchangeId:a,invoiceNumber:p,createdAt:f&&i.createdAt?"function"==typeof i.createdAt.toDate?i.createdAt.toDate().toISOString():new Date(i.createdAt).toISOString():new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:f&&i.createdBy?i.createdBy:e.uid,userName:f&&i.userName?i.userName:e.name,count:b.length,totalAmount:n,isConfirmed:i.isConfirmed||!1,date:b[0]?.date||new Date().toISOString().slice(0,10),auditLog:i.auditLog||[]},t={action:f?"UPDATE":"CREATE",userId:e.uid,userName:e.name,timestamp:new Date().toISOString()};s.auditLog.push(t),m.set(l,{...s,updatedAt:k.FieldValue.serverTimestamp(),createdAt:f?s.createdAt:k.FieldValue.serverTimestamp()},{merge:!0}),await m.commit(),await (0,r.UI)({userId:e.uid,title:"تم تسجيل دفعة تسديدات",body:`تم تسجيل ${b.length} تسديدات جديدة للبورصة بفاتورة ${p}`,type:"voucher",link:`/exchanges/report?exchangeId=${a}`}),await H(a,e),(0,h.revalidatePath)("/exchanges/report");let u={id:l.id,...s,description:"",entryType:"payment",details:o};return{success:!0,batch:u}}let I=(0,i.cache)(async(a,b,c)=>{if(!a)return[];let d=await (0,g.Lf)();if(!d)return[];let e=d.collection("exchange_transaction_batches").where("exchangeId","==",a),f=d.collection("exchange_payment_batches").where("exchangeId","==",a),[h,i]=await Promise.all([e.get(),f.get()]),j=[];for(let a of h.docs){let b=F(a),c=(await d.collection("transactions").where("batchId","==",a.id).get()).docs.map(F);j.push({...b,entryType:"transaction",details:c})}for(let a of i.docs){let b=F(a),c=(await d.collection("payments").where("batchId","==",a.id).get()).docs.map(F);j.push({...b,entryType:"payment",details:c})}j.sort((a,b)=>new Date(a.createdAt||a.date).getTime()-new Date(b.createdAt||b.date).getTime());let k=0,l=j.map(a=>{let b=a.totalAmount||0;k+=b;let c="";if("transaction"===a.entryType){let b=[...new Set(a.details.map(a=>a.partyName))],d=Object.entries(a.details.reduce((a,b)=>(a[b.originalCurrency]||(a[b.originalCurrency]=0),a[b.originalCurrency]+=b.originalAmount,a),{})).map(([a,b])=>`إجمالي ${a}: ${b.toLocaleString()}`).join(" | ");c=`معاملات مع: ${b.join(", ")} | ${d}`}else"payment"===a.entryType&&(c=a.details.map(a=>{let b=`${"payment"===a.type?"دفع إلى":"قبض من"} ${a.paidTo}`;return a.intermediary&&(b+=` بواسطة ${a.intermediary}`),b+=`: ${a.originalAmount.toLocaleString()} ${a.originalCurrency}`,a.note&&(b+=` (${a.note})`),b}).join(" | "));return{...a,balance:k,description:c}}).reverse();if(b&&c){let a={start:(0,m.o)(b),end:(0,n.D)(c)};return l.filter(b=>(0,o.v)((0,p.H)(b.date),a))}return l});async function B(a,b,c){let d=await (0,g.Lf)();if(!d)return{success:!1,error:"Database not available"};let e=await (0,j.$T)();if(!e)return{success:!1,error:"User not authenticated"};let f=d.collection("transaction"===b?"exchange_transaction_batches":"exchange_payment_batches").doc(a);try{let a={action:`UPDATE_${Object.keys(c).join("_").toUpperCase()}`,userId:e.uid,userName:e.name,timestamp:new Date().toISOString(),changes:c},b={...c,updatedAt:k.FieldValue.serverTimestamp(),auditLog:k.FieldValue.arrayUnion(a)};return await f.update(b),(0,h.revalidatePath)("/exchanges/report"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function C(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};try{let c=b.collection("exchange_transaction_batches").doc(a);if(!(await c.get()).exists)throw Error("Batch not found.");let d=b.batch();return(await b.collection("transactions").where("batchId","==",a).get()).forEach(a=>d.delete(a.ref)),d.delete(c),await d.commit(),(0,h.revalidatePath)("/exchanges/report"),{success:!0,deletedId:a}}catch(a){return console.error("Error deleting transaction batch:",a),{success:!1,error:a.message}}}async function D(a){let b=await (0,g.Lf)();if(!b)return{success:!1,error:"Database not available."};try{let c=b.collection("exchange_payment_batches").doc(a);if(!(await c.get()).exists)throw Error("Batch not found.");let d=b.batch();return(await b.collection("payments").where("batchId","==",a).get()).forEach(a=>d.delete(a.ref)),d.delete(c),await d.commit(),(0,h.revalidatePath)("/exchanges/report"),{success:!0,deletedId:a}}catch(a){return console.error("Error deleting payment batch:",a),{success:!1,error:a.message}}}let J=(0,i.cache)(async()=>{if(!await (0,g.Lf)())return[];let a=await G();if(!a.accounts)return[];let b=a.accounts.map(async a=>{let b=await I(a.id),c=b.slice(0,3),d=b.length>0&&b[0]?.balance||0;return{...a,balance:d,lastTransactions:c}});return Promise.all(b)});(0,s.D)([u,G,v,w,x,y,z,A,I,B,C,D,J]),(0,e.A)(u,"7efe1f798361b3ef301fd7b48f8f3206292a2cecba",null),(0,e.A)(G,"7fff34be9ad53d22bcedbe289fd19cffbcbb61a920",null),(0,e.A)(v,"403c01bdb267219d16430eb023611daabec8b63ec8",null),(0,e.A)(w,"6011fc1c38056bdf4ffec77b46cde7479e7bed0ffe",null),(0,e.A)(x,"70303f32e5ed8b56558bdc328a329d038fd2e61ace",null),(0,e.A)(y,"704baf0749912d6e636a66524e43f80ce5c8454d38",null),(0,e.A)(z,"7036a92c4c51de937e481f7c0d6bc541b735f99157",null),(0,e.A)(A,"7003bafa516cae88838b2870c227bb8f7b1ef595ec",null),(0,e.A)(I,"7f56b7b077f6ef503c674aaefafd2b7951d91adaa8",null),(0,e.A)(B,"70a2ee919f2d86ac514a326d140a0804c759a4d955",null),(0,e.A)(C,"407ad343a0d07dddd296d749ab0d60ad67dfc5bb39",null),(0,e.A)(D,"405ce651eeff5dd6c93f3965b62049b45a42e5a7d4",null),(0,e.A)(J,"7fbd1d6bc63ebe1b1eeb689b35afc9c8cba834559f",null),d()}catch(a){d(a)}})}};