"use strict";exports.id=8568,exports.ids=[8568],exports.modules={39043:(a,b,c)=>{c.d(b,{S:()=>i});var d=c(21124),e=c(38301),f=c(89339),g=c(8015),h=c(44943);let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)(f.bL,{ref:c,className:(0,h.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",a),...b,children:(0,d.jsx)(f.C1,{className:(0,h.cn)("flex items-center justify-center text-current"),children:(0,d.jsx)(g.A,{className:"h-4 w-4"})})}));i.displayName=f.bL.displayName},55880:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{An:()=>v,C9:()=>t,IZ:()=>r,eZ:()=>s,xI:()=>q,zz:()=>u});var e=c(91488);c(27806);var f=c(80446),g=c(71734),h=c(46204),i=c(27340),j=c(63097),k=c(91837),l=c(7879),m=c(40410),n=a([f,l]);[f,l]=n.then?(await n)():n;let v=(0,h.cache)(async()=>{let a=await (0,f.Lf)();return a?(await a.collection("flight_reports").orderBy("flightDate","desc").get()).docs.map(a=>({id:a.id,...a.data()})):[]});async function o(a){let b=new Map;a.forEach(a=>{(a.pnrGroups||[]).forEach(c=>{let d=c.bookingReference;d&&(b.has(d)||b.set(d,[]),b.get(d).push({reportId:a.id,route:a.route,date:a.flightDate,pnr:c.pnr,fileName:a.fileName,time:a.flightTime,paxCount:c.paxCount}))})});let c=new Map;for(let[a,d]of b.entries())if(d.length>1){let b=new Set(d.map(a=>`${a.route}|${a.date}`));if(b.size>1){let e=Array.from(b).join(" و "),f={id:`pnr-${a}`,type:"DUPLICATE_PNR",pnr:a,description:`تم العثور على مرجع الحجز في رحلات مختلفة: ${e}`,details:d.map(b=>({...b,bookingReference:a})),link:"#"};d.forEach(a=>{c.has(a.reportId)||c.set(a.reportId,[]),c.get(a.reportId).some(a=>a.id===f.id)||c.get(a.reportId).push(f)})}}return c}async function p(a){let b=new Map;a.forEach(a=>{let c=`${a.flightDate}|${a.flightTime}|${a.route}|${a.paxCount}|${(a.totalRevenue||0).toFixed(2)}`;b.has(c)||b.set(c,[]),b.get(c).push({reportId:a.id,fileName:a.fileName,flightDate:a.flightDate,flightTime:a.flightTime,route:a.route})});let c=new Map;for(let[a,d]of b.entries())if(d.length>1){d.sort((a,b)=>a.reportId.localeCompare(b.reportId));let b=d[0].reportId,e=d.map(a=>a.fileName).join(", "),f={id:`file-${a}`,type:"DUPLICATE_FILE",description:`تم العثور على هذا الملف مكررًا في: ${e}`,details:d,link:"#"};d.forEach(a=>{c.has(a.reportId)||c.set(a.reportId,[]);let d={...f,details:{...f.details,originalReportId:b}};c.get(a.reportId).push(d)})}return c}async function q(){let a=await v();if(0===a.length)return[];let[b,c]=await Promise.all([o(a),p(a)]),d=new Map;for(let b of(a.forEach(a=>{(a.pnrGroups||[]).forEach(b=>{b.passengers.forEach(c=>{let e=`${(0,g.Pc)(b.bookingReference)}|${(0,g.Pc)(c.name)}|${c.passportNumber||""}`;d.has(e)||d.set(e,[]),d.get(e).push({reportId:a.id,date:(0,j.H)(a.flightDate),bookingReference:b.bookingReference})})})}),d.values()))b.sort((a,b)=>a.date.getTime()-b.date.getTime());return[...a.map(a=>{let e,f;return e=b.get(a.id)||[],f=c.get(a.id)||[],(0,i.jM)(a,a=>{a.issues={tripAnalysis:[],duplicatePnr:e,fileAnalysis:f,dataIntegrity:[]},a.totalDiscount=0,a.tripTypeCounts={oneWay:0,roundTrip:0};let b=new Set,c=f.find(a=>"DUPLICATE_FILE"===a.type);if(c&&c.details.originalReportId!==a.id)a.totalDiscount=0,a.manualDiscountValue=0,a.filteredRevenue=0,(a.passengers||[]).forEach(a=>{a.actualPrice=0});else{(a.passengers||[]).forEach(c=>{let e=`${(0,g.Pc)(c.bookingReference)}|${(0,g.Pc)(c.name)}|${c.passportNumber||""}`,f=d.get(e)||[];if(f.length>1){b.has(e)||(a.tripTypeCounts.roundTrip+=1,b.add(e));let d=f.find(b=>b.reportId===a.id);if(d){let b=f.indexOf(d);0===b?(c.tripType="DEPARTURE",c.actualPrice=c.payable):b>0&&(c.tripType="RETURN",c.actualPrice=0,c.departureDate=f[0].date.toISOString(),a.totalDiscount+=c.payable)}a.issues.tripAnalysis.some(a=>a.id===`return-${e}`)||a.issues.tripAnalysis.push({id:`return-${e}`,type:"UNMATCHED_RETURN",pnr:c.bookingReference,description:`رحلة ذهاب وعودة للمسافر: ${c.name}`,details:f})}else b.has(e)||(a.tripTypeCounts.oneWay+=1,b.add(e)),c.tripType="SINGLE",c.actualPrice=c.payable});let c=0;if(a.manualDiscount?.type==="fixed")c=a.manualDiscount.value||0;else if(a.manualDiscount?.type==="per_passenger"){let b=(a.passengers||[]).reduce((a,b)=>(a[b.passengerType||"Adult"]=(a[b.passengerType||"Adult"]||0)+1,a),{});c=(b.Adult||0)*(a.manualDiscount.perAdult||0)+(b.Child||0)*(a.manualDiscount.perChild||0)+(b.Infant||0)*(a.manualDiscount.perInfant||0)}a.manualDiscountValue=c,a.filteredRevenue=(a.totalRevenue||0)-(a.totalDiscount||0)-c}})})].sort((a,b)=>(0,j.H)(b.flightDate).getTime()-(0,j.H)(a.flightDate).getTime())}async function r(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};try{let c=b.collection("flight_reports").doc();return await c.set({...a,id:c.id}),(0,k.revalidatePath)("/reports/flight-analysis"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function s(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};try{return await b.collection("flight_reports").doc(a).delete(),(0,k.revalidatePath)("/reports/flight-analysis"),{success:!0,deletedId:a}}catch(b){return console.error(`فشل حذف التقرير: ${a}`,b),{success:!1,error:`فشل حذف التقرير: ${b.message}`}}}async function t(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};try{let d=c.collection("flight_reports").doc(a);await d.update({isSelectedForReconciliation:b});let e=await d.get(),f={id:e.id,...e.data()};return{success:!0,updatedReport:f}}catch(b){return console.error(`Error updating selection for ${a}:`,b),{success:!1,error:b.message}}}async function u(a,b,c,d){let e=await (0,f.Lf)();if(!e)return{success:!1,error:"Database not available."};try{let f=e.collection("flight_reports").doc(a),g={manualDiscountValue:b};d?g.manualDiscount=d:g.manualDiscount=l.FieldValue.delete(),c?g.manualDiscountNotes=c:g.manualDiscountNotes=l.FieldValue.delete(),await f.update(g);let h=(await q()).find(b=>b.id===a);if(!h)throw Error("Could not find the updated report after analysis.");return{success:!0,updatedReport:h}}catch(b){return console.error(`Error updating manual discount for ${a}:`,b),{success:!1,error:b.message}}}(0,m.D)([v,q,r,s,t,u]),(0,e.A)(v,"7f8dbe1de22b275226279ce2bba96452d3525a87d3",null),(0,e.A)(q,"00f74d83d197fb270f7f799b24d2f55a333dd66df2",null),(0,e.A)(r,"40e3c8292a4f0b84d05a9c4ad934c059de920dc94d",null),(0,e.A)(s,"40f54af95455474c6797db53b51dec407d05484277",null),(0,e.A)(t,"60e1aafb0ecafed63ad832743da622104cdf70c1e0",null),(0,e.A)(u,"78a8754dc047ed50c9c7bb185ed3ad0a79b3755f58",null),d()}catch(a){d(a)}})},71734:(a,b,c)=>{c.d(b,{Pc:()=>d});function d(a){if(!a)return"";let b=String(a).normalize("NFKD");return(b=b.replace(/[\u0300-\u036f]/g,"")).replace(/\s+/g," ").trim().toLowerCase()}},79202:(a,b,c)=>{c.d(b,{A0:()=>h,BF:()=>i,Gg:()=>j,Hj:()=>k,XI:()=>g,nA:()=>m,nd:()=>l});var d=c(21124),e=c(38301),f=c(44943);let g=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("div",{className:"relative w-full overflow-auto",children:(0,d.jsx)("table",{ref:c,className:(0,f.cn)("w-full caption-bottom text-sm",a),...b})}));g.displayName="Table";let h=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("thead",{ref:c,className:(0,f.cn)("[&_tr]:border-b",a),...b}));h.displayName="TableHeader";let i=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tbody",{ref:c,className:(0,f.cn)("[&_tr:last-child]:border-0",a),...b}));i.displayName="TableBody";let j=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tfoot",{ref:c,className:(0,f.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",a),...b}));j.displayName="TableFooter";let k=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("tr",{ref:c,className:(0,f.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",a),...b}));k.displayName="TableRow";let l=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("th",{ref:c,className:(0,f.cn)("h-12 px-4 text-right align-middle font-bold text-muted-foreground [&:has([role=checkbox])]:pr-0",a),...b}));l.displayName="TableHead";let m=e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("td",{ref:c,className:(0,f.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",a),...b}));m.displayName="TableCell",e.forwardRef(({className:a,...b},c)=>(0,d.jsx)("caption",{ref:c,className:(0,f.cn)("mt-4 text-sm text-muted-foreground",a),...b})).displayName="TableCaption"},95378:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{DI:()=>m,EP:()=>q,EZ:()=>o,KB:()=>t,Lf:()=>n,d5:()=>p,zO:()=>r,zZ:()=>s});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(62641),i=c(58749),j=c(29631),k=c(40410),l=a([f,h,i,j]);async function m(a){let{clients:b}=await n({...a,all:!0});return b.map(a=>({value:a.id,label:`${a.name} ${a.code?`(${a.code})`:""}`,relationType:a.relationType,paymentType:a.paymentType}))}async function n(a={}){let{all:b=!1,limit:c=15,page:d=1,searchTerm:e,relationType:g,paymentType:h,status:i,country:j,province:k,sortBy:l="useCount_desc"}=a,m=await (0,f.Lf)();if(!m)return{clients:[],total:0};try{let f,n=m.collection("clients");g&&"all"!==g&&(n=n.where("relationType","in","client"===g?["client","both"]:"supplier"===g?["supplier","both"]:[g])),h&&"all"!==h&&(n=n.where("paymentType","==",h)),i&&"all"!==i&&(n=n.where("status","==",i)),!0===a.includeInactive||i||(n=n.where("status","==","active")),j&&"all"!==j&&(n=n.where("country","==",j)),k&&"all"!==k&&(n=n.where("province","==",k));let o=(await n.get()).docs;if(e){let a=e.toLowerCase();o=o.filter(b=>{let c=b.data();return c.name&&c.name.toLowerCase().includes(a)||c.phone&&String(c.phone).includes(a)||c.code&&c.code.toLowerCase().includes(a)})}let p=o.length;if(l){let[a,b]=l.split("_");o.sort((c,d)=>{let e=c.data(),f=d.data(),g=e[a],h=f[a];if(null==g)return 1;if(null==h)return -1;let i=0;return"string"==typeof g&&"string"==typeof h?i=g.localeCompare(h):g>h?i=1:g<h&&(i=-1),"desc"===b?-1*i:i})}if(b)f=o;else{let a=(d-1)*c;f=o.slice(a,a+c)}if(0===f.length)return{clients:[],total:0};return{clients:f.map(a=>{let b=a.data();return{...JSON.parse(JSON.stringify(b,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),id:a.id}}),total:p}}catch(a){return console.error("Error getting clients from Firestore: ",String(a)),{clients:[],total:0}}}async function o(a){let b=await (0,f.Lf)();if(!b)return null;try{let c=await b.collection("clients").doc(a).get();if(!c.exists)return null;let d=c.data(),e=JSON.parse(JSON.stringify(d,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b));return{id:c.id,...e}}catch(b){return console.error(`Error getting client by ID ${a}:`,String(b)),null}}async function p(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=c.name,e=await (0,j.tu)("CL"),f={...a,code:e,createdAt:new Date().toISOString(),createdBy:d,balance:{USD:0,IQD:0},lastTransaction:null,useCount:0};f.password&&f.password.length>=6||delete f.password;let h=await b.collection("clients").add(f);await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:`أنشأ علاقة جديدة باسم: ${f.name} (ID: ${h.id})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts");let k={...f,id:h.id};return{success:!0,client:k}}catch(a){return console.error("Error adding client:",a),{success:!1,error:a.message}}}async function q(a){let b=await (0,f.Lf)();if(!b)return{success:!1,count:0,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,count:0,error:"Unauthorized"};try{for(let d of a){let a=b.batch(),e=b.collection("clients").doc(),f=await (0,j.tu)("CL"),g={...d,code:f,createdAt:new Date().toISOString(),createdBy:`مستورد بواسطة ${c.name}`,type:d.type||"individual",relationType:d.relationType||"client",status:d.status||"active",balance:{USD:0,IQD:0},lastTransaction:null,useCount:0,avatarUrl:""};g.password||delete g.password,a.set(e,g),await a.commit()}return await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:`استورد ${a.length} علاقات جديدة من ملف.`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/relations/settings"),(0,g.revalidatePath)("/reports/debts"),{success:!0,count:a.length}}catch(a){return console.error("Error adding multiple clients: ",String(a)),{success:!1,count:0,error:"Failed to add clients."}}}async function r(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,h.$T)();if(!d)return{success:!1,error:"Unauthorized"};try{let e=JSON.parse(JSON.stringify(b));(""===b.password||void 0===b.password||null===b.password)&&delete e.password,await c.collection("clients").doc(a).update(e),await (0,i.iL)({userId:d.uid,userName:d.name,action:"UPDATE",targetType:"CLIENT",description:`عدل بيانات العلاقة (ID: ${a})`});let f=await c.collection("clients").doc(a).get(),h=JSON.parse(JSON.stringify(f.data(),(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),j={id:f.id,...h};return(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0,updatedClient:j}}catch(a){return console.error("Error updating client:",a),{success:!1,error:a.message}}}async function s(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=(await b.collection("clients").doc(a).get()).data();if(d?.useCount&&d.useCount>0)return{success:!1,error:"لا يمكن حذف هذه العلاقة لوجود معاملات مالية مرتبطة بها."};let e=d?.name||"unknown";return await b.collection("clients").doc(a).delete(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:`حذف العلاقة: ${e} (ID: ${a})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function t(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=b.batch();return a.forEach(a=>{let c=b.collection("clients").doc(a);d.delete(c)}),await d.commit(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:`حذف ${a.length} علاقات بشكل جماعي.`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}[f,h,i,j]=l.then?(await l)():l,(0,k.D)([m,n,o,p,q,r,s,t]),(0,e.A)(m,"405872236907704344162aca1c38160d1eac727fe8",null),(0,e.A)(n,"400e621b7f78c4800cffc85d668ca10cd73eb6853c",null),(0,e.A)(o,"408c94c431661ae65070856bc4a78d84f2cbfcba1c",null),(0,e.A)(p,"403331dfc341d9a7f9cbe156b5d10cfd49a20be531",null),(0,e.A)(q,"408c54ad33973364b68d8475849f76b4a4ca590722",null),(0,e.A)(r,"6023146a7bfefc423ba02712c56694a31432de707c",null),(0,e.A)(s,"4085652545b10cc37283ef55992935bd43a8ce947e",null),(0,e.A)(t,"40f4619201eea9704cbf15357e730e9458fc66e834",null),d()}catch(a){d(a)}})}};