"use strict";exports.id=2762,exports.ids=[2762],exports.modules={6375:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]])},10087:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Bx:()=>l,N2:()=>u,T2:()=>p,Uo:()=>q,dJ:()=>v,eA:()=>r,li:()=>s,sN:()=>t,vq:()=>n,xu:()=>m,yF:()=>o});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(2992),i=c(62641),j=c(40410),k=a([f,h,i]);[f,h,i]=k.then?(await k)():k;let v=(0,g.unstable_cache)(async(a={})=>{let{page:b=1,limit:c=10,all:d=!1,includeDeleted:e=!1}=a,g=await (0,f.Lf)();if(!g)return console.error("Database not available"),{bookings:[],total:0};try{let a=g.collection("bookings");e||(a=a.where("isDeleted","==",!1));let f=(await a.get()).size,h=a.orderBy("enteredAt","desc");return d||(h=h.limit(c).offset((b-1)*c)),{bookings:(await h.get()).docs.map(a=>({id:a.id,...a.data()})),total:f}}catch(a){throw console.error("Error getting bookings: ",String(a)),Error(`Firestore query failed. A composite index is likely required. Original error: ${String(a)}`)}},["get-bookings"]);async function l(a){let b=await (0,i.$T)();if(!b)throw Error("User not authenticated.");let c=a.passengers.reduce((a,b)=>a+(Number(b.salePrice)||0),0),d=a.passengers.reduce((a,b)=>a+(Number(b.purchasePrice)||0),0),e=(await (0,f.Lf)()).collection("bookings").doc();return await e.set({...a,id:e.id,enteredBy:b.name,enteredAt:new Date().toISOString()}),await (0,h.T)({sourceType:"tickets",sourceId:e.id,date:a.issueDate,currency:a.currency,amount:c-d,clientId:a.clientId}),d>0&&await (0,h.C)({costKey:"cost_tickets",sourceType:"tickets",sourceId:e.id,date:a.issueDate,currency:a.currency,amount:d,supplierId:a.supplierId}),{success:!0,newBooking:{id:e.id,...a}}}async function m(a){return[]}async function n(a,b){return{success:!1,error:"Not implemented"}}async function o(a,b,c){return{success:!1,error:"Not implemented"}}async function p(a,b,c){return{success:!1,error:"Not implemented"}}async function q(a,b,c){return{success:!1,error:"Not implemented"}}async function r(a){return{success:!1,count:0,error:"Not implemented"}}async function s(a){return{success:!1,error:"Not implemented"}}async function t(a){return{success:!1,error:"Not implemented"}}async function u(a){return{success:!1,error:"Not implemented"}}(0,j.D)([v,l,m,n,o,p,q,r,s,t,u]),(0,e.A)(v,"7ffb585af41918dddb19e9e747514fc75eda9f07ca",null),(0,e.A)(l,"40ca4bf9958b6d1d26e411af5f72ad73b881d7ffc2",null),(0,e.A)(m,"40d0a9025cfae5e19ff9bfb1d8c43204722c4febb5",null),(0,e.A)(n,"60186e37473393f3008b2a76484829f65c2825bc22",null),(0,e.A)(o,"70cfe727250a23b23d98bdaa484b32a157baabef97",null),(0,e.A)(p,"7057bd85393d69e4688037e9bf4c49ca196efecf46",null),(0,e.A)(q,"70278708d5cbbc8d6310dcac5ed55f18c8eab7bbdd",null),(0,e.A)(r,"40894ff0ee9a14922c13beed18ea3d0c678338253d",null),(0,e.A)(s,"40dc0f099e7b5a731a230c5f6ba0d64c59c23245aa",null),(0,e.A)(t,"40cf063cd0996b5720c994376cff75a5921b27cb15",null),(0,e.A)(u,"40c0dccd0c2a8e67f36983065fa5432d130bc97c65",null),d()}catch(a){d(a)}})},13826:(a,b,c)=>{c.d(b,{A:()=>aa});var d=c(21124),e=c(38301),f=c(42378),g=c(85708);g.callServer,g.findSourceMapURL,g.callServer,g.findSourceMapURL,c(58496),c(48129),c(38516),g.callServer,g.findSourceMapURL,c(60977);var h=c(91842),i=c(72717),j=c(31407),k=c(35284),l=c(40068),m=c(37448),n=c(27894),o=c(98341),p=c(40822),q=c(10656),r=c(49113),s=c(99546),t=c(31980),u=c(50937),v=c(27186),w=c(93758),x=c(77837),y=c(27410),z=c(44943),A=c(25054),B=c(63822),C=c(79202),D=c(67094),E=c(11563),F=c(78965),G=c(70066),H=c(21853);let I=s.Ik({fromDate:s.p6({required_error:"تاريخ البدء مطلوب."}),toDate:s.p6({required_error:"تاريخ الانتهاء مطلوب."})}),J=s.Ik({clientId:s.Yj().min(1,{message:"اسم الشركة مطلوب."}),partnerId:s.Yj().min(1,{message:"اسم الشريك مطلوب."}),tickets:s.au.number().int().nonnegative().default(0),visas:s.au.number().int().nonnegative().default(0),hotels:s.au.number().int().nonnegative().default(0),groups:s.au.number().int().nonnegative().default(0)}),K=({entryData:a,allCompanyOptions:b,partnerOptions:c,onSave:e,onCancel:f})=>{let g=(0,t.mN)({resolver:(0,u.u)(J),defaultValues:{clientId:a.clientId||"",partnerId:c.find(b=>b.value===a.partnerId)?.value||"",tickets:a.tickets||0,visas:a.visas||0,hotels:a.hotels||0,groups:a.groups||0}});return(0,d.jsx)(v.lV,{...g,children:(0,d.jsxs)("form",{onSubmit:g.handleSubmit(e),className:"p-4 bg-muted/50 rounded-lg space-y-4",children:[(0,d.jsxs)("h4",{className:"font-semibold text-base mb-2",children:["تعديل بيانات: ",a.companyName]}),(0,d.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,d.jsx)(v.zB,{control:g.control,name:"clientId",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الشركة المصدرة للسكمنت"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(H.j,{options:b,value:a.value,onValueChange:a.onChange,placeholder:"ابحث عن شركة..."})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:g.control,name:"partnerId",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الشريك"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(H.j,{options:c,value:a.value,onValueChange:a.onChange,placeholder:"ابحث عن شريك..."})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:g.control,name:"tickets",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"التذاكر"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:g.control,name:"visas",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الفيزا"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:g.control,name:"hotels",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الفنادق"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:g.control,name:"groups",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الكروبات"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})})]}),(0,d.jsxs)("div",{className:"flex justify-end items-center gap-2",children:[(0,d.jsx)(k.$,{type:"button",variant:"ghost",onClick:f,children:"إلغاء"}),(0,d.jsxs)(k.$,{type:"submit",children:[(0,d.jsx)(n.A,{className:"me-2 h-4 w-4"})," تحديث البيانات"]})]})]})})};function L({existingPeriod:a,clients:b,suppliers:c,onSuccess:f}){let[g,h]=(0,e.useState)(!1),{toast:i}=(0,m.dj)(),[j,s]=(0,e.useState)(!1),[L,M]=(0,e.useState)([]),[N,O]=(0,e.useState)(null),P=(0,e.useMemo)(()=>b.filter(a=>"company"===a.type).map(a=>({value:a.id,label:a.name})),[b]),Q=(0,e.useMemo)(()=>Array.from(new Map([...b,...c].map(a=>[a.id,a])).values()).map(a=>{let b="";return"client"===a.relationType?b="عميل: ":"supplier"===a.relationType?b="مورد: ":"both"===a.relationType&&(b="عميل ومورد: "),{value:a.id,label:`${b}${a.name}`}}),[b,c]),[R,S]=(0,e.useState)(!1),[T,U]=(0,e.useState)(!1),V=(0,t.mN)({resolver:(0,u.u)(I),defaultValues:{fromDate:(0,A.H)(a.fromDate),toDate:(0,A.H)(a.toDate)}}),W=(0,t.mN)({resolver:(0,u.u)(J)}),X=(a,c)=>{let d=c||{ticketProfitPercentage:50,visaProfitPercentage:100,hotelProfitPercentage:100,groupProfitPercentage:100,alrawdatainSharePercentage:50},e=a.tickets*(d.ticketProfitPercentage/100),f=a.visas*(d.visaProfitPercentage/100),g=f+a.hotels*(d.hotelProfitPercentage/100)+a.groups*(d.groupProfitPercentage/100),h=e+g,i=(c?.alrawdatainSharePercentage||50)/100*h,j=b.find(b=>b.id===a.clientId),k=Q.find(b=>b.value===a.partnerId);return{...a,ticketProfits:e,otherProfits:g,total:h,alrawdatainShare:i,partnerShare:h-i,companyName:j?.name||"",partnerId:k?.value.split("-")[1]||"",partnerName:k?.label||""}},Y=async()=>{let b=await V.trigger()?V.getValues():null;if(!b)return void i({title:"الرجاء تحديد فترة محاسبية صحيحة",variant:"destructive"});if(0===L.length){await (0,F.O)(a.fromDate,a.toDate),i({title:"تم حذف الفترة",description:"تم حذف الفترة المحاسبية لعدم وجود سجلات."}),h(!1),await f();return}s(!0);try{await (0,F.O)(a.fromDate,a.toDate);let c=L.map(a=>{let{id:c,...d}=a;return{...d,fromDate:(0,B.GP)(b.fromDate,"yyyy-MM-dd"),toDate:(0,B.GP)(b.toDate,"yyyy-MM-dd")}});await (0,G.v)(c),i({title:"تم حفظ بيانات الفترة بنجاح"}),h(!1),await f()}catch(a){i({title:"خطأ",description:a.message||"لم يتم حفظ البيانات.",variant:"destructive"})}finally{s(!1)}};return(0,d.jsxs)(l.lG,{open:g,onOpenChange:h,children:[(0,d.jsx)(l.zM,{asChild:!0,children:(0,d.jsxs)(E._2,{onSelect:a=>a.preventDefault(),children:[(0,d.jsx)(n.A,{className:"me-2 h-4 w-4"}),"تعديل الفترة"]})}),(0,d.jsxs)(l.Cf,{className:"sm:max-w-4xl max-h-[90vh] flex flex-col",children:[(0,d.jsxs)(l.c7,{children:[(0,d.jsx)(l.L3,{children:"تعديل سجل سكمنت"}),(0,d.jsx)(l.rr,{children:"عدّل بيانات الفترة، ثم أضف أو عدّل الشركات، ثم احفظ الفترة كاملة."})]}),(0,d.jsxs)("div",{className:"flex-grow overflow-auto pr-6 -mr-6 space-y-4",children:[(0,d.jsxs)("div",{className:"p-4 border rounded-lg bg-background/50 sticky top-0 z-10",children:[(0,d.jsx)("h3",{className:"font-semibold text-base mb-2",children:"الخطوة 1: تعديل الفترة المحاسبية"}),(0,d.jsx)(v.lV,{...V,children:(0,d.jsxs)("form",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-start",children:[(0,d.jsx)(v.zB,{control:V.control,name:"fromDate",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"من تاريخ"}),(0,d.jsxs)(x.AM,{open:R,onOpenChange:S,children:[(0,d.jsx)(x.Wv,{asChild:!0,children:(0,d.jsx)(v.MJ,{children:(0,d.jsxs)(k.$,{variant:"outline",className:(0,z.cn)("w-full justify-start text-left font-normal",!a.value&&"text-muted-foreground"),children:[a.value?(0,B.GP)(a.value,"yyyy-MM-dd"):(0,d.jsx)("span",{children:"اختر تاريخاً"}),(0,d.jsx)(o.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,d.jsx)(x.hl,{className:"w-auto p-0",align:"start",children:(0,d.jsx)(y.V,{mode:"single",selected:a.value,onSelect:b=>{b&&a.onChange(b),S(!1)},initialFocus:!0})})]}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:V.control,name:"toDate",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"إلى تاريخ"}),(0,d.jsxs)(x.AM,{open:T,onOpenChange:U,children:[(0,d.jsx)(x.Wv,{asChild:!0,children:(0,d.jsx)(v.MJ,{children:(0,d.jsxs)(k.$,{variant:"outline",className:(0,z.cn)("w-full justify-start text-left font-normal",!a.value&&"text-muted-foreground"),children:[a.value?(0,B.GP)(a.value,"yyyy-MM-dd"):(0,d.jsx)("span",{children:"اختر تاريخاً"}),(0,d.jsx)(o.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,d.jsx)(x.hl,{className:"w-auto p-0",align:"start",children:(0,d.jsx)(y.V,{mode:"single",selected:a.value,onSelect:b=>{b&&a.onChange(b),U(!1)},initialFocus:!0})})]}),(0,d.jsx)(v.C5,{})]})})]})})]}),(0,d.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,d.jsxs)("h3",{className:"font-semibold text-base mb-2",children:["الخطوة 2: الشركات المضافة لهذه الفترة (",L.length,")"]}),(0,d.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,d.jsxs)(C.XI,{children:[(0,d.jsx)(C.A0,{children:(0,d.jsxs)(C.Hj,{children:[(0,d.jsx)(C.nd,{children:"الشركة"}),(0,d.jsx)(C.nd,{children:"إجمالي الربح"}),(0,d.jsx)(C.nd,{children:"حصة الروضتين"}),(0,d.jsx)(C.nd,{children:"حصة الشريك"}),(0,d.jsx)(C.nd,{className:"w-[100px] text-center",children:"الإجراءات"})]})}),(0,d.jsx)(C.BF,{children:0===L.length?(0,d.jsx)(C.Hj,{children:(0,d.jsx)(C.nA,{colSpan:5,className:"text-center h-24",children:"لا توجد سجلات. سيتم حذف الفترة عند الحفظ."})}):L.map((a,b)=>(0,d.jsx)(D.Nt,{asChild:!0,open:N===b,onOpenChange:()=>O(a=>a===b?null:b),children:(0,d.jsxs)("tbody",{className:"border-t",children:[(0,d.jsxs)(C.Hj,{className:"cursor-pointer",onClick:()=>O(a=>a===b?null:b),children:[(0,d.jsx)(C.nA,{className:"font-semibold",children:a.companyName}),(0,d.jsx)(C.nA,{className:"font-mono",children:a.total.toFixed(2)}),(0,d.jsx)(C.nA,{className:"font-mono text-green-600",children:a.alrawdatainShare.toFixed(2)}),(0,d.jsx)(C.nA,{className:"font-mono text-blue-600",children:a.partnerShare.toFixed(2)}),(0,d.jsxs)(C.nA,{className:"text-center space-x-1",children:[(0,d.jsx)(k.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",children:(0,d.jsx)(n.A,{className:"h-4 w-4"})}),(0,d.jsx)(k.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:a=>{a.stopPropagation(),M(a=>a.filter((a,c)=>c!==b))},children:(0,d.jsx)(p.A,{className:"h-4 w-4"})})]})]}),(0,d.jsx)(D.Ke,{asChild:!0,children:(0,d.jsx)(C.Hj,{children:(0,d.jsx)(C.nA,{colSpan:5,className:"p-0",children:(0,d.jsx)(K,{entryData:a,allCompanyOptions:P,partnerOptions:Q,onSave:a=>((a,b)=>{let c=X(b),d=[...L];d[a]={...d[a],...c},M(d),i({title:"تم تحديث الشركة",description:`تم تحديث بيانات ${c.companyName}.`}),O(null)})(b,a),onCancel:()=>O(null)})})})})]})},a.id||b))})]})})]}),(0,d.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,d.jsx)("h3",{className:"font-semibold text-base mb-2",children:"الخطوة 3: إضافة شركة جديدة"}),(0,d.jsx)(v.lV,{...W,children:(0,d.jsxs)("form",{onSubmit:W.handleSubmit(a=>{let c=b.find(b=>b.id===a.clientId),d=X(a,c?.segmentSettings);M(a=>[...a,{id:`new-${Date.now()}`,...d}]),i({title:"تمت إضافة الشركة",description:`تمت إضافة ${d.companyName} إلى الفترة الحالية.`}),W.reset({clientId:"",partnerId:"",tickets:0,visas:0,hotels:0,groups:0})}),className:"space-y-4",children:[(0,d.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,d.jsx)(v.zB,{control:W.control,name:"clientId",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الشركة المصدرة للسكمنت"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(H.j,{options:P,value:a.value,onValueChange:a.onChange,placeholder:"ابحث عن شركة..."})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:W.control,name:"partnerId",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الشريك"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(H.j,{options:Q,value:a.value,onValueChange:a.onChange,placeholder:"ابحث عن شريك..."})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:W.control,name:"tickets",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"التذاكر"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:W.control,name:"visas",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الفيزا"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:W.control,name:"hotels",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الفنادق"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})}),(0,d.jsx)(v.zB,{control:W.control,name:"groups",render:({field:a})=>(0,d.jsxs)(v.eI,{children:[(0,d.jsx)(v.lR,{children:"الكروبات"}),(0,d.jsx)(v.MJ,{children:(0,d.jsx)(w.p,{type:"number",...a})}),(0,d.jsx)(v.C5,{})]})})]}),(0,d.jsx)("div",{className:"flex justify-end",children:(0,d.jsxs)(k.$,{type:"submit",children:[(0,d.jsx)(q.A,{className:"me-2 h-4 w-4"})," إضافة للفترة"]})})]})})]})]}),(0,d.jsx)(l.Es,{className:"sticky bottom-0 bg-background pt-4 border-t",children:(0,d.jsxs)(k.$,{type:"button",onClick:Y,disabled:j,className:"w-full sm:w-auto",children:[j&&(0,d.jsx)(r.A,{className:"me-2 h-4 w-4 animate-spin"}),"حفظ التعديلات (",L.length," سجلات)"]})})]})]})}var M=c(75818),N=c(51273),O=c(45608),P=c(57105),Q=c(94340),R=c(27810),S=c(68573),T=c(65451),U=c(62186),V=c(72001),W=c(12439);let X=({title:a,value:b})=>(0,d.jsxs)("div",{className:"bg-muted/50 border p-4 rounded-lg text-center",children:[(0,d.jsx)("p",{className:"text-sm text-muted-foreground font-bold",children:a}),(0,d.jsx)("p",{className:"text-2xl font-bold",children:b})]}),Y=({period:a,partners:b,onDataChange:c,index:f})=>{let[g,h]=(0,e.useState)([]),[i,j]=(0,e.useState)(!1),[l,n]=(0,e.useState)(!1),{toast:o}=(0,m.dj)(),q=(0,e.useCallback)(async()=>{if(l){j(!0);try{let c=await (0,M.k)(a.id),d=(0,V.jM)(c,a=>{a.forEach(a=>{if(!a.partnerName){let c=b.find(b=>b.id===a.partnerId);c&&(a.partnerName=c.name)}})});h(d)}catch(a){console.error("Failed to fetch or enrich shares",a),o({title:"خطأ",description:"فشل تحميل تفاصيل الحصص.",variant:"destructive"})}finally{j(!1)}}},[l,a.id,b,o]),s=async()=>{if(a.fromSystem)return;let b=await (0,N.D)(a.id);b.success?(o({title:"تم حذف الفترة اليدوية بنجاح"}),c()):o({title:"خطأ",description:b.error,variant:"destructive"})};(0,e.useEffect)(()=>{l&&q()},[l,q]);let t=a.notes||(a.fromSystem?`أرباح شهر ${a.id}`:`فترة يدوية`),u=a.fromSystem?(0,B.GP)((0,A.H)(`${a.id}-01`),"yyyy-MM-dd"):a.fromDate,v=a.fromSystem?"-":a.toDate,w=b.find(b=>b.id===a.sourceAccountId)?.name||a.sourceAccountId||"غير محدد";return(0,d.jsx)(D.Nt,{asChild:!0,open:l,onOpenChange:n,children:(0,d.jsxs)("tbody",{className:"border-t",children:[(0,d.jsxs)(C.Hj,{className:"cursor-pointer",onClick:()=>n(!l),children:[(0,d.jsx)(C.nA,{className:"p-1 text-center",children:(0,d.jsx)(D.R6,{asChild:!0,children:(0,d.jsx)(k.$,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,d.jsx)(P.A,{className:(0,z.cn)("h-4 w-4 transition-transform",l&&"rotate-180")})})})}),(0,d.jsx)(C.nA,{className:"font-mono text-xs text-center p-2",children:a.invoiceNumber||"N/A"}),(0,d.jsx)(C.nA,{className:"p-2",children:t.split(" | ")[0]}),(0,d.jsx)(C.nA,{className:"font-mono text-xs text-center p-2",children:u}),(0,d.jsx)(C.nA,{className:"font-mono text-xs text-center p-2",children:v}),(0,d.jsx)(C.nA,{className:"font-semibold text-center p-2",children:w}),(0,d.jsx)(C.nA,{className:"font-mono text-xs text-center p-2",children:a.createdAt?(0,B.GP)((0,A.H)(a.createdAt),"yyyy-MM-dd hh:mm a"):"-"}),(0,d.jsx)(C.nA,{className:"p-2 text-center",children:a.userName||"غير معروف"}),(0,d.jsxs)(C.nA,{className:"text-right font-mono font-bold p-2",children:[a.totalProfit.toLocaleString()," ",a.currency||"USD"]}),(0,d.jsx)(C.nA,{className:"p-1 text-center",children:!a.fromSystem&&(0,d.jsxs)(E.rI,{children:[(0,d.jsx)(E.ty,{asChild:!0,children:(0,d.jsx)(k.$,{variant:"ghost",size:"icon",onClick:a=>a.stopPropagation(),children:(0,d.jsx)(Q.A,{className:"h-4 w-4"})})}),(0,d.jsxs)(E.SQ,{children:[(0,d.jsx)(T.A,{period:a,partners:b,onSuccess:c,isEditing:!0,children:(0,d.jsxs)(E._2,{onSelect:a=>a.preventDefault(),children:[(0,d.jsx)(R.A,{className:"me-2 h-4 w-4"})," تعديل الفترة"]})}),(0,d.jsxs)(W.Lt,{children:[(0,d.jsx)(W.tv,{asChild:!0,children:(0,d.jsxs)(E._2,{onSelect:a=>a.preventDefault(),className:"text-destructive focus:text-destructive",children:[(0,d.jsx)(p.A,{className:"me-2 h-4 w-4"})," حذف الفترة"]})}),(0,d.jsxs)(W.EO,{children:[(0,d.jsxs)(W.wd,{children:[(0,d.jsx)(W.r7,{children:"هل أنت متأكد؟"}),(0,d.jsx)(W.$v,{children:"سيتم حذف هذه الفترة اليدوية وكل توزيعاتها."})]}),(0,d.jsxs)(W.ck,{children:[(0,d.jsx)(W.Zr,{children:"إلغاء"}),(0,d.jsx)(W.Rx,{onClick:a=>{a.stopPropagation(),s()},className:(0,z.cn)((0,k.r)({variant:"destructive"})),children:"نعم، احذف"})]})]})]})]})]})})]}),(0,d.jsx)(D.Ke,{asChild:!0,children:(0,d.jsx)(C.Hj,{children:(0,d.jsx)(C.nA,{colSpan:10,className:"p-0",children:(0,d.jsx)("div",{className:"p-2 bg-muted/20",children:i?(0,d.jsx)("div",{className:"flex justify-center p-8",children:(0,d.jsx)(r.A,{className:"animate-spin h-6 w-6"})}):(0,d.jsx)(S.A,{shares:g,partners:b,onDataChange:()=>{q(),c()},totalProfit:a.totalProfit,currency:a.currency||"USD",isManual:!a.fromSystem,monthId:a.id})})})})})]})})};function Z({initialMonthlyProfits:a,partners:b,onDataChange:c}){let[f,g]=(0,e.useState)(a),[h,i]=(0,e.useState)("all"),j=(0,e.useMemo)(()=>"all"===h?f:f.filter(a=>a.fromSystem===("system"===h)),[f,h]),{totalDistributedProfit:l,totalCompanyShare:m,grandTotal:n}=(0,e.useMemo)(()=>{let a=0,b=0;return f.forEach(c=>{a+=c.totalProfit,Array.isArray(c.partners)&&(b+=c.partners.reduce((a,b)=>a+b.amount,0))}),{grandTotal:a,totalDistributedProfit:b,totalCompanyShare:a-b}},[f]);return(0,d.jsxs)("div",{className:"space-y-6",children:[(0,d.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,d.jsx)(X,{title:"\uD83D\uDCB0 إجمالي صافي الأرباح",value:`${n.toLocaleString()} USD`}),(0,d.jsx)(X,{title:"\uD83D\uDCCA إجمالي حصص الشركاء الموزعة",value:`${l.toLocaleString()} USD`}),(0,d.jsx)(X,{title:"\uD83C\uDFE2 إجمالي حصة الشركة",value:`${m.toLocaleString()} USD`})]}),(0,d.jsxs)(U.Zp,{children:[(0,d.jsxs)(U.aR,{className:"flex flex-row justify-between items-center",children:[(0,d.jsxs)("div",{children:[(0,d.jsx)(U.ZB,{children:"الفترات المحاسبية للأرباح"}),(0,d.jsx)(U.BT,{children:"انقر على أي فترة لعرض توزيع حصصها."})]}),(0,d.jsxs)("div",{className:"flex items-center gap-2",children:[(0,d.jsxs)(O.l6,{value:h,onValueChange:a=>i(a),children:[(0,d.jsx)(O.bq,{className:"w-[150px]",children:(0,d.jsx)(O.yv,{})}),(0,d.jsxs)(O.gC,{children:[(0,d.jsx)(O.eb,{value:"all",children:"الكل"}),(0,d.jsx)(O.eb,{value:"system",children:"تلقائي"}),(0,d.jsx)(O.eb,{value:"manual",children:"يدوي"})]})]}),(0,d.jsx)(T.A,{partners:b,onSuccess:c,children:(0,d.jsxs)(k.$,{children:[(0,d.jsx)(q.A,{className:"me-2 h-4 w-4"})," إضافة توزيع يدوي"]})})]})]}),(0,d.jsx)(U.Wu,{children:(0,d.jsx)("div",{className:"border rounded-lg overflow-x-auto",children:(0,d.jsxs)(C.XI,{children:[(0,d.jsx)(C.A0,{children:(0,d.jsxs)(C.Hj,{children:[(0,d.jsx)(C.nd,{className:"w-[50px] p-2"}),(0,d.jsx)(C.nd,{className:"p-2",children:"رقم الفاتورة"}),(0,d.jsx)(C.nd,{className:"p-2",children:"الوصف"}),(0,d.jsx)(C.nd,{className:"p-2",children:"من"}),(0,d.jsx)(C.nd,{className:"p-2",children:"إلى"}),(0,d.jsx)(C.nd,{className:"p-2",children:"مصدر الربح"}),(0,d.jsx)(C.nd,{className:"p-2",children:"تاريخ الإنشاء"}),(0,d.jsx)(C.nd,{className:"p-2",children:"الموظف"}),(0,d.jsx)(C.nd,{className:"text-right p-2",children:"إجمالي الربح"}),(0,d.jsx)(C.nd,{className:"text-center p-2",children:"الإجراءات"})]})}),j.map((a,e)=>(0,d.jsx)(Y,{period:a,partners:b,index:e,onDataChange:c},a.id))]})})})]})]})}var $=c(12495),_=c(40968);function aa({voucher:a,isOpen:b,onClose:c}){(0,f.useRouter)();let[g,k]=(0,e.useState)(null),[l,m]=(0,e.useState)(!1),n=()=>{c()};if(!b||!a||!g||l)return null;switch(a.sourceType){case"booking":return(0,d.jsx)(h.A,{isEditing:!0,booking:g,onBookingUpdated:n,children:(0,d.jsx)("div",{})});case"visa":return(0,d.jsx)(i.A,{booking:g,onBookingUpdated:n});case"subscription":return(0,d.jsx)(j.A,{isEditing:!0,initialData:g,onSubscriptionUpdated:n,children:(0,d.jsx)("div",{})});case"segment":return(0,d.jsx)(L,{existingPeriod:g,clients:[],suppliers:[],onSuccess:n});case"profit-sharing":return(0,d.jsx)(Z,{period:g,partners:[],onSuccess:n});case"remittance":return(0,d.jsx)($.A,{isEditing:!0,initialData:g,onSaveSuccess:n,children:(0,d.jsx)("div",{})});case"exchange_transaction":case"exchange_payment":return(0,d.jsx)(_.A,{batch:g.batch,exchanges:g.exchanges,onSuccess:n,children:(0,d.jsx)("div",{})});default:return null}}},15914:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]])},38516:(a,b,c)=>{c.d(b,{L:()=>e});var d=c(85708);let e=(0,d.createServerReference)("403ab84bcb8381bf290b99f5595e7f53fbfe6fdc2c",d.callServer,void 0,d.findSourceMapURL,"getSegments")},40968:(a,b,c)=>{c.d(b,{A:()=>g});var d=c(21124);c(38301);var e=c(68191),f=c(44839);function g({batch:a,exchanges:b,onSuccess:c,children:g}){return"transaction"===a.entryType?(0,d.jsx)(e.A,{exchangeId:a.exchangeId||"",exchanges:b,onSuccess:c,isEditing:!0,initialData:a,children:g}):"payment"===a.entryType?(0,d.jsx)(f.A,{exchangeId:a.exchangeId||"",exchanges:b,onSuccess:c,isEditing:!0,initialData:a,children:g}):(0,d.jsx)(d.Fragment,{children:g})}},49065:(a,b,c)=>{c.d(b,{Q:()=>e});var d=c(85708);let e=(0,d.createServerReference)("40b3f399476b2e0c0084bb235048022f7151d8d61a",d.callServer,void 0,d.findSourceMapURL,"deleteVoucher")},57553:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Qp:()=>n,UR:()=>t,Uo:()=>p,Ww:()=>q,eA:()=>o});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(62641),i=c(54756),j=c(29631),k=c(58749),l=c(40410),m=a([f,h,i,j,k]);[f,h,i,j,k]=m.then?(await m)():m;let r=a=>{if(!a)return;if("function"==typeof a.toDate)return a.toDate().toISOString();if("string"==typeof a)try{if(!isNaN(Date.parse(a)))return a}catch(a){}let b=new Date(a);if(!isNaN(b.getTime()))return b.toISOString()},s=a=>{let b=a.data();return{...b,id:a.id,createdAt:r(b.createdAt),updatedAt:r(b.updatedAt),auditedAt:r(b.auditedAt),receivedAt:r(b.receivedAt)}},t=async()=>{let a=await (0,i.mt)();if(!a.databaseStatus?.isDatabaseConnected)return console.log("Database connection is disabled in settings. Skipping getRemittances fetch."),[];let b=await (0,f.Lf)();if(!b)return[];try{let a=await b.collection("remittances").orderBy("createdAt","desc").get();if(a.empty)return[];return a.docs.map(s)}catch(a){return console.error("Error getting remittances from Firestore: ",String(a)),[]}};async function n(a){let b=await (0,h.$T)();if(!b)return{success:!1,error:"User not authenticated."};let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};try{let d=c.collection("remittances").doc(),e={...a,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:b.name,status:"pending_audit",isAudited:!1};await d.set(e),await (0,k.iL)({userId:b.uid,userName:b.name,action:"CREATE",targetType:"VOUCHER",description:`أضاف حوالة جديدة من ${a.companyName} بمبلغ ${a.totalAmountUsd>0?`${a.totalAmountUsd} USD`:`${a.totalAmountIqd} IQD`}.`}),(0,g.revalidatePath)("/accounts/remittances");let f={id:d.id,...e};return{success:!0,newRemittance:f}}catch(a){return console.error("Error adding remittance: ",String(a)),{success:!1,error:"Failed to add remittance."}}}async function o(a,b){let c=await (0,h.$T)();if(!c)return{success:!1,error:"User not authenticated."};let d=await (0,f.Lf)();if(!d)return{success:!1,error:"Database not available."};try{let e=d.collection("remittances").doc(a);return await e.update({status:"pending_reception",isAudited:!0,auditedBy:c.name,auditedAt:new Date().toISOString(),updatedAt:new Date().toISOString(),auditNotes:b}),await (0,k.iL)({userId:c.uid,userName:c.name,action:"APPROVE",targetType:"VOUCHER",description:`دقق الحوالة رقم ${a}.`}),(0,g.revalidatePath)("/accounts/remittances"),{success:!0}}catch(a){return console.error("Error auditing remittance: ",String(a)),{success:!1,error:"Failed to audit remittance."}}}async function p(a,b){let c=await (0,h.$T)();if(!c)return{success:!1,error:"User not authenticated."};let d=await (0,f.Lf)();if(!d)return{success:!1,error:"Database not available."};let e=d.batch(),i=d.collection("remittances").doc(a.id);e.update(i,{status:"received",receivedBy:c.name,receivedAt:new Date().toISOString(),updatedAt:new Date().toISOString()});let l=d.collection("journal-vouchers").doc(),m={invoiceNumber:await (0,j.tu)("TR"),date:new Date().toISOString(),currency:a.totalAmountUsd>0?"USD":"IQD",exchangeRate:null,notes:`استلام حوالة من مكتب ${a.officeName}`,createdBy:c.uid,officer:c.name,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),voucherType:"journal_from_remittance",debitEntries:[{accountId:b,amount:a.totalAmountUsd>0?a.totalAmountUsd:a.totalAmountIqd,description:`ايداع حوالة من ${a.companyName}`}],creditEntries:[{accountId:`remittance_source_${a.officeName.toLowerCase()}`,amount:a.totalAmountUsd>0?a.totalAmountUsd:a.totalAmountIqd,description:`من حساب مكتب ${a.officeName}`}],isAudited:!0,isConfirmed:!0,originalData:a};e.set(l,m);try{return await e.commit(),await (0,k.iL)({userId:c.uid,userName:c.name,action:"APPROVE",targetType:"VOUCHER",description:`استلم الحوالة رقم ${a.id} وأنشأ سندًا مرافقًا.`}),(0,g.revalidatePath)("/accounts/remittances"),(0,g.revalidatePath)("/accounts/vouchers/list"),{success:!0}}catch(a){return console.error("Error receiving remittance:",String(a)),{success:!1,error:"Failed to process remittance reception."}}}async function q(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,h.$T)();if(!d)return{success:!1,error:"User not authenticated."};try{return await c.collection("remittances").doc(a).update({...b,updatedAt:new Date().toISOString()}),await (0,k.iL)({userId:d.uid,userName:d.name,action:"UPDATE",targetType:"VOUCHER",description:`عدل بيانات الحوالة رقم ${a}.`}),(0,g.revalidatePath)("/accounts/remittances"),{success:!0}}catch(a){return{success:!1,error:a.message}}}(0,l.D)([t,n,o,p,q]),(0,e.A)(t,"7fe304717562da7e993bf1bc3e43f26d6024716c28",null),(0,e.A)(n,"408c79ddd0d0a9122724301d14534a0975eed69018",null),(0,e.A)(o,"60266b614460f4fd778e8111e66e4c8bff9744db3e",null),(0,e.A)(p,"60c7ace3c7601560697ba8ea1632ea71447c0b65ec",null),(0,e.A)(q,"60c7862a4ca16493782c4d556b1c72f9ee8d90ed17",null),d()}catch(a){d(a)}})},58496:(a,b,c)=>{c.d(b,{I:()=>e});var d=c(85708);let e=(0,d.createServerReference)("7f156258846f24d01f7193780d90bff0896769f3dc",d.callServer,void 0,d.findSourceMapURL,"getSubscriptionById")},72717:(a,b,c)=>{c.d(b,{A:()=>k});var d=c(21124),e=c(38301),f=c(35284),g=c(40068),h=c(27894),i=c(60150),j=c(25054);function k({booking:a,onBookingUpdated:b}){let[c,k]=(0,e.useState)(!1),l={...a,submissionDate:a.submissionDate?(0,j.H)(a.submissionDate):new Date};return(0,d.jsxs)(g.lG,{open:c,onOpenChange:k,children:[(0,d.jsx)(g.zM,{asChild:!0,children:(0,d.jsx)(f.$,{variant:"ghost",size:"icon",className:"text-blue-600 h-8 w-8",children:(0,d.jsx)(h.A,{className:"h-4 w-4"})})}),(0,d.jsxs)(g.Cf,{className:"sm:max-w-4xl p-0",children:[(0,d.jsxs)(g.c7,{className:"bg-primary text-primary-foreground p-4 rounded-t-lg",children:[(0,d.jsxs)(g.L3,{children:["تعديل طلب الفيزا (الفاتورة: ",a.invoiceNumber,")"]}),(0,d.jsx)(g.rr,{className:"text-primary-foreground/80",children:"قم بتحديث تفاصيل الطلب هنا."})]}),(0,d.jsx)("div",{className:"max-h-[80vh] overflow-y-auto p-6",children:(0,d.jsx)(i.A,{isEditing:!0,initialData:l,onBookingUpdated:a=>{b(a),k(!1)}})})]})]})}},84248:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{NG:()=>n,RO:()=>m,hp:()=>l});var e=c(91488);c(27806);var f=c(80446),g=c(95378),h=c(63097),i=c(90521),j=c(40410),k=a([f,g,i]);async function l(a){let b=await (0,f.Lf)();if(!b)throw console.error("Database not available"),Error("Database connection is not available.");let{accountId:c,dateFrom:d,dateTo:e,voucherType:g}=a;try{let a=[],f=await (0,i.lo)(),j=new Map(f.map(a=>[a.uid,a.name]));a=[],(await b.collection("journal-vouchers").orderBy("date","asc").get()).forEach(b=>{let f=b.data();if(f.isDeleted)return;let g=(0,h.H)(f.date);(!d||!(g<d))&&(!e||!(g>e))&&(f.debitEntries?.some(a=>a.accountId===c)||f.creditEntries?.some(a=>a.accountId===c))&&(f.debitEntries?.forEach((d,e)=>{if(d.accountId===c){let c=d.description||f.notes;if("segment"===f.sourceType&&c.startsWith("إيراد سكمنت من")){let a=c.split(" للفترة من ");a.length>1&&(c=`سكمنت للفترة من ${a[1]}`)}a.push({id:`${b.id}_debit_${e}`,date:f.date,invoiceNumber:f.invoiceNumber,description:c,debit:Number(d.amount)||0,credit:0,currency:f.currency||"USD",officer:j.get(f.createdBy)||f.officer||f.createdBy,voucherType:f.voucherType,sourceType:f.originalData?.sourceType||f.voucherType,sourceId:f.originalData?.sourceId||b.id,sourceRoute:f.originalData?.sourceRoute,originalData:f.originalData})}}),f.creditEntries?.forEach((d,e)=>{if(d.accountId===c){let c=d.description||f.notes;if("segment"===f.sourceType&&c.startsWith("إيراد سكمنت من")){let a=c.split(" للفترة من ");a.length>1&&(c=`سكمنت للفترة من ${a[1]}`)}a.push({id:`${b.id}_credit_${e}`,date:f.date,invoiceNumber:f.invoiceNumber,description:c,debit:0,credit:Number(d.amount)||0,currency:f.currency||"USD",officer:j.get(f.createdBy)||f.officer||f.createdBy,voucherType:f.voucherType,sourceType:f.originalData?.sourceType||f.voucherType,sourceId:f.originalData?.sourceId||b.id,sourceRoute:f.originalData?.sourceRoute,originalData:f.originalData})}}))});let k=g&&g.length>0?a.filter(a=>a.voucherType&&g.includes(a.voucherType)||a.sourceType&&g.includes(a.sourceType)):a,l=0,m=0;return k.sort((a,b)=>new Date(a.date).getTime()-new Date(b.date).getTime()).map(a=>("USD"===a.currency?l+=(a.debit||0)-(a.credit||0):"IQD"===a.currency&&(m+=(a.debit||0)-(a.credit||0)),{...a,balanceUSD:l,balanceIQD:m}))}catch(a){if(console.error("❌ Error loading account statement:",a.message),9===a.code||"FAILED_PRECONDITION"===a.code||a.message&&a.message.includes("requires an index")){let b=a.message.match(/(https?:\/\/[^\s)\]]+)/),c=b?b[0]:null,d=`فشل تحميل كشف الحساب: يتطلب الاستعلام فهرسًا مركبًا في Firestore.`;if(c)throw Error(`FIRESTORE_INDEX_URL::${c}`);throw Error(`${d} يرجى مراجعة سجلات الخادم للحصول على الرابط وإنشاء الفهرس المطلوب.`)}throw Error(`فشل تحميل كشف الحساب: ${a.message}`)}}async function m(a){let b=await l({accountId:a});await (0,g.Lf)({all:!0});let c=0,d=0,e=0;b.forEach(a=>{if("booking"===a.sourceType||"visa"===a.sourceType||"subscription"===a.sourceType){if(c+=a.debit,a.originalData){let b=a.originalData.salePrice||(a.originalData.passengers||[]).reduce((a,b)=>a+(b.salePrice||0),0),c=a.originalData.purchasePrice||(a.originalData.passengers||[]).reduce((a,b)=>a+(b.purchasePrice||0),0);e+=b-c}}else("standard_receipt"===a.sourceType||"payment"===a.sourceType)&&(d+=a.credit)});let f=c-d;return{transactions:b.map(a=>({...a,id:a.id||a.invoiceNumber})),totalSales:c,paidAmount:d,dueAmount:f,totalProfit:e,currency:"USD"}}async function n(){let a=await (0,f.Lf)();if(!a)return{entries:[],summary:{totalDebitUSD:0,totalCreditUSD:0,balanceUSD:0,totalDebitIQD:0,totalCreditIQD:0,balanceIQD:0}};let{clients:b}=await (0,g.Lf)({all:!0,includeInactive:!1}),c=await a.collection("journal-vouchers").get(),d={};b.forEach(a=>{d[a.id]={balanceUSD:0,balanceIQD:0,lastTransaction:null}}),c.docs.sort((a,b)=>{let c=a.data().date;return b.data().date,new Date(c).getTime()-new Date(b.date).getTime()}).forEach(a=>{let b=a.data();if(b.isDeleted)return;let c=(a,c)=>{a.forEach(a=>{if(d[a.accountId]){let e=c?a.amount:-a.amount;"USD"===b.currency?d[a.accountId].balanceUSD+=e:"IQD"===b.currency&&(d[a.accountId].balanceIQD+=e),(!d[a.accountId].lastTransaction||b.date>d[a.accountId].lastTransaction)&&(d[a.accountId].lastTransaction=b.date)}})};c(b.debitEntries||[],!0),c(b.creditEntries||[],!1)});let e=b.map(a=>({id:a.id,name:a.name,code:a.code,phone:a.phone,accountType:a.relationType,balanceUSD:d[a.id]?.balanceUSD||0,balanceIQD:d[a.id]?.balanceIQD||0,lastTransaction:d[a.id]?.lastTransaction||null})),h=e.reduce((a,b)=>{let c=b.balanceUSD||0,d=b.balanceIQD||0;return"client"===b.accountType||"both"===b.accountType?c>0?a.totalCreditUSD+=c:a.totalDebitUSD-=c:c<0?a.totalCreditUSD-=c:a.totalDebitUSD+=c,"client"===b.accountType||"both"===b.accountType?d>0?a.totalCreditIQD+=d:a.totalDebitIQD-=d:d<0?a.totalCreditIQD-=d:a.totalDebitIQD+=d,a},{totalDebitUSD:0,totalCreditUSD:0,totalDebitIQD:0,totalCreditIQD:0});return{entries:e,summary:{...h,balanceUSD:h.totalCreditUSD-h.totalDebitUSD,balanceIQD:h.totalCreditIQD-h.totalDebitIQD}}}[f,g,i]=k.then?(await k)():k,(0,j.D)([l,m,n]),(0,e.A)(l,"402c7b78446472945608a53a3ef0be184327c2a5fe",null),(0,e.A)(m,"40441d5aaea8d5d093d6fa7844f284cd19f7057790",null),(0,e.A)(n,"00eaf4ca1bba0811cb1b58225d617ed49fc805c0d1",null),d()}catch(a){d(a)}})},86100:(a,b,c)=>{c.d(b,{A:()=>l});var d=c(21124),e=c(44345),f=c(15914),g=c(90743),h=c(34118),i=c(44943);let j=(a,b)=>{if(.01>Math.abs(a))return`0.00 ${b}`;let c=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a);return`${c} ${b}`},k=({title:a,usd:b,iqd:c,className:e,icon:f})=>(0,d.jsxs)("div",{className:(0,i.cn)("text-center p-2 rounded-lg bg-background",e),children:[(0,d.jsxs)("p",{className:"text-xs font-bold text-muted-foreground flex items-center justify-center gap-1",children:[(0,d.jsx)(f,{className:"h-4 w-4"}),a]}),(0,d.jsx)("p",{className:(0,i.cn)("font-bold font-mono text-sm",b<0?"text-red-500":""),children:j(b,"USD")}),(0,d.jsx)("p",{className:(0,i.cn)("font-bold font-mono text-xs text-muted-foreground",c<0?"text-red-500/80":""),children:j(c,"IQD")})]});function l({report:a}){return(0,d.jsxs)("div",{className:"grid grid-cols-4 gap-3 w-full",children:[(0,d.jsx)(k,{title:"الرصيد الافتتاحي",usd:a.openingBalanceUSD,iqd:a.openingBalanceIQD,className:"border-gray-500/30",icon:e.A}),(0,d.jsx)(k,{title:"إجمالي الدائن",usd:a.totalCreditUSD,iqd:a.totalCreditIQD,className:"border-green-500/30 text-green-600",icon:f.A}),(0,d.jsx)(k,{title:"إجمالي المدين",usd:a.totalDebitUSD,iqd:a.totalDebitIQD,className:"border-red-500/30 text-red-600",icon:g.A}),(0,d.jsx)(k,{title:"الرصيد الختامي",usd:a.finalBalanceUSD,iqd:a.finalBalanceIQD,className:"border-blue-500/30 text-blue-600",icon:h.A})]})}},90743:(a,b,c)=>{c.d(b,{A:()=>d});let d=(0,c(8808).A)("TrendingDown",[["polyline",{points:"22 17 13.5 8.5 8.5 13.5 2 7",key:"1r2t7k"}],["polyline",{points:"16 17 22 17 22 11",key:"11uiuu"}]])},98981:(a,b,c)=>{c.d(b,{h:()=>e});var d=c(85708);let e=(0,d.createServerReference)("402c7b78446472945608a53a3ef0be184327c2a5fe",d.callServer,void 0,d.findSourceMapURL,"getAccountStatement")},99093:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Bj:()=>r,Ln:()=>n,O1:()=>p,hh:()=>q,vY:()=>o});var e=c(91488);c(27806);var f=c(80446),g=c(15105),h=c(91837),i=c(62641),j=c(29631),k=c(7879),l=c(40410),m=a([f,g,i,j,k]);[f,g,i,j,k]=m.then?(await m)():m;let s=async()=>{let a=await (0,i.$T)();if(!a||"isClient"in a)throw Error("Access Denied: User not authenticated or does not have required permissions.");if(!(a.permissions?.includes("segments:read")||"admin"===a.role))throw Error("Access Denied: You don't have permission to manage segments.");if(!a.boxId)throw Error("User has no assigned box. Please contact admin.");return a};async function n(a=!1){try{let b=await (0,f.Lf)();if(!b)return[];let c=b.collection("segments").orderBy("toDate","desc"),d=await c.get();if(d.empty)return[];return d.docs.map(a=>({id:a.id,...a.data()})).filter(b=>!!b.isDeleted===a)}catch(a){return console.error("Error getting segments from Firestore: ",String(a)),a instanceof Error&&a.message.startsWith("Access Denied"),[]}}async function o(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};try{let d=await s(),e=c.batch(),f=b||c.collection("temp").doc().id;if(b){let a=await c.collection("segments").where("periodId","==",b).get(),d=await c.collection("journal-vouchers").where("originalData.periodId","==",b).get();a.forEach(a=>e.delete(a.ref)),d.forEach(a=>e.delete(a.ref))}for(let b of a){let a=c.collection("segments").doc(),h=await (0,j.tu)("SEG"),i=b.entryDate?new Date(b.entryDate):new Date,[k,l]=await Promise.all([c.collection("clients").doc(b.clientId).get(),b.partnerId?c.collection("clients").doc(b.partnerId).get():Promise.resolve(null)]);if(!k.exists)throw Error(`Client with ID ${b.clientId} not found.`);let m=k.data(),n=l&&l.exists?l.data():null,o=function(a,b){let c=b||{ticketProfitType:"percentage",ticketProfitValue:50,visaProfitType:"percentage",visaProfitValue:100,hotelProfitType:"percentage",hotelProfitValue:100,groupProfitType:"percentage",groupProfitValue:100,alrawdatainSharePercentage:50},d=(a,b,c)=>a&&c?"fixed"===b?a*c:a*c/100:0,e=d(a.tickets,c.ticketProfitType,c.ticketProfitValue),f=d(a.visas,c.visaProfitType,c.visaProfitValue),g=d(a.hotels,c.hotelProfitType,c.hotelProfitValue),h=d(a.groups,c.groupProfitType,c.groupProfitValue),i=f+g+h,j=e+i,k=a.hasPartner?j*(a.alrawdatainSharePercentage/100):j,l=a.hasPartner?j-k:0;return{ticketProfits:e,otherProfits:i,total:j,alrawdatainShare:k,partnerShare:l}}(b,m.segmentSettings),p={...b,...o,companyName:m.name,partnerId:b.hasPartner&&n?n.id:"",partnerName:b.hasPartner&&n?n.name:"",periodId:f,invoiceNumber:h,enteredBy:d.name,createdAt:new Date().toISOString(),isDeleted:!1};e.set(a,p);let q=[];if(p.hasPartner&&p.partnerId&&p.partnerShare>0&&q.push({accountId:p.partnerId,amount:p.partnerShare,description:`حصة الشريك ${p.partnerName}`}),p.alrawdatainShare>0){let a="revenue_segments";if(!a)throw Error("Revenue account for segments is not defined.");q.push({accountId:a,amount:p.alrawdatainShare,description:"حصة الشركة من السكمنت"})}await (0,g.a)({sourceType:"segment",sourceId:a.id,description:`ربح سكمنت من ${p.companyName} للفترة من ${p.fromDate} إلى ${p.toDate}`,amount:p.total,currency:p.currency,date:i,userId:d.uid,debitAccountId:p.clientId,creditEntries:q})}return await e.commit(),(0,h.revalidatePath)("/segments"),(0,h.revalidatePath)("/reports/account-statement"),{success:!0,newEntries:a}}catch(a){return console.error("Error adding segment entries: ",String(a)),{success:!1,error:a.message||"Failed to add segment entries"}}}async function p(a,b=!1){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available.",count:0};try{await s();let d=await c.collection("segments").where("periodId","==",a).get();if(d.empty)return{success:!0,count:0};let e=c.batch(),f=d.docs.map(a=>a.id);if(d.docs.forEach(a=>{b?e.delete(a.ref):e.update(a.ref,{isDeleted:!0,deletedAt:new Date().toISOString()})}),f.length>0)for(let a=0;a<f.length;a+=30){let d=f.slice(a,a+30);(await c.collection("journal-vouchers").where("sourceId","in",d).get()).forEach(a=>{b?e.delete(a.ref):e.update(a.ref,{isDeleted:!0,deletedAt:new Date().toISOString()})})}return await e.commit(),(0,h.revalidatePath)("/segments"),(0,h.revalidatePath)("/segments/deleted-segments"),(0,h.revalidatePath)("/reports/account-statement"),{success:!0,count:d.size}}catch(a){return console.error("Error deleting segment period: ",String(a)),{success:!1,error:a.message||"Failed to delete segment period.",count:0}}}async function q(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available.",count:0};try{await s();let c=await b.collection("segments").where("periodId","==",a).where("isDeleted","==",!0).get();if(c.empty)return{success:!0,count:0};let d=b.batch(),e=c.docs.map(a=>a.id);if(c.docs.forEach(a=>{d.update(a.ref,{isDeleted:!1,deletedAt:k.FieldValue.delete()})}),e.length>0)for(let a=0;a<e.length;a+=30){let c=e.slice(a,a+30);(await b.collection("journal-vouchers").where("sourceId","in",c).get()).forEach(a=>{d.update(a.ref,{isDeleted:!1,deletedAt:k.FieldValue.delete()})})}return await d.commit(),(0,h.revalidatePath)("/segments"),(0,h.revalidatePath)("/segments/deleted-segments"),(0,h.revalidatePath)("/reports/account-statement"),{success:!0,count:c.size}}catch(a){return console.error("Error restoring segment period: ",String(a)),{success:!1,error:a.message||"Failed to restore segment period.",count:0}}}async function r(a,b){return{success:!1,error:"Not implemented"}}(0,l.D)([n,o,p,q,r]),(0,e.A)(n,"403ab84bcb8381bf290b99f5595e7f53fbfe6fdc2c",null),(0,e.A)(o,"60e78d426fd8219914cf72d1a693001c780eb7a14f",null),(0,e.A)(p,"607e850594ea411b5e11f09fc4d3f42888c31e8a99",null),(0,e.A)(q,"40a8d173d667be3c84cc8faca9e89e6cbaaca03394",null),(0,e.A)(r,"60820cfaaeadd667c732435450fd4e0c210ced2897",null),d()}catch(a){d(a)}})}};