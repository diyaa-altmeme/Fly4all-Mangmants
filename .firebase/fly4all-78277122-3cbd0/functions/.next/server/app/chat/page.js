(()=>{var a={};a.id=8457,a.ids=[8457],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},1903:(a,b,c)=>{"use strict";var d=c(27910).Stream,e=c(28354),f=c(94519),g=c(15554),h=c(99826),i=c(78829),j=c(50501),k=function(a,b,c){this.writable=!0,c=c||{},this._stream=b.socket,this._ping=c.ping||this.DEFAULT_PING,this._retry=c.retry||this.DEFAULT_RETRY;var d=f.isSecureRequest(a)?"https:":"http:";this.url=d+"//"+a.headers.host+a.url,this.lastEventId=a.headers["last-event-id"]||"",this.readyState=h.CONNECTING;var e=new g,i=this;if(c.headers)for(var j in c.headers)e.set(j,c.headers[j]);if(this._stream&&this._stream.writable){process.nextTick(function(){i._open()}),this._stream.setTimeout(0),this._stream.setNoDelay(!0);var k="HTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nCache-Control: no-cache, no-store\r\nConnection: close\r\n"+e.toString()+"\r\nretry: "+Math.floor(1e3*this._retry)+"\r\n\r\n";this._write(k),this._stream.on("drain",function(){i.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){i.ping()},1e3*this._ping)),["error","end"].forEach(function(a){i._stream.on(a,function(){i.close()})})}};e.inherits(k,d),k.isEventSource=function(a){return"GET"===a.method&&(a.headers.accept||"").split(/\s*,\s*/).indexOf("text/event-stream")>=0};var l={DEFAULT_PING:10,DEFAULT_RETRY:5,_write:function(a){if(!this.writable)return!1;try{return this._stream.write(a,"utf8")}catch(a){return!1}},_open:function(){if(this.readyState===h.CONNECTING){this.readyState=h.OPEN;var a=new j("open");a.initEvent("open",!1,!1),this.dispatchEvent(a)}},write:function(a){return this.send(a)},end:function(a){void 0!==a&&this.write(a),this.close()},send:function(a,b){if(this.readyState>h.OPEN)return!1;a=String(a).replace(/(\r\n|\r|\n)/g,"$1data: ");var c="";return(b=b||{}).event&&(c+="event: "+b.event+"\r\n"),b.id&&(c+="id: "+b.id+"\r\n"),c+="data: "+a+"\r\n\r\n",this._write(c)},ping:function(){return this._write(":\r\n\r\n")},close:function(){if(this.readyState>h.OPEN)return!1;this.readyState=h.CLOSED,this.writable=!1,this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end();var a=new j("close");return a.initEvent("close",!1,!1),this.dispatchEvent(a),!0}};for(var m in l)k.prototype[m]=l[m];for(var n in i)k.prototype[n]=i[n];a.exports=k},3295:a=>{"use strict";a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4717:a=>{"use strict";var b=function(a){this._bufferSize=a,this.clear()};b.prototype.clear=function(){this._buffer=Array(this._bufferSize),this._ringOffset=0,this._ringSize=this._bufferSize,this._head=0,this._tail=0,this.length=0},b.prototype.push=function(a){var b=!1,c=!1;this._ringSize<this._bufferSize?b=0===this._tail:this._ringOffset===this._ringSize&&(b=!0,c=0===this._tail),b&&(this._tail=this._bufferSize,this._buffer=this._buffer.concat(Array(this._bufferSize)),this._bufferSize=this._buffer.length,c&&(this._ringSize=this._bufferSize)),this._buffer[this._tail]=a,this.length+=1,this._tail<this._ringSize&&(this._ringOffset+=1),this._tail=(this._tail+1)%this._bufferSize},b.prototype.peek=function(){if(0!==this.length)return this._buffer[this._head]},b.prototype.shift=function(){if(0!==this.length){var a=this._buffer[this._head];return this._buffer[this._head]=void 0,this.length-=1,this._ringOffset-=1,0===this._ringOffset&&this.length>0?(this._head=this._ringSize,this._ringOffset=this.length,this._ringSize=this._bufferSize):this._head=(this._head+1)%this._ringSize,a}},a.exports=b},5321:(a,b)=>{function c(a){if(void 0!==a&&a!==c.REQUEST&&a!==c.RESPONSE)throw Error("type must be REQUEST or RESPONSE");void 0===a||this.initialize(a),this.maxHeaderSize=c.maxHeaderSize}b.e=c,c.prototype.initialize=function(a,b){if(a!==c.REQUEST&&a!==c.RESPONSE)throw Error("type must be REQUEST or RESPONSE");this.type=a,this.state=a+"_LINE",this.info={headers:[],upgrade:!1},this.trailers=[],this.line="",this.isChunked=!1,this.connection="",this.headerSize=0,this.body_bytes=null,this.isUserCall=!1,this.hadError=!1},c.encoding="ascii",c.maxHeaderSize=81920,c.REQUEST="REQUEST",c.RESPONSE="RESPONSE";var d=c.kOnHeaders=1,e=c.kOnHeadersComplete=2,f=c.kOnBody=3,g=c.kOnMessageComplete=4;c.prototype[d]=c.prototype[e]=c.prototype[f]=c.prototype[g]=function(){};var h=!0;Object.defineProperty(c,"kOnExecute",{get:function(){return h=!1,99}});var i=c.methods=["DELETE","GET","HEAD","POST","PUT","CONNECT","OPTIONS","TRACE","COPY","LOCK","MKCOL","MOVE","PROPFIND","PROPPATCH","SEARCH","UNLOCK","BIND","REBIND","UNBIND","ACL","REPORT","MKACTIVITY","CHECKOUT","MERGE","M-SEARCH","NOTIFY","SUBSCRIBE","UNSUBSCRIBE","PATCH","PURGE","MKCALENDAR","LINK","UNLINK","SOURCE"],j=i.indexOf("CONNECT");c.prototype.reinitialize=c,c.prototype.close=c.prototype.pause=c.prototype.resume=c.prototype.remove=c.prototype.free=function(){},c.prototype._compatMode0_11=!1,c.prototype.getAsyncId=function(){return 0};var k={REQUEST_LINE:!0,RESPONSE_LINE:!0,HEADER:!0};c.prototype.execute=function(a,b,d){if(!(this instanceof c))throw TypeError("not a HTTPParser");b=b||0,d="number"==typeof d?d:a.length,this.chunk=a,this.offset=b;var e=this.end=b+d;try{for(;this.offset<e&&!this[this.state](););}catch(a){if(this.isUserCall)throw a;return this.hadError=!0,a}return(this.chunk=null,d=this.offset-b,k[this.state]&&(this.headerSize+=d,this.headerSize>(this.maxHeaderSize||c.maxHeaderSize)))?Error("max header size exceeded"):d};var l={REQUEST_LINE:!0,RESPONSE_LINE:!0,BODY_RAW:!0};c.prototype.finish=function(){if(!this.hadError){if(!l[this.state])return Error("invalid state for EOF");"BODY_RAW"===this.state&&this.userCall()(this[g]())}},c.prototype.consume=c.prototype.unconsume=c.prototype.getCurrentBuffer=function(){},c.prototype.userCall=function(){this.isUserCall=!0;var a=this;return function(b){return a.isUserCall=!1,b}},c.prototype.nextRequest=function(){this.userCall()(this[g]()),this.reinitialize(this.type)},c.prototype.consumeLine=function(){for(var a=this.end,b=this.chunk,d=this.offset;d<a;d++)if(10===b[d]){var e=this.line+b.toString(c.encoding,this.offset,d);return"\r"===e.charAt(e.length-1)&&(e=e.substr(0,e.length-1)),this.line="",this.offset=d+1,e}this.line+=b.toString(c.encoding,this.offset,this.end),this.offset=this.end};var m=/^([^: \t]+):[ \t]*((?:.*[^ \t])|)/,n=/^[ \t]+(.*[^ \t])/;c.prototype.parseHeader=function(a,b){if(-1!==a.indexOf("\r"))throw q("HPE_LF_EXPECTED");var c=m.exec(a),d=c&&c[1];if(d)b.push(d),b.push(c[2]);else{var e=n.exec(a);e&&b.length&&(b[b.length-1]&&(b[b.length-1]+=" "),b[b.length-1]+=e[1])}};var o=/^([A-Z-]+) ([^ ]+) HTTP\/(\d)\.(\d)$/;c.prototype.REQUEST_LINE=function(){var a=this.consumeLine();if(a){var b=o.exec(a);if(null===b)throw q("HPE_INVALID_CONSTANT");if(this.info.method=this._compatMode0_11?b[1]:i.indexOf(b[1]),-1===this.info.method)throw Error("invalid request method");this.info.url=b[2],this.info.versionMajor=+b[3],this.info.versionMinor=+b[4],this.body_bytes=0,this.state="HEADER"}};var p=/^HTTP\/(\d)\.(\d) (\d{3}) ?(.*)$/;function q(a){var b=Error("Parse Error");return b.code=a,b}c.prototype.RESPONSE_LINE=function(){var a=this.consumeLine();if(a){var b=p.exec(a);if(null===b)throw q("HPE_INVALID_CONSTANT");this.info.versionMajor=+b[1],this.info.versionMinor=+b[2];var c=this.info.statusCode=+b[3];this.info.statusMessage=b[4],((c/100|0)==1||204===c||304===c)&&(this.body_bytes=0),this.state="HEADER"}},c.prototype.shouldKeepAlive=function(){if(this.info.versionMajor>0&&this.info.versionMinor>0){if(-1!==this.connection.indexOf("close"))return!1}else if(-1===this.connection.indexOf("keep-alive"))return!1;return null!==this.body_bytes||!!this.isChunked},c.prototype.HEADER=function(){var a=this.consumeLine();if(void 0!==a){var b=this.info;if(a)this.parseHeader(a,b.headers);else{for(var d,f,g=b.headers,i=!1,k=!1,l=0;l<g.length;l+=2)switch(g[l].toLowerCase()){case"transfer-encoding":this.isChunked="chunked"===g[l+1].toLowerCase();break;case"content-length":if(d=+g[l+1],i){if(d!==this.body_bytes)throw q("HPE_UNEXPECTED_CONTENT_LENGTH")}else i=!0,this.body_bytes=d;break;case"connection":this.connection+=g[l+1].toLowerCase();break;case"upgrade":k=!0}if(this.isChunked&&i&&(i=!1,this.body_bytes=null),k&&-1!=this.connection.indexOf("upgrade")?b.upgrade=this.type===c.REQUEST||101===b.statusCode:b.upgrade=b.method===j,this.isChunked&&b.upgrade&&(this.isChunked=!1),b.shouldKeepAlive=this.shouldKeepAlive(),2===(f=h?this.userCall()(this[e](b)):this.userCall()(this[e](b.versionMajor,b.versionMinor,b.headers,b.method,b.url,b.statusCode,b.statusMessage,b.upgrade,b.shouldKeepAlive))))return this.nextRequest(),!0;if(this.isChunked&&!f)this.state="BODY_CHUNKHEAD";else{if(f||0===this.body_bytes)return this.nextRequest(),b.upgrade;null===this.body_bytes?this.state="BODY_RAW":this.state="BODY_SIZED"}}}},c.prototype.BODY_CHUNKHEAD=function(){var a=this.consumeLine();void 0!==a&&(this.body_bytes=parseInt(a,16),this.body_bytes?this.state="BODY_CHUNK":this.state="BODY_CHUNKTRAILERS")},c.prototype.BODY_CHUNK=function(){var a=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[f](this.chunk.slice(this.offset,this.offset+a),0,a)),this.offset+=a,this.body_bytes-=a,this.body_bytes||(this.state="BODY_CHUNKEMPTYLINE")},c.prototype.BODY_CHUNKEMPTYLINE=function(){var a=this.consumeLine();if(void 0!==a){if(""!==a)throw Error("Expected empty line");this.state="BODY_CHUNKHEAD"}},c.prototype.BODY_CHUNKTRAILERS=function(){var a=this.consumeLine();void 0!==a&&(a?this.parseHeader(a,this.trailers):(this.trailers.length&&this.userCall()(this[d](this.trailers,"")),this.nextRequest()))},c.prototype.BODY_RAW=function(){this.userCall()(this[f](this.chunk.slice(this.offset,this.end),0,this.end-this.offset)),this.offset=this.end},c.prototype.BODY_SIZED=function(){var a=Math.min(this.end-this.offset,this.body_bytes);this.userCall()(this[f](this.chunk.slice(this.offset,this.offset+a),0,a)),this.offset+=a,this.body_bytes-=a,this.body_bytes||this.nextRequest()},["Headers","HeadersComplete","Body","MessageComplete"].forEach(function(a){var b=c["kOn"+a];Object.defineProperty(c.prototype,"on"+a,{get:function(){return this[b]},set:function(a){return this._compatMode0_11=!0,j="CONNECT",this[b]=a}})})},6094:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(28647),f=c(93867),g=c(55511),h=c(28354),i=function(a){return parseInt((a.match(/[0-9]/g)||[]).join(""),10)},j=function(a){return(a.match(/ /g)||[]).length},k=function(a,b,c){f.apply(this,arguments),this._stage=-1,this._body=[],this.version="hixie-76",this._headers.clear(),this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Origin",this._request.headers.origin),this._headers.set("Sec-WebSocket-Location",this.url)};h.inherits(k,f);var l={BODY_SIZE:8,start:function(){return!!f.prototype.start.call(this)&&(this._started=!0,this._sendHandshakeBody(),!0)},close:function(){return 3!==this.readyState&&(1===this.readyState&&this._write(d.from([255,0])),this.readyState=3,this.emit("close",new e.CloseEvent(null,null)),!0)},_handshakeResponse:function(){var a=this._request.headers,b=a["sec-websocket-key1"],c=a["sec-websocket-key2"];if(!b)throw Error("Missing required header: Sec-WebSocket-Key1");if(!c)throw Error("Missing required header: Sec-WebSocket-Key2");var e=i(b),f=j(b),g=i(c),h=j(c);if(e%f!=0||g%h!=0)throw Error("Client sent invalid Sec-WebSocket-Key headers");this._keyValues=[e/f,g/h];var a=["HTTP/1.1 101 WebSocket Protocol Handshake",this._headers.toString(),""];return d.from(a.join("\r\n"),"binary")},_handshakeSignature:function(){if(this._body.length<this.BODY_SIZE)return null;var a=g.createHash("md5"),b=d.allocUnsafe(8+this.BODY_SIZE);return b.writeUInt32BE(this._keyValues[0],0),b.writeUInt32BE(this._keyValues[1],4),d.from(this._body).copy(b,8,0,this.BODY_SIZE),a.update(b),d.from(a.digest("binary"),"binary")},_sendHandshakeBody:function(){if(this._started){var a=this._handshakeSignature();a&&(this._write(a),this._stage=0,this._open(),this._body.length>this.BODY_SIZE&&this.parse(this._body.slice(this.BODY_SIZE)))}},_parseLeadingByte:function(a){if(255!==a)return f.prototype._parseLeadingByte.call(this,a);this._closing=!0,this._length=0,this._stage=1}};for(var m in l)k.prototype[m]=l[m];a.exports=k},7879:a=>{"use strict";a.exports=import("firebase-admin/firestore")},8245:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{d:()=>j});var e=c(91488);c(27806);var f=c(80446),g=c(7879),h=c(40410),i=a([f,g]);async function j(a,b){let c=await (0,f.Lf)();if(!c)throw Error("Database not available.");let d=[a,b].sort().join("_"),e=c.collection("chats").doc(d);if((await e.get()).exists)return d;{let[f,h]=await Promise.all([c.collection("users").doc(a).get(),c.collection("users").doc(b).get()]);if(!f.exists||!h.exists)throw Error("One or both users not found.");let i=f.data(),j=h.data(),k=g.FieldValue.serverTimestamp(),l=c.batch();l.set(e,{type:"direct",members:{[a]:!0,[b]:!0},createdAt:k,updatedAt:k});let m=c.doc(`userChats/${a}/summaries/${d}`);l.set(m,{type:"direct",otherMemberId:b,otherMemberName:j?.name||"Unknown",otherMemberAvatar:j?.avatarUrl||null,updatedAt:k,unreadCount:0});let n=c.doc(`userChats/${b}/summaries/${d}`);return l.set(n,{type:"direct",otherMemberId:a,otherMemberName:i?.name||"Unknown",otherMemberAvatar:i?.avatarUrl||null,updatedAt:k,unreadCount:0}),await l.commit(),d}}[f,g]=i.then?(await i)():i,(0,h.D)([j]),(0,e.A)(j,"6095092e7df48b6be6bd48b6d0c17d16afc7b4de53",null),d()}catch(a){d(a)}})},9578:(a,b,c)=>{Promise.resolve().then(c.bind(c,79466))},9757:(a,b,c)=>{"use strict";var d=c(28354),e=c(94519),f=c(99826),g=function(a,b,c,d,g){g=g||{},this._stream=b,this._driver=e.http(a,{maxLength:g.maxLength,protocols:d});var h=this;if(this._stream&&this._stream.writable){if(!this._stream.readable)return this._stream.end();var i=function(){h._stream.removeListener("data",i)};this._stream.on("data",i),f.call(this,g),process.nextTick(function(){h._driver.start(),h._driver.io.write(c)})}};d.inherits(g,f),g.isWebSocket=function(a){return e.isWebSocket(a)},g.validateOptions=function(a,b){e.validateOptions(a,b)},g.WebSocket=g,g.Client=c(63995),g.EventSource=c(1903),a.exports=g},9801:a=>{"use strict";a.exports=import("firebase-admin/app")},10846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},13166:(a,b,c)=>{"use strict";var d=c(69727),e=c(95599),f=function(a){this._ext=a[0],this._session=a[1],this._functors={incoming:new d(this._session,"processIncomingMessage"),outgoing:new d(this._session,"processOutgoingMessage")}};f.prototype.pending=function(a){var b=this._functors[a];b._stopped||(b.pending+=1)},f.prototype.incoming=function(a,b,c,d){this._exec("incoming",a,b,c,d)},f.prototype.outgoing=function(a,b,c,d){this._exec("outgoing",a,b,c,d)},f.prototype.close=function(){return this._closed=this._closed||new e,this._doClose(),this._closed},f.prototype._exec=function(a,b,c,d,e){this._functors[a].call(b,c,function(a,b){a&&(a.message=this._ext.name+": "+a.message),d.call(e,a,b),this._doClose()},this)},f.prototype._doClose=function(){var a=this._functors.incoming,b=this._functors.outgoing;this._closed&&a.pending+b.pending===0&&(this._session&&this._session.close(),this._session=null,this._closed.done())},a.exports=f},14276:a=>{"use strict";a.exports=import("firebase-admin/auth")},14985:a=>{"use strict";a.exports=require("dns")},15554:a=>{"use strict";var b=function(){this.clear()};b.prototype.ALLOWED_DUPLICATES=["set-cookie","set-cookie2","warning","www-authenticate"],b.prototype.clear=function(){this._sent={},this._lines=[]},b.prototype.set=function(a,b){if(void 0!==b){a=this._strip(a),b=this._strip(b);var c=a.toLowerCase();(!this._sent.hasOwnProperty(c)||this.ALLOWED_DUPLICATES.indexOf(c)>=0)&&(this._sent[c]=!0,this._lines.push(a+": "+b+"\r\n"))}},b.prototype.toString=function(){return this._lines.join("")},b.prototype._strip=function(a){return a.toString().replace(/^ */,"").replace(/ *$/,"")},a.exports=b},19121:a=>{"use strict";a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},19771:a=>{"use strict";a.exports=require("process")},21820:a=>{"use strict";a.exports=require("os")},22516:(a,b,c)=>{"use strict";c.r(b),c.d(b,{default:()=>d});let d=(0,c(97954).registerClientReference)(function(){throw Error("Attempted to call the default export of \"/home/user/studio/src/app/chat/page.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"/home/user/studio/src/app/chat/page.tsx","default")},23444:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(27910).Stream,f=c(79551),g=c(28354),h=c(28647),i=c(15554),j=c(31531),k={"ws:":80,"wss:":443},l=function(a,b,c){this._client=a,this._http=new j("response"),this._origin="object"==typeof a.url?a.url:f.parse(a.url),this._url="object"==typeof b?b:f.parse(b),this._options=c||{},this._state=0,this.readable=this.writable=!0,this._paused=!1,this._headers=new i,this._headers.set("Host",this._origin.host),this._headers.set("Connection","keep-alive"),this._headers.set("Proxy-Connection","keep-alive");var e=this._url.auth&&d.from(this._url.auth,"utf8").toString("base64");e&&this._headers.set("Proxy-Authorization","Basic "+e)};g.inherits(l,e);var m={setHeader:function(a,b){return 0===this._state&&(this._headers.set(a,b),!0)},start:function(){if(0!==this._state)return!1;this._state=1;var a=this._origin,b=a.port||k[a.protocol],c=["CONNECT "+a.hostname+":"+b+" HTTP/1.1",this._headers.toString(),""];return this.emit("data",d.from(c.join("\r\n"),"utf8")),!0},pause:function(){this._paused=!0},resume:function(){this._paused=!1,this.emit("drain")},write:function(a){if(!this.writable)return!1;if(this._http.parse(a),!this._http.isComplete())return!this._paused;if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,200===this.statusCode)this.emit("connect",new h.ConnectEvent);else{var b="Can't establish a connection to the server at "+this._origin.href;this.emit("error",Error(b))}return this.end(),!this._paused},end:function(a){this.writable&&(void 0!==a&&this.write(a),this.readable=this.writable=!1,this.emit("close"),this.emit("end"))},destroy:function(){this.end()}};for(var n in m)l.prototype[n]=m[n];a.exports=l},24803:a=>{"use strict";a.exports=import("firebase-admin/storage")},26713:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/is-bot")},27910:a=>{"use strict";a.exports=require("stream")},28354:a=>{"use strict";a.exports=require("util")},28647:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(94735).EventEmitter,f=c(28354),g=c(63416),h=c(15554),i=c(77018),j=function(a,b,c){e.call(this),j.validateOptions(c||{},["maxLength","masking","requireMasking","protocols"]),this._request=a,this._reader=new i,this._options=c||{},this._maxLength=this._options.maxLength||this.MAX_LENGTH,this._headers=new h,this.__queue=[],this.readyState=0,this.url=b,this.io=new g.IO(this),this.messages=new g.Messages(this),this._bindEventListeners()};f.inherits(j,e),j.isWebSocket=function(a){var b=a.headers.connection||"",c=a.headers.upgrade||"";return"GET"===a.method&&b.toLowerCase().split(/ *, */).indexOf("upgrade")>=0&&"websocket"===c.toLowerCase()},j.validateOptions=function(a,b){for(var c in a)if(0>b.indexOf(c))throw Error("Unrecognized option: "+c)};var k={MAX_LENGTH:0x3ffffff,STATES:["connecting","open","closing","closed"],_bindEventListeners:function(){var a=this;this.messages.on("error",function(){}),this.on("message",function(b){var c=a.messages;c.readable&&c.emit("data",b.data)}),this.on("error",function(b){var c=a.messages;c.readable&&c.emit("error",b)}),this.on("close",function(){var b=a.messages;b.readable&&(b.readable=b.writable=!1,b.emit("end"))})},getState:function(){return this.STATES[this.readyState]||null},addExtension:function(a){return!1},setHeader:function(a,b){return!(this.readyState>0)&&(this._headers.set(a,b),!0)},start:function(){var a;if(0!==this.readyState)return!1;if(!j.isWebSocket(this._request))return this._failHandshake(Error("Not a WebSocket request"));try{a=this._handshakeResponse()}catch(a){return this._failHandshake(a)}return this._write(a),-1!==this._stage&&this._open(),!0},_failHandshake:function(a){var b=new h;return b.set("Content-Type","text/plain"),b.set("Content-Length",d.byteLength(a.message,"utf8")),b=["HTTP/1.1 400 Bad Request",b.toString(),a.message],this._write(d.from(b.join("\r\n"),"utf8")),this._fail("protocol_error",a.message),!1},text:function(a){return this.frame(a)},binary:function(a){return!1},ping:function(){return!1},pong:function(){return!1},close:function(a,b){return 1===this.readyState&&(this.readyState=3,this.emit("close",new j.CloseEvent(null,null)),!0)},_open:function(){this.readyState=1,this.__queue.forEach(function(a){this.frame.apply(this,a)},this),this.__queue=[],this.emit("open",new j.OpenEvent)},_queue:function(a){return this.__queue.push(a),!0},_write:function(a){var b=this.io;b.readable&&b.emit("data",a)},_fail:function(a,b){this.readyState=2,this.emit("error",Error(b)),this.close()}};for(var l in k)j.prototype[l]=k[l];j.ConnectEvent=function(){},j.OpenEvent=function(){},j.CloseEvent=function(a,b){this.code=a,this.reason=b},j.MessageEvent=function(a){this.data=a},j.PingEvent=function(a){this.data=a},j.PongEvent=function(a){this.data=a},a.exports=j},29021:a=>{"use strict";a.exports=require("fs")},29294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31531:(a,b,c)=>{"use strict";var d=c(5321).e,e=c(62253).Buffer,f={request:d.REQUEST||"request",response:d.RESPONSE||"response"},g=function(a){this._type=a,this._parser=new d(f[a]),this._complete=!1,this.headers={};var b=null,c=this;this._parser.onHeaderField=function(a,c,d){b=a.toString("utf8",c,c+d).toLowerCase()},this._parser.onHeaderValue=function(a,d,e){var f=a.toString("utf8",d,d+e);c.headers.hasOwnProperty(b)?c.headers[b]+=", "+f:c.headers[b]=f},this._parser.onHeadersComplete=this._parser[d.kOnHeadersComplete]=function(a,b,d,e,f,h){var i=arguments[0];if("object"==typeof i&&(e=i.method,f=i.url,h=i.statusCode,d=i.headers),c.method="number"==typeof e?g.METHODS[e]:e,c.statusCode=h,c.url=f,d){for(var j,k,l=0,m=d.length;l<m;l+=2)j=d[l].toLowerCase(),k=d[l+1],c.headers.hasOwnProperty(j)?c.headers[j]+=", "+k:c.headers[j]=k;c._complete=!0}}};g.METHODS={0:"DELETE",1:"GET",2:"HEAD",3:"POST",4:"PUT",5:"CONNECT",6:"OPTIONS",7:"TRACE",8:"COPY",9:"LOCK",10:"MKCOL",11:"MOVE",12:"PROPFIND",13:"PROPPATCH",14:"SEARCH",15:"UNLOCK",16:"BIND",17:"REBIND",18:"UNBIND",19:"ACL",20:"REPORT",21:"MKACTIVITY",22:"CHECKOUT",23:"MERGE",24:"M-SEARCH",25:"NOTIFY",26:"SUBSCRIBE",27:"UNSUBSCRIBE",28:"PATCH",29:"PURGE",30:"MKCALENDAR",31:"LINK",32:"UNLINK"};var h=process.version?process.version.match(/[0-9]+/g).map(function(a){return parseInt(a,10)}):[];0===h[0]&&12===h[1]&&(g.METHODS[16]="REPORT",g.METHODS[17]="MKACTIVITY",g.METHODS[18]="CHECKOUT",g.METHODS[19]="MERGE",g.METHODS[20]="M-SEARCH",g.METHODS[21]="NOTIFY",g.METHODS[22]="SUBSCRIBE",g.METHODS[23]="UNSUBSCRIBE",g.METHODS[24]="PATCH",g.METHODS[25]="PURGE"),g.prototype.isComplete=function(){return this._complete},g.prototype.parse=function(a){var b=this._parser.execute(a,0,a.length);if("number"!=typeof b){this.error=b,this._complete=!0;return}this._complete&&(this.body=b<a.length?a.slice(b):e.alloc(0))},a.exports=g},31820:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(55511),f=c(28354),g=c(77335),h=c(28647),i=c(66186),j=c(56620),k=function(a,b,c){if(h.apply(this,arguments),this._extensions=new g,this._stage=0,this._masking=this._options.masking,this._protocols=this._options.protocols||[],this._requireMasking=this._options.requireMasking,this._pingCallbacks={},"string"==typeof this._protocols&&(this._protocols=this._protocols.split(/ *, */)),this._request){var d=this._request.headers["sec-websocket-protocol"],e=this._protocols;void 0!==d&&("string"==typeof d&&(d=d.split(/ *, */)),this.protocol=d.filter(function(a){return e.indexOf(a)>=0})[0]),this.version="hybi-"+k.VERSION}};f.inherits(k,h),k.VERSION="13",k.mask=function(a,b,c){if(!b||0===b.length)return a;c=c||0;for(var d=0,e=a.length-c;d<e;d++)a[c+d]=a[c+d]^b[d%4];return a},k.generateAccept=function(a){var b=e.createHash("sha1");return b.update(a+k.GUID),b.digest("base64")},k.GUID="258EAFA5-E914-47DA-95CA-C5AB0DC85B11";var l={FIN:128,MASK:128,RSV1:64,RSV2:32,RSV3:16,OPCODE:15,LENGTH:127,OPCODES:{continuation:0,text:1,binary:2,close:8,ping:9,pong:10},OPCODE_CODES:[0,1,2,8,9,10],MESSAGE_OPCODES:[0,1,2],OPENING_OPCODES:[1,2],ERRORS:{normal_closure:1e3,going_away:1001,protocol_error:1002,unacceptable:1003,encoding_error:1007,policy_violation:1008,too_large:1009,extension_error:1010,unexpected_condition:1011},ERROR_CODES:[1e3,1001,1002,1003,1007,1008,1009,1010,1011],DEFAULT_ERROR_CODE:1e3,MIN_RESERVED_ERROR:3e3,MAX_RESERVED_ERROR:4999,UTF8_MATCH:/^([\x00-\x7F]|[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF]|\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})*$/,addExtension:function(a){return this._extensions.add(a),!0},parse:function(a){this._reader.put(a);for(var b=!0;b;)switch(this._stage){case 0:(b=this._reader.read(1))&&this._parseOpcode(b[0]);break;case 1:(b=this._reader.read(1))&&this._parseLength(b[0]);break;case 2:(b=this._reader.read(this._frame.lengthBytes))&&this._parseExtendedLength(b);break;case 3:(b=this._reader.read(4))&&(this._stage=4,this._frame.maskingKey=b);break;case 4:(b=this._reader.read(this._frame.length))&&(this._stage=0,this._emitFrame(b));break;default:b=null}},text:function(a){return!(this.readyState>1)&&this.frame(a,"text")},binary:function(a){return!(this.readyState>1)&&this.frame(a,"binary")},ping:function(a,b){return!(this.readyState>1)&&(a=a||"",b&&(this._pingCallbacks[a]=b),this.frame(a,"ping"))},pong:function(a){return!(this.readyState>1)&&(a=a||"",this.frame(a,"pong"))},close:function(a,b){return(a=a||"",b=b||this.ERRORS.normal_closure,this.readyState<=0)?(this.readyState=3,this.emit("close",new h.CloseEvent(b,a)),!0):1===this.readyState&&(this.readyState=2,this._extensions.close(function(){this.frame(a,"close",b)},this),!0)},frame:function(a,b,c){if(this.readyState<=0)return this._queue([a,b,c]);if(this.readyState>2)return!1;a instanceof Array&&(a=d.from(a)),"number"==typeof a&&(a=a.toString());var f,g,h=new j,k="string"==typeof a;h.rsv1=h.rsv2=h.rsv3=!1,h.opcode=this.OPCODES[b||(k?"text":"binary")],f=k?d.from(a,"utf8"):a,c&&(g=f,(f=d.allocUnsafe(2+g.length)).writeUInt16BE(c,0),g.copy(f,2)),h.data=f;var l=function(a){var b=new i;b.final=!0,b.rsv1=a.rsv1,b.rsv2=a.rsv2,b.rsv3=a.rsv3,b.opcode=a.opcode,b.masked=!!this._masking,b.length=a.data.length,b.payload=a.data,b.masked&&(b.maskingKey=e.randomBytes(4)),this._sendFrame(b)};return this.MESSAGE_OPCODES.indexOf(h.opcode)>=0?this._extensions.processOutgoingMessage(h,function(a,b){if(a)return this._fail("extension_error",a.message);l.call(this,b)},this):l.call(this,h),!0},_sendFrame:function(a){var b=a.length,c=b<=125?2:b<=65535?4:10,e=c+4*!!a.masked,f=d.allocUnsafe(e+b),g=a.masked?this.MASK:0;f[0]=(a.final?this.FIN:0)|(a.rsv1?this.RSV1:0)|(a.rsv2?this.RSV2:0)|(a.rsv3?this.RSV3:0)|a.opcode,b<=125?f[1]=g|b:b<=65535?(f[1]=126|g,f.writeUInt16BE(b,2)):(f[1]=127|g,f.writeUInt32BE(Math.floor(b/0x100000000),2),f.writeUInt32BE(b%0x100000000,6)),a.payload.copy(f,e),a.masked&&(a.maskingKey.copy(f,c),k.mask(f,a.maskingKey,e)),this._write(f)},_handshakeResponse:function(){var a=this._request.headers["sec-websocket-key"],b=this._request.headers["sec-websocket-version"];if(b!==k.VERSION)throw Error("Unsupported WebSocket version: "+b);if("string"!=typeof a)throw Error("Missing handshake request header: Sec-WebSocket-Key");this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Accept",k.generateAccept(a)),this.protocol&&this._headers.set("Sec-WebSocket-Protocol",this.protocol);var c=this._extensions.generateResponse(this._request.headers["sec-websocket-extensions"]);c&&this._headers.set("Sec-WebSocket-Extensions",c);var e=["HTTP/1.1 101 Switching Protocols",this._headers.toString(),""];return d.from(e.join("\r\n"),"utf8")},_shutdown:function(a,b,c){delete this._frame,delete this._message,this._stage=5;var d=1===this.readyState;this.readyState=2,this._extensions.close(function(){d&&this.frame(b,"close",a),this.readyState=3,c&&this.emit("error",Error(b)),this.emit("close",new h.CloseEvent(a,b))},this)},_fail:function(a,b){this.readyState>1||this._shutdown(this.ERRORS[a],b,!0)},_parseOpcode:function(a){var b=[this.RSV1,this.RSV2,this.RSV3].map(function(b){return(a&b)===b}),c=this._frame=new i;return(c.final=(a&this.FIN)===this.FIN,c.rsv1=b[0],c.rsv2=b[1],c.rsv3=b[2],c.opcode=a&this.OPCODE,this._stage=1,this._extensions.validFrameRsv(c))?0>this.OPCODE_CODES.indexOf(c.opcode)?this._fail("protocol_error","Unrecognized frame opcode: "+c.opcode):0>this.MESSAGE_OPCODES.indexOf(c.opcode)&&!c.final?this._fail("protocol_error","Received fragmented control frame: opcode = "+c.opcode):this._message&&this.OPENING_OPCODES.indexOf(c.opcode)>=0?this._fail("protocol_error","Received new data frame but previous continuous frame is unfinished"):void 0:this._fail("protocol_error","One or more reserved bits are on: reserved1 = "+ +!!c.rsv1+", reserved2 = "+ +!!c.rsv2+", reserved3 = "+ +!!c.rsv3)},_parseLength:function(a){var b=this._frame;if(b.masked=(a&this.MASK)===this.MASK,b.length=a&this.LENGTH,b.length>=0&&b.length<=125){if(this._stage=b.masked?3:4,!this._checkFrameLength())return}else this._stage=2,b.lengthBytes=126===b.length?2:8;if(this._requireMasking&&!b.masked)return this._fail("unacceptable","Received unmasked frame but masking is required")},_parseExtendedLength:function(a){var b=this._frame;if(b.length=this._readUInt(a),this._stage=b.masked?3:4,0>this.MESSAGE_OPCODES.indexOf(b.opcode)&&b.length>125)return this._fail("protocol_error","Received control frame having too long payload: "+b.length);if(!this._checkFrameLength())return},_checkFrameLength:function(){return!((this._message?this._message.length:0)+this._frame.length>this._maxLength)||(this._fail("too_large","WebSocket frame length too large"),!1)},_emitFrame:function(a){var b,c,d,e,f,g=this._frame,i=g.payload=k.mask(a,g.maskingKey),l=g.opcode;if(delete this._frame,l===this.OPCODES.continuation){if(!this._message)return this._fail("protocol_error","Received unexpected continuation frame");this._message.pushFrame(g)}if((l===this.OPCODES.text||l===this.OPCODES.binary)&&(this._message=new j,this._message.pushFrame(g)),g.final&&this.MESSAGE_OPCODES.indexOf(l)>=0)return this._emitMessage(this._message);l===this.OPCODES.close&&(c=i.length>=2?i.readUInt16BE(0):null,d=i.length>2?this._encode(i.slice(2)):null,0!==i.length&&!(null!==c&&c>=this.MIN_RESERVED_ERROR&&c<=this.MAX_RESERVED_ERROR)&&0>this.ERROR_CODES.indexOf(c)&&(c=this.ERRORS.protocol_error),(i.length>125||i.length>2&&!d)&&(c=this.ERRORS.protocol_error),this._shutdown(c||this.DEFAULT_ERROR_CODE,d||"")),l===this.OPCODES.ping&&(this.frame(i,"pong"),this.emit("ping",new h.PingEvent(i.toString()))),l===this.OPCODES.pong&&(f=(e=this._pingCallbacks)[b=this._encode(i)],delete e[b],f&&f(),this.emit("pong",new h.PongEvent(i.toString())))},_emitMessage:function(a){var a=this._message;a.read(),delete this._message,this._extensions.processIncomingMessage(a,function(a,b){if(a)return this._fail("extension_error",a.message);var c=b.data;if(b.opcode===this.OPCODES.text&&(c=this._encode(c)),null===c)return this._fail("encoding_error","Could not decode a text frame as UTF-8");this.emit("message",new h.MessageEvent(c))},this)},_encode:function(a){try{var b=a.toString("binary",0,a.length);if(!this.UTF8_MATCH.test(b))return null}catch(a){}return a.toString("utf8",0,a.length)},_readUInt:function(a){return 2===a.length?a.readUInt16BE(0):0x100000000*a.readUInt32BE(0)+a.readUInt32BE(4)}};for(var m in l)k.prototype[m]=l[m];a.exports=k},33412:(a,b,c)=>{"use strict";var d=c(13166),e=c(95599),f=function(a){this._cells=a.map(function(a){return new d(a)}),this._stopped={incoming:!1,outgoing:!1}};f.prototype.processIncomingMessage=function(a,b,c){this._stopped.incoming||this._loop("incoming",this._cells.length-1,-1,-1,a,b,c)},f.prototype.processOutgoingMessage=function(a,b,c){this._stopped.outgoing||this._loop("outgoing",0,this._cells.length,1,a,b,c)},f.prototype.close=function(a,b){this._stopped={incoming:!0,outgoing:!0};var c=this._cells.map(function(a){return a.close()});a&&e.all(c).then(function(){a.call(b)})},f.prototype._loop=function(a,b,c,d,e,f,g){for(var h=this._cells,i=h.length,j=this;i--;)h[i].pending(a);var k=function(b,e,i){if(b===c)return f.call(g,e,i);h[b][a](e,i,function(c,e){c&&(j._stopped[a]=!0),k(b+d,c,e)})};k(b,null,e)},a.exports=f},33873:a=>{"use strict";a.exports=require("path")},34631:a=>{"use strict";a.exports=require("tls")},40485:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(55511),f=c(79551),g=c(28354),h=c(31531),i=c(28647),j=c(31820),k=c(23444),l=function(a,b){this.version="hybi-"+j.VERSION,j.call(this,null,a,b),this.readyState=-1,this._key=l.generateKey(),this._accept=j.generateAccept(this._key),this._http=new h("response");var c=f.parse(this.url),e=c.auth&&d.from(c.auth,"utf8").toString("base64");if(0>this.VALID_PROTOCOLS.indexOf(c.protocol))throw Error(this.url+" is not a valid WebSocket URL");this._pathname=(c.pathname||"/")+(c.search||""),this._headers.set("Host",c.host),this._headers.set("Upgrade","websocket"),this._headers.set("Connection","Upgrade"),this._headers.set("Sec-WebSocket-Key",this._key),this._headers.set("Sec-WebSocket-Version",j.VERSION),this._protocols.length>0&&this._headers.set("Sec-WebSocket-Protocol",this._protocols.join(", ")),e&&this._headers.set("Authorization","Basic "+e)};g.inherits(l,j),l.generateKey=function(){return e.randomBytes(16).toString("base64")};var m={VALID_PROTOCOLS:["ws:","wss:"],proxy:function(a,b){return new k(this,a,b)},start:function(){return -1===this.readyState&&(this._write(this._handshakeRequest()),this.readyState=0,!0)},parse:function(a){if(3!==this.readyState){if(this.readyState>0)return j.prototype.parse.call(this,a);this._http.parse(a),this._http.isComplete()&&(this._validateHandshake(),3!==this.readyState&&(this._open(),this.parse(this._http.body)))}},_handshakeRequest:function(){var a=this._extensions.generateOffer();a&&this._headers.set("Sec-WebSocket-Extensions",a);var b=["GET "+this._pathname+" HTTP/1.1",this._headers.toString(),""];return d.from(b.join("\r\n"),"utf8")},_failHandshake:function(a){a="Error during WebSocket handshake: "+a,this.readyState=3,this.emit("error",Error(a)),this.emit("close",new i.CloseEvent(this.ERRORS.protocol_error,a))},_validateHandshake:function(){if(this.statusCode=this._http.statusCode,this.headers=this._http.headers,this._http.error)return this._failHandshake(this._http.error.message);if(101!==this._http.statusCode)return this._failHandshake("Unexpected response code: "+this._http.statusCode);var a=this._http.headers,b=a.upgrade||"",c=a.connection||"",d=a["sec-websocket-accept"]||"",e=a["sec-websocket-protocol"]||"";if(""===b)return this._failHandshake("'Upgrade' header is missing");if("websocket"!==b.toLowerCase())return this._failHandshake("'Upgrade' header value is not 'WebSocket'");if(""===c)return this._failHandshake("'Connection' header is missing");if("upgrade"!==c.toLowerCase())return this._failHandshake("'Connection' header value is not 'Upgrade'");if(d!==this._accept)return this._failHandshake("Sec-WebSocket-Accept mismatch");if(this.protocol=null,""!==e)if(0>this._protocols.indexOf(e))return this._failHandshake("Sec-WebSocket-Protocol mismatch");else this.protocol=e;try{this._extensions.activate(this.headers["sec-websocket-extensions"])}catch(a){return this._failHandshake(a.message)}}};for(var n in m)l.prototype[n]=m[n];a.exports=l},41025:a=>{"use strict";a.exports=require("next/dist/server/app-render/dynamic-access-async-storage.external.js")},50501:a=>{"use strict";var b=function(a,b){for(var c in this.type=a,b)this[c]=b[c]};b.prototype.initEvent=function(a,b,c){this.type=a,this.bubbles=b,this.cancelable=c},b.prototype.stopPropagation=function(){},b.prototype.preventDefault=function(){},b.CAPTURING_PHASE=1,b.AT_TARGET=2,b.BUBBLING_PHASE=3,a.exports=b},55511:a=>{"use strict";a.exports=require("crypto")},56620:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=function(){this.rsv1=!1,this.rsv2=!1,this.rsv3=!1,this.opcode=null,this.length=0,this._chunks=[]},f={read:function(){return this.data=this.data||d.concat(this._chunks,this.length)},pushFrame:function(a){this.rsv1=this.rsv1||a.rsv1,this.rsv2=this.rsv2||a.rsv2,this.rsv3=this.rsv3||a.rsv3,null===this.opcode&&(this.opcode=a.opcode),this._chunks.push(a.payload),this.length+=a.length}};for(var g in f)e.prototype[g]=f[g];a.exports=e},62253:(a,b,c)=>{var d=c(79428),e=d.Buffer;function f(a,b){for(var c in a)b[c]=a[c]}function g(a,b,c){return e(a,b,c)}e.from&&e.alloc&&e.allocUnsafe&&e.allocUnsafeSlow?a.exports=d:(f(d,b),b.Buffer=g),g.prototype=Object.create(e.prototype),f(e,g),g.from=function(a,b,c){if("number"==typeof a)throw TypeError("Argument must not be a number");return e(a,b,c)},g.alloc=function(a,b,c){if("number"!=typeof a)throw TypeError("Argument must be a number");var d=e(a);return void 0!==b?"string"==typeof c?d.fill(b,c):d.fill(b):d.fill(0),d},g.allocUnsafe=function(a){if("number"!=typeof a)throw TypeError("Argument must be a number");return e(a)},g.allocUnsafeSlow=function(a){if("number"!=typeof a)throw TypeError("Argument must be a number");return d.SlowBuffer(a)}},62466:a=>{"use strict";var b=/([!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z]+)/,c=/([^!#\$%&'\*\+\-\.\^_`\|~0-9A-Za-z])/g,d=RegExp(b.source+"(?:=(?:"+b.source+"|"+/"((?:\\[\x00-\x7f]|[^\x00-\x08\x0a-\x1f\x7f"\\])*)"/.source+"))?"),e=RegExp(b.source+"(?: *; *"+d.source+")*","g"),f=RegExp("^"+e.source+"(?: *, *"+e.source+")*$"),g=/^-?(0|[1-9][0-9]*)(\.[0-9]+)?$/,h=Object.prototype.hasOwnProperty,i=function(){this._byName={},this._inOrder=[]};i.prototype.push=function(a,b){h.call(this._byName,a)||(this._byName[a]=[]),this._byName[a].push(b),this._inOrder.push({name:a,params:b})},i.prototype.eachOffer=function(a,b){for(var c=this._inOrder,d=0,e=c.length;d<e;d++)a.call(b,c[d].name,c[d].params)},i.prototype.byName=function(a){return this._byName[a]||[]},i.prototype.toArray=function(){return this._inOrder.slice()},a.exports={parseHeader:function(a){var b=new i;if(""===a||void 0===a)return b;if(!f.test(a))throw SyntaxError("Invalid Sec-WebSocket-Extensions header: "+a);return a.match(e).forEach(function(a){var c=a.match(RegExp(d.source,"g")),e=c.shift(),f={};c.forEach(function(a){var b,c=a.match(d),e=c[1];b=void 0!==c[2]?c[2]:void 0===c[3]||c[3].replace(/\\/g,""),g.test(b)&&(b=parseFloat(b)),h.call(f,e)?(f[e]=[].concat(f[e]),f[e].push(b)):f[e]=b},this),b.push(e,f)},this),b},serializeParams:function(a,b){var d=[],e=function(a,b){b instanceof Array?b.forEach(function(b){e(a,b)}):!0===b?d.push(a):"number"==typeof b?d.push(a+"="+b):c.test(b)?d.push(a+'="'+b.replace(/"/g,'\\"')+'"'):d.push(a+"="+b)};for(var f in b)e(f,b[f]);return[a].concat(d).join("; ")}}},63033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63416:(a,b,c)=>{"use strict";var d=c(27910).Stream,e=c(28354),f=function(a){this.readable=this.writable=!0,this._paused=!1,this._driver=a};e.inherits(f,d),f.prototype.pause=function(){this._paused=!0,this._driver.messages._paused=!0},f.prototype.resume=function(){this._paused=!1,this.emit("drain");var a=this._driver.messages;a._paused=!1,a.emit("drain")},f.prototype.write=function(a){return!!this.writable&&(this._driver.parse(a),!this._paused)},f.prototype.end=function(a){if(this.writable){void 0!==a&&this.write(a),this.writable=!1;var b=this._driver.messages;b.readable&&(b.readable=b.writable=!1,b.emit("end"))}},f.prototype.destroy=function(){this.end()};var g=function(a){this.readable=this.writable=!0,this._paused=!1,this._driver=a};e.inherits(g,d),g.prototype.pause=function(){this._driver.io._paused=!0},g.prototype.resume=function(){this._driver.io._paused=!1,this._driver.io.emit("drain")},g.prototype.write=function(a){return!!this.writable&&("string"==typeof a?this._driver.text(a):this._driver.binary(a),!this._paused)},g.prototype.end=function(a){void 0!==a&&this.write(a)},g.prototype.destroy=function(){},b.IO=f,b.Messages=g},63995:(a,b,c)=>{"use strict";var d=c(28354),e=c(91645),f=c(34631),g=c(79551),h=c(94519),i=c(99826);c(50501);var j={"http:":80,"https:":443,"ws:":80,"wss:":443},k=["https:","wss:"],l=function(a,b,c){c=c||{},this.url=a,this._driver=h.client(this.url,{maxLength:c.maxLength,protocols:b}),["open","error"].forEach(function(a){this._driver.on(a,function(){s.headers=s._driver.headers,s.statusCode=s._driver.statusCode})},this);var d=c.proxy||{},l=g.parse(d.origin||this.url),m=l.port||j[l.protocol],n=k.indexOf(l.protocol)>=0,o=function(){s._onConnect()},p=c.net||{},q=c.tls||{},r=d.origin?d.tls||{}:q,s=this;p.host=r.host=l.hostname,p.port=r.port=m,q.ca=q.ca||c.ca,r.servername=r.servername||l.hostname,this._stream=n?f.connect(r,o):e.connect(p,o),d.origin&&this._configureProxy(d,q),i.call(this,c)};d.inherits(l,i),l.prototype._onConnect=function(){(this._proxy||this._driver).start()},l.prototype._configureProxy=function(a,b){var c,d=g.parse(this.url),e=k.indexOf(d.protocol)>=0,h=this;if(this._proxy=this._driver.proxy(a.origin),a.headers)for(c in a.headers)this._proxy.setHeader(c,a.headers[c]);this._proxy.pipe(this._stream,{end:!1}),this._stream.pipe(this._proxy),this._proxy.on("connect",function(){if(e){var a={socket:h._stream,servername:d.hostname};for(c in b)a[c]=b[c];h._stream=f.connect(a),h._configureStream()}h._driver.io.pipe(h._stream),h._stream.pipe(h._driver.io),h._driver.start()}),this._proxy.on("error",function(a){h._driver.emit("error",a)})},a.exports=l},66186:a=>{"use strict";var b=function(){},c={final:!1,rsv1:!1,rsv2:!1,rsv3:!1,opcode:null,masked:!1,maskingKey:null,lengthBytes:1,length:0,payload:null};for(var d in c)b.prototype[d]=c[d];a.exports=b},68108:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{"0004c295195cb02aa74b7e03b9ab47835262f651f3":()=>i._u,"00454095f373f8afcf3cd8b88a3e9643ba6181edb6":()=>e.y4,"005773e734ccf3535fa61ed9b34042d47625b1ede6":()=>f.O0,"006a7d18b222ac9fd27f636e3f60be09c88c550762":()=>l.ib,"00afcee30c25fc6521aeaf596fabd0fef5e0ca707f":()=>f.qV,"00d790a9c67325f46e1dda5ba33e59ecfd95062466":()=>e.HW,"400c0115434cd29d4eca4428f9840cb7a074049ed1":()=>n.EZ,"400c84b00cbc18181ec896b17d3329ab44688122ee":()=>q.q,"400e621b7f78c4800cffc85d668ca10cd73eb6853c":()=>g.Lf,"4013135d45b93942093eced825516b1e20941831b7":()=>p.d,"401b140032a44590c12253e287a8d7d0383408525e":()=>h.lc,"40211bb4321aca8530a09b81e44f46cc59da30c2c4":()=>n.KB,"40213622e57351942781ff52345df063ded4056884":()=>e.Sm,"40290c8e8678ea3c7dc08bc14a2b21bf84ced558a3":()=>f.lo,"403331dfc341d9a7f9cbe156b5d10cfd49a20be531":()=>g.d5,"40341251e8d632597ecf83a7ab87f3793a83f06b51":()=>o.r,"403c01bdb267219d16430eb023611daabec8b63ec8":()=>j.nX,"405181b3416ca6fb6435ab9096a0a68342e5255501":()=>k.u,"405872236907704344162aca1c38160d1eac727fe8":()=>g.DI,"405ce651eeff5dd6c93f3965b62049b45a42e5a7d4":()=>j.LD,"406818275705b776627a9e14558eaa7857fbec9b73":()=>f.ht,"406c8a5fa8b6f219b1d6c0d2ed6d4215e348e5c534":()=>n.Lf,"407ad343a0d07dddd296d749ab0d60ad67dfc5bb39":()=>j.rC,"4085652545b10cc37283ef55992935bd43a8ce947e":()=>g.zZ,"4085aac590f12a4a641b5bc7fff47d5353af49510e":()=>e.S,"408c54ad33973364b68d8475849f76b4a4ca590722":()=>g.EP,"408c94c431661ae65070856bc4a78d84f2cbfcba1c":()=>g.EZ,"408d4523c5fa8dbd353900a15d896d0ebee083358b":()=>e.X7,"40939e0ffddd5729906956a18bd5a10b991b0ccc8b":()=>n.d5,"409ba91156ff082c07d90f218ef67bfea8be50f67c":()=>n.DI,"409ee2d098a25e0103bd4e5cbd3c84c821bce98df9":()=>h.fW,"40b3f399476b2e0c0084bb235048022f7151d8d61a":()=>l.Qt,"40bd3493b6cd183a3f75aa7b2dffe9f325b07a2b9d":()=>i.Xx,"40c15e87ca74d3ad5ae09fdc0c6d9616384469f25f":()=>m._,"40c58d0bc8d4f91d67a942b18e51dcb1bf43076f6e":()=>n.zZ,"40d0448bacb32a373d23394258f9e7de4aa7fd38a9":()=>n.EP,"40d4790cf5bfe15d462399ad8c52d1baec8babf86f":()=>f.nu,"40e13d085ff779b8dfbb82e790ebb21702ce079192":()=>f.Cm,"40ef77a697a84cf599002575e6afc4c1de58c3cdab":()=>f.hG,"40f4619201eea9704cbf15357e730e9458fc66e834":()=>g.KB,"40fc6757a7ed8ba6cf86a7bf30e6bf0934f153f439":()=>e.Lx,"6011fc1c38056bdf4ffec77b46cde7479e7bed0ffe":()=>j.vL,"601532f3b7a46dae258a5ff32f14fb4b3e2e141e9f":()=>f.TK,"601838acb9f969bfd30fa9f583c86dd453b19524dd":()=>f.v_,"6023146a7bfefc423ba02712c56694a31432de707c":()=>g.zO,"6052254d233f0ea6b36992b2b81ce07178dee95ad7":()=>l.oS,"6073e98acf09f5000817ebcdd05234acc9c4d29f85":()=>h.rj,"6095092e7df48b6be6bd48b6d0c17d16afc7b4de53":()=>r.d,"60e34f9cbe57141cf2262bc166578e2d558a98e99f":()=>n.zO,"60eed12072721bc1c2c48214672b423b5d4cc8a6f3":()=>m.L,"7003bafa516cae88838b2870c227bb8f7b1ef595ec":()=>j.Nb,"70303f32e5ed8b56558bdc328a329d038fd2e61ace":()=>j.I0,"7036a92c4c51de937e481f7c0d6bc541b735f99157":()=>j.k5,"704baf0749912d6e636a66524e43f80ce5c8454d38":()=>j.xo,"70a2ee919f2d86ac514a326d140a0804c759a4d955":()=>j.Kq,"7efe1f798361b3ef301fd7b48f8f3206292a2cecba":()=>j.AZ,"7f085acd10c7b589563e59e7e18d605a9cf6eb6b56":()=>h.cl,"7f33ef79ae72de1c2db1340cf81f1c0a0a525a8033":()=>e.kl,"7f33fcd02c8b1dfc136d21fd7035ce40fe2d48b135":()=>e.ht,"7f4fa596b78e1050be57bd23eeef63bf754e59a5c8":()=>l.xi,"7f56b7b077f6ef503c674aaefafd2b7951d91adaa8":()=>j.LQ,"7f7cc5ac28f76953e580388c96325185bdb57f592c":()=>e.EZ,"7faf63d9d8686c0ff053833c82fd60b3e9c6fa0bff":()=>e.$T,"7fbd1d6bc63ebe1b1eeb689b35afc9c8cba834559f":()=>j.f9,"7fc073ecd1a2a3a687a33b240d39c28a9944119247":()=>l.Z7,"7fe3cedf8b5b39f6ca6561f08402f1ad7a82ecff97":()=>i.mt,"7fff34be9ad53d22bcedbe289fd19cffbcbb61a920":()=>j.ro});var e=c(62641),f=c(90521),g=c(95378),h=c(94762),i=c(54756),j=c(24799),k=c(28541),l=c(18210),m=c(87965),n=c(39661),o=c(13732),p=c(40982),q=c(33875),r=c(8245),s=a([e,f,g,h,i,j,k,l,m,n,o,p,q,r]);[e,f,g,h,i,j,k,l,m,n,o,p,q,r]=s.then?(await s)():s,d()}catch(a){d(a)}})},69727:(a,b,c)=>{"use strict";var d=c(4717),e=function(a,b){this._session=a,this._method=b,this._queue=new d(e.QUEUE_SIZE),this._stopped=!1,this.pending=0};e.QUEUE_SIZE=8,e.prototype.call=function(a,b,c,d){if(!this._stopped){var e={error:a,message:b,callback:c,context:d,done:!1},f=!1,g=this;if(this._queue.push(e),e.error)return e.done=!0,this._stop(),this._flushQueue();var h=function(a,b){f^(f=!0)&&(a?(g._stop(),e.error=a,e.message=null):e.message=b,e.done=!0,g._flushQueue())};try{this._session[this._method](b,h)}catch(a){h(a)}}},e.prototype._stop=function(){this.pending=this._queue.length,this._stopped=!0},e.prototype._flushQueue=function(){for(var a,b=this._queue;b.length>0&&b.peek().done;)(a=b.shift()).error?(this.pending=0,b.clear()):this.pending-=1,a.callback.call(a.context,a.error,a.message)},a.exports=e},72153:(a,b,c)=>{"use strict";var d=c(28354),e=c(31531),f=c(28647),g=c(93867),h=c(6094),i=c(31820),j=function(a){f.call(this,null,null,a),this._http=new e("request")};d.inherits(j,f);var k={EVENTS:["open","message","error","close","ping","pong"],_bindEventListeners:function(){this.messages.on("error",function(){}),this.on("error",function(){})},parse:function(a){if(this._delegate)return this._delegate.parse(a);if(this._http.parse(a),this._http.isComplete()){this.method=this._http.method,this.url=this._http.url,this.headers=this._http.headers,this.body=this._http.body;var b=this;this._delegate=j.http(this,this._options),this._delegate.messages=this.messages,this._delegate.io=this.io,this._open(),this.EVENTS.forEach(function(a){this._delegate.on(a,function(c){b.emit(a,c)})},this),this.protocol=this._delegate.protocol,this.version=this._delegate.version,this.parse(this._http.body),this.emit("connect",new f.ConnectEvent)}},_open:function(){this.__queue.forEach(function(a){this._delegate[a[0]].apply(this._delegate,a[1])},this),this.__queue=[]}};for(var l in["addExtension","setHeader","start","frame","text","binary","ping","close"].forEach(function(a){k[a]=function(){return this._delegate?this._delegate[a].apply(this._delegate,arguments):(this.__queue.push([a,arguments]),!0)}}),k)j.prototype[l]=k[l];j.isSecureRequest=function(a){if(a.connection&&void 0!==a.connection.authorized||a.socket&&a.socket.secure)return!0;var b=a.headers;return!!b&&("on"===b.https||"on"===b["x-forwarded-ssl"]||"https"===b["x-forwarded-scheme"]||"https"===b["x-forwarded-proto"])},j.determineUrl=function(a){return(this.isSecureRequest(a)?"wss:":"ws:")+"//"+a.headers.host+a.url},j.http=function(a,b){void 0===(b=b||{}).requireMasking&&(b.requireMasking=!0);var c=a.headers,d=c["sec-websocket-version"],e=c["sec-websocket-key"],f=c["sec-websocket-key1"],j=c["sec-websocket-key2"],k=this.determineUrl(a);return d||e?new i(a,k,b):f||j?new h(a,k,b):new g(a,k,b)},a.exports=j},73496:a=>{"use strict";a.exports=require("http2")},74075:a=>{"use strict";a.exports=require("zlib")},77018:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=function(){this._queue=[],this._queueSize=0,this._offset=0};e.prototype.put=function(a){a&&0!==a.length&&(d.isBuffer(a)||(a=d.from(a)),this._queue.push(a),this._queueSize+=a.length)},e.prototype.read=function(a){if(a>this._queueSize)return null;if(0===a)return d.alloc(0);this._queueSize-=a;var b,c,e=this._queue,f=a,g=e[0];if(g.length>=a)if(g.length===a)return e.shift();else return c=g.slice(0,a),e[0]=g.slice(a),c;for(var h=0,i=e.length;h<i&&!(f<e[h].length);h++)f-=e[h].length;return b=e.splice(0,h),f>0&&e.length>0&&(b.push(e[0].slice(0,f)),e[0]=e[0].slice(f)),d.concat(b,a)},e.prototype.eachByte=function(a,b){for(var c,d,e;this._queue.length>0;){for(d=(c=this._queue[0]).length;this._offset<d;)e=this._offset,this._offset+=1,a.call(b,c[e]);this._offset=0,this._queue.shift()}},a.exports=e},77335:(a,b,c)=>{"use strict";var d=c(62466),e=c(33412),f=function(){this._rsv1=this._rsv2=this._rsv3=null,this._byName={},this._inOrder=[],this._sessions=[],this._index={}};f.MESSAGE_OPCODES=[1,2];var g={add:function(a){if("string"!=typeof a.name)throw TypeError("extension.name must be a string");if("permessage"!==a.type)throw TypeError('extension.type must be "permessage"');if("boolean"!=typeof a.rsv1)throw TypeError("extension.rsv1 must be true or false");if("boolean"!=typeof a.rsv2)throw TypeError("extension.rsv2 must be true or false");if("boolean"!=typeof a.rsv3)throw TypeError("extension.rsv3 must be true or false");if(this._byName.hasOwnProperty(a.name))throw TypeError('An extension with name "'+a.name+'" is already registered');this._byName[a.name]=a,this._inOrder.push(a)},generateOffer:function(){var a=[],b=[],c={};return this._inOrder.forEach(function(e){var f=e.createClientSession();if(f){var g=[e,f];a.push(g),c[e.name]=g;var h=f.generateOffer();(h=h?[].concat(h):[]).forEach(function(a){b.push(d.serializeParams(e.name,a))},this)}},this),this._sessions=a,this._index=c,b.length>0?b.join(", "):null},activate:function(a){var b=d.parseHeader(a),c=[];b.eachOffer(function(a,b){var e=this._index[a];if(!e)throw Error('Server sent an extension response for unknown extension "'+a+'"');var f=e[0],g=e[1],h=this._reserved(f);if(h)throw Error("Server sent two extension responses that use the RSV"+h[0]+' bit: "'+h[1]+'" and "'+f.name+'"');if(!0!==g.activate(b))throw Error("Server sent unacceptable extension parameters: "+d.serializeParams(a,b));this._reserve(f),c.push(e)},this),this._sessions=c,this._pipeline=new e(c)},generateResponse:function(a){var b=[],c=[],f=d.parseHeader(a);return this._inOrder.forEach(function(a){var e=f.byName(a.name);if(!(0===e.length||this._reserved(a))){var g=a.createServerSession(e);g&&(this._reserve(a),b.push([a,g]),c.push(d.serializeParams(a.name,g.generateResponse())))}},this),this._sessions=b,this._pipeline=new e(b),c.length>0?c.join(", "):null},validFrameRsv:function(a){var b,c={rsv1:!1,rsv2:!1,rsv3:!1};if(f.MESSAGE_OPCODES.indexOf(a.opcode)>=0)for(var d=0,e=this._sessions.length;d<e;d++)b=this._sessions[d][0],c.rsv1=c.rsv1||b.rsv1,c.rsv2=c.rsv2||b.rsv2,c.rsv3=c.rsv3||b.rsv3;return(c.rsv1||!a.rsv1)&&(c.rsv2||!a.rsv2)&&(c.rsv3||!a.rsv3)},processIncomingMessage:function(a,b,c){this._pipeline.processIncomingMessage(a,b,c)},processOutgoingMessage:function(a,b,c){this._pipeline.processOutgoingMessage(a,b,c)},close:function(a,b){if(!this._pipeline)return a.call(b);this._pipeline.close(a,b)},_reserve:function(a){this._rsv1=this._rsv1||a.rsv1&&a.name,this._rsv2=this._rsv2||a.rsv2&&a.name,this._rsv3=this._rsv3||a.rsv3&&a.name},_reserved:function(a){return this._rsv1&&a.rsv1?[1,this._rsv1]:this._rsv2&&a.rsv2?[2,this._rsv2]:!!this._rsv3&&!!a.rsv3&&[3,this._rsv3]}};for(var h in g)f.prototype[h]=g[h];a.exports=f},78829:(a,b,c)=>{"use strict";var d=c(50501);a.exports={onopen:null,onmessage:null,onerror:null,onclose:null,addEventListener:function(a,b,c){this.on(a,b)},removeEventListener:function(a,b,c){this.removeListener(a,b)},dispatchEvent:function(a){a.target=a.currentTarget=this,a.eventPhase=d.AT_TARGET,this["on"+a.type]&&this["on"+a.type](a),this.emit(a.type,a)}}},79428:a=>{"use strict";a.exports=require("buffer")},79466:(a,b,c)=>{"use strict";let d,e,f,g,h,i,j,k,l,m;c.r(b),c.d(b,{default:()=>dv});var n,o=c(21124),p=c(38301),q=c.n(p),r=c(45937),s=c(13737),t=c(63009),u=c(84407),v=c(38692),w=c(10656),x=c(9683),y=c(49113),z=c(23727),A=c(44943),B=c(28165),C=c(38533),D=c(93758),E=c(27184),F=c(40068);c(79541);var G=c(85708);let H=(0,G.createServerReference)("6095092e7df48b6be6bd48b6d0c17d16afc7b4de53",G.callServer,void 0,G.findSourceMapURL,"createOrGetDirectChat");var I=c(80665);function J({children:a,onChatCreated:b}){let[c,d]=(0,p.useState)(!1),[e,f]=(0,p.useState)(""),[g,h]=(0,p.useState)([]),[i,j]=(0,p.useState)(!1),[k,l]=(0,p.useState)(!1),m=(0,E.d)(e,200),{user:n}=(0,t.A)(),q=(0,p.useMemo)(()=>{if(!m)return g;let a=m.toLowerCase();return g.filter(b=>b.name.toLowerCase().includes(a)||b.email.toLowerCase().includes(a))},[g,m]),r=async a=>{if(n&&"uid"in n){l(!0);try{let c=await H(n.uid,a.uid);b(c),d(!1),f("")}catch(a){console.error("Failed to create or get chat",a)}finally{l(!1)}}};return(0,o.jsxs)(F.lG,{open:c,onOpenChange:d,children:[(0,o.jsx)(F.zM,{asChild:!0,children:a}),(0,o.jsxs)(F.Cf,{children:[(0,o.jsxs)(F.c7,{children:[(0,o.jsx)(F.L3,{children:"  "}),(0,o.jsx)(F.rr,{children:"      ."})]}),(0,o.jsxs)("div",{className:"py-4",children:[(0,o.jsxs)("div",{className:"relative",children:[(0,o.jsx)(x.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,o.jsx)(D.p,{placeholder:"    ...",className:"pl-10",value:e,onChange:a=>f(a.target.value)})]}),(0,o.jsxs)(I.F,{className:"mt-4 space-y-2 max-h-64",children:[i&&(0,o.jsx)("div",{className:"flex justify-center p-4",children:(0,o.jsx)(y.A,{className:"animate-spin"})}),!i&&q.map(a=>(0,o.jsxs)("div",{className:"flex items-center justify-between p-2 rounded-lg hover:bg-muted cursor-pointer",onClick:()=>r(a),children:[(0,o.jsxs)("div",{className:"flex items-center gap-3",children:[(0,o.jsxs)(z.eu,{children:[(0,o.jsx)(z.BK,{src:a.avatarUrl}),(0,o.jsx)(z.q5,{children:a.name.charAt(0)})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("p",{className:"font-semibold",children:a.name}),(0,o.jsx)("p",{className:"text-sm text-muted-foreground",children:a.email})]})]}),k&&(0,o.jsx)(y.A,{className:"animate-spin h-4 w-4"})]},a.uid)),!i&&0===q.length&&(0,o.jsx)("div",{className:"text-center p-4 text-muted-foreground",children:e?"    .":"   ."})]})]})]})]})}var K=c(99187),L=c(35284);function M({onSelectChat:a,selectedChatId:b}){let[c,d]=(0,p.useState)([]),[e,f]=(0,p.useState)(!0),[g,h]=(0,p.useState)(""),i=(0,E.d)(g,300),{user:j}=(0,t.A)(),k=async b=>{if(a(b),j&&"uid"in j){let a=(0,r.H9)(s.db,`userChats/${j.uid}/summaries/${b}`),c=await getDoc(a);if(c.exists()&&c.data().unreadCount>0){let b=(0,r.wP)(s.db);b.update(a,{unreadCount:0}),await b.commit()}}},l=(0,p.useMemo)(()=>i?c.filter(a=>{let b="group"===a.type?a.title:a.otherMemberName;return b?.toLowerCase().includes(i.toLowerCase())}):c,[c,i]);return j&&"uid"in j?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:"p-3 border-b sticky top-0 bg-background z-10",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,o.jsx)("h2",{className:"text-xl font-bold",children:""}),(0,o.jsx)(J,{onChatCreated:b=>a(b),children:(0,o.jsx)(L.$,{variant:"ghost",size:"icon",children:(0,o.jsx)(w.A,{className:"h-5 w-5"})})})]}),(0,o.jsxs)("div",{className:"relative",children:[(0,o.jsx)(x.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,o.jsx)(D.p,{placeholder:"...",className:"ps-10",value:g,onChange:a=>h(a.target.value)})]})]}),(0,o.jsx)(I.F,{className:"flex-1",children:e?(0,o.jsx)("div",{className:"flex justify-center items-center h-full p-8",children:(0,o.jsx)(y.A,{className:"animate-spin"})}):0===l.length?(0,o.jsx)("div",{className:"text-center p-8 text-muted-foreground",children:"  ."}):(0,o.jsx)("div",{className:"p-2 space-y-1",children:l.map(a=>{let{name:c,avatarUrl:d}="group"===a.type?{name:a.title||"",avatarUrl:a.avatarUrl,icon:(0,o.jsx)(u.A,{className:"h-5 w-5"})}:{name:a.otherMemberName||"",avatarUrl:a.otherMemberAvatar,icon:(0,o.jsx)(v.A,{className:"h-5 w-5"})},e=a.lastMessage,f=b===a.id;return(0,o.jsxs)("button",{className:(0,A.cn)("w-full text-right p-3 rounded-lg hover:bg-muted transition-colors flex items-center gap-3",f&&"bg-primary/10"),onClick:()=>k(a.id),children:[(0,o.jsxs)(z.eu,{className:"h-12 w-12 border",children:[(0,o.jsx)(z.BK,{src:d}),(0,o.jsx)(z.q5,{children:c?.charAt(0)})]}),(0,o.jsxs)("div",{className:"flex-grow overflow-hidden",children:[(0,o.jsxs)("div",{className:"flex justify-between items-center",children:[(0,o.jsx)("p",{className:"font-bold truncate",children:c}),(0,o.jsx)("p",{className:"text-xs text-muted-foreground shrink-0",children:e?.createdAt&&(0,B.m)(e.createdAt.toDate(),{addSuffix:!0,locale:C.ar})})]}),(0,o.jsxs)("div",{className:"flex justify-between items-center mt-1",children:[(0,o.jsx)("p",{className:"text-sm text-muted-foreground truncate",children:e?.text||" "}),a.unreadCount>0&&(0,o.jsx)(K.E,{className:"w-5 h-5 flex items-center justify-center p-0",children:a.unreadCount})]})]})]},a.id)})})})]}):(0,o.jsx)("div",{className:"flex justify-center items-center h-full p-8 text-muted-foreground text-center",children:"    ."})}var N=c(63822);function O({chatId:a,msg:b}){let[c,d]=(0,p.useState)(!1),[e,f]=(0,p.useState)(b.text||""),{user:g}=(0,t.A)(),h=b.senderId===g?.uid;return(0,o.jsxs)("div",{className:(0,A.cn)("flex items-end gap-2 my-2",h?"justify-end":"justify-start"),children:[!h&&(0,o.jsxs)(z.eu,{className:"h-8 w-8",children:[(0,o.jsx)(z.BK,{src:b.senderAvatarUrl}),(0,o.jsx)(z.q5,{children:b.senderName?.charAt(0)||"U"})]}),(0,o.jsxs)("div",{className:(0,A.cn)("p-3 rounded-2xl max-w-lg shadow-sm",h?"bg-primary text-primary-foreground rounded-br-none":"bg-muted rounded-bl-none"),children:[!h&&(0,o.jsx)("p",{className:"text-xs font-bold mb-1",children:b.senderName}),(0,o.jsx)("p",{className:"whitespace-pre-wrap text-sm",children:b.deleted?(0,o.jsx)("i",{children:"   "}):b.text}),(0,o.jsxs)("p",{className:(0,A.cn)("text-xs mt-1 text-right",h?"text-primary-foreground/70":"text-muted-foreground"),children:[b.createdAt?.toDate()?(0,N.GP)(b.createdAt.toDate(),"p",{locale:C.ar}):"",b.editedAt&&" ( )"]})]}),h&&(0,o.jsxs)(z.eu,{className:"h-8 w-8",children:[(0,o.jsx)(z.BK,{src:b.senderAvatarUrl}),(0,o.jsx)(z.q5,{children:b.senderName?.charAt(0)||"U"})]})]})}var P=c(33525),Q=c(15003),R=c(37448);function S({onUpload:a,children:b,chatId:c}){let[d,e]=(0,p.useState)(!1),{toast:f}=(0,R.dj)(),g=q().useRef(null),h=async b=>{let d=b.target.files;if(!d?.length||!c)return;e(!0),f({title:"  ..."});let h=(0,P.c7)(),i=[];try{for(let a of Array.from(d)){let b=`chat_attachments/${c}/${Date.now()}_${(0,Q.A)()}_${a.name}`,d=(0,P.KR)(h,b);await (0,P.bp)(d,a);let e=await (0,P.qk)(d);i.push({name:a.name,path:b,url:e,size:a.size,type:a.type})}a(i),f({title:"   "})}catch(a){f({title:"  ",description:a.message,variant:"destructive"})}finally{e(!1),g.current&&(g.current.value="")}};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("input",{type:"file",multiple:!0,onChange:h,className:"hidden",ref:g,disabled:d}),(0,o.jsx)("div",{onClick:()=>{g.current?.click()},className:"cursor-pointer",children:d?(0,o.jsx)(y.A,{className:"animate-spin"}):b})]})}let T=(0,c(8808).A)("Paperclip",[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]]);var U=c(94429),V=c(27081);let W=({chatId:a})=>{let[b,c]=(0,p.useState)(null),[d,e]=(0,p.useState)(!0),{user:f}=(0,t.A)();return((0,p.useEffect)(()=>{if(!f||!a)return;let b=(0,r.H9)(s.db,`userChats/${f.uid}/summaries/${a}`),d=(0,r.aQ)(b,a=>{a.exists()&&c(a.data()),e(!1)});return()=>d()},[a,f]),d)?(0,o.jsxs)("div",{className:"p-3 border-b flex items-center gap-3",children:[(0,o.jsx)(V.E,{className:"h-10 w-10 rounded-full"}),(0,o.jsx)(V.E,{className:"h-6 w-32"})]}):(0,o.jsxs)("div",{className:"p-3 border-b flex items-center gap-3 bg-card sticky top-0 z-10",children:[(0,o.jsxs)(z.eu,{children:[(0,o.jsx)(z.BK,{src:b?.otherMemberAvatar}),(0,o.jsx)(z.q5,{children:b?.otherMemberName?.charAt(0)})]}),(0,o.jsxs)("div",{children:[(0,o.jsx)("p",{className:"font-bold",children:b?.otherMemberName}),(0,o.jsx)("p",{className:"text-xs text-muted-foreground",children:""})]})]})};function X({chatId:a}){let[b,c]=(0,p.useState)([]),[d,e]=(0,p.useState)(!1),[f,g]=(0,p.useState)(null),[h,i]=(0,p.useState)(""),{user:j}=(0,t.A)(),k=(0,p.useRef)(null),l=async(b,c)=>{let d=b||h;if(!j||!d.trim()&&!c)return;let e=(0,r.rJ)(s.db,`chats/${a}/messages`),f={senderId:j.uid,senderName:j.name,senderAvatarUrl:j.avatarUrl||null,createdAt:(0,r.O5)()};d.trim()&&(f.text=d.trim()),c&&(f.attachments=c),await (0,r.gS)(e,f);let g=(0,r.H9)(s.db,`chats/${a}`),k=(0,r.wP)(s.db),l={text:d.trim()||" ",senderId:j.uid,createdAt:(0,r.O5)()};k.update(g,{lastMessage:l,updatedAt:(0,r.O5)()});let m=await (0,r.x7)(g);m.exists()&&Object.keys(m.data().members).forEach(b=>{let c=(0,r.H9)(s.db,`userChats/${b}/summaries/${a}`),d={lastMessage:l,updatedAt:(0,r.O5)()};b!==j.uid&&(d.unreadCount=(0,r.GV)(1)),k.update(c,d)}),await k.commit(),i("")};return(0,o.jsxs)("div",{className:"flex flex-col h-full bg-background overflow-hidden",children:[(0,o.jsx)(W,{chatId:a}),(0,o.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,o.jsxs)(I.F,{className:"h-full p-4",children:[b.map(b=>(0,o.jsx)(O,{chatId:a,msg:b},b.id)),(0,o.jsx)("div",{ref:k})]})}),(0,o.jsxs)("div",{className:"p-4 border-t flex items-center gap-2 bg-card",children:[(0,o.jsx)(S,{chatId:a,onUpload:a=>l(void 0,a),children:(0,o.jsx)(L.$,{variant:"ghost",size:"icon",children:(0,o.jsx)(T,{})})}),(0,o.jsx)(D.p,{value:h,onChange:a=>i(a.target.value),placeholder:" ...",onKeyDown:a=>"Enter"===a.key&&l(),className:"bg-muted border-muted-foreground/20 focus-visible:ring-primary"}),(0,o.jsx)(L.$,{onClick:()=>l(),disabled:!h.trim(),children:(0,o.jsx)(U.A,{})})]})]})}var Y=c(9757),Z=c(8191),$=c(86408),_=c(58141),aa=c(23637);let ab=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,ac="websocket",ad="long_polling";class ae{constructor(a){this.domStorage_=a,this.prefix_="firebase:"}set(a,b){null==b?this.domStorage_.removeItem(this.prefixedName_(a)):this.domStorage_.setItem(this.prefixedName_(a),(0,Z.As)(b))}get(a){let b=this.domStorage_.getItem(this.prefixedName_(a));return null==b?null:(0,Z.$L)(b)}remove(a){this.domStorage_.removeItem(this.prefixedName_(a))}prefixedName_(a){return this.prefix_+a}toString(){return this.domStorage_.toString()}}class af{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(a,b){null==b?delete this.cache_[a]:this.cache_[a]=b}get(a){return(0,Z.gR)(this.cache_,a)?this.cache_[a]:null}remove(a){delete this.cache_[a]}}let ag=function(a){try{if("undefined"!=typeof window&&void 0!==window[a]){let b=window[a];return b.setItem("firebase:sentinel","cache"),b.removeItem("firebase:sentinel"),new ae(b)}}catch(a){}return new af},ah=ag("localStorage"),ai=ag("sessionStorage"),aj=new $.Vy("@firebase/database"),ak=function(){let a=1;return function(){return a++}}(),al=function(a){let b=(0,Z.kj)(a),c=new Z.gz;c.update(b);let d=c.digest();return Z.K3.encodeByteArray(d)},am=function(...a){let b="";for(let c=0;c<a.length;c++){let d=a[c];Array.isArray(d)||d&&"object"==typeof d&&"number"==typeof d.length?b+=am.apply(null,d):"object"==typeof d?b+=(0,Z.As)(d):b+=d,b+=" "}return b},an=null,ao=!0,ap=function(a,b){(0,Z.vA)(!b||!0===a||!1===a,"Can't turn on custom loggers persistently."),!0===a?(aj.logLevel=$.$b.VERBOSE,an=aj.log.bind(aj),b&&ai.set("logging_enabled",!0)):"function"==typeof a?an=a:(an=null,ai.remove("logging_enabled"))},aq=function(...a){if(!0===ao&&(ao=!1,null===an&&!0===ai.get("logging_enabled")&&ap(!0)),an){let b=am.apply(null,a);an(b)}},ar=function(a){return function(...b){aq(a,...b)}},as=function(...a){let b="FIREBASE INTERNAL ERROR: "+am(...a);aj.error(b)},at=function(...a){let b=`FIREBASE FATAL ERROR: ${am(...a)}`;throw aj.error(b),Error(b)},au=function(...a){let b="FIREBASE WARNING: "+am(...a);aj.warn(b)},av=function(){"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&au("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},aw=function(a){return"number"==typeof a&&(a!=a||a===1/0||a===-1/0)},ax=function(a){if((0,Z.$g)()||"complete"===document.readyState)a();else{let b=!1,c=function(){if(!document.body)return void setTimeout(c,Math.floor(10));b||(b=!0,a())};document.addEventListener?(document.addEventListener("DOMContentLoaded",c,!1),window.addEventListener("load",c,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&c()}),window.attachEvent("onload",c))}},ay="[MIN_NAME]",az="[MAX_NAME]",aA=function(a,b){if(a===b)return 0;{if(a===ay||b===az)return -1;if(b===ay||a===az)return 1;let c=aI(a),d=aI(b);if(null!==c)if(null!==d)return c-d==0?a.length-b.length:c-d;else return -1;return null!==d?1:a<b?-1:1}},aB=function(a,b){return a===b?0:a<b?-1:1},aC=function(a,b){if(b&&a in b)return b[a];throw Error("Missing required key ("+a+") in object: "+(0,Z.As)(b))},aD=function(a){if("object"!=typeof a||null===a)return(0,Z.As)(a);let b=[];for(let c in a)b.push(c);b.sort();let c="{";for(let d=0;d<b.length;d++)0!==d&&(c+=","),c+=(0,Z.As)(b[d]),c+=":",c+=aD(a[b[d]]);return c+"}"},aE=function(a,b){let c=a.length;if(c<=b)return[a];let d=[];for(let e=0;e<c;e+=b)e+b>c?d.push(a.substring(e,c)):d.push(a.substring(e,e+b));return d};function aF(a,b){for(let c in a)a.hasOwnProperty(c)&&b(c,a[c])}let aG=function(a){let b,c,d,e,f;(0,Z.vA)(!aw(a),"Invalid JSON number");0===a?(c=0,d=0,b=+(1/a==-1/0)):(b=a<0,(a=Math.abs(a))>=22250738585072014e-324?(c=(e=Math.min(Math.floor(Math.log(a)/Math.LN2),1023))+1023,d=Math.round(a*Math.pow(2,52-e)-0x10000000000000)):(c=0,d=Math.round(a/5e-324)));let g=[];for(f=52;f;f-=1)g.push(d%2?1:0),d=Math.floor(d/2);for(f=11;f;f-=1)g.push(c%2?1:0),c=Math.floor(c/2);g.push(+!!b),g.reverse();let h=g.join(""),i="";for(f=0;f<64;f+=8){let a=parseInt(h.substr(f,8),2).toString(16);1===a.length&&(a="0"+a),i+=a}return i.toLowerCase()},aH=RegExp("^-?(0*)\\d{1,10}$"),aI=function(a){if(aH.test(a)){let b=Number(a);if(b>=-0x80000000&&b<=0x7fffffff)return b}return null},aJ=function(a){try{a()}catch(a){setTimeout(()=>{throw au("Exception was thrown by user callback.",a.stack||""),a},Math.floor(0))}},aK=function(a,b){let c=setTimeout(a,b);return"number"==typeof c&&"undefined"!=typeof Deno&&Deno.unrefTimer?Deno.unrefTimer(c):"object"==typeof c&&c.unref&&c.unref(),c};class aL{constructor(a,b,c,d,e=!1,f="",g=!1,h=!1,i=null){this.secure=b,this.namespace=c,this.webSocketOnly=d,this.nodeAdmin=e,this.persistenceKey=f,this.includeNamespaceInQueryParams=g,this.isUsingEmulator=h,this.emulatorOptions=i,this._host=a.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=ah.get("host:"+a)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(a){a!==this.internalHost&&(this.internalHost=a,this.isCacheableHost()&&ah.set("host:"+this._host,this.internalHost))}toString(){let a=this.toURLString();return this.persistenceKey&&(a+="<"+this.persistenceKey+">"),a}toURLString(){let a=this.secure?"https://":"http://",b=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${a}${this.host}/${b}`}}function aM(a,b,c){let d;if((0,Z.vA)("string"==typeof b,"typeof type must == string"),(0,Z.vA)("object"==typeof c,"typeof params must == object"),b===ac)d=(a.secure?"wss://":"ws://")+a.internalHost+"/.ws?";else if(b===ad)d=(a.secure?"https://":"http://")+a.internalHost+"/.lp?";else throw Error("Unknown connection type: "+b);(a.host!==a.internalHost||a.isCustomHost()||a.includeNamespaceInQueryParams)&&(c.ns=a.namespace);let e=[];return aF(c,(a,b)=>{e.push(a+"="+b)}),d+e.join("&")}class aN{constructor(){this.counters_={}}incrementCounter(a,b=1){(0,Z.gR)(this.counters_,a)||(this.counters_[a]=0),this.counters_[a]+=b}get(){return(0,Z.A4)(this.counters_)}}let aO={},aP={};function aQ(a){let b=a.toString();return aO[b]||(aO[b]=new aN),aO[b]}let aR="",aS=null;"undefined"!=typeof MozWebSocket?aS=MozWebSocket:"undefined"!=typeof WebSocket&&(aS=WebSocket);class aT{constructor(a,b,c,d,e,f,g){this.connId=a,this.applicationId=c,this.appCheckToken=d,this.authToken=e,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=ar(this.connId),this.stats_=aQ(b),this.connURL=aT.connectionURL_(b,f,g,d,c),this.nodeAdmin=b.nodeAdmin}static connectionURL_(a,b,c,d,e){let f={};return f.v="5",!(0,Z.$g)()&&"undefined"!=typeof location&&location.hostname&&ab.test(location.hostname)&&(f.r="f"),b&&(f.s=b),c&&(f.ls=c),d&&(f.ac=d),e&&(f.p=e),aM(a,ac,f)}open(a,b){this.onDisconnect=b,this.onMessage=a,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,ah.set("previous_websocket_failure",!0);try{let a;if((0,Z.$g)()){let b=this.nodeAdmin?"AdminNode":"Node";a={headers:{"User-Agent":`Firebase/5/${aR}/${process.platform}/${b}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(a.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(a.headers["X-Firebase-AppCheck"]=this.appCheckToken);let c=process.env,d=0===this.connURL.indexOf("wss://")?c.HTTPS_PROXY||c.https_proxy:c.HTTP_PROXY||c.http_proxy;d&&(a.proxy={origin:d})}this.mySock=new aS(this.connURL,[],a)}catch(b){this.log_("Error instantiating WebSocket.");let a=b.message||b.data;a&&this.log_(a),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=a=>{this.handleIncomingFrame(a)},this.mySock.onerror=a=>{this.log_("WebSocket error.  Closing connection.");let b=a.message||a.data;b&&this.log_(b),this.onClosed_()}}start(){}static forceDisallow(){aT.forceDisallow_=!0}static isAvailable(){let a=!1;if("undefined"!=typeof navigator&&navigator.userAgent){let b=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);b&&b.length>1&&4.4>parseFloat(b[1])&&(a=!0)}return!a&&null!==aS&&!aT.forceDisallow_}static previouslyFailed(){return ah.isInMemoryStorage||!0===ah.get("previous_websocket_failure")}markConnectionHealthy(){ah.remove("previous_websocket_failure")}appendFrame_(a){if(this.frames.push(a),this.frames.length===this.totalFrames){let a=this.frames.join("");this.frames=null;let b=(0,Z.$L)(a);this.onMessage(b)}}handleNewFrameCount_(a){this.totalFrames=a,this.frames=[]}extractFrameCount_(a){if((0,Z.vA)(null===this.frames,"We already have a frame buffer"),a.length<=6){let b=Number(a);if(!isNaN(b))return this.handleNewFrameCount_(b),null}return this.handleNewFrameCount_(1),a}handleIncomingFrame(a){if(null===this.mySock)return;let b=a.data;if(this.bytesReceived+=b.length,this.stats_.incrementCounter("bytes_received",b.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(b);else{let a=this.extractFrameCount_(b);null!==a&&this.appendFrame_(a)}}send(a){this.resetKeepAlive();let b=(0,Z.As)(a);this.bytesSent+=b.length,this.stats_.incrementCounter("bytes_sent",b.length);let c=aE(b,16384);c.length>1&&this.sendString_(String(c.length));for(let a=0;a<c.length;a++)this.sendString_(c[a])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){!this.isClosed_&&(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(45e3))}sendString_(a){try{this.mySock.send(a)}catch(a){this.log_("Exception thrown from WebSocket.send():",a.message||a.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}aT.responsesRequiredToBeHealthy=2,aT.healthyTimeout=3e4;let aU="@firebase/database",aV="1.1.0";class aW{constructor(a,b){this.appCheckProvider=b,this.appName=a.name,(0,_.xZ)(a)&&a.settings.appCheckToken&&(this.serverAppAppCheckToken=a.settings.appCheckToken),this.appCheck=b?.getImmediate({optional:!0}),this.appCheck||b?.get().then(a=>this.appCheck=a)}getToken(a){if(this.serverAppAppCheckToken){if(a)throw Error("Attempted reuse of `FirebaseServerApp.appCheckToken` after previous usage failed.");return Promise.resolve({token:this.serverAppAppCheckToken})}return this.appCheck?this.appCheck.getToken(a):new Promise((b,c)=>{setTimeout(()=>{this.appCheck?this.getToken(a).then(b,c):b(null)},0)})}addTokenChangeListener(a){this.appCheckProvider?.get().then(b=>b.addTokenListener(a))}notifyForInvalidToken(){au(`Provided AppCheck credentials for the app named "${this.appName}" are invalid. This usually indicates your app was not initialized correctly.`)}}class aX{constructor(a,b,c){this.appName_=a,this.firebaseOptions_=b,this.authProvider_=c,this.auth_=null,this.auth_=c.getImmediate({optional:!0}),this.auth_||c.onInit(a=>this.auth_=a)}getToken(a){return this.auth_?this.auth_.getToken(a).catch(a=>a&&"auth/token-not-initialized"===a.code?(aq("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(a)):new Promise((b,c)=>{setTimeout(()=>{this.auth_?this.getToken(a).then(b,c):b(null)},0)})}addTokenChangeListener(a){this.auth_?this.auth_.addAuthTokenListener(a):this.authProvider_.get().then(b=>b.addAuthTokenListener(a))}removeTokenChangeListener(a){this.authProvider_.get().then(b=>b.removeAuthTokenListener(a))}notifyForInvalidToken(){let a='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?a+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?a+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':a+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',au(a)}}class aY{constructor(a){this.accessToken=a}getToken(a){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(a){a(this.accessToken)}removeTokenChangeListener(a){}notifyForInvalidToken(){}}aY.OWNER="owner";class aZ{constructor(a){this.onMessage_=a,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(a,b){this.closeAfterResponse=a,this.onClose=b,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(a,b){for(this.pendingResponses[a]=b;this.pendingResponses[this.currentResponseNum];){let a=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let b=0;b<a.length;++b)a[b]&&aJ(()=>{this.onMessage_(a[b])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}let a$="start";class a_{constructor(a,b,c,d,e,f,g){this.connId=a,this.repoInfo=b,this.applicationId=c,this.appCheckToken=d,this.authToken=e,this.transportSessionId=f,this.lastSessionId=g,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=ar(a),this.stats_=aQ(b),this.urlFn=a=>(this.appCheckToken&&(a.ac=this.appCheckToken),aM(b,ad,a))}open(a,b){this.curSegmentNum=0,this.onDisconnect_=b,this.myPacketOrderer=new aZ(a),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(3e4)),ax(()=>{if(this.isClosed_)return;this.scriptTagHolder=new a0((...a)=>{let[b,c,d,e,f]=a;if(this.incrementIncomingBytes_(a),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,b===a$)this.id=c,this.password=d;else if("close"===b)c?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(c,()=>{this.onClosed_()})):this.onClosed_();else throw Error("Unrecognized command received: "+b)},(...a)=>{let[b,c]=a;this.incrementIncomingBytes_(a),this.myPacketOrderer.handleResponse(b,c)},()=>{this.onClosed_()},this.urlFn);let a={};a[a$]="t",a.ser=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(a.cb=this.scriptTagHolder.uniqueCallbackIdentifier),a.v="5",this.transportSessionId&&(a.s=this.transportSessionId),this.lastSessionId&&(a.ls=this.lastSessionId),this.applicationId&&(a.p=this.applicationId),this.appCheckToken&&(a.ac=this.appCheckToken),"undefined"!=typeof location&&location.hostname&&ab.test(location.hostname)&&(a.r="f");let b=this.urlFn(a);this.log_("Connecting via long-poll to "+b),this.scriptTagHolder.addTag(b,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){a_.forceAllow_=!0}static forceDisallow(){a_.forceDisallow_=!0}static isAvailable(){return!(0,Z.$g)()&&(!!a_.forceAllow_||!a_.forceDisallow_&&"undefined"!=typeof document&&null!=document.createElement&&!("object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&("object"!=typeof Windows||"object"!=typeof Windows.UI))}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){!this.isClosed_&&(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(a){let b=(0,Z.As)(a);this.bytesSent+=b.length,this.stats_.incrementCounter("bytes_sent",b.length);let c=aE((0,Z.KA)(b),1840);for(let a=0;a<c.length;a++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,c.length,c[a]),this.curSegmentNum++}addDisconnectPingFrame(a,b){if((0,Z.$g)())return;this.myDisconnFrame=document.createElement("iframe");let c={};c.dframe="t",c.id=a,c.pw=b,this.myDisconnFrame.src=this.urlFn(c),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(a){let b=(0,Z.As)(a).length;this.bytesReceived+=b,this.stats_.incrementCounter("bytes_received",b)}}class a0{constructor(a,b,c,d){if(this.onDisconnect=c,this.urlFn=d,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,Z.$g)())this.commandCB=a,this.onMessageCB=b;else{this.uniqueCallbackIdentifier=ak(),window["pLPCommand"+this.uniqueCallbackIdentifier]=a,window["pRTLPCB"+this.uniqueCallbackIdentifier]=b,this.myIFrame=a0.createIFrame_();let c="";this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)&&(c='<script>document.domain="'+document.domain+'";<\/script>');let d="<html><body>"+c+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(d),this.myIFrame.doc.close()}catch(a){aq("frame writing exception"),a.stack&&aq(a.stack),aq(a)}}}static createIFrame_(){let a=document.createElement("iframe");if(a.style.display="none",document.body){document.body.appendChild(a);try{a.contentWindow.document||aq("No IE domain setting required")}catch(b){a.src="javascript:void((function(){document.open();document.domain='"+document.domain+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return a.contentDocument?a.doc=a.contentDocument:a.contentWindow?a.doc=a.contentWindow.document:a.document&&(a.doc=a.document),a}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let a=this.onDisconnect;a&&(this.onDisconnect=null,a())}startLongPoll(a,b){for(this.myID=a,this.myPW=b,this.alive=!0;this.newRequest_(););}newRequest_(){if(!this.alive||!this.sendNewPolls||!(this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)))return!1;{this.currentSerial++;let a={};a.id=this.myID,a.pw=this.myPW,a.ser=this.currentSerial;let b=this.urlFn(a),c="",d=0;for(;this.pendingSegs.length>0;)if(this.pendingSegs[0].d.length+30+c.length<=1870){let a=this.pendingSegs.shift();c=c+"&seg"+d+"="+a.seg+"&ts"+d+"="+a.ts+"&d"+d+"="+a.d,d++}else break;return b+=c,this.addLongPollTag_(b,this.currentSerial),!0}}enqueueSegment(a,b,c){this.pendingSegs.push({seg:a,ts:b,d:c}),this.alive&&this.newRequest_()}addLongPollTag_(a,b){this.outstandingRequests.add(b);let c=()=>{this.outstandingRequests.delete(b),this.newRequest_()},d=setTimeout(c,Math.floor(25e3));this.addTag(a,()=>{clearTimeout(d),c()})}addTag(a,b){(0,Z.$g)()?this.doNodeLongPoll(a,b):setTimeout(()=>{try{if(!this.sendNewPolls)return;let c=this.myIFrame.doc.createElement("script");c.type="text/javascript",c.async=!0,c.src=a,c.onload=c.onreadystatechange=function(){let a=c.readyState;a&&"loaded"!==a&&"complete"!==a||(c.onload=c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c),b())},c.onerror=()=>{aq("Long-poll script failed to load: "+a),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(c)}catch(a){}},Math.floor(1))}}class a1{static get ALL_TRANSPORTS(){return[a_,aT]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}constructor(a){this.initTransports_(a)}initTransports_(a){let b=aT&&aT.isAvailable(),c=b&&!aT.previouslyFailed();if(a.webSocketOnly&&(b||au("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),c=!0),c)this.transports_=[aT];else{let a=this.transports_=[];for(let b of a1.ALL_TRANSPORTS)b&&b.isAvailable()&&a.push(b);a1.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}a1.globalTransportInitialized_=!1;class a2{constructor(a,b,c,d,e,f,g,h,i,j){this.id=a,this.repoInfo_=b,this.applicationId_=c,this.appCheckToken_=d,this.authToken_=e,this.onMessage_=f,this.onReady_=g,this.onDisconnect_=h,this.onKill_=i,this.lastSessionId=j,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=ar("c:"+this.id+":"),this.transportManager_=new a1(b),this.log_("Connection created"),this.start_()}start_(){let a=this.transportManager_.initialTransport();this.conn_=new a(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=a.responsesRequiredToBeHealthy||0;let b=this.connReceiver_(this.conn_),c=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(b,c)},Math.floor(0));let d=a.healthyTimeout||0;d>0&&(this.healthyTimeout_=aK(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(d)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(a){return b=>{a===this.conn_?this.onConnectionLost_(b):a===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(a){return b=>{2!==this.state_&&(a===this.rx_?this.onPrimaryMessageReceived_(b):a===this.secondaryConn_?this.onSecondaryMessageReceived_(b):this.log_("message on old connection"))}}sendRequest(a){this.sendData_({t:"d",d:a})}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(a){if("t"in a){let b=a.t;"a"===b?this.upgradeIfSecondaryHealthy_():"r"===b?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):"o"===b&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(a){let b=aC("t",a),c=aC("d",a);if("c"===b)this.onSecondaryControl_(c);else if("d"===b)this.pendingDataMessages.push(c);else throw Error("Unknown protocol layer: "+b)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(a){let b=aC("t",a),c=aC("d",a);"c"===b?this.onControl_(c):"d"===b&&this.onDataMessage_(c)}onDataMessage_(a){this.onPrimaryResponse_(),this.onMessage_(a)}onPrimaryResponse_(){!this.isHealthy_&&(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(a){let b=aC("t",a);if("d"in a){let c=a.d;if("h"===b){let a={...c};this.repoInfo_.isUsingEmulator&&(a.h=this.repoInfo_.host),this.onHandshake_(a)}else if("n"===b){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let a=0;a<this.pendingDataMessages.length;++a)this.onDataMessage_(this.pendingDataMessages[a]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===b?this.onConnectionShutdown_(c):"r"===b?this.onReset_(c):"e"===b?as("Server Error: "+c):"o"===b?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):as("Unknown control packet command: "+b)}}onHandshake_(a){let b=a.ts,c=a.v,d=a.h;this.sessionId=a.s,this.repoInfo_.host=d,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,b),"5"!==c&&au("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let a=this.transportManager_.upgradeTransport();a&&this.startUpgrade_(a)}startUpgrade_(a){this.secondaryConn_=new a(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=a.responsesRequiredToBeHealthy||0;let b=this.connReceiver_(this.secondaryConn_),c=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(b,c),aK(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(6e4))}onReset_(a){this.log_("Reset packet received.  New host: "+a),this.repoInfo_.host=a,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(a,b){this.log_("Realtime connection established."),this.conn_=a,this.state_=1,this.onReady_&&(this.onReady_(b,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):aK(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))}sendPingOnPrimaryIfNecessary_(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){let a=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===a||this.rx_===a)&&this.close()}onConnectionLost_(a){this.conn_=null,a||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(ah.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(a){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(a),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(a){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(a)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class a3{put(a,b,c,d){}merge(a,b,c,d){}refreshAuthToken(a){}refreshAppCheckToken(a){}onDisconnectPut(a,b,c){}onDisconnectMerge(a,b,c){}onDisconnectCancel(a,b){}reportStats(a){}}class a4{constructor(a){this.allowedEvents_=a,this.listeners_={},(0,Z.vA)(Array.isArray(a)&&a.length>0,"Requires a non-empty array")}trigger(a,...b){if(Array.isArray(this.listeners_[a])){let c=[...this.listeners_[a]];for(let a=0;a<c.length;a++)c[a].callback.apply(c[a].context,b)}}on(a,b,c){this.validateEventType_(a),this.listeners_[a]=this.listeners_[a]||[],this.listeners_[a].push({callback:b,context:c});let d=this.getInitialEvent(a);d&&b.apply(c,d)}off(a,b,c){this.validateEventType_(a);let d=this.listeners_[a]||[];for(let a=0;a<d.length;a++)if(d[a].callback===b&&(!c||c===d[a].context))return void d.splice(a,1)}validateEventType_(a){(0,Z.vA)(this.allowedEvents_.find(b=>b===a),"Unknown event: "+a)}}class a5 extends a4{static getInstance(){return new a5}constructor(){super(["online"]),this.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||(0,Z.jZ)()||(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}getInitialEvent(a){return(0,Z.vA)("online"===a,"Unknown event type: "+a),[this.online_]}currentlyOnline(){return this.online_}}class a6{constructor(a,b){if(void 0===b){this.pieces_=a.split("/");let b=0;for(let a=0;a<this.pieces_.length;a++)this.pieces_[a].length>0&&(this.pieces_[b]=this.pieces_[a],b++);this.pieces_.length=b,this.pieceNum_=0}else this.pieces_=a,this.pieceNum_=b}toString(){let a="";for(let b=this.pieceNum_;b<this.pieces_.length;b++)""!==this.pieces_[b]&&(a+="/"+this.pieces_[b]);return a||"/"}}function a7(){return new a6("")}function a8(a){return a.pieceNum_>=a.pieces_.length?null:a.pieces_[a.pieceNum_]}function a9(a){return a.pieces_.length-a.pieceNum_}function ba(a){let b=a.pieceNum_;return b<a.pieces_.length&&b++,new a6(a.pieces_,b)}function bb(a){return a.pieceNum_<a.pieces_.length?a.pieces_[a.pieces_.length-1]:null}function bc(a,b=0){return a.pieces_.slice(a.pieceNum_+b)}function bd(a){if(a.pieceNum_>=a.pieces_.length)return null;let b=[];for(let c=a.pieceNum_;c<a.pieces_.length-1;c++)b.push(a.pieces_[c]);return new a6(b,0)}function be(a,b){let c=[];for(let b=a.pieceNum_;b<a.pieces_.length;b++)c.push(a.pieces_[b]);if(b instanceof a6)for(let a=b.pieceNum_;a<b.pieces_.length;a++)c.push(b.pieces_[a]);else{let a=b.split("/");for(let b=0;b<a.length;b++)a[b].length>0&&c.push(a[b])}return new a6(c,0)}function bf(a){return a.pieceNum_>=a.pieces_.length}function bg(a,b){let c=a8(a),d=a8(b);if(null===c)return b;if(c===d)return bg(ba(a),ba(b));throw Error("INTERNAL ERROR: innerPath ("+b+") is not within outerPath ("+a+")")}function bh(a,b){if(a9(a)!==a9(b))return!1;for(let c=a.pieceNum_,d=b.pieceNum_;c<=a.pieces_.length;c++,d++)if(a.pieces_[c]!==b.pieces_[d])return!1;return!0}function bi(a,b){let c=a.pieceNum_,d=b.pieceNum_;if(a9(a)>a9(b))return!1;for(;c<a.pieces_.length;){if(a.pieces_[c]!==b.pieces_[d])return!1;++c,++d}return!0}class bj{constructor(a,b){this.errorPrefix_=b,this.parts_=bc(a,0),this.byteLength_=Math.max(1,this.parts_.length);for(let a=0;a<this.parts_.length;a++)this.byteLength_+=(0,Z.OE)(this.parts_[a]);bk(this)}}function bk(a){if(a.byteLength_>768)throw Error(a.errorPrefix_+"has a key path longer than 768 bytes ("+a.byteLength_+").");if(a.parts_.length>32)throw Error(a.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+bl(a))}function bl(a){return 0===a.parts_.length?"":"in property '"+a.parts_.join(".")+"'"}class bm extends a4{static getInstance(){return new bm}constructor(){let a,b;super(["visible"]),"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(b="visibilitychange",a="hidden"):void 0!==document.mozHidden?(b="mozvisibilitychange",a="mozHidden"):void 0!==document.msHidden?(b="msvisibilitychange",a="msHidden"):void 0!==document.webkitHidden&&(b="webkitvisibilitychange",a="webkitHidden")),this.visible_=!0,b&&document.addEventListener(b,()=>{let b=!document[a];b!==this.visible_&&(this.visible_=b,this.trigger("visible",b))},!1)}getInitialEvent(a){return(0,Z.vA)("visible"===a,"Unknown event type: "+a),[this.visible_]}}class bn extends a3{constructor(a,b,c,d,e,f,g,h){if(super(),this.repoInfo_=a,this.applicationId_=b,this.onDataUpdate_=c,this.onConnectStatus_=d,this.onServerInfoUpdate_=e,this.authTokenProvider_=f,this.appCheckTokenProvider_=g,this.authOverride_=h,this.id=bn.nextPersistentConnectionId_++,this.log_=ar("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=1e3,this.maxReconnectDelay_=3e5,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,h&&!(0,Z.$g)())throw Error("Auth override specified in options, but not supported on non Node.js platforms");bm.getInstance().on("visible",this.onVisible_,this),-1===a.host.indexOf("fblocal")&&a5.getInstance().on("online",this.onOnline_,this)}sendRequest(a,b,c){let d=++this.requestNumber_,e={r:d,a:a,b:b};this.log_((0,Z.As)(e)),(0,Z.vA)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(e),c&&(this.requestCBHash_[d]=c)}get(a){this.initConnection_();let b=new Z.cY,c={p:a._path.toString(),q:a._queryObject};this.outstandingGets_.push({action:"g",request:c,onComplete:a=>{let c=a.d;"ok"===a.s?b.resolve(c):b.reject(c)}}),this.outstandingGetCount_++;let d=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(d),b.promise}listen(a,b,c,d){this.initConnection_();let e=a._queryIdentifier,f=a._path.toString();this.log_("Listen called for "+f+" "+e),this.listens.has(f)||this.listens.set(f,new Map),(0,Z.vA)(a._queryParams.isDefault()||!a._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,Z.vA)(!this.listens.get(f).has(e),"listen() called twice for same path/queryId.");let g={onComplete:d,hashFn:b,query:a,tag:c};this.listens.get(f).set(e,g),this.connected_&&this.sendListen_(g)}sendGet_(a){let b=this.outstandingGets_[a];this.sendRequest("g",b.request,c=>{delete this.outstandingGets_[a],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),b.onComplete&&b.onComplete(c)})}sendListen_(a){let b=a.query,c=b._path.toString(),d=b._queryIdentifier;this.log_("Listen on "+c+" for "+d);let e={p:c};a.tag&&(e.q=b._queryObject,e.t=a.tag),e.h=a.hashFn(),this.sendRequest("q",e,e=>{let f=e.d,g=e.s;bn.warnOnListenWarnings_(f,b),(this.listens.get(c)&&this.listens.get(c).get(d))===a&&(this.log_("listen response",e),"ok"!==g&&this.removeListen_(c,d),a.onComplete&&a.onComplete(g,f))})}static warnOnListenWarnings_(a,b){if(a&&"object"==typeof a&&(0,Z.gR)(a,"w")){let c=(0,Z.yw)(a,"w");if(Array.isArray(c)&&~c.indexOf("no_index")){let a='".indexOn": "'+b._queryParams.getIndex().toString()+'"',c=b._path.toString();au(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${a} at ${c} to your security rules for better performance.`)}}}refreshAuthToken(a){this.authToken_=a,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(a)}reduceReconnectDelayIfAdminCredential_(a){(a&&40===a.length||(0,Z.qc)(a))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)}refreshAppCheckToken(a){this.appCheckToken_=a,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let a=this.authToken_,b=(0,Z.Cv)(a)?"auth":"gauth",c={cred:a};null===this.authOverride_?c.noauth=!0:"object"==typeof this.authOverride_&&(c.authvar=this.authOverride_),this.sendRequest(b,c,b=>{let c=b.s,d=b.d||"error";this.authToken_===a&&("ok"===c?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(c,d))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},a=>{let b=a.s,c=a.d||"error";"ok"===b?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(b,c)})}unlisten(a,b){let c=a._path.toString(),d=a._queryIdentifier;this.log_("Unlisten called for "+c+" "+d),(0,Z.vA)(a._queryParams.isDefault()||!a._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(c,d)&&this.connected_&&this.sendUnlisten_(c,d,a._queryObject,b)}sendUnlisten_(a,b,c,d){this.log_("Unlisten on "+a+" for "+b);let e={p:a};d&&(e.q=c,e.t=d),this.sendRequest("n",e)}onDisconnectPut(a,b,c){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",a,b,c):this.onDisconnectRequestQueue_.push({pathString:a,action:"o",data:b,onComplete:c})}onDisconnectMerge(a,b,c){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",a,b,c):this.onDisconnectRequestQueue_.push({pathString:a,action:"om",data:b,onComplete:c})}onDisconnectCancel(a,b){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",a,null,b):this.onDisconnectRequestQueue_.push({pathString:a,action:"oc",data:null,onComplete:b})}sendOnDisconnect_(a,b,c,d){let e={p:b,d:c};this.log_("onDisconnect "+a,e),this.sendRequest(a,e,a=>{d&&setTimeout(()=>{d(a.s,a.d)},Math.floor(0))})}put(a,b,c,d){this.putInternal("p",a,b,c,d)}merge(a,b,c,d){this.putInternal("m",a,b,c,d)}putInternal(a,b,c,d,e){this.initConnection_();let f={p:b,d:c};void 0!==e&&(f.h=e),this.outstandingPuts_.push({action:a,request:f,onComplete:d}),this.outstandingPutCount_++;let g=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(g):this.log_("Buffering put: "+b)}sendPut_(a){let b=this.outstandingPuts_[a].action,c=this.outstandingPuts_[a].request,d=this.outstandingPuts_[a].onComplete;this.outstandingPuts_[a].queued=this.connected_,this.sendRequest(b,c,c=>{this.log_(b+" response",c),delete this.outstandingPuts_[a],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),d&&d(c.s,c.d)})}reportStats(a){if(this.connected_){let b={c:a};this.log_("reportStats",b),this.sendRequest("s",b,a=>{if("ok"!==a.s){let b=a.d;this.log_("reportStats","Error sending stats: "+b)}})}}onDataMessage_(a){if("r"in a){this.log_("from server: "+(0,Z.As)(a));let b=a.r,c=this.requestCBHash_[b];c&&(delete this.requestCBHash_[b],c(a.b))}else if("error"in a)throw"A server-side error has occurred: "+a.error;else"a"in a&&this.onDataPush_(a.a,a.b)}onDataPush_(a,b){this.log_("handleServerMessage",a,b),"d"===a?this.onDataUpdate_(b.p,b.d,!1,b.t):"m"===a?this.onDataUpdate_(b.p,b.d,!0,b.t):"c"===a?this.onListenRevoked_(b.p,b.q):"ac"===a?this.onAuthRevoked_(b.s,b.d):"apc"===a?this.onAppCheckRevoked_(b.s,b.d):"sd"===a?this.onSecurityDebugPacket_(b):as("Unrecognized action received from server: "+(0,Z.As)(a)+"\nAre you using the latest client?")}onReady_(a,b){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(a),this.lastSessionId=b,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(a){(0,Z.vA)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(a))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(a){a&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)),this.visible_=a}onOnline_(a){a?(this.log_("Browser went online."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=1e3),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let a=Math.max(0,new Date().getTime()-this.lastConnectionAttemptTime_),b=Math.max(0,this.reconnectDelay_-a);b=Math.random()*b,this.log_("Trying to reconnect in "+b+"ms"),this.scheduleConnect_(b),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let a=this.onDataMessage_.bind(this),b=this.onReady_.bind(this),c=this.onRealtimeDisconnect_.bind(this),d=this.id+":"+bn.nextConnectionId_++,e=this.lastSessionId,f=!1,g=null,h=function(){g?g.close():(f=!0,c())};this.realtime_={close:h,sendRequest:function(a){(0,Z.vA)(g,"sendRequest call when we're not connected not allowed."),g.sendRequest(a)}};let i=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[h,j]=await Promise.all([this.authTokenProvider_.getToken(i),this.appCheckTokenProvider_.getToken(i)]);f?aq("getToken() completed but was canceled"):(aq("getToken() completed. Creating connection."),this.authToken_=h&&h.accessToken,this.appCheckToken_=j&&j.token,g=new a2(d,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,a,b,c,a=>{au(a+" ("+this.repoInfo_.toString()+")"),this.interrupt("server_kill")},e))}catch(a){this.log_("Failed to get token: "+a),f||(this.repoInfo_.nodeAdmin&&au(a),h())}}}interrupt(a){aq("Interrupting connection for reason: "+a),this.interruptReasons_[a]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(a){aq("Resuming connection for reason: "+a),delete this.interruptReasons_[a],(0,Z.Im)(this.interruptReasons_)&&(this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(a){let b=a-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:b})}cancelSentTransactions_(){for(let a=0;a<this.outstandingPuts_.length;a++){let b=this.outstandingPuts_[a];b&&"h"in b.request&&b.queued&&(b.onComplete&&b.onComplete("disconnect"),delete this.outstandingPuts_[a],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(a,b){let c;c=b?b.map(a=>aD(a)).join("$"):"default";let d=this.removeListen_(a,c);d&&d.onComplete&&d.onComplete("permission_denied")}removeListen_(a,b){let c,d=new a6(a).toString();if(this.listens.has(d)){let a=this.listens.get(d);c=a.get(b),a.delete(b),0===a.size&&this.listens.delete(d)}else c=void 0;return c}onAuthRevoked_(a,b){aq("Auth token revoked: "+a+"/"+b),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),("invalid_token"===a||"permission_denied"===a)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(a,b){aq("App check token revoked: "+a+"/"+b),this.appCheckToken_=null,this.forceTokenRefresh_=!0,("invalid_token"===a||"permission_denied"===a)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(a){this.securityDebugCallback_?this.securityDebugCallback_(a):"msg"in a&&console.log("FIREBASE: "+a.msg.replace("\n","\nFIREBASE: "))}restoreState_(){for(let a of(this.tryAuth(),this.tryAppCheck(),this.listens.values()))for(let b of a.values())this.sendListen_(b);for(let a=0;a<this.outstandingPuts_.length;a++)this.outstandingPuts_[a]&&this.sendPut_(a);for(;this.onDisconnectRequestQueue_.length;){let a=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(a.action,a.pathString,a.data,a.onComplete)}for(let a=0;a<this.outstandingGets_.length;a++)this.outstandingGets_[a]&&this.sendGet_(a)}sendConnectStats_(){let a={},b="js";(0,Z.$g)()&&(b=this.repoInfo_.nodeAdmin?"admin_node":"node"),a["sdk."+b+"."+aR.replace(/\./g,"-")]=1,(0,Z.jZ)()?a["framework.cordova"]=1:(0,Z.lV)()&&(a["framework.reactnative"]=1),this.reportStats(a)}shouldReconnect_(){let a=a5.getInstance().currentlyOnline();return(0,Z.Im)(this.interruptReasons_)&&a}}bn.nextPersistentConnectionId_=0,bn.nextConnectionId_=0;class bo{constructor(a,b){this.name=a,this.node=b}static Wrap(a,b){return new bo(a,b)}}class bp{getCompare(){return this.compare.bind(this)}indexedValueChanged(a,b){let c=new bo(ay,a),d=new bo(ay,b);return 0!==this.compare(c,d)}minPost(){return bo.MIN}}class bq extends bp{static get __EMPTY_NODE(){return d}static set __EMPTY_NODE(a){d=a}compare(a,b){return aA(a.name,b.name)}isDefinedOn(a){throw(0,Z.Hk)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(a,b){return!1}minPost(){return bo.MIN}maxPost(){return new bo(az,d)}makePost(a,b){return(0,Z.vA)("string"==typeof a,"KeyIndex indexValue must always be a string."),new bo(a,d)}toString(){return".key"}}let br=new bq;class bs{constructor(a,b,c,d,e=null){this.isReverse_=d,this.resultGenerator_=e,this.nodeStack_=[];let f=1;for(;!a.isEmpty();)if(f=b?c(a.key,b):1,d&&(f*=-1),f<0)a=this.isReverse_?a.left:a.right;else if(0===f){this.nodeStack_.push(a);break}else this.nodeStack_.push(a),a=this.isReverse_?a.right:a.left}getNext(){let a;if(0===this.nodeStack_.length)return null;let b=this.nodeStack_.pop();if(a=this.resultGenerator_?this.resultGenerator_(b.key,b.value):{key:b.key,value:b.value},this.isReverse_)for(b=b.left;!b.isEmpty();)this.nodeStack_.push(b),b=b.right;else for(b=b.right;!b.isEmpty();)this.nodeStack_.push(b),b=b.left;return a}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;let a=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(a.key,a.value):{key:a.key,value:a.value}}}class bt{constructor(a,b,c,d,e){this.key=a,this.value=b,this.color=null!=c?c:bt.RED,this.left=null!=d?d:bv.EMPTY_NODE,this.right=null!=e?e:bv.EMPTY_NODE}copy(a,b,c,d,e){return new bt(null!=a?a:this.key,null!=b?b:this.value,null!=c?c:this.color,null!=d?d:this.left,null!=e?e:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(a){return this.left.inorderTraversal(a)||!!a(this.key,this.value)||this.right.inorderTraversal(a)}reverseTraversal(a){return this.right.reverseTraversal(a)||a(this.key,this.value)||this.left.reverseTraversal(a)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(a,b,c){let d=this,e=c(a,d.key);return(d=e<0?d.copy(null,null,null,d.left.insert(a,b,c),null):0===e?d.copy(null,b,null,null,null):d.copy(null,null,null,null,d.right.insert(a,b,c))).fixUp_()}removeMin_(){if(this.left.isEmpty())return bv.EMPTY_NODE;let a=this;return a.left.isRed_()||a.left.left.isRed_()||(a=a.moveRedLeft_()),(a=a.copy(null,null,null,a.left.removeMin_(),null)).fixUp_()}remove(a,b){let c,d;if(c=this,0>b(a,c.key))c.left.isEmpty()||c.left.isRed_()||c.left.left.isRed_()||(c=c.moveRedLeft_()),c=c.copy(null,null,null,c.left.remove(a,b),null);else{if(c.left.isRed_()&&(c=c.rotateRight_()),c.right.isEmpty()||c.right.isRed_()||c.right.left.isRed_()||(c=c.moveRedRight_()),0===b(a,c.key))if(c.right.isEmpty())return bv.EMPTY_NODE;else d=c.right.min_(),c=c.copy(d.key,d.value,null,null,c.right.removeMin_());c=c.copy(null,null,null,null,c.right.remove(a,b))}return c.fixUp_()}isRed_(){return this.color}fixUp_(){let a=this;return a.right.isRed_()&&!a.left.isRed_()&&(a=a.rotateLeft_()),a.left.isRed_()&&a.left.left.isRed_()&&(a=a.rotateRight_()),a.left.isRed_()&&a.right.isRed_()&&(a=a.colorFlip_()),a}moveRedLeft_(){let a=this.colorFlip_();return a.right.left.isRed_()&&(a=(a=(a=a.copy(null,null,null,null,a.right.rotateRight_())).rotateLeft_()).colorFlip_()),a}moveRedRight_(){let a=this.colorFlip_();return a.left.left.isRed_()&&(a=(a=a.rotateRight_()).colorFlip_()),a}rotateLeft_(){let a=this.copy(null,null,bt.RED,null,this.right.left);return this.right.copy(null,null,this.color,a,null)}rotateRight_(){let a=this.copy(null,null,bt.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,a)}colorFlip_(){let a=this.left.copy(null,null,!this.left.color,null,null),b=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,a,b)}checkMaxDepth_(){return Math.pow(2,this.check_())<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw Error("Right child of ("+this.key+","+this.value+") is red");let a=this.left.check_();if(a===this.right.check_())return a+ +!this.isRed_();throw Error("Black depths differ")}}bt.RED=!0,bt.BLACK=!1;class bu{copy(a,b,c,d,e){return this}insert(a,b,c){return new bt(a,b,null)}remove(a,b){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(a){return!1}reverseTraversal(a){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}}class bv{constructor(a,b=bv.EMPTY_NODE){this.comparator_=a,this.root_=b}insert(a,b){return new bv(this.comparator_,this.root_.insert(a,b,this.comparator_).copy(null,null,bt.BLACK,null,null))}remove(a){return new bv(this.comparator_,this.root_.remove(a,this.comparator_).copy(null,null,bt.BLACK,null,null))}get(a){let b,c=this.root_;for(;!c.isEmpty();){if(0===(b=this.comparator_(a,c.key)))return c.value;b<0?c=c.left:b>0&&(c=c.right)}return null}getPredecessorKey(a){let b,c=this.root_,d=null;for(;!c.isEmpty();){if(0===(b=this.comparator_(a,c.key)))if(c.left.isEmpty())if(d)return d.key;else return null;else{for(c=c.left;!c.right.isEmpty();)c=c.right;return c.key}b<0?c=c.left:b>0&&(d=c,c=c.right)}throw Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(a){return this.root_.inorderTraversal(a)}reverseTraversal(a){return this.root_.reverseTraversal(a)}getIterator(a){return new bs(this.root_,null,this.comparator_,!1,a)}getIteratorFrom(a,b){return new bs(this.root_,a,this.comparator_,!1,b)}getReverseIteratorFrom(a,b){return new bs(this.root_,a,this.comparator_,!0,b)}getReverseIterator(a){return new bs(this.root_,null,this.comparator_,!0,a)}}function bw(a,b){return aA(a.name,b.name)}function bx(a,b){return aA(a,b)}bv.EMPTY_NODE=new bu;let by=function(a){return"number"==typeof a?"number:"+aG(a):"string:"+a},bz=function(a){if(a.isLeafNode()){let b=a.val();(0,Z.vA)("string"==typeof b||"number"==typeof b||"object"==typeof b&&(0,Z.gR)(b,".sv"),"Priority must be a string or number.")}else(0,Z.vA)(a===e||a.isEmpty(),"priority of unexpected type.");(0,Z.vA)(a===e||a.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};class bA{static set __childrenNodeConstructor(a){f=a}static get __childrenNodeConstructor(){return f}constructor(a,b=bA.__childrenNodeConstructor.EMPTY_NODE){this.value_=a,this.priorityNode_=b,this.lazyHash_=null,(0,Z.vA)(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),bz(this.priorityNode_)}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(a){return new bA(this.value_,a)}getImmediateChild(a){return".priority"===a?this.priorityNode_:bA.__childrenNodeConstructor.EMPTY_NODE}getChild(a){return bf(a)?this:".priority"===a8(a)?this.priorityNode_:bA.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(a,b){return null}updateImmediateChild(a,b){return".priority"===a?this.updatePriority(b):b.isEmpty()&&".priority"!==a?this:bA.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(a,b).updatePriority(this.priorityNode_)}updateChild(a,b){let c=a8(a);return null===c?b:b.isEmpty()&&".priority"!==c?this:((0,Z.vA)(".priority"!==c||1===a9(a),".priority must be the last token in a path"),this.updateImmediateChild(c,bA.__childrenNodeConstructor.EMPTY_NODE.updateChild(ba(a),b)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(a,b){return!1}val(a){return a&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let a="";this.priorityNode_.isEmpty()||(a+="priority:"+by(this.priorityNode_.val())+":");let b=typeof this.value_;a+=b+":","number"===b?a+=aG(this.value_):a+=this.value_,this.lazyHash_=al(a)}return this.lazyHash_}getValue(){return this.value_}compareTo(a){return a===bA.__childrenNodeConstructor.EMPTY_NODE?1:a instanceof bA.__childrenNodeConstructor?-1:((0,Z.vA)(a.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(a))}compareToLeafNode_(a){let b=typeof a.value_,c=typeof this.value_,d=bA.VALUE_TYPE_ORDER.indexOf(b),e=bA.VALUE_TYPE_ORDER.indexOf(c);return((0,Z.vA)(d>=0,"Unknown leaf type: "+b),(0,Z.vA)(e>=0,"Unknown leaf type: "+c),d!==e)?e-d:"object"===c?0:this.value_<a.value_?-1:1*(this.value_!==a.value_)}withIndex(){return this}isIndexed(){return!0}equals(a){return a===this||!!a.isLeafNode()&&this.value_===a.value_&&this.priorityNode_.equals(a.priorityNode_)}}bA.VALUE_TYPE_ORDER=["object","boolean","number","string"];class bB extends bp{compare(a,b){let c=a.node.getPriority(),d=b.node.getPriority(),e=c.compareTo(d);return 0===e?aA(a.name,b.name):e}isDefinedOn(a){return!a.getPriority().isEmpty()}indexedValueChanged(a,b){return!a.getPriority().equals(b.getPriority())}minPost(){return bo.MIN}maxPost(){return new bo(az,new bA("[PRIORITY-POST]",h))}makePost(a,b){return new bo(b,new bA("[PRIORITY-POST]",g(a)))}toString(){return".priority"}}let bC=new bB,bD=Math.log(2);class bE{constructor(a){this.count=parseInt(Math.log(a+1)/bD,10),this.current_=this.count-1;let b=parseInt(Array(this.count+1).join("1"),2);this.bits_=a+1&b}nextBitIsOne(){let a=!(this.bits_&1<<this.current_);return this.current_--,a}}let bF=function(a,b,c,d){a.sort(b);let e=function(b,d){let f,g=d-b;if(0===g)return null;if(1===g)return f=a[b],new bt(c?c(f):f,f.node,bt.BLACK,null,null);{let h=parseInt(g/2,10)+b,i=e(b,h),j=e(h+1,d);return f=a[h],new bt(c?c(f):f,f.node,bt.BLACK,i,j)}};return new bv(d||b,function(b){let d=null,f=null,g=a.length,h=function(b,d){let f=g-b,h=g;g-=b;let j=e(f+1,h),k=a[f];i(new bt(c?c(k):k,k.node,d,null,j))},i=function(a){d?d.left=a:f=a,d=a};for(let a=0;a<b.count;++a){let c=b.nextBitIsOne(),d=Math.pow(2,b.count-(a+1));c?h(d,bt.BLACK):(h(d,bt.BLACK),h(d,bt.RED))}return f}(new bE(a.length)))},bG={};class bH{static get Default(){return(0,Z.vA)(bG&&bC,"ChildrenNode.ts has not been loaded"),i=i||new bH({".priority":bG},{".priority":bC})}constructor(a,b){this.indexes_=a,this.indexSet_=b}get(a){let b=(0,Z.yw)(this.indexes_,a);if(!b)throw Error("No index defined for "+a);return b instanceof bv?b:null}hasIndex(a){return(0,Z.gR)(this.indexSet_,a.toString())}addIndex(a,b){let c;(0,Z.vA)(a!==br,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let d=[],e=!1,f=b.getIterator(bo.Wrap),g=f.getNext();for(;g;)e=e||a.isDefinedOn(g.node),d.push(g),g=f.getNext();c=e?bF(d,a.getCompare()):bG;let h=a.toString(),i={...this.indexSet_};i[h]=a;let j={...this.indexes_};return j[h]=c,new bH(j,i)}addToIndexes(a,b){return new bH((0,Z.kH)(this.indexes_,(c,d)=>{let e=(0,Z.yw)(this.indexSet_,d);if((0,Z.vA)(e,"Missing index implementation for "+d),c===bG)if(!e.isDefinedOn(a.node))return bG;else{let c=[],d=b.getIterator(bo.Wrap),f=d.getNext();for(;f;)f.name!==a.name&&c.push(f),f=d.getNext();return c.push(a),bF(c,e.getCompare())}{let d=b.get(a.name),e=c;return d&&(e=e.remove(new bo(a.name,d))),e.insert(a,a.node)}}),this.indexSet_)}removeFromIndexes(a,b){return new bH((0,Z.kH)(this.indexes_,c=>{if(c===bG)return c;{let d=b.get(a.name);return d?c.remove(new bo(a.name,d)):c}}),this.indexSet_)}}class bI{static get EMPTY_NODE(){return j||(j=new bI(new bv(bx),null,bH.Default))}constructor(a,b,c){this.children_=a,this.priorityNode_=b,this.indexMap_=c,this.lazyHash_=null,this.priorityNode_&&bz(this.priorityNode_),this.children_.isEmpty()&&(0,Z.vA)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}isLeafNode(){return!1}getPriority(){return this.priorityNode_||j}updatePriority(a){return this.children_.isEmpty()?this:new bI(this.children_,a,this.indexMap_)}getImmediateChild(a){if(".priority"===a)return this.getPriority();{let b=this.children_.get(a);return null===b?j:b}}getChild(a){let b=a8(a);return null===b?this:this.getImmediateChild(b).getChild(ba(a))}hasChild(a){return null!==this.children_.get(a)}updateImmediateChild(a,b){if((0,Z.vA)(b,"We should always be passing snapshot nodes"),".priority"===a)return this.updatePriority(b);{let c,d,e=new bo(a,b);b.isEmpty()?(c=this.children_.remove(a),d=this.indexMap_.removeFromIndexes(e,this.children_)):(c=this.children_.insert(a,b),d=this.indexMap_.addToIndexes(e,this.children_));let f=c.isEmpty()?j:this.priorityNode_;return new bI(c,f,d)}}updateChild(a,b){let c=a8(a);if(null===c)return b;{(0,Z.vA)(".priority"!==a8(a)||1===a9(a),".priority must be the last token in a path");let d=this.getImmediateChild(c).updateChild(ba(a),b);return this.updateImmediateChild(c,d)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(a){if(this.isEmpty())return null;let b={},c=0,d=0,e=!0;if(this.forEachChild(bC,(f,g)=>{b[f]=g.val(a),c++,e&&bI.INTEGER_REGEXP_.test(f)?d=Math.max(d,Number(f)):e=!1}),a||!e||!(d<2*c))return a&&!this.getPriority().isEmpty()&&(b[".priority"]=this.getPriority().val()),b;{let a=[];for(let c in b)a[c]=b[c];return a}}hash(){if(null===this.lazyHash_){let a="";this.getPriority().isEmpty()||(a+="priority:"+by(this.getPriority().val())+":"),this.forEachChild(bC,(b,c)=>{let d=c.hash();""!==d&&(a+=":"+b+":"+d)}),this.lazyHash_=""===a?"":al(a)}return this.lazyHash_}getPredecessorChildName(a,b,c){let d=this.resolveIndex_(c);if(!d)return this.children_.getPredecessorKey(a);{let c=d.getPredecessorKey(new bo(a,b));return c?c.name:null}}getFirstChildName(a){let b=this.resolveIndex_(a);if(!b)return this.children_.minKey();{let a=b.minKey();return a&&a.name}}getFirstChild(a){let b=this.getFirstChildName(a);return b?new bo(b,this.children_.get(b)):null}getLastChildName(a){let b=this.resolveIndex_(a);if(!b)return this.children_.maxKey();{let a=b.maxKey();return a&&a.name}}getLastChild(a){let b=this.getLastChildName(a);return b?new bo(b,this.children_.get(b)):null}forEachChild(a,b){let c=this.resolveIndex_(a);return c?c.inorderTraversal(a=>b(a.name,a.node)):this.children_.inorderTraversal(b)}getIterator(a){return this.getIteratorFrom(a.minPost(),a)}getIteratorFrom(a,b){let c=this.resolveIndex_(b);if(c)return c.getIteratorFrom(a,a=>a);{let c=this.children_.getIteratorFrom(a.name,bo.Wrap),d=c.peek();for(;null!=d&&0>b.compare(d,a);)c.getNext(),d=c.peek();return c}}getReverseIterator(a){return this.getReverseIteratorFrom(a.maxPost(),a)}getReverseIteratorFrom(a,b){let c=this.resolveIndex_(b);if(c)return c.getReverseIteratorFrom(a,a=>a);{let c=this.children_.getReverseIteratorFrom(a.name,bo.Wrap),d=c.peek();for(;null!=d&&b.compare(d,a)>0;)c.getNext(),d=c.peek();return c}}compareTo(a){if(this.isEmpty())if(a.isEmpty())return 0;else return -1;return a.isLeafNode()||a.isEmpty()?1:a===bK?-1:0}withIndex(a){if(a===br||this.indexMap_.hasIndex(a))return this;{let b=this.indexMap_.addIndex(a,this.children_);return new bI(this.children_,this.priorityNode_,b)}}isIndexed(a){return a===br||this.indexMap_.hasIndex(a)}equals(a){if(a===this)return!0;if(a.isLeafNode()||!this.getPriority().equals(a.getPriority()))return!1;if(this.children_.count()!==a.children_.count())return!1;{let b=this.getIterator(bC),c=a.getIterator(bC),d=b.getNext(),e=c.getNext();for(;d&&e;){if(d.name!==e.name||!d.node.equals(e.node))return!1;d=b.getNext(),e=c.getNext()}return null===d&&null===e}}resolveIndex_(a){return a===br?null:this.indexMap_.get(a.toString())}}bI.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;class bJ extends bI{constructor(){super(new bv(bx),bI.EMPTY_NODE,bH.Default)}compareTo(a){return+(a!==this)}equals(a){return a===this}getPriority(){return this}getImmediateChild(a){return bI.EMPTY_NODE}isEmpty(){return!1}}let bK=new bJ;function bL(a,b=null){if(null===a)return bI.EMPTY_NODE;if("object"==typeof a&&".priority"in a&&(b=a[".priority"]),(0,Z.vA)(null===b||"string"==typeof b||"number"==typeof b||"object"==typeof b&&".sv"in b,"Invalid priority type found: "+typeof b),"object"==typeof a&&".value"in a&&null!==a[".value"]&&(a=a[".value"]),"object"!=typeof a||".sv"in a)return new bA(a,bL(b));if(a instanceof Array){let c=bI.EMPTY_NODE;return aF(a,(b,d)=>{if((0,Z.gR)(a,b)&&"."!==b.substring(0,1)){let a=bL(d);(a.isLeafNode()||!a.isEmpty())&&(c=c.updateImmediateChild(b,a))}}),c.updatePriority(bL(b))}{let c=[],d=!1;if(aF(a,(a,b)=>{if("."!==a.substring(0,1)){let e=bL(b);e.isEmpty()||(d=d||!e.getPriority().isEmpty(),c.push(new bo(a,e)))}}),0===c.length)return bI.EMPTY_NODE;let e=bF(c,bw,a=>a.name,bx);if(!d)return new bI(e,bL(b),bH.Default);{let a=bF(c,bC.getCompare());return new bI(e,bL(b),new bH({".priority":a},{".priority":bC}))}}}Object.defineProperties(bo,{MIN:{value:new bo(ay,bI.EMPTY_NODE)},MAX:{value:new bo(az,bK)}}),bq.__EMPTY_NODE=bI.EMPTY_NODE,bA.__childrenNodeConstructor=bI,e=bK,h=bK,g=bL;class bM extends bp{constructor(a){super(),this.indexPath_=a,(0,Z.vA)(!bf(a)&&".priority"!==a8(a),"Can't create PathIndex with empty path or .priority key")}extractChild(a){return a.getChild(this.indexPath_)}isDefinedOn(a){return!a.getChild(this.indexPath_).isEmpty()}compare(a,b){let c=this.extractChild(a.node),d=this.extractChild(b.node),e=c.compareTo(d);return 0===e?aA(a.name,b.name):e}makePost(a,b){let c=bL(a);return new bo(b,bI.EMPTY_NODE.updateChild(this.indexPath_,c))}maxPost(){return new bo(az,bI.EMPTY_NODE.updateChild(this.indexPath_,bK))}toString(){return bc(this.indexPath_,0).join("/")}}class bN extends bp{compare(a,b){let c=a.node.compareTo(b.node);return 0===c?aA(a.name,b.name):c}isDefinedOn(a){return!0}indexedValueChanged(a,b){return!a.equals(b)}minPost(){return bo.MIN}maxPost(){return bo.MAX}makePost(a,b){return new bo(b,bL(a))}toString(){return".value"}}let bO=new bN;function bP(a,b,c){return{type:"child_changed",snapshotNode:b,childName:a,oldSnap:c}}class bQ{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=bC}hasStart(){return this.startSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,Z.vA)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return((0,Z.vA)(this.startSet_,"Only valid if start has been set"),this.startNameSet_)?this.indexStartName_:ay}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,Z.vA)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return((0,Z.vA)(this.endSet_,"Only valid if end has been set"),this.endNameSet_)?this.indexEndName_:az}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,Z.vA)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===bC}copy(){let a=new bQ;return a.limitSet_=this.limitSet_,a.limit_=this.limit_,a.startSet_=this.startSet_,a.startAfterSet_=this.startAfterSet_,a.indexStartValue_=this.indexStartValue_,a.startNameSet_=this.startNameSet_,a.indexStartName_=this.indexStartName_,a.endSet_=this.endSet_,a.endBeforeSet_=this.endBeforeSet_,a.indexEndValue_=this.indexEndValue_,a.endNameSet_=this.endNameSet_,a.indexEndName_=this.indexEndName_,a.index_=this.index_,a.viewFrom_=this.viewFrom_,a}}function bR(a){let b,c={};if(a.isDefault())return c;if(a.index_===bC?b="$priority":a.index_===bO?b="$value":a.index_===br?b="$key":((0,Z.vA)(a.index_ instanceof bM,"Unrecognized index type!"),b=a.index_.toString()),c.orderBy=(0,Z.As)(b),a.startSet_){let b=a.startAfterSet_?"startAfter":"startAt";c[b]=(0,Z.As)(a.indexStartValue_),a.startNameSet_&&(c[b]+=","+(0,Z.As)(a.indexStartName_))}if(a.endSet_){let b=a.endBeforeSet_?"endBefore":"endAt";c[b]=(0,Z.As)(a.indexEndValue_),a.endNameSet_&&(c[b]+=","+(0,Z.As)(a.indexEndName_))}return a.limitSet_&&(a.isViewFromLeft()?c.limitToFirst=a.limit_:c.limitToLast=a.limit_),c}function bS(a){let b={};if(a.startSet_&&(b.sp=a.indexStartValue_,a.startNameSet_&&(b.sn=a.indexStartName_),b.sin=!a.startAfterSet_),a.endSet_&&(b.ep=a.indexEndValue_,a.endNameSet_&&(b.en=a.indexEndName_),b.ein=!a.endBeforeSet_),a.limitSet_){b.l=a.limit_;let c=a.viewFrom_;""===c&&(c=a.isViewFromLeft()?"l":"r"),b.vf=c}return a.index_!==bC&&(b.i=a.index_.toString()),b}class bT extends a3{reportStats(a){throw Error("Method not implemented.")}static getListenId_(a,b){return void 0!==b?"tag$"+b:((0,Z.vA)(a._queryParams.isDefault(),"should have a tag if it's not a default query."),a._path.toString())}constructor(a,b,c,d){super(),this.repoInfo_=a,this.onDataUpdate_=b,this.authTokenProvider_=c,this.appCheckTokenProvider_=d,this.log_=ar("p:rest:"),this.listens_={}}listen(a,b,c,d){let e=a._path.toString();this.log_("Listen called for "+e+" "+a._queryIdentifier);let f=bT.getListenId_(a,c),g={};this.listens_[f]=g;let h=bR(a._queryParams);this.restRequest_(e+".json",h,(a,b)=>{let h=b;(404===a&&(h=null,a=null),null===a&&this.onDataUpdate_(e,h,!1,c),(0,Z.yw)(this.listens_,f)===g)&&d(a?401===a?"permission_denied":"rest_error:"+a:"ok",null)})}unlisten(a,b){let c=bT.getListenId_(a,b);delete this.listens_[c]}get(a){let b=bR(a._queryParams),c=a._path.toString(),d=new Z.cY;return this.restRequest_(c+".json",b,(a,b)=>{let e=b;404===a&&(e=null,a=null),null===a?(this.onDataUpdate_(c,e,!1,null),d.resolve(e)):d.reject(Error(e))}),d.promise}refreshAuthToken(a){}restRequest_(a,b={},c){return b.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([d,e])=>{d&&d.accessToken&&(b.auth=d.accessToken),e&&e.token&&(b.ac=e.token);let f=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+a+"?ns="+this.repoInfo_.namespace+(0,Z.Am)(b);this.log_("Sending REST request for "+f);let g=new XMLHttpRequest;g.onreadystatechange=()=>{if(c&&4===g.readyState){this.log_("REST Response for "+f+" received. status:",g.status,"response:",g.responseText);let a=null;if(g.status>=200&&g.status<300){try{a=(0,Z.$L)(g.responseText)}catch(a){au("Failed to parse JSON response for "+f+": "+g.responseText)}c(null,a)}else 401!==g.status&&404!==g.status&&au("Got unsuccessful REST response for "+f+" Status: "+g.status),c(g.status);c=null}},g.open("GET",f,!0),g.send()})}}class bU{constructor(){this.rootNode_=bI.EMPTY_NODE}getNode(a){return this.rootNode_.getChild(a)}updateSnapshot(a,b){this.rootNode_=this.rootNode_.updateChild(a,b)}}function bV(){return{value:null,children:new Map}}function bW(a,b,c){var d,e;null!==a.value?c(b,a.value):(d=a,e=(a,d)=>{bW(d,new a6(b.toString()+"/"+a),c)},d.children.forEach((a,b)=>{e(b,a)}))}class bX{constructor(a){this.collection_=a,this.last_=null}get(){let a=this.collection_.get(),b={...a};return this.last_&&aF(this.last_,(a,c)=>{b[a]=b[a]-c}),this.last_=a,b}}class bY{constructor(a,b){this.server_=b,this.statsToReport_={},this.statsListener_=new bX(a);let c=1e4+2e4*Math.random();aK(this.reportStats_.bind(this),Math.floor(c))}reportStats_(){let a=this.statsListener_.get(),b={},c=!1;aF(a,(a,d)=>{d>0&&(0,Z.gR)(this.statsToReport_,a)&&(b[a]=d,c=!0)}),c&&this.server_.reportStats(b),aK(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))}}function bZ(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function b$(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function b_(a){return{fromUser:!1,fromServer:!0,queryId:a,tagged:!0}}!function(a){a[a.OVERWRITE=0]="OVERWRITE",a[a.MERGE=1]="MERGE",a[a.ACK_USER_WRITE=2]="ACK_USER_WRITE",a[a.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(n||(n={}));class b0{constructor(a,b,c){this.path=a,this.affectedTree=b,this.revert=c,this.type=n.ACK_USER_WRITE,this.source=bZ()}operationForChild(a){if(!bf(this.path))return(0,Z.vA)(a8(this.path)===a,"operationForChild called for unrelated child."),new b0(ba(this.path),this.affectedTree,this.revert);if(null!=this.affectedTree.value)return(0,Z.vA)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let b=this.affectedTree.subtree(new a6(a));return new b0(a7(),b,this.revert)}}}class b1{constructor(a,b,c){this.source=a,this.path=b,this.snap=c,this.type=n.OVERWRITE}operationForChild(a){return bf(this.path)?new b1(this.source,a7(),this.snap.getImmediateChild(a)):new b1(this.source,ba(this.path),this.snap)}}class b2{constructor(a,b,c){this.source=a,this.path=b,this.children=c,this.type=n.MERGE}operationForChild(a){if(!bf(this.path))return(0,Z.vA)(a8(this.path)===a,"Can't get a merge for a child not on the path of the operation"),new b2(this.source,ba(this.path),this.children);{let b=this.children.subtree(new a6(a));return b.isEmpty()?null:b.value?new b1(this.source,a7(),b.value):new b2(this.source,a7(),b)}}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class b3{constructor(a,b,c){this.node_=a,this.fullyInitialized_=b,this.filtered_=c}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(a){if(bf(a))return this.isFullyInitialized()&&!this.filtered_;let b=a8(a);return this.isCompleteForChild(b)}isCompleteForChild(a){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(a)}getNode(){return this.node_}}function b4(a,b,c,d,e,f){let g=d.filter(a=>a.type===c);g.sort((b,c)=>(function(a,b,c){if(null==b.childName||null==c.childName)throw(0,Z.Hk)("Should only compare child_ events.");let d=new bo(b.childName,b.snapshotNode),e=new bo(c.childName,c.snapshotNode);return a.index_.compare(d,e)})(a,b,c)),g.forEach(c=>{var d,g,h;let i=(d=a,g=c,h=f,"value"===g.type||"child_removed"===g.type||(g.prevName=h.getPredecessorChildName(g.childName,g.snapshotNode,d.index_)),g);e.forEach(d=>{d.respondsTo(c.type)&&b.push(d.createEvent(i,a.query_))})})}function b5(a,b){return{eventCache:a,serverCache:b}}function b6(a,b,c,d){return b5(new b3(b,c,d),a.serverCache)}function b7(a,b,c,d){return b5(a.eventCache,new b3(b,c,d))}function b8(a){return a.eventCache.isFullyInitialized()?a.eventCache.getNode():null}function b9(a){return a.serverCache.isFullyInitialized()?a.serverCache.getNode():null}class ca{static fromObject(a){let b=new ca(null);return aF(a,(a,c)=>{b=b.set(new a6(a),c)}),b}constructor(a,b=(!k&&(k=new bv(aB)),k)){this.value=a,this.children=b}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(a,b){if(null!=this.value&&b(this.value))return{path:a7(),value:this.value};{if(bf(a))return null;let c=a8(a),d=this.children.get(c);if(null===d)return null;{let e=d.findRootMostMatchingPathAndValue(ba(a),b);return null!=e?{path:be(new a6(c),e.path),value:e.value}:null}}}findRootMostValueAndPath(a){return this.findRootMostMatchingPathAndValue(a,()=>!0)}subtree(a){if(bf(a))return this;{let b=a8(a),c=this.children.get(b);return null!==c?c.subtree(ba(a)):new ca(null)}}set(a,b){if(bf(a))return new ca(b,this.children);{let c=a8(a),d=(this.children.get(c)||new ca(null)).set(ba(a),b),e=this.children.insert(c,d);return new ca(this.value,e)}}remove(a){if(bf(a))if(this.children.isEmpty())return new ca(null);else return new ca(null,this.children);{let b=a8(a),c=this.children.get(b);if(!c)return this;{let d,e=c.remove(ba(a));return(d=e.isEmpty()?this.children.remove(b):this.children.insert(b,e),null===this.value&&d.isEmpty())?new ca(null):new ca(this.value,d)}}}get(a){if(bf(a))return this.value;{let b=a8(a),c=this.children.get(b);return c?c.get(ba(a)):null}}setTree(a,b){if(bf(a))return b;{let c,d=a8(a),e=(this.children.get(d)||new ca(null)).setTree(ba(a),b);return c=e.isEmpty()?this.children.remove(d):this.children.insert(d,e),new ca(this.value,c)}}fold(a){return this.fold_(a7(),a)}fold_(a,b){let c={};return this.children.inorderTraversal((d,e)=>{c[d]=e.fold_(be(a,d),b)}),b(a,this.value,c)}findOnPath(a,b){return this.findOnPath_(a,a7(),b)}findOnPath_(a,b,c){let d=!!this.value&&c(b,this.value);if(d)return d;{if(bf(a))return null;let d=a8(a),e=this.children.get(d);return e?e.findOnPath_(ba(a),be(b,d),c):null}}foreachOnPath(a,b){return this.foreachOnPath_(a,a7(),b)}foreachOnPath_(a,b,c){if(bf(a))return this;{this.value&&c(b,this.value);let d=a8(a),e=this.children.get(d);return e?e.foreachOnPath_(ba(a),be(b,d),c):new ca(null)}}foreach(a){this.foreach_(a7(),a)}foreach_(a,b){this.children.inorderTraversal((c,d)=>{d.foreach_(be(a,c),b)}),this.value&&b(a,this.value)}foreachChild(a){this.children.inorderTraversal((b,c)=>{c.value&&a(b,c.value)})}}class cb{constructor(a){this.writeTree_=a}static empty(){return new cb(new ca(null))}}function cc(a,b,c){if(bf(b))return new cb(new ca(c));{let d=a.writeTree_.findRootMostValueAndPath(b);if(null!=d){let e=d.path,f=d.value,g=bg(e,b);return f=f.updateChild(g,c),new cb(a.writeTree_.set(e,f))}{let d=new ca(c);return new cb(a.writeTree_.setTree(b,d))}}}function cd(a,b,c){let d=a;return aF(c,(a,c)=>{d=cc(d,be(b,a),c)}),d}function ce(a,b){return bf(b)?cb.empty():new cb(a.writeTree_.setTree(b,new ca(null)))}function cf(a,b){return null!=cg(a,b)}function cg(a,b){let c=a.writeTree_.findRootMostValueAndPath(b);return null!=c?a.writeTree_.get(c.path).getChild(bg(c.path,b)):null}function ch(a){let b=[],c=a.writeTree_.value;return null!=c?c.isLeafNode()||c.forEachChild(bC,(a,c)=>{b.push(new bo(a,c))}):a.writeTree_.children.inorderTraversal((a,c)=>{null!=c.value&&b.push(new bo(a,c.value))}),b}function ci(a,b){if(bf(b))return a;{let c=cg(a,b);return new cb(null!=c?new ca(c):a.writeTree_.subtree(b))}}function cj(a){return a.writeTree_.isEmpty()}function ck(a,b){return function a(b,c,d){if(null!=c.value)return d.updateChild(b,c.value);{let e=null;return c.children.inorderTraversal((c,f)=>{".priority"===c?((0,Z.vA)(null!==f.value,"Priority writes must always be leaf nodes"),e=f.value):d=a(be(b,c),f,d)}),d.getChild(b).isEmpty()||null===e||(d=d.updateChild(be(b,".priority"),e)),d}}(a7(),a.writeTree_,b)}function cl(a){return a.visible}function cm(a,b,c){let d=cb.empty();for(let e=0;e<a.length;++e){let f=a[e];if(b(f)){let a,b=f.path;if(f.snap)bi(c,b)?d=cc(d,a=bg(c,b),f.snap):bi(b,c)&&(a=bg(b,c),d=cc(d,a7(),f.snap.getChild(a)));else if(f.children){if(bi(c,b))d=cd(d,a=bg(c,b),f.children);else if(bi(b,c))if(bf(a=bg(b,c)))d=cd(d,a7(),f.children);else{let b=(0,Z.yw)(f.children,a8(a));if(b){let c=b.getChild(ba(a));d=cc(d,a7(),c)}}}else throw(0,Z.Hk)("WriteRecord should have .snap or .children")}}return d}function cn(a,b,c,d,e){if(d||e){let f=ci(a.visibleWrites,b);return!e&&cj(f)?c:e||null!=c||cf(f,a7())?ck(cm(a.allWrites,function(a){return(a.visible||e)&&(!d||!~d.indexOf(a.writeId))&&(bi(a.path,b)||bi(b,a.path))},b),c||bI.EMPTY_NODE):null}{let d=cg(a.visibleWrites,b);if(null!=d)return d;{let d=ci(a.visibleWrites,b);return cj(d)?c:null!=c||cf(d,a7())?ck(d,c||bI.EMPTY_NODE):null}}}function co(a,b,c,d){return cn(a.writeTree,a.treePath,b,c,d)}function cp(a,b){return function(a,b,c){let d=bI.EMPTY_NODE,e=cg(a.visibleWrites,b);if(e)return e.isLeafNode()||e.forEachChild(bC,(a,b)=>{d=d.updateImmediateChild(a,b)}),d;if(!c)return ch(ci(a.visibleWrites,b)).forEach(a=>{d=d.updateImmediateChild(a.name,a.node)}),d;{let e=ci(a.visibleWrites,b);return c.forEachChild(bC,(a,b)=>{let c=ck(ci(e,new a6(a)),b);d=d.updateImmediateChild(a,c)}),ch(e).forEach(a=>{d=d.updateImmediateChild(a.name,a.node)}),d}}(a.writeTree,a.treePath,b)}function cq(a,b,c,d){return function(a,b,c,d,e){(0,Z.vA)(d||e,"Either existingEventSnap or existingServerSnap must exist");let f=be(b,c);if(cf(a.visibleWrites,f))return null;{let b=ci(a.visibleWrites,f);return cj(b)?e.getChild(c):ck(b,e.getChild(c))}}(a.writeTree,a.treePath,b,c,d)}function cr(a,b){var c,d;return c=a.writeTree,d=be(a.treePath,b),cg(c.visibleWrites,d)}function cs(a,b,c){return function(a,b,c,d){let e=be(b,c),f=cg(a.visibleWrites,e);return null!=f?f:d.isCompleteForChild(c)?ck(ci(a.visibleWrites,e),d.getNode().getImmediateChild(c)):null}(a.writeTree,a.treePath,b,c)}function ct(a,b){return cu(be(a.treePath,b),a.writeTree)}function cu(a,b){return{treePath:a,writeTree:b}}class cv{constructor(){this.changeMap=new Map}trackChildChange(a){let b=a.type,c=a.childName;(0,Z.vA)("child_added"===b||"child_changed"===b||"child_removed"===b,"Only child changes supported for tracking"),(0,Z.vA)(".priority"!==c,"Only non-priority child changes can be tracked.");let d=this.changeMap.get(c);if(d){let e=d.type;if("child_added"===b&&"child_removed"===e)this.changeMap.set(c,bP(c,a.snapshotNode,d.snapshotNode));else if("child_removed"===b&&"child_added"===e)this.changeMap.delete(c);else if("child_removed"===b&&"child_changed"===e)this.changeMap.set(c,{type:"child_removed",snapshotNode:d.oldSnap,childName:c});else if("child_changed"===b&&"child_added"===e)this.changeMap.set(c,{type:"child_added",snapshotNode:a.snapshotNode,childName:c});else if("child_changed"===b&&"child_changed"===e)this.changeMap.set(c,bP(c,a.snapshotNode,d.oldSnap));else throw(0,Z.Hk)("Illegal combination of changes: "+a+" occurred after "+d)}else this.changeMap.set(c,a)}getChanges(){return Array.from(this.changeMap.values())}}class cw{getCompleteChild(a){return null}getChildAfterChild(a,b,c){return null}}let cx=new cw;class cy{constructor(a,b,c=null){this.writes_=a,this.viewCache_=b,this.optCompleteServerCache_=c}getCompleteChild(a){let b=this.viewCache_.eventCache;if(b.isCompleteForChild(a))return b.getNode().getImmediateChild(a);{let b=null!=this.optCompleteServerCache_?new b3(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return cs(this.writes_,a,b)}}getChildAfterChild(a,b,c){var d;let e=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:b9(this.viewCache_),f=(d=this.writes_,function(a,b,c,d,e,f,g){let h,i=ci(a.visibleWrites,b),j=cg(i,a7());if(null!=j)h=j;else{if(null==c)return[];h=ck(i,c)}if((h=h.withIndex(g)).isEmpty()||h.isLeafNode())return[];{let a=[],b=g.getCompare(),c=f?h.getReverseIteratorFrom(d,g):h.getIteratorFrom(d,g),e=c.getNext();for(;e&&a.length<1;)0!==b(e,d)&&a.push(e),e=c.getNext();return a}}(d.writeTree,d.treePath,e,b,1,c,a));return 0===f.length?null:f[0]}}function cz(a,b,c,d,e,f){let g=b.eventCache;if(null!=cr(d,c))return b;{let h,i;if(bf(c))if((0,Z.vA)(b.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),b.serverCache.isFiltered()){let c=b9(b),e=cp(d,c instanceof bI?c:bI.EMPTY_NODE);h=a.filter.updateFullNode(b.eventCache.getNode(),e,f)}else{let c=co(d,b9(b));h=a.filter.updateFullNode(b.eventCache.getNode(),c,f)}else{let j=a8(c);if(".priority"===j){(0,Z.vA)(1===a9(c),"Can't have a priority with additional path components");let e=g.getNode(),f=cq(d,c,e,i=b.serverCache.getNode());h=null!=f?a.filter.updatePriority(e,f):g.getNode()}else{let k,l=ba(c);if(g.isCompleteForChild(j)){i=b.serverCache.getNode();let a=cq(d,c,g.getNode(),i);k=null!=a?g.getNode().getImmediateChild(j).updateChild(l,a):g.getNode().getImmediateChild(j)}else k=cs(d,j,b.serverCache);h=null!=k?a.filter.updateChild(g.getNode(),j,k,l,e,f):g.getNode()}}return b6(b,h,g.isFullyInitialized()||bf(c),a.filter.filtersNodes())}}function cA(a,b,c,d,e,f,g,h){let i,j=b.serverCache,k=g?a.filter:a.filter.getIndexedFilter();if(bf(c))i=k.updateFullNode(j.getNode(),d,null);else if(k.filtersNodes()&&!j.isFiltered()){let a=j.getNode().updateChild(c,d);i=k.updateFullNode(j.getNode(),a,null)}else{let a=a8(c);if(!j.isCompleteForPath(c)&&a9(c)>1)return b;let e=ba(c),f=j.getNode().getImmediateChild(a).updateChild(e,d);i=".priority"===a?k.updatePriority(j.getNode(),f):k.updateChild(j.getNode(),a,f,e,cx,null)}let l=b7(b,i,j.isFullyInitialized()||bf(c),k.filtersNodes()),m=new cy(e,l,f);return cz(a,l,c,e,m,h)}function cB(a,b,c,d,e,f,g){let h,i,j=b.eventCache,k=new cy(e,b,f);if(bf(c))i=a.filter.updateFullNode(b.eventCache.getNode(),d,g),h=b6(b,i,!0,a.filter.filtersNodes());else{let e=a8(c);if(".priority"===e)i=a.filter.updatePriority(b.eventCache.getNode(),d),h=b6(b,i,j.isFullyInitialized(),j.isFiltered());else{let f,i=ba(c),l=j.getNode().getImmediateChild(e);if(bf(i))f=d;else{let a=k.getCompleteChild(e);f=null!=a?".priority"===bb(i)&&a.getChild(bd(i)).isEmpty()?a:a.updateChild(i,d):bI.EMPTY_NODE}h=l.equals(f)?b:b6(b,a.filter.updateChild(j.getNode(),e,f,i,k,g),j.isFullyInitialized(),a.filter.filtersNodes())}}return h}function cC(a,b){return a.eventCache.isCompleteForChild(b)}function cD(a,b,c){return c.foreach((a,c)=>{b=b.updateChild(a,c)}),b}function cE(a,b,c,d,e,f,g,h){let i;if(b.serverCache.getNode().isEmpty()&&!b.serverCache.isFullyInitialized())return b;let j=b;i=bf(c)?d:new ca(null).setTree(c,d);let k=b.serverCache.getNode();return i.children.inorderTraversal((c,d)=>{if(k.hasChild(c)){let i=cD(a,b.serverCache.getNode().getImmediateChild(c),d);j=cA(a,j,new a6(c),i,e,f,g,h)}}),i.children.inorderTraversal((c,d)=>{let i=!b.serverCache.isCompleteForChild(c)&&null===d.value;if(!k.hasChild(c)&&!i){let i=cD(a,b.serverCache.getNode().getImmediateChild(c),d);j=cA(a,j,new a6(c),i,e,f,g,h)}}),j}function cF(a,b,c,d){var e,f;b.type===n.MERGE&&null!==b.source.queryId&&((0,Z.vA)(b9(a.viewCache_),"We should always have a full cache before handling merges"),(0,Z.vA)(b8(a.viewCache_),"Missing event cache, even though we have a server cache"));let g=a.viewCache_,h=function(a,b,c,d,e){let f,g,h=new cv;if(c.type===n.OVERWRITE)c.source.fromUser?f=cB(a,b,c.path,c.snap,d,e,h):((0,Z.vA)(c.source.fromServer,"Unknown source."),g=c.source.tagged||b.serverCache.isFiltered()&&!bf(c.path),f=cA(a,b,c.path,c.snap,d,e,g,h));else if(c.type===n.MERGE){var i,j,k,l,m,o,p;let n;c.source.fromUser?(i=a,j=b,k=c.path,l=c.children,m=d,o=e,p=h,n=j,l.foreach((a,b)=>{let c=be(k,a);cC(j,a8(c))&&(n=cB(i,n,c,b,m,o,p))}),l.foreach((a,b)=>{let c=be(k,a);cC(j,a8(c))||(n=cB(i,n,c,b,m,o,p))}),f=n):((0,Z.vA)(c.source.fromServer,"Unknown source."),g=c.source.tagged||b.serverCache.isFiltered(),f=cE(a,b,c.path,c.children,d,e,g,h))}else if(c.type===n.ACK_USER_WRITE)f=c.revert?function(a,b,c,d,e,f){let g;if(null!=cr(d,c))return b;{let h,i=new cy(d,b,e),j=b.eventCache.getNode();if(bf(c)||".priority"===a8(c)){let c;if(b.serverCache.isFullyInitialized())c=co(d,b9(b));else{let a=b.serverCache.getNode();(0,Z.vA)(a instanceof bI,"serverChildren would be complete if leaf node"),c=cp(d,a)}h=a.filter.updateFullNode(j,c,f)}else{let e=a8(c),k=cs(d,e,b.serverCache);null==k&&b.serverCache.isCompleteForChild(e)&&(k=j.getImmediateChild(e)),(h=null!=k?a.filter.updateChild(j,e,k,ba(c),i,f):b.eventCache.getNode().hasChild(e)?a.filter.updateChild(j,e,bI.EMPTY_NODE,ba(c),i,f):j).isEmpty()&&b.serverCache.isFullyInitialized()&&(g=co(d,b9(b))).isLeafNode()&&(h=a.filter.updateFullNode(h,g,f))}return g=b.serverCache.isFullyInitialized()||null!=cr(d,a7()),b6(b,h,g,a.filter.filtersNodes())}}(a,b,c.path,d,e,h):function(a,b,c,d,e,f,g){if(null!=cr(e,c))return b;let h=b.serverCache.isFiltered(),i=b.serverCache;if(null!=d.value)if(bf(c)&&i.isFullyInitialized()||i.isCompleteForPath(c))return cA(a,b,c,i.getNode().getChild(c),e,f,h,g);else{if(!bf(c))return b;let d=new ca(null);return i.getNode().forEachChild(br,(a,b)=>{d=d.set(new a6(a),b)}),cE(a,b,c,d,e,f,h,g)}{let j=new ca(null);return d.foreach((a,b)=>{let d=be(c,a);i.isCompleteForPath(d)&&(j=j.set(a,i.getNode().getChild(d)))}),cE(a,b,c,j,e,f,h,g)}}(a,b,c.path,c.affectedTree,d,e,h);else if(c.type===n.LISTEN_COMPLETE)f=function(a,b,c,d,e){let f=b.serverCache;return cz(a,b7(b,f.getNode(),f.isFullyInitialized()||bf(c),f.isFiltered()),c,d,cx,e)}(a,b,c.path,d,h);else throw(0,Z.Hk)("Unknown operation type: "+c.type);let q=h.getChanges();return function(a,b,c){let d=b.eventCache;if(d.isFullyInitialized()){let e=d.getNode().isLeafNode()||d.getNode().isEmpty(),f=b8(a);!(c.length>0)&&a.eventCache.isFullyInitialized()&&(!e||d.getNode().equals(f))&&d.getNode().getPriority().equals(f.getPriority())||c.push({type:"value",snapshotNode:b8(b)})}}(b,f,q),{viewCache:f,changes:q}}(a.processor_,g,b,c,d);return e=a.processor_,f=h.viewCache,(0,Z.vA)(f.eventCache.getNode().isIndexed(e.filter.getIndex()),"Event snap not indexed"),(0,Z.vA)(f.serverCache.getNode().isIndexed(e.filter.getIndex()),"Server snap not indexed"),(0,Z.vA)(h.viewCache.serverCache.isFullyInitialized()||!g.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),a.viewCache_=h.viewCache,function(a,b,c,d){let e=(0,a.eventRegistrations_);var f=a.eventGenerator_;let g=[],h=[];return b.forEach(a=>{var b;"child_changed"===a.type&&f.index_.indexedValueChanged(a.oldSnap,a.snapshotNode)&&h.push((b=a.childName,{type:"child_moved",snapshotNode:a.snapshotNode,childName:b}))}),b4(f,g,"child_removed",b,e,c),b4(f,g,"child_added",b,e,c),b4(f,g,"child_moved",h,e,c),b4(f,g,"child_changed",b,e,c),b4(f,g,"value",b,e,c),g}(a,h.changes,h.viewCache.eventCache.getNode(),null)}function cG(a,b,c,d){let e=b.source.queryId;if(null!==e){let f=a.views.get(e);return(0,Z.vA)(null!=f,"SyncTree gave us an op for an invalid query."),cF(f,b,c,d)}{let e=[];for(let f of a.views.values())e=e.concat(cF(f,b,c,d));return e}}function cH(a,b){let c=null;for(let d of a.views.values())c=c||function(a,b){let c=b9(a.viewCache_);return c&&(a.query._queryParams.loadsAllData()||!bf(b)&&!c.getImmediateChild(a8(b)).isEmpty())?c.getChild(b):null}(d,b);return c}class cI{constructor(a){this.listenProvider_=a,this.syncPointTree_=new ca(null),this.pendingWriteTree_={visibleWrites:cb.empty(),allWrites:[],lastWriteId:-1},this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function cJ(a,b,c=!1){let d=function(a,b){for(let c=0;c<a.allWrites.length;c++){let d=a.allWrites[c];if(d.writeId===b)return d}return null}(a.pendingWriteTree_,b);if(!function(a,b){var c;let d=a.allWrites.findIndex(a=>a.writeId===b);(0,Z.vA)(d>=0,"removeWrite called with nonexistent writeId.");let e=a.allWrites[d];a.allWrites.splice(d,1);let f=e.visible,g=!1,h=a.allWrites.length-1;for(;f&&h>=0;){let b=a.allWrites[h];b.visible&&(h>=d&&function(a,b){if(a.snap)return bi(a.path,b);for(let c in a.children)if(a.children.hasOwnProperty(c)&&bi(be(a.path,c),b))return!0;return!1}(b,e.path)?f=!1:bi(e.path,b.path)&&(g=!0)),h--}return!!f&&(g?((c=a).visibleWrites=cm(c.allWrites,cl,a7()),c.allWrites.length>0?c.lastWriteId=c.allWrites[c.allWrites.length-1].writeId:c.lastWriteId=-1):e.snap?a.visibleWrites=ce(a.visibleWrites,e.path):aF(e.children,b=>{a.visibleWrites=ce(a.visibleWrites,be(e.path,b))}),!0)}(a.pendingWriteTree_,b))return[];{let b=new ca(null);return null!=d.snap?b=b.set(a7(),!0):aF(d.children,a=>{b=b.set(new a6(a),!0)}),cM(a,new b0(d.path,b,c))}}function cK(a,b,c){return cM(a,new b1(b$(),b,c))}function cL(a,b,c){let d=a.pendingWriteTree_,e=a.syncPointTree_.findOnPath(b,(a,c)=>{let d=cH(c,bg(a,b));if(d)return d});return cn(d,b,e,c,!0)}function cM(a,b){var c;return function a(b,c,d,e){if(bf(b.path))return function a(b,c,d,e){let f=c.get(a7());null==d&&null!=f&&(d=cH(f,a7()));let g=[];return c.children.inorderTraversal((c,f)=>{let h=d?d.getImmediateChild(c):null,i=ct(e,c),j=b.operationForChild(c);j&&(g=g.concat(a(j,f,h,i)))}),f&&(g=g.concat(cG(f,b,e,d))),g}(b,c,d,e);{let f=c.get(a7());null==d&&null!=f&&(d=cH(f,a7()));let g=[],h=a8(b.path),i=b.operationForChild(h),j=c.children.get(h);if(j&&i){let b=d?d.getImmediateChild(h):null,c=ct(e,h);g=g.concat(a(i,j,b,c))}return f&&(g=g.concat(cG(f,b,e,d))),g}}(b,a.syncPointTree_,null,(c=a.pendingWriteTree_,cu(a7(),c)))}function cN(a,b){return a.tagToQueryMap.get(b)}function cO(a){let b=a.indexOf("$");return(0,Z.vA)(-1!==b&&b<a.length-1,"Bad queryKey."),{queryId:a.substr(b+1),path:new a6(a.substr(0,b))}}function cP(a,b,c){let d=a.syncPointTree_.get(b);return(0,Z.vA)(d,"Missing sync point for query tag that we're tracking"),cG(d,c,cu(b,a.pendingWriteTree_),null)}class cQ{constructor(a){this.node_=a}getImmediateChild(a){return new cQ(this.node_.getImmediateChild(a))}node(){return this.node_}}class cR{constructor(a,b){this.syncTree_=a,this.path_=b}getImmediateChild(a){let b=be(this.path_,a);return new cR(this.syncTree_,b)}node(){return cL(this.syncTree_,this.path_)}}let cS=function(a,b,c){return a&&"object"==typeof a?((0,Z.vA)(".sv"in a,"Unexpected leaf node or priority contents"),"string"==typeof a[".sv"])?cT(a[".sv"],b,c):"object"==typeof a[".sv"]?cU(a[".sv"],b):void(0,Z.vA)(!1,"Unexpected server value: "+JSON.stringify(a,null,2)):a},cT=function(a,b,c){if("timestamp"===a)return c.timestamp;(0,Z.vA)(!1,"Unexpected server value: "+a)},cU=function(a,b,c){a.hasOwnProperty("increment")||(0,Z.vA)(!1,"Unexpected server value: "+JSON.stringify(a,null,2));let d=a.increment;"number"!=typeof d&&(0,Z.vA)(!1,"Unexpected increment value: "+d);let e=b.node();if((0,Z.vA)(null!=e,"Expected ChildrenNode.EMPTY_NODE for nulls"),!e.isLeafNode())return d;let f=e.getValue();return"number"!=typeof f?d:f+d};function cV(a,b,c){let d,e=cS(a.getPriority().val(),b.getImmediateChild(".priority"),c);if(!a.isLeafNode())return d=a,e!==a.getPriority().val()&&(d=d.updatePriority(new bA(e))),a.forEachChild(bC,(a,e)=>{let f=cV(e,b.getImmediateChild(a),c);f!==e&&(d=d.updateImmediateChild(a,f))}),d;{let d=cS(a.getValue(),b,c);return d!==a.getValue()||e!==a.getPriority().val()?new bA(d,bL(e)):a}}class cW{constructor(a="",b=null,c={children:{},childCount:0}){this.name=a,this.parent=b,this.node=c}}function cX(a,b){let c=b instanceof a6?b:new a6(b),d=a,e=a8(c);for(;null!==e;){let a=(0,Z.yw)(d.node.children,e)||{children:{},childCount:0};d=new cW(e,d,a),e=a8(c=ba(c))}return d}function cY(a){return a.node.value}function cZ(a,b){a.node.value=b,function a(b){null!==b.parent&&function(b,c,d){let e=void 0===cY(d)&&!c$(d),f=(0,Z.gR)(b.node.children,c);e&&f?(delete b.node.children[c],b.node.childCount--,a(b)):e||f||(b.node.children[c]=d.node,b.node.childCount++,a(b))}(b.parent,b.name,b)}(a)}function c$(a){return a.node.childCount>0}function c_(a,b){aF(a.node.children,(c,d)=>{b(new cW(c,a,d))})}function c0(a){return new a6(null===a.parent?a.name:c0(a.parent)+"/"+a.name)}let c1=/[\[\].#$\/\u0000-\u001F\u007F]/,c2=/[\[\].#$\u0000-\u001F\u007F]/,c3=function(a){return"string"==typeof a&&0!==a.length&&!c1.test(a)},c4=function(a){var b;return a&&(a=a.replace(/^\/*\.info(\/|$)/,"/")),"string"==typeof(b=a)&&0!==b.length&&!c2.test(b)},c5=function(a,b,c){let d=c instanceof a6?new bj(c,a):c;if(void 0===b)throw Error(a+"contains undefined "+bl(d));if("function"==typeof b)throw Error(a+"contains a function "+bl(d)+" with contents = "+b.toString());if(aw(b))throw Error(a+"contains "+b.toString()+" "+bl(d));if("string"==typeof b&&b.length>3495253.3333333335&&(0,Z.OE)(b)>0xa00000)throw Error(a+"contains a string greater than 10485760 utf8 bytes "+bl(d)+" ('"+b.substring(0,50)+"...')");if(b&&"object"==typeof b){let c=!1,e=!1;if(aF(b,(b,f)=>{if(".value"===b)c=!0;else if(".priority"!==b&&".sv"!==b&&(e=!0,!c3(b)))throw Error(a+" contains an invalid key ("+b+") "+bl(d)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');d.parts_.length>0&&(d.byteLength_+=1),d.parts_.push(b),d.byteLength_+=(0,Z.OE)(b),bk(d),c5(a,f,d);let g=d.parts_.pop();d.byteLength_-=(0,Z.OE)(g),d.parts_.length>0&&(d.byteLength_-=1)}),c&&e)throw Error(a+' contains ".value" child '+bl(d)+" in addition to actual children.")}},c6=function(a,b){let c=b.path.toString();if("string"!=typeof b.repoInfo.host||0===b.repoInfo.host.length||!c3(b.repoInfo.namespace)&&"localhost"!==b.repoInfo.host.split(":")[0]||0!==c.length&&!c4(c))throw Error((0,Z.dI)(a,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};class c7{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function c8(a,b,c){let d=null;for(let b=0;b<c.length;b++){let e=c[b],f=e.getPath();null===d||bh(f,d.path)||(a.eventLists_.push(d),d=null),null===d&&(d={events:[],path:f}),d.events.push(e)}d&&a.eventLists_.push(d),function(a,b){a.recursionDepth_++;let c=!0;for(let d=0;d<a.eventLists_.length;d++){let e=a.eventLists_[d];e&&(b(e.path)?(function(a){for(let b=0;b<a.events.length;b++){let c=a.events[b];if(null!==c){a.events[b]=null;let d=c.getEventRunner();an&&aq("event: "+c.toString()),aJ(d)}}}(a.eventLists_[d]),a.eventLists_[d]=null):c=!1)}c&&(a.eventLists_=[]),a.recursionDepth_--}(a,a=>bi(a,b)||bi(b,a))}class c9{constructor(a,b,c,d){this.repoInfo_=a,this.forceRestClient_=b,this.authTokenProvider_=c,this.appCheckProvider_=d,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new c7,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=bV(),this.transactionQueueTree_=new cW,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function da(a){var b;return(b=b={timestamp:function(a){let b=a.infoData_.getNode(new a6(".info/serverTimeOffset")).val()||0;return new Date().getTime()+b}(a)}).timestamp=b.timestamp||new Date().getTime(),b}function db(a,b,c,d,e){a.dataUpdateCount++;let f=new a6(b);c=a.interceptServerDataCallback_?a.interceptServerDataCallback_(b,c):c;let g=[];if(e)if(d){let b=(0,Z.kH)(c,a=>bL(a));g=function(a,b,c,d){let e=cN(a,d);if(!e)return[];{let d=cO(e),f=d.path,g=d.queryId,h=bg(f,b),i=ca.fromObject(c);return cP(a,f,new b2(b_(g),h,i))}}(a.serverSyncTree_,f,b,e)}else{let b=bL(c);g=function(a,b,c,d){let e=cN(a,d);if(null==e)return[];{let d=cO(e),f=d.path,g=d.queryId,h=bg(f,b);return cP(a,f,new b1(b_(g),h,c))}}(a.serverSyncTree_,f,b,e)}else if(d){let b=(0,Z.kH)(c,a=>bL(a));g=function(a,b,c){let d=ca.fromObject(c);return cM(a,new b2(b$(),b,d))}(a.serverSyncTree_,f,b)}else{let b=bL(c);g=cK(a.serverSyncTree_,f,b)}let h=f;g.length>0&&(h=dg(a,f)),c8(a.eventQueue_,h,g)}function dc(a,b){dd(a,"connected",b),!1===b&&function(a){de(a,"onDisconnectEvents");let b=da(a),c=bV();bW(a.onDisconnect_,a7(),(d,e)=>{var f;let g=(f=a.serverSyncTree_,cV(e,new cR(f,d),b));!function a(b,c,d){if(bf(c))b.value=d,b.children.clear();else if(null!==b.value)b.value=b.value.updateChild(c,d);else{let e=a8(c);b.children.has(e)||b.children.set(e,bV()),a(b.children.get(e),c=ba(c),d)}}(c,d,g)});let d=[];bW(c,a7(),(b,c)=>{d=d.concat(cK(a.serverSyncTree_,b,c));let e=function(a,b){let c=c0(dh(a,b)),d=cX(a.transactionQueueTree_,b);return!function(a,b,c){let d=a.parent;for(;null!==d;){if(b(d))return!0;d=d.parent}}(d,b=>{dk(a,b)}),dk(a,d),!function a(b,c,d,e){d&&!e&&c(b),c_(b,b=>{a(b,c,!0,e)}),d&&e&&c(b)}(d,b=>{dk(a,b)}),c}(a,b);dg(a,e)}),a.onDisconnect_=bV(),c8(a.eventQueue_,a7(),d)}(a)}function dd(a,b,c){let d=new a6("/.info/"+b),e=bL(c);a.infoData_.updateSnapshot(d,e);let f=cK(a.infoSyncTree_,d,e);c8(a.eventQueue_,d,f)}function de(a,...b){let c="";a.persistentConnection_&&(c=a.persistentConnection_.id+":"),aq(c,...b)}function df(a,b,c){return cL(a.serverSyncTree_,b,c)||bI.EMPTY_NODE}function dg(a,b){let c=dh(a,b),d=c0(c),e=di(a,c);return function(a,b,c){if(0===b.length)return;let d=[],e=[],f=b.filter(a=>0===a.status).map(a=>a.currentWriteId);for(let g=0;g<b.length;g++){let h=b[g],i=bg(c,h.path),j=!1,k;if((0,Z.vA)(null!==i,"rerunTransactionsUnderNode_: relativePath should not be null."),4===h.status)j=!0,k=h.abortReason,e=e.concat(cJ(a.serverSyncTree_,h.currentWriteId,!0));else if(0===h.status)if(h.retryCount>=25)j=!0,k="maxretry",e=e.concat(cJ(a.serverSyncTree_,h.currentWriteId,!0));else{let c=df(a,h.path,f);h.currentInputSnapshot=c;let d=b[g].update(c.val());if(void 0!==d){c5("transaction failed: Data returned ",d,h.path);let b=bL(d);"object"==typeof d&&null!=d&&(0,Z.gR)(d,".priority")||(b=b.updatePriority(c.getPriority()));let g=h.currentWriteId,i=da(a),j=cV(b,new cQ(c),i);h.currentOutputSnapshotRaw=b,h.currentOutputSnapshotResolved=j,h.currentWriteId=a.nextWriteId_++,f.splice(f.indexOf(g),1),e=(e=e.concat(function(a,b,c,d,e){var f,g;return(f=a.pendingWriteTree_,g=e,(0,Z.vA)(d>f.lastWriteId,"Stacking an older write on top of newer ones"),void 0===g&&(g=!0),f.allWrites.push({path:b,snap:c,writeId:d,visible:g}),g&&(f.visibleWrites=cc(f.visibleWrites,b,c)),f.lastWriteId=d,e)?cM(a,new b1(bZ(),b,c)):[]}(a.serverSyncTree_,h.path,j,h.currentWriteId,h.applyLocally))).concat(cJ(a.serverSyncTree_,g,!0))}else j=!0,k="nodata",e=e.concat(cJ(a.serverSyncTree_,h.currentWriteId,!0))}c8(a.eventQueue_,c,e),e=[],j&&(b[g].status=2,setTimeout(b[g].unwatcher,Math.floor(0)),b[g].onComplete&&("nodata"===k?d.push(()=>b[g].onComplete(null,!1,b[g].currentInputSnapshot)):d.push(()=>b[g].onComplete(Error(k),!1,null))))}dj(a,a.transactionQueueTree_);for(let a=0;a<d.length;a++)aJ(d[a]);!function a(b,c=b.transactionQueueTree_){if(c||dj(b,c),cY(c)){let d=di(b,c);(0,Z.vA)(d.length>0,"Sending zero length transaction queue"),d.every(a=>0===a.status)&&function(b,c,d){let e=df(b,c,d.map(a=>a.currentWriteId)),f=e,g=e.hash();for(let a=0;a<d.length;a++){let b=d[a];(0,Z.vA)(0===b.status,"tryToSendTransactionQueue_: items in queue should all be run."),b.status=1,b.retryCount++;let e=bg(c,b.path);f=f.updateChild(e,b.currentOutputSnapshotRaw)}let h=f.val(!0);b.server_.put(c.toString(),h,e=>{de(b,"transaction put response",{path:c.toString(),status:e});let f=[];if("ok"===e){let e=[];for(let a=0;a<d.length;a++)d[a].status=2,f=f.concat(cJ(b.serverSyncTree_,d[a].currentWriteId)),d[a].onComplete&&e.push(()=>d[a].onComplete(null,!0,d[a].currentOutputSnapshotResolved)),d[a].unwatcher();dj(b,cX(b.transactionQueueTree_,c)),a(b,b.transactionQueueTree_),c8(b.eventQueue_,c,f);for(let a=0;a<e.length;a++)aJ(e[a])}else{if("datastale"===e)for(let a=0;a<d.length;a++)3===d[a].status?d[a].status=4:d[a].status=0;else{au("transaction at "+c.toString()+" failed: "+e);for(let a=0;a<d.length;a++)d[a].status=4,d[a].abortReason=e}dg(b,c)}},g)}(b,c0(c),d)}else c$(c)&&c_(c,c=>{a(b,c)})}(a,a.transactionQueueTree_)}(a,e,d),d}function dh(a,b){let c,d=a.transactionQueueTree_;for(c=a8(b);null!==c&&void 0===cY(d);)d=cX(d,c),c=a8(b=ba(b));return d}function di(a,b){let c=[];return function a(b,c,d){let e=cY(c);if(e)for(let a=0;a<e.length;a++)d.push(e[a]);c_(c,c=>{a(b,c,d)})}(a,b,c),c.sort((a,b)=>a.order-b.order),c}function dj(a,b){let c=cY(b);if(c){let a=0;for(let b=0;b<c.length;b++)2!==c[b].status&&(c[a]=c[b],a++);c.length=a,cZ(b,c.length>0?c:void 0)}c_(b,b=>{dj(a,b)})}function dk(a,b){let c=cY(b);if(c){let d=[],e=[],f=-1;for(let b=0;b<c.length;b++)3===c[b].status||(1===c[b].status?((0,Z.vA)(f===b-1,"All SENT items should be at beginning of queue."),f=b,c[b].status=3,c[b].abortReason="set"):((0,Z.vA)(0===c[b].status,"Unexpected transaction status in abort"),c[b].unwatcher(),e=e.concat(cJ(a.serverSyncTree_,c[b].currentWriteId,!0)),c[b].onComplete&&d.push(c[b].onComplete.bind(null,Error("set"),!1,null))));-1===f?cZ(b,void 0):c.length=f+1,c8(a.eventQueue_,c0(b),e);for(let a=0;a<d.length;a++)aJ(d[a])}}let dl=function(a,b){let c=dm(a),d=c.namespace;"firebase.com"===c.domain&&at(c.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),d&&"undefined"!==d||"localhost"===c.domain||at("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),c.secure||av();let e="ws"===c.scheme||"wss"===c.scheme;return{repoInfo:new aL(c.host,c.secure,d,e,b,"",d!==c.subdomain),path:new a6(c.pathString)}},dm=function(a){let b="",c="",d="",e="",f="",g=!0,h="https",i=443;if("string"==typeof a){let j=a.indexOf("//");j>=0&&(h=a.substring(0,j-1),a=a.substring(j+2));let k=a.indexOf("/");-1===k&&(k=a.length);let l=a.indexOf("?");-1===l&&(l=a.length),b=a.substring(0,Math.min(k,l)),k<l&&(e=function(a){let b="",c=a.split("/");for(let a=0;a<c.length;a++)if(c[a].length>0){let d=c[a];try{d=decodeURIComponent(d.replace(/\+/g," "))}catch(a){}b+="/"+d}return b}(a.substring(k,l)));let m=function(a){let b={};for(let c of("?"===a.charAt(0)&&(a=a.substring(1)),a.split("&"))){if(0===c.length)continue;let d=c.split("=");2===d.length?b[decodeURIComponent(d[0])]=decodeURIComponent(d[1]):au(`Invalid query segment '${c}' in query '${a}'`)}return b}(a.substring(Math.min(a.length,l)));(j=b.indexOf(":"))>=0?(g="https"===h||"wss"===h,i=parseInt(b.substring(j+1),10)):j=b.length;let n=b.slice(0,j);if("localhost"===n.toLowerCase())c="localhost";else if(n.split(".").length<=2)c=n;else{let a=b.indexOf(".");d=b.substring(0,a).toLowerCase(),c=b.substring(a+1),f=d}"ns"in m&&(f=m.ns)}return{host:b,port:i,domain:c,subdomain:d,secure:g,scheme:h,pathString:e,namespace:f}};class dn{constructor(a,b,c,d){this._repo=a,this._path=b,this._queryParams=c,this._orderByCalled=d}get key(){return bf(this._path)?null:bb(this._path)}get ref(){return new dp(this._repo,this._path)}get _queryIdentifier(){let a=aD(bS(this._queryParams));return"{}"===a?"default":a}get _queryObject(){return bS(this._queryParams)}isEqual(a){if(!((a=(0,Z.Ku)(a))instanceof dn))return!1;let b=this._repo===a._repo,c=bh(this._path,a._path),d=this._queryIdentifier===a._queryIdentifier;return b&&c&&d}toJSON(){return this.toString()}toString(){return this._repo.toString()+function(a){let b="";for(let c=a.pieceNum_;c<a.pieces_.length;c++)""!==a.pieces_[c]&&(b+="/"+encodeURIComponent(String(a.pieces_[c])));return b||"/"}(this._path)}}class dp extends dn{constructor(a,b){super(a,b,new bQ,!1)}get parent(){let a=bd(this._path);return null===a?null:new dp(this._repo,a)}get root(){let a=this;for(;null!==a.parent;)a=a.parent;return a}}(0,Z.vA)(!l,"__referenceConstructor has already been defined"),l=dp,(0,Z.vA)(!m,"__referenceConstructor has already been defined"),m=dp;let dq={};class dr{constructor(a,b){this._repoInternal=a,this.app=b,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(!function(a,b,c){if(a.stats_=aQ(a.repoInfo_),a.forceRestClient_||("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)a.server_=new bT(a.repoInfo_,(b,c,d,e)=>{db(a,b,c,d,e)},a.authTokenProvider_,a.appCheckProvider_),setTimeout(()=>dc(a,!0),0);else{if(null!=c){if("object"!=typeof c)throw Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,Z.As)(c)}catch(a){throw Error("Invalid authOverride provided: "+a)}}a.persistentConnection_=new bn(a.repoInfo_,b,(b,c,d,e)=>{db(a,b,c,d,e)},b=>{dc(a,b)},b=>{var c;c=a,aF(b,(a,b)=>{dd(c,a,b)})},a.authTokenProvider_,a.appCheckProvider_,c),a.server_=a.persistentConnection_}a.authTokenProvider_.addTokenChangeListener(b=>{a.server_.refreshAuthToken(b)}),a.appCheckProvider_.addTokenChangeListener(b=>{a.server_.refreshAppCheckToken(b.token)}),a.statsReporter_=function(a,b){let c=a.toString();return aP[c]||(aP[c]=b()),aP[c]}(a.repoInfo_,()=>new bY(a.stats_,a.server_)),a.infoData_=new bU,a.infoSyncTree_=new cI({startListening:(b,c,d,e)=>{let f=[],g=a.infoData_.getNode(b._path);return g.isEmpty()||(f=cK(a.infoSyncTree_,b._path,g),setTimeout(()=>{e("ok")},0)),f},stopListening:()=>{}}),dd(a,"connected",!1),a.serverSyncTree_=new cI({startListening:(b,c,d,e)=>(a.server_.listen(b,d,c,(c,d)=>{let f=e(c,d);c8(a.eventQueue_,b._path,f)}),[]),stopListening:(b,c)=>{a.server_.unlisten(b,c)}})}(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new dp(this._repo,a7())),this._rootInternal}_delete(){return null!==this._rootInternal&&(!function(a,b){let c=dq[b];c&&c[a.key]===a||at(`Database ${b}(${a.repoInfo_}) has already been deleted.`),a.persistentConnection_&&a.persistentConnection_.interrupt("repo_interrupt"),delete c[a.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(a){null===this._rootInternal&&at("Cannot call "+a+" on a deleted database.")}}bn.prototype.simpleListen=function(a,b){this.sendRequest("q",{p:a},b)},bn.prototype.echo=function(a,b){this.sendRequest("echo",{d:a},b)},aS=Y.Client;aR=_.MF,(0,_.om)(new aa.uA("database",(a,{instanceIdentifier:b})=>{let c=a.getProvider("app").getImmediate();return function(a,b,c,d,e){var f,g,h,i;let j,k,l,m,n=d||a.options.databaseURL;void 0===n&&(a.options.projectId||at("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),aq("Using default host for project ",a.options.projectId),n=`${a.options.projectId}-default-rtdb.firebaseio.com`);let o=dl(n,void 0),p=o.repoInfo;"undefined"!=typeof process&&process.env&&(l=process.env.FIREBASE_DATABASE_EMULATOR_HOST),l?(m=!0,p=(o=dl(n=`http://${l}?ns=${p.namespace}`,void 0)).repoInfo):m=!o.repoInfo.secure;let q=e&&m?new aY(aY.OWNER):new aX(a.name,a.options,b);return c6("Invalid Firebase Database URL",o),bf(o.path)||at("Database URL must point to the root of a Firebase Database (not including a child path)."),new dr((f=p,g=a,h=q,i=new aW(a,c),(j=dq[g.name])||(j={},dq[g.name]=j),(k=j[f.toURLString()])&&at("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),k=new c9(f,!1,h,i),j[f.toURLString()]=k,k),a)}(c,a.getProvider("auth-internal"),a.getProvider("app-check-internal"),b)},"PUBLIC").setMultipleInstances(!0)),(0,_.KO)(aU,aV,"node"),(0,_.KO)(aU,aV,"esm2020"),c(68618);var ds=c(83557),dt=c(97662),du=c(11759);function dv(){let[a,b]=q().useState(null);return(0,du.a)()?(0,o.jsxs)("div",{className:"h-[calc(100vh-100px)] border rounded-lg bg-card text-card-foreground overflow-hidden",children:[(0,o.jsx)("div",{className:(0,A.cn)("h-full transition-transform duration-300",a?"-translate-x-full":"translate-x-0"),children:(0,o.jsx)(M,{onSelectChat:b,selectedChatId:a})}),(0,o.jsx)("div",{className:(0,A.cn)("absolute inset-0 transition-transform duration-300",a?"translate-x-0":"translate-x-full"),children:a&&(0,o.jsxs)("div",{className:"flex flex-col h-full",children:[(0,o.jsx)("div",{className:"p-2 border-b flex items-center gap-2",children:(0,o.jsx)(L.$,{variant:"ghost",size:"icon",onClick:()=>{b(null)},children:(0,o.jsx)(ds.A,{className:"h-5 w-5"})})}),(0,o.jsx)(X,{chatId:a})]})})]}):(0,o.jsxs)("div",{className:"flex h-[calc(100vh-100px)] border rounded-lg bg-card text-card-foreground",children:[(0,o.jsx)("aside",{className:"w-full md:w-[350px] border-l flex flex-col bg-muted/20",children:(0,o.jsx)(M,{onSelectChat:b,selectedChatId:a})}),(0,o.jsx)("main",{className:"flex-1 flex-col hidden md:flex",children:a?(0,o.jsx)(X,{chatId:a}):(0,o.jsx)("div",{className:"flex-grow flex items-center justify-center text-muted-foreground",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)(dt.A,{className:"h-16 w-16 mx-auto text-gray-300 dark:text-gray-600"}),(0,o.jsx)("p",{className:"mt-4 font-bold",children:"   ."}),(0,o.jsx)("p",{className:"text-sm",children:"     ."})]})})})]})}},79551:a=>{"use strict";a.exports=require("url")},80665:(a,b,c)=>{"use strict";c.d(b,{$:()=>i,F:()=>h});var d=c(21124),e=c(38301),f=c(84550),g=c(44943);let h=e.forwardRef(({className:a,children:b,...c},e)=>(0,d.jsxs)(f.bL,{ref:e,className:(0,g.cn)("relative overflow-hidden",a),...c,children:[(0,d.jsx)(f.LM,{className:"h-full w-full rounded-[inherit]",children:b}),(0,d.jsx)(i,{}),(0,d.jsx)(f.OK,{})]}));h.displayName=f.bL.displayName;let i=e.forwardRef(({className:a,orientation:b="vertical",...c},e)=>(0,d.jsx)(f.VM,{ref:e,orientation:b,className:(0,g.cn)("flex touch-none select-none transition-colors","vertical"===b&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===b&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...c,children:(0,d.jsx)(f.lr,{className:"relative flex-1 rounded-full bg-border"})}));i.displayName=f.VM.displayName},81630:a=>{"use strict";a.exports=require("http")},86439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},91426:(a,b,c)=>{Promise.resolve().then(c.bind(c,22516))},91645:a=>{"use strict";a.exports=require("net")},93867:(a,b,c)=>{"use strict";var d=c(62253).Buffer,e=c(28647),f=c(28354),g=function(a,b,c){e.apply(this,arguments),this._stage=0,this.version="hixie-75",this._headers.set("Upgrade","WebSocket"),this._headers.set("Connection","Upgrade"),this._headers.set("WebSocket-Origin",this._request.headers.origin),this._headers.set("WebSocket-Location",this.url)};f.inherits(g,e);var h={close:function(){return 3!==this.readyState&&(this.readyState=3,this.emit("close",new e.CloseEvent(null,null)),!0)},parse:function(a){this.readyState>1||(this._reader.put(a),this._reader.eachByte(function(a){var b;switch(this._stage){case -1:this._body.push(a),this._sendHandshakeBody();break;case 0:this._parseLeadingByte(a);break;case 1:if(this._length=(127&a)+128*this._length,this._closing&&0===this._length)return this.close();(128&a)!=128&&(0===this._length?this._stage=0:(this._skipped=0,this._stage=2));break;case 2:if(255===a)this._stage=0,b=d.from(this._buffer).toString("utf8",0,this._buffer.length),this.emit("message",new e.MessageEvent(b));else if(this._length)this._skipped+=1,this._skipped===this._length&&(this._stage=0);else if(this._buffer.push(a),this._buffer.length>this._maxLength)return this.close()}},this))},frame:function(a){if(0===this.readyState)return this._queue([a]);if(this.readyState>1)return!1;"string"!=typeof a&&(a=a.toString());var b=d.byteLength(a),c=d.allocUnsafe(b+2);return c[0]=0,c.write(a,1),c[c.length-1]=255,this._write(c),!0},_handshakeResponse:function(){var a=["HTTP/1.1 101 Web Socket Protocol Handshake",this._headers.toString(),""];return d.from(a.join("\r\n"),"utf8")},_parseLeadingByte:function(a){(128&a)==128?(this._length=0,this._stage=1):(delete this._length,delete this._skipped,this._buffer=[],this._stage=2)}};for(var i in h)g.prototype[i]=h[i];a.exports=g},94519:(a,b,c)=>{"use strict";var d=c(28647),e=c(40485),f=c(72153);a.exports={client:function(a,b){return void 0===(b=b||{}).masking&&(b.masking=!0),new e(a,b)},server:function(a){return void 0===(a=a||{}).requireMasking&&(a.requireMasking=!0),new f(a)},http:function(){return f.http.apply(f,arguments)},isSecureRequest:function(a){return f.isSecureRequest(a)},isWebSocket:function(a){return d.isWebSocket(a)},validateOptions:function(a,b){d.validateOptions(a,b)}}},94735:a=>{"use strict";a.exports=require("events")},95378:(a,b,c)=>{"use strict";c.a(a,async(a,d)=>{try{c.d(b,{DI:()=>m,EP:()=>q,EZ:()=>o,KB:()=>t,Lf:()=>n,d5:()=>p,zO:()=>r,zZ:()=>s});var e=c(91488);c(27806);var f=c(80446),g=c(91837),h=c(62641),i=c(58749),j=c(29631),k=c(40410),l=a([f,h,i,j]);async function m(a){let{clients:b}=await n({...a,all:!0});return b.map(a=>({value:a.id,label:`${a.name} ${a.code?`(${a.code})`:""}`,relationType:a.relationType,paymentType:a.paymentType}))}async function n(a={}){let{all:b=!1,limit:c=15,page:d=1,searchTerm:e,relationType:g,paymentType:h,status:i,country:j,province:k,sortBy:l="useCount_desc"}=a,m=await (0,f.Lf)();if(!m)return{clients:[],total:0};try{let f,n=m.collection("clients");g&&"all"!==g&&(n=n.where("relationType","in","client"===g?["client","both"]:"supplier"===g?["supplier","both"]:[g])),h&&"all"!==h&&(n=n.where("paymentType","==",h)),i&&"all"!==i&&(n=n.where("status","==",i)),!0===a.includeInactive||i||(n=n.where("status","==","active")),j&&"all"!==j&&(n=n.where("country","==",j)),k&&"all"!==k&&(n=n.where("province","==",k));let o=(await n.get()).docs;if(e){let a=e.toLowerCase();o=o.filter(b=>{let c=b.data();return c.name&&c.name.toLowerCase().includes(a)||c.phone&&String(c.phone).includes(a)||c.code&&c.code.toLowerCase().includes(a)})}let p=o.length;if(l){let[a,b]=l.split("_");o.sort((c,d)=>{let e=c.data(),f=d.data(),g=e[a],h=f[a];if(null==g)return 1;if(null==h)return -1;let i=0;return"string"==typeof g&&"string"==typeof h?i=g.localeCompare(h):g>h?i=1:g<h&&(i=-1),"desc"===b?-1*i:i})}if(b)f=o;else{let a=(d-1)*c;f=o.slice(a,a+c)}if(0===f.length)return{clients:[],total:0};return{clients:f.map(a=>{let b=a.data();return{...JSON.parse(JSON.stringify(b,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),id:a.id}}),total:p}}catch(a){return console.error("Error getting clients from Firestore: ",String(a)),{clients:[],total:0}}}async function o(a){let b=await (0,f.Lf)();if(!b)return null;try{let c=await b.collection("clients").doc(a).get();if(!c.exists)return null;let d=c.data(),e=JSON.parse(JSON.stringify(d,(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b));return{id:c.id,...e}}catch(b){return console.error(`Error getting client by ID ${a}:`,String(b)),null}}async function p(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=c.name,e=await (0,j.tu)("CL"),f={...a,code:e,createdAt:new Date().toISOString(),createdBy:d,balance:{USD:0,IQD:0},lastTransaction:null,useCount:0};f.password&&f.password.length>=6||delete f.password;let h=await b.collection("clients").add(f);await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:`   : ${f.name} (ID: ${h.id})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts");let k={...f,id:h.id};return{success:!0,client:k}}catch(a){return console.error("Error adding client:",a),{success:!1,error:a.message}}}async function q(a){let b=await (0,f.Lf)();if(!b)return{success:!1,count:0,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,count:0,error:"Unauthorized"};try{for(let d of a){let a=b.batch(),e=b.collection("clients").doc(),f=await (0,j.tu)("CL"),g={...d,code:f,createdAt:new Date().toISOString(),createdBy:`  ${c.name}`,type:d.type||"individual",relationType:d.relationType||"client",status:d.status||"active",balance:{USD:0,IQD:0},lastTransaction:null,useCount:0,avatarUrl:""};g.password||delete g.password,a.set(e,g),await a.commit()}return await (0,i.iL)({userId:c.uid,userName:c.name,action:"CREATE",targetType:"CLIENT",description:` ${a.length}    .`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/relations/settings"),(0,g.revalidatePath)("/reports/debts"),{success:!0,count:a.length}}catch(a){return console.error("Error adding multiple clients: ",String(a)),{success:!1,count:0,error:"Failed to add clients."}}}async function r(a,b){let c=await (0,f.Lf)();if(!c)return{success:!1,error:"Database not available."};let d=await (0,h.$T)();if(!d)return{success:!1,error:"Unauthorized"};try{let e=JSON.parse(JSON.stringify(b));(""===b.password||void 0===b.password||null===b.password)&&delete e.password,await c.collection("clients").doc(a).update(e),await (0,i.iL)({userId:d.uid,userName:d.name,action:"UPDATE",targetType:"CLIENT",description:`   (ID: ${a})`});let f=await c.collection("clients").doc(a).get(),h=JSON.parse(JSON.stringify(f.data(),(a,b)=>b&&"object"==typeof b&&b.hasOwnProperty("seconds")&&b.hasOwnProperty("nanoseconds")?new Date(1e3*b.seconds).toISOString():b)),j={id:f.id,...h};return(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0,updatedClient:j}}catch(a){return console.error("Error updating client:",a),{success:!1,error:a.message}}}async function s(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=(await b.collection("clients").doc(a).get()).data();if(d?.useCount&&d.useCount>0)return{success:!1,error:"         ."};let e=d?.name||"unknown";return await b.collection("clients").doc(a).delete(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:` : ${e} (ID: ${a})`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}async function t(a){let b=await (0,f.Lf)();if(!b)return{success:!1,error:"Database not available."};let c=await (0,h.$T)();if(!c)return{success:!1,error:"Unauthorized"};try{let d=b.batch();return a.forEach(a=>{let c=b.collection("clients").doc(a);d.delete(c)}),await d.commit(),await (0,i.iL)({userId:c.uid,userName:c.name,action:"DELETE",targetType:"CLIENT",description:` ${a.length}   .`}),(0,g.revalidatePath)("/clients"),(0,g.revalidatePath)("/suppliers"),(0,g.revalidatePath)("/reports/debts"),{success:!0}}catch(a){return{success:!1,error:a.message}}}[f,h,i,j]=l.then?(await l)():l,(0,k.D)([m,n,o,p,q,r,s,t]),(0,e.A)(m,"405872236907704344162aca1c38160d1eac727fe8",null),(0,e.A)(n,"400e621b7f78c4800cffc85d668ca10cd73eb6853c",null),(0,e.A)(o,"408c94c431661ae65070856bc4a78d84f2cbfcba1c",null),(0,e.A)(p,"403331dfc341d9a7f9cbe156b5d10cfd49a20be531",null),(0,e.A)(q,"408c54ad33973364b68d8475849f76b4a4ca590722",null),(0,e.A)(r,"6023146a7bfefc423ba02712c56694a31432de707c",null),(0,e.A)(s,"4085652545b10cc37283ef55992935bd43a8ce947e",null),(0,e.A)(t,"40f4619201eea9704cbf15357e730e9458fc66e834",null),d()}catch(a){d(a)}})},95599:(a,b,c)=>{"use strict";var d=c(4717),e=function(){this._complete=!1,this._callbacks=new d(e.QUEUE_SIZE)};e.QUEUE_SIZE=4,e.all=function(a){var b=new e,c=a.length,d=c;for(0===c&&b.done();d--;)a[d].then(function(){0==(c-=1)&&b.done()});return b},e.prototype.then=function(a){this._complete?a():this._callbacks.push(a)},e.prototype.done=function(){this._complete=!0;for(var a,b=this._callbacks;a=b.shift();)a()},a.exports=e},99787:(a,b,c)=>{"use strict";c.r(b),c.d(b,{GlobalError:()=>D.a,__next_app__:()=>J,handler:()=>L,pages:()=>I,routeModule:()=>K,tree:()=>H});var d=c(49754),e=c(9117),f=c(46595),g=c(32324),h=c(39326),i=c(38928),j=c(20175),k=c(12),l=c(54290),m=c(12696),n=c(82802),o=c(77533),p=c(45229),q=c(32822),r=c(261),s=c(26453),t=c(52474),u=c(26713),v=c(51356),w=c(62685),x=c(36225),y=c(63446),z=c(2762),A=c(45742),B=c(86439),C=c(81170),D=c.n(C),E=c(62506),F=c(91203),G={};for(let a in E)0>["default","tree","pages","GlobalError","__next_app__","routeModule","handler"].indexOf(a)&&(G[a]=()=>E[a]);c.d(b,G);let H={children:["",{children:["chat",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(c.bind(c,22516)),"/home/user/studio/src/app/chat/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(c.bind(c,51472)),"/home/user/studio/src/app/layout.tsx"],"global-error":[()=>Promise.resolve().then(c.t.bind(c,81170,23)),"next/dist/client/components/builtin/global-error.js"],"not-found":[()=>Promise.resolve().then(c.t.bind(c,87028,23)),"next/dist/client/components/builtin/not-found.js"],forbidden:[()=>Promise.resolve().then(c.t.bind(c,90461,23)),"next/dist/client/components/builtin/forbidden.js"],unauthorized:[()=>Promise.resolve().then(c.t.bind(c,32768,23)),"next/dist/client/components/builtin/unauthorized.js"]}]}.children,I=["/home/user/studio/src/app/chat/page.tsx"],J={require:c,loadChunk:()=>Promise.resolve()},K=new d.AppPageRouteModule({definition:{kind:e.RouteKind.APP_PAGE,page:"/chat/page",pathname:"/chat",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:H},distDir:".next",relativeProjectDir:""});async function L(a,b,d){var C;let G="/chat/page";"/index"===G&&(G="/");let M=(0,h.getRequestMeta)(a,"postponed"),N=(0,h.getRequestMeta)(a,"minimalMode"),O=await K.prepare(a,b,{srcPage:G,multiZoneDraftMode:!1});if(!O)return b.statusCode=400,b.end("Bad Request"),null==d.waitUntil||d.waitUntil.call(d,Promise.resolve()),null;let{buildId:P,query:Q,params:R,parsedUrl:S,pageIsDynamic:T,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,serverActionsManifest:X,clientReferenceManifest:Y,subresourceIntegrityManifest:Z,prerenderManifest:$,isDraftMode:_,resolvedPathname:aa,revalidateOnlyGenerated:ab,routerServerContext:ac,nextConfig:ad,interceptionRoutePatterns:ae}=O,af=S.pathname||"/",ag=(0,r.normalizeAppPath)(G),{isOnDemandRevalidate:ah}=O,ai=K.match(af,$),aj=!!$.routes[aa],ak=!!(ai||aj||$.routes[ag]),al=a.headers["user-agent"]||"",am=(0,u.getBotType)(al),an=(0,p.isHtmlBotRequest)(a),ao=(0,h.getRequestMeta)(a,"isPrefetchRSCRequest")??"1"===a.headers[t.NEXT_ROUTER_PREFETCH_HEADER],ap=(0,h.getRequestMeta)(a,"isRSCRequest")??!!a.headers[t.RSC_HEADER],aq=(0,s.getIsPossibleServerAction)(a),ar=(0,m.checkIsAppPPREnabled)(ad.experimental.ppr)&&(null==(C=$.routes[ag]??$.dynamicRoutes[ag])?void 0:C.renderingMode)==="PARTIALLY_STATIC",as=!1,at=!1,au=ar?M:void 0,av=ar&&ap&&!ao,aw=(0,h.getRequestMeta)(a,"segmentPrefetchRSCRequest"),ax=!al||(0,p.shouldServeStreamingMetadata)(al,ad.htmlLimitedBots);an&&ar&&(ak=!1,ax=!1);let ay=!0===K.isDev||!ak||"string"==typeof M||av,az=an&&ar,aA=null;_||!ak||ay||aq||au||av||(aA=aa);let aB=aA;!aB&&K.isDev&&(aB=aa),K.isDev||_||!ak||!ap||av||(0,k.d)(a.headers);let aC={...E,tree:H,pages:I,GlobalError:D(),handler:L,routeModule:K,__next_app__:J};X&&Y&&(0,o.setReferenceManifestsSingleton)({page:G,clientReferenceManifest:Y,serverActionsManifest:X,serverModuleMap:(0,q.createServerModuleMap)({serverActionsManifest:X})});let aD=a.method||"GET",aE=(0,g.getTracer)(),aF=aE.getActiveScopeSpan();try{let f=K.getVaryHeader(aa,ae);b.setHeader("Vary",f);let k=async(c,d)=>{let e=new l.NodeNextRequest(a),f=new l.NodeNextResponse(b);return K.render(e,f,d).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=aE.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==i.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${aD} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${aD} ${a.url}`)})},m=async({span:e,postponed:f,fallbackRouteParams:g})=>{let i={query:Q,params:R,page:ag,sharedContext:{buildId:P},serverComponentsHmrCache:(0,h.getRequestMeta)(a,"serverComponentsHmrCache"),fallbackRouteParams:g,renderOpts:{App:()=>null,Document:()=>null,pageConfig:{},ComponentMod:aC,Component:(0,j.T)(aC),params:R,routeModule:K,page:G,postponed:f,shouldWaitOnAllReady:az,serveStreamingMetadata:ax,supportsDynamicResponse:"string"==typeof f||ay,buildManifest:U,nextFontManifest:V,reactLoadableManifest:W,subresourceIntegrityManifest:Z,serverActionsManifest:X,clientReferenceManifest:Y,setIsrStatus:null==ac?void 0:ac.setIsrStatus,dir:c(33873).join(process.cwd(),K.relativeProjectDir),isDraftMode:_,isRevalidate:ak&&!f&&!av,botType:am,isOnDemandRevalidate:ah,isPossibleServerAction:aq,assetPrefix:ad.assetPrefix,nextConfigOutput:ad.output,crossOrigin:ad.crossOrigin,trailingSlash:ad.trailingSlash,previewProps:$.preview,deploymentId:ad.deploymentId,enableTainting:ad.experimental.taint,htmlLimitedBots:ad.htmlLimitedBots,devtoolSegmentExplorer:ad.experimental.devtoolSegmentExplorer,reactMaxHeadersLength:ad.reactMaxHeadersLength,multiZoneDraftMode:!1,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:ad.experimental.cacheLife,basePath:ad.basePath,serverActions:ad.experimental.serverActions,...as?{nextExport:!0,supportsDynamicResponse:!1,isStaticGeneration:!0,isRevalidate:!0,isDebugDynamicAccesses:as}:{},experimental:{isRoutePPREnabled:ar,expireTime:ad.expireTime,staleTimes:ad.experimental.staleTimes,cacheComponents:!!ad.experimental.cacheComponents,clientSegmentCache:!!ad.experimental.clientSegmentCache,clientParamParsing:!!ad.experimental.clientParamParsing,dynamicOnHover:!!ad.experimental.dynamicOnHover,inlineCss:!!ad.experimental.inlineCss,authInterrupts:!!ad.experimental.authInterrupts,clientTraceMetadata:ad.experimental.clientTraceMetadata||[]},waitUntil:d.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:()=>{},onInstrumentationRequestError:(b,c,d)=>K.onRequestError(a,b,d,ac),err:(0,h.getRequestMeta)(a,"invokeError"),dev:K.isDev}},l=await k(e,i),{metadata:m}=l,{cacheControl:n,headers:o={},fetchTags:p}=m;if(p&&(o[y.NEXT_CACHE_TAGS_HEADER]=p),a.fetchMetrics=m.fetchMetrics,ak&&(null==n?void 0:n.revalidate)===0&&!K.isDev&&!ar){let a=m.staticBailoutInfo,b=Object.defineProperty(Error(`Page changed from static to dynamic at runtime ${aa}${(null==a?void 0:a.description)?`, reason: ${a.description}`:""}
see more here https://nextjs.org/docs/messages/app-static-to-dynamic-error`),"__NEXT_ERROR_CODE",{value:"E132",enumerable:!1,configurable:!0});if(null==a?void 0:a.stack){let c=a.stack;b.stack=b.message+c.substring(c.indexOf("\n"))}throw b}return{value:{kind:v.CachedRouteKind.APP_PAGE,html:l,headers:o,rscData:m.flightData,postponed:m.postponed,status:m.statusCode,segmentData:m.segmentData},cacheControl:n}},o=async({hasResolved:c,previousCacheEntry:f,isRevalidating:g,span:i})=>{let j,k=!1===K.isDev,l=c||b.writableEnded;if(ah&&ab&&!f&&!N)return(null==ac?void 0:ac.render404)?await ac.render404(a,b):(b.statusCode=404,b.end("This page could not be found")),null;if(ai&&(j=(0,w.parseFallbackField)(ai.fallback)),j===w.FallbackMode.PRERENDER&&(0,u.isBot)(al)&&(!ar||an)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),(null==f?void 0:f.isStale)===-1&&(ah=!0),ah&&(j!==w.FallbackMode.NOT_FOUND||f)&&(j=w.FallbackMode.BLOCKING_STATIC_RENDER),!N&&j!==w.FallbackMode.BLOCKING_STATIC_RENDER&&aB&&!l&&!_&&T&&(k||!aj)){let b;if((k||ai)&&j===w.FallbackMode.NOT_FOUND)throw new B.NoFallbackError;if(ar&&!ap){let c="string"==typeof(null==ai?void 0:ai.fallback)?ai.fallback:k?ag:null;if(b=await K.handleResponse({cacheKey:c,req:a,nextConfig:ad,routeKind:e.RouteKind.APP_PAGE,isFallback:!0,prerenderManifest:$,isRoutePPREnabled:ar,responseGenerator:async()=>m({span:i,postponed:void 0,fallbackRouteParams:k||at?(0,n.u)(ag):null}),waitUntil:d.waitUntil}),null===b)return null;if(b)return delete b.cacheControl,b}}let o=ah||g||!au?void 0:au;if(as&&void 0!==o)return{cacheControl:{revalidate:1,expire:void 0},value:{kind:v.CachedRouteKind.PAGES,html:x.default.EMPTY,pageData:{},headers:void 0,status:void 0}};let p=T&&ar&&((0,h.getRequestMeta)(a,"renderFallbackShell")||at)?(0,n.u)(af):null;return m({span:i,postponed:o,fallbackRouteParams:p})},p=async c=>{var f,g,i,j,k;let l,n=await K.handleResponse({cacheKey:aA,responseGenerator:a=>o({span:c,...a}),routeKind:e.RouteKind.APP_PAGE,isOnDemandRevalidate:ah,isRoutePPREnabled:ar,req:a,nextConfig:ad,prerenderManifest:$,waitUntil:d.waitUntil});if(_&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate"),K.isDev&&b.setHeader("Cache-Control","no-store, must-revalidate"),!n){if(aA)throw Object.defineProperty(Error("invariant: cache entry required but not generated"),"__NEXT_ERROR_CODE",{value:"E62",enumerable:!1,configurable:!0});return null}if((null==(f=n.value)?void 0:f.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant app-page handler received invalid cache entry ${null==(i=n.value)?void 0:i.kind}`),"__NEXT_ERROR_CODE",{value:"E707",enumerable:!1,configurable:!0});let p="string"==typeof n.value.postponed;ak&&!av&&(!p||ao)&&(N||b.setHeader("x-nextjs-cache",ah?"REVALIDATED":n.isMiss?"MISS":n.isStale?"STALE":"HIT"),b.setHeader(t.NEXT_IS_PRERENDER_HEADER,"1"));let{value:q}=n;if(au)l={revalidate:0,expire:void 0};else if(N&&ap&&!ao&&ar)l={revalidate:0,expire:void 0};else if(!K.isDev)if(_)l={revalidate:0,expire:void 0};else if(ak){if(n.cacheControl)if("number"==typeof n.cacheControl.revalidate){if(n.cacheControl.revalidate<1)throw Object.defineProperty(Error(`Invalid revalidate configuration provided: ${n.cacheControl.revalidate} < 1`),"__NEXT_ERROR_CODE",{value:"E22",enumerable:!1,configurable:!0});l={revalidate:n.cacheControl.revalidate,expire:(null==(j=n.cacheControl)?void 0:j.expire)??ad.expireTime}}else l={revalidate:y.CACHE_ONE_YEAR,expire:void 0}}else b.getHeader("Cache-Control")||(l={revalidate:0,expire:void 0});if(n.cacheControl=l,"string"==typeof aw&&(null==q?void 0:q.kind)===v.CachedRouteKind.APP_PAGE&&q.segmentData){b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"2");let c=null==(k=q.headers)?void 0:k[y.NEXT_CACHE_TAGS_HEADER];N&&ak&&c&&"string"==typeof c&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,c);let d=q.segmentData.get(aw);return void 0!==d?(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(d,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl}):(b.statusCode=204,(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.EMPTY,cacheControl:n.cacheControl}))}let r=(0,h.getRequestMeta)(a,"onCacheEntry");if(r&&await r({...n,value:{...n.value,kind:"PAGE"}},{url:(0,h.getRequestMeta)(a,"initURL")}))return null;if(p&&au)throw Object.defineProperty(Error("Invariant: postponed state should not be present on a resume request"),"__NEXT_ERROR_CODE",{value:"E396",enumerable:!1,configurable:!0});if(q.headers){let a={...q.headers};for(let[c,d]of(N&&ak||delete a[y.NEXT_CACHE_TAGS_HEADER],Object.entries(a)))if(void 0!==d)if(Array.isArray(d))for(let a of d)b.appendHeader(c,a);else"number"==typeof d&&(d=d.toString()),b.appendHeader(c,d)}let s=null==(g=q.headers)?void 0:g[y.NEXT_CACHE_TAGS_HEADER];if(N&&ak&&s&&"string"==typeof s&&b.setHeader(y.NEXT_CACHE_TAGS_HEADER,s),!q.status||ap&&ar||(b.statusCode=q.status),!N&&q.status&&F.RedirectStatusCode[q.status]&&ap&&(b.statusCode=200),p&&b.setHeader(t.NEXT_DID_POSTPONE_HEADER,"1"),ap&&!_){if(void 0===q.rscData){if(q.postponed)throw Object.defineProperty(Error("Invariant: Expected postponed to be undefined"),"__NEXT_ERROR_CODE",{value:"E372",enumerable:!1,configurable:!0});return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:q.html,cacheControl:av?{revalidate:0,expire:void 0}:n.cacheControl})}return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:x.default.fromStatic(q.rscData,t.RSC_CONTENT_TYPE_HEADER),cacheControl:n.cacheControl})}let u=q.html;if(!p||N||ap)return(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:n.cacheControl});if(as)return u.push(new ReadableStream({start(a){a.enqueue(z.ENCODED_TAGS.CLOSED.BODY_AND_HTML),a.close()}})),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}});let w=new TransformStream;return u.push(w.readable),m({span:c,postponed:q.postponed,fallbackRouteParams:null}).then(async a=>{var b,c;if(!a)throw Object.defineProperty(Error("Invariant: expected a result to be returned"),"__NEXT_ERROR_CODE",{value:"E463",enumerable:!1,configurable:!0});if((null==(b=a.value)?void 0:b.kind)!==v.CachedRouteKind.APP_PAGE)throw Object.defineProperty(Error(`Invariant: expected a page response, got ${null==(c=a.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E305",enumerable:!1,configurable:!0});await a.value.html.pipeTo(w.writable)}).catch(a=>{w.writable.abort(a).catch(a=>{console.error("couldn't abort transformer",a)})}),(0,A.sendRenderResult)({req:a,res:b,generateEtags:ad.generateEtags,poweredByHeader:ad.poweredByHeader,result:u,cacheControl:{revalidate:0,expire:void 0}})};if(!aF)return await aE.withPropagatedContext(a.headers,()=>aE.trace(i.BaseServerSpan.handleRequest,{spanName:`${aD} ${a.url}`,kind:g.SpanKind.SERVER,attributes:{"http.method":aD,"http.target":a.url}},p));await p(aF)}catch(b){throw b instanceof B.NoFallbackError||await K.onRequestError(a,b,{routerKind:"App Router",routePath:G,routeType:"render",revalidateReason:(0,f.c)({isRevalidate:ak,isOnDemandRevalidate:ah})},ac),b}}},99826:(a,b,c)=>{"use strict";var d=c(27910).Stream,e=c(28354),f=c(94519),g=c(78829),h=c(50501),i=function(a){a=a||{},f.validateOptions(a,["headers","extensions","maxLength","ping","proxy","tls","ca"]),this.readable=this.writable=!0;var b=a.headers;if(b)for(var c in b)this._driver.setHeader(c,b[c]);var d=a.extensions;d&&[].concat(d).forEach(this._driver.addExtension,this._driver),this._ping=a.ping,this._pingId=0,this.readyState=i.CONNECTING,this.bufferedAmount=0,this.protocol="",this.url=this._driver.url,this.version=this._driver.version;var e=this;this._driver.on("open",function(a){e._open()}),this._driver.on("message",function(a){e._receiveMessage(a.data)}),this._driver.on("close",function(a){e._beginClose(a.reason,a.code)}),this._driver.on("error",function(a){e._emitError(a.message)}),this.on("error",function(){}),this._driver.messages.on("drain",function(){e.emit("drain")}),this._ping&&(this._pingTimer=setInterval(function(){e._pingId+=1,e.ping(e._pingId.toString())},1e3*this._ping)),this._configureStream(),this._proxy||(this._stream.pipe(this._driver.io),this._driver.io.pipe(this._stream))};e.inherits(i,d),i.CONNECTING=0,i.OPEN=1,i.CLOSING=2,i.CLOSED=3,i.CLOSE_TIMEOUT=3e4;var j={write:function(a){return this.send(a)},end:function(a){void 0!==a&&this.send(a),this.close()},pause:function(){return this._driver.messages.pause()},resume:function(){return this._driver.messages.resume()},send:function(a){return!(this.readyState>i.OPEN)&&(a instanceof Buffer||(a=String(a)),this._driver.messages.write(a))},ping:function(a,b){return!(this.readyState>i.OPEN)&&this._driver.ping(a,b)},close:function(a,b){if(void 0===a&&(a=1e3),void 0===b&&(b=""),1e3!==a&&(a<3e3||a>4999))throw Error("Failed to execute 'close' on WebSocket: The code must be either 1000, or between 3000 and 4999. "+a+" is neither.");if(this.readyState<i.CLOSING){var c=this;this._closeTimer=setTimeout(function(){c._beginClose("",1006)},i.CLOSE_TIMEOUT)}this.readyState!==i.CLOSED&&(this.readyState=i.CLOSING),this._driver.close(b,a)},_configureStream:function(){var a=this;this._stream.setTimeout(0),this._stream.setNoDelay(!0),["close","end"].forEach(function(b){this._stream.on(b,function(){a._finalizeClose()})},this),this._stream.on("error",function(b){a._emitError("Network error: "+a.url+": "+b.message),a._finalizeClose()})},_open:function(){if(this.readyState===i.CONNECTING){this.readyState=i.OPEN,this.protocol=this._driver.protocol||"";var a=new h("open");a.initEvent("open",!1,!1),this.dispatchEvent(a)}},_receiveMessage:function(a){if(this.readyState>i.OPEN)return!1;this.readable&&this.emit("data",a);var b=new h("message",{data:a});b.initEvent("message",!1,!1),this.dispatchEvent(b)},_emitError:function(a){if(!(this.readyState>=i.CLOSING)){var b=new h("error",{message:a});b.initEvent("error",!1,!1),this.dispatchEvent(b)}},_beginClose:function(a,b){this.readyState!==i.CLOSED&&(this.readyState=i.CLOSING,this._closeParams=[a,b],this._stream&&(this._stream.destroy(),this._stream.readable||this._finalizeClose()))},_finalizeClose:function(){if(this.readyState!==i.CLOSED){this.readyState=i.CLOSED,this._closeTimer&&clearTimeout(this._closeTimer),this._pingTimer&&clearInterval(this._pingTimer),this._stream&&this._stream.end(),this.readable&&this.emit("end"),this.readable=this.writable=!1;var a=this._closeParams?this._closeParams[0]:"",b=new h("close",{code:this._closeParams?this._closeParams[1]:1006,reason:a});b.initEvent("close",!1,!1),this.dispatchEvent(b)}}};for(var k in j)i.prototype[k]=j[k];for(var l in g)i.prototype[l]=g[l];a.exports=i}};var b=require("../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,8298,3103,9664,4550,4951,8165,4154,4799],()=>b(b.s=99787));module.exports=c})();