(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7651],{4942:(e,s,t)=>{Promise.resolve().then(t.bind(t,78848))},18332:(e,s,t)=>{"use strict";t.d(s,{Fc:()=>i,TN:()=>o,XL:()=>d});var n=t(95155),a=t(12115),r=t(83101),l=t(64269);let c=(0,r.F)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),i=a.forwardRef((e,s)=>{let{className:t,variant:a,...r}=e;return(0,n.jsx)("div",{ref:s,role:"alert",className:(0,l.cn)(c({variant:a}),t),...r})});i.displayName="Alert";let d=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)("h5",{ref:s,className:(0,l.cn)("mb-1 font-medium leading-none tracking-tight",t),...a})});d.displayName="AlertTitle";let o=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)("div",{ref:s,className:(0,l.cn)("text-sm [&_p]:leading-relaxed",t),...a})});o.displayName="AlertDescription"},27432:(e,s,t)=>{"use strict";t.d(s,{K:()=>m});var n=t(95155);t(12115);var a=t(14223),r=t(28127),l=t(64269),c=t(3998),i=t(50276),d=t(26333),o=t(65142);function x(e){let{date:s,setDate:t}=e,a=s?"".concat(String(s.getHours()).padStart(2,"0"),":").concat(String(s.getMinutes()).padStart(2,"0")):"";return(0,n.jsx)(o.p,{type:"time",value:a,onChange:e=>{let n=e.target.value;if(!n||!s)return;let[a,r]=n.split(":").map(Number),l=new Date(s);l.setHours(a),l.setMinutes(r),t(l)},className:"text-center"})}function m(e){let{date:s,setDate:t}=e;return(0,n.jsxs)(d.AM,{children:[(0,n.jsx)(d.Wv,{asChild:!0,children:(0,n.jsxs)(c.$,{variant:"outline",className:(0,l.cn)("w-full justify-start text-left font-normal",!s&&"text-muted-foreground"),children:[(0,n.jsx)(r.A,{className:"mr-2 h-4 w-4"}),s?(0,a.GP)(s,"yyyy-MM-dd hh:mm a"):(0,n.jsx)("span",{children:"اختر تاريخ ووقت"})]})}),(0,n.jsxs)(d.hl,{className:"w-auto p-0",children:[(0,n.jsx)(i.V,{mode:"single",selected:s,onSelect:e=>{if(!e)return void t(void 0);let n=new Date(e);s&&(n.setHours(s.getHours()),n.setMinutes(s.getMinutes()),n.setSeconds(s.getSeconds())),t(n)},initialFocus:!0}),(0,n.jsx)("div",{className:"p-3 border-t border-border",children:(0,n.jsx)(x,{date:s,setDate:t})})]})]})}},30940:(e,s,t)=>{"use strict";t.d(s,{X:()=>a});var n=t(30926);let a=(0,n.createServerReference)("40bd3493b6cd183a3f75aa7b2dffe9f325b07a2b9d",n.callServer,void 0,n.findSourceMapURL,"updateSettings")},41052:(e,s,t)=>{"use strict";t.d(s,{C5:()=>g,MJ:()=>f,Rr:()=>p,eI:()=>h,lR:()=>j,lV:()=>d,zB:()=>x});var n=t(95155),a=t(12115),r=t(32467),l=t(22544),c=t(64269),i=t(76444);let d=l.Op,o=a.createContext({}),x=e=>{let{...s}=e;return(0,n.jsx)(o.Provider,{value:{name:s.name},children:(0,n.jsx)(l.xI,{...s})})},m=()=>{let e=a.useContext(o),s=a.useContext(u),{getFieldState:t,formState:n}=(0,l.xW)(),r=t(e.name,n);if(!e)throw Error("useFormField should be used within <FormField>");let{id:c}=s;return{id:c,name:e.name,formItemId:"".concat(c,"-form-item"),formDescriptionId:"".concat(c,"-form-item-description"),formMessageId:"".concat(c,"-form-item-message"),...r}},u=a.createContext({}),h=a.forwardRef((e,s)=>{let{className:t,...r}=e,l=a.useId();return(0,n.jsx)(u.Provider,{value:{id:l},children:(0,n.jsx)("div",{ref:s,className:(0,c.cn)("space-y-2",t),...r})})});h.displayName="FormItem";let j=a.forwardRef((e,s)=>{let{className:t,...a}=e,{error:r,formItemId:l}=m();return(0,n.jsx)(i.J,{ref:s,className:(0,c.cn)(r&&"text-destructive",t),htmlFor:l,...a})});j.displayName="FormLabel";let f=a.forwardRef((e,s)=>{let{...t}=e,{error:a,formItemId:l,formDescriptionId:c,formMessageId:i}=m();return(0,n.jsx)(r.DX,{ref:s,id:l,"aria-describedby":a?"".concat(c," ").concat(i):"".concat(c),"aria-invalid":!!a,...t})});f.displayName="FormControl";let p=a.forwardRef((e,s)=>{let{className:t,...a}=e,{formDescriptionId:r}=m();return(0,n.jsx)("p",{ref:s,id:r,className:(0,c.cn)("text-sm text-muted-foreground",t),...a})});p.displayName="FormDescription";let g=a.forwardRef((e,s)=>{var t;let{className:a,children:r,...l}=e,{error:i,formMessageId:d}=m(),o=i?String(null!=(t=null==i?void 0:i.message)?t:""):r;return o?(0,n.jsx)("p",{ref:s,id:d,className:(0,c.cn)("text-sm font-medium text-destructive",a),...l,children:o}):null});g.displayName="FormMessage"},50276:(e,s,t)=>{"use strict";t.d(s,{V:()=>x});var n=t(95155);t(12115);var a=t(51190),r=t(63263),l=t(66984),c=t(76422),i=t(64269),d=t(3998),o=t(14223);function x(e){let{className:s,classNames:t,showOutsideDays:x=!0,...m}=e;return(0,n.jsx)(l.hv,{showOutsideDays:x,className:(0,i.cn)("p-3",s),locale:c.ar,formatters:{formatCaption:(e,s)=>{var t;let{year:n,month:a}=(0,l.cq)(),r=e.getFullYear(),c=e.getMonth(),i=null!=(t=null==n?void 0:n.getFullYear())?t:r,d=(0,o.GP)(new Date(i,c),"MMMM",{locale:null==s?void 0:s.locale});return"".concat(d," ").concat(i)}},classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:(0,i.cn)((0,d.r)({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected])]:bg-accent/50 first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:(0,i.cn)((0,d.r)({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"text-muted-foreground opacity-50",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...t},components:{IconLeft:e=>{let{...s}=e;return(0,n.jsx)(a.A,{className:"h-4 w-4"})},IconRight:e=>{let{...s}=e;return(0,n.jsx)(r.A,{className:"h-4 w-4"})}},...m})}x.displayName="Calendar"},78848:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>eJ});var n=t(95155),a=t(12115),r=t(86948),l=t(7545),c=t(30926);let i=(0,c.createServerReference)("7f7228b058474be00c09729ab715fa20e010333dfa",c.callServer,void 0,c.findSourceMapURL,"getSubscriptions"),d=(0,c.createServerReference)("7f59f3075656a91b7ed27ed0deb8f239c13fb4a30e",c.callServer,void 0,c.findSourceMapURL,"getSubscriptionInstallmentsForAll");var o=t(18332),x=t(3998),m=t(45444),u=t(22452),h=t(92033),j=t(13630),f=t(91658),p=t(19201);let g=(0,c.createServerReference)("40fb273cfe11e3acbfaa3953430203de2db167f95f",c.callServer,void 0,c.findSourceMapURL,"softDeleteSubscription");var v=t(15894),b=t(98053),y=t(87270),N=t(14223),w=t(19056),A=t(11647),S=t(64269),C=t(6259),M=t(51834),R=t(27314),D=t(94972),I=t(44381),k=t(88917);let P=(0,c.createServerReference)("7ea99aecbe6da08b740bfa589a23855143625f516a",c.callServer,void 0,c.findSourceMapURL,"paySubscriptionInstallment");var F=t(76444),L=t(5470),_=t(23451),B=t(54879),O=t(66942),H=t(22544),z=t(41052),E=t(97916),U=t(11186),V=t(65142);let J=B.Ik({paymentAmount:B.au.number().positive("المبلغ يجب أن يكون أكبر من صفر."),paymentCurrency:B.k5(["USD","IQD"]),exchangeRate:B.au.number().optional(),discount:B.au.number().optional()}),W=e=>{let{title:s,value:t,currency:a,className:l}=e;return(0,n.jsx)(r.Zp,{className:(0,S.cn)("text-center",l),children:(0,n.jsxs)(r.Wu,{className:"p-3",children:[(0,n.jsx)("p",{className:"text-xs text-muted-foreground",children:s}),(0,n.jsx)("p",{className:"text-lg font-bold font-mono",children:t.toLocaleString()})]})})};function $(e){var s,t,r,l;let{installment:c,subscription:i,onPaymentSuccess:d,children:o}=e,[m,u]=(0,a.useState)(!1),{toast:j}=(0,v.dj)(),{data:f,loaded:p}=(0,L.Z)(),{user:g}=(0,_.A)(),[b,y]=(0,a.useState)(c),[N,w]=(0,a.useState)(i),A=(0,a.useMemo)(()=>(b.amount||0)-((b.paidAmount||0)+(b.discount||0)),[b]),C=(0,a.useMemo)(()=>(N.salePrice||0)-(N.paidAmount||0),[N]),B=(0,H.mN)({resolver:(0,O.u)(J),defaultValues:{paymentAmount:A>0?A:0,paymentCurrency:b.currency,exchangeRate:(null==f||null==(t=f.settings)||null==(s=t.currencySettings)?void 0:s.exchangeRates.USD_IQD)||1480,discount:0}});a.useCallback(async()=>{if(!N.id)return;let e=await (0,k.I)(N.id);if(e){var s;w(e);let t=null==(s=e.installments)?void 0:s.find(e=>e.id===b.id);t&&y(t)}},[N.id,b.id]),(0,a.useEffect)(()=>{if(m){var e,s;y(c),w(i),B.reset({paymentAmount:A>0?A:0,paymentCurrency:c.currency,exchangeRate:(null==f||null==(s=f.settings)||null==(e=s.currencySettings)?void 0:e.exchangeRates.USD_IQD)||1480,discount:0})}},[m,c,i,B,f,A]);let{isSubmitting:$,watch:T,control:G,handleSubmit:Q}=B,Z=T("paymentCurrency"),X=T("paymentAmount"),q=T("exchangeRate"),K=T("discount"),Y=(0,a.useMemo)(()=>{let e=(X||0)+(K||0);return Z===b.currency?e:q&&0!==q?"USD"===Z?e*q:e/q:0},[Z,b.currency,X,K,q]),ee=A-Y,es=async e=>{if(!g||!("role"in g)||!g.boxId)return void j({title:"خطأ",description:"الصندوق غير محدد للمستخدم الحالي.",variant:"destructive"});j({title:"جاري تسجيل الدفعة..."});let s=await P(b.id,g.boxId,e.paymentAmount,e.paymentCurrency,e.exchangeRate,e.discount);s.success?(j({title:"تم تسجيل الدفعة بنجاح"}),d(),u(!1)):j({title:"خطأ",description:s.error,variant:"destructive"})};return(0,n.jsxs)(M.lG,{open:m,onOpenChange:u,children:[(0,n.jsx)(M.zM,{asChild:!0,children:o}),(0,n.jsx)(M.Cf,{className:"p-0 sm:max-w-xl",children:(0,n.jsx)(z.lV,{...B,children:(0,n.jsxs)("form",{onSubmit:Q(es),className:"flex flex-col flex-grow overflow-hidden",children:[(0,n.jsxs)(M.c7,{className:"p-4 rounded-t-lg",style:{backgroundColor:"USD"===Z?"hsl(var(--accent))":"hsl(var(--primary))",color:"white"},children:[(0,n.jsx)(M.L3,{className:"text-white",children:"تسجيل دفعة قسط"}),(0,n.jsx)(M.rr,{className:"text-white/80",children:"يمكنك تسديد القسط الحالي، أو تسديد مبلغ أكبر لتغطية أقساط مستقبلية أو ليكون كرصيد للعميل."})]}),(0,n.jsxs)("div",{className:"p-6 space-y-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,n.jsx)(W,{title:"قيمة القسط",value:b.amount,currency:b.currency}),(0,n.jsx)(W,{title:"المتبقي من القسط",value:A,currency:b.currency,className:"border-red-500/50 bg-red-50 dark:bg-red-950/30"}),(0,n.jsx)(W,{title:"المتبقي من الاشتراك",value:C,currency:b.currency,className:"border-orange-500/50 bg-orange-50 dark:bg-orange-950/30"}),(0,n.jsx)(W,{title:"المتبقي بعد الدفعة",value:ee,currency:b.currency,className:"border-blue-500/50 bg-blue-50 dark:bg-blue-950/30"})]}),(0,n.jsxs)("div",{className:"grid md:grid-cols-2 gap-4 pt-4 border-t",children:[(0,n.jsx)(z.zB,{control:G,name:"paymentAmount",render:e=>{let{field:s}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"المبلغ المدفوع الآن"}),(0,n.jsx)(z.MJ,{children:(0,n.jsx)(E.O,{currency:Z,currencyClassName:(0,S.cn)("USD"===Z?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),value:s.value,onValueChange:e=>s.onChange(e||0)})}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsx)(z.zB,{control:B.control,name:"paymentCurrency",render:e=>{var s,t;let{field:a}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"عملة الدفع"}),(0,n.jsxs)(U.l6,{onValueChange:a.onChange,value:a.value,children:[(0,n.jsx)(z.MJ,{children:(0,n.jsx)(U.bq,{children:(0,n.jsx)(U.yv,{})})}),(0,n.jsx)(U.gC,{children:((null==f||null==(t=f.settings)||null==(s=t.currencySettings)?void 0:s.currencies)||[]).map(e=>(0,n.jsx)(U.eb,{value:e.code,children:e.code},e.code))})]}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsx)(z.zB,{control:G,name:"discount",render:e=>{let{field:s}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"خصم على القسط"}),(0,n.jsx)(z.MJ,{children:(0,n.jsx)(E.O,{currency:Z,currencyClassName:(0,S.cn)("USD"===Z?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),value:s.value,onValueChange:e=>s.onChange(e||0)})}),(0,n.jsx)(z.C5,{})]})}})]}),Z!==b.currency&&(0,n.jsxs)("div",{className:"grid md:grid-cols-2 gap-4",children:[(0,n.jsx)(z.zB,{control:G,name:"exchangeRate",render:e=>{let{field:s}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"سعر الصرف"}),(0,n.jsx)(z.MJ,{children:(0,n.jsx)(E.O,{value:s.value,onValueChange:e=>s.onChange(e||0)})}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{children:"المبلغ المعادل"}),(0,n.jsx)(V.p,{value:"".concat(Y.toLocaleString()," ").concat(b.currency),readOnly:!0,disabled:!0})]})]})]}),(0,n.jsx)(M.Es,{className:"p-4 border-t bg-background mt-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,n.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,n.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,n.jsx)(R.A,{className:"h-4 w-4"})," ",(0,n.jsx)("span",{children:(null==g?void 0:g.name)||"..."})]}),(0,n.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,n.jsx)(D.A,{className:"h-4 w-4"})," ",(0,n.jsx)("span",{children:(null==f||null==(l=f.boxes)||null==(r=l.find(e=>e.id===(null==g?void 0:g.boxId)))?void 0:r.name)||"..."})]}),(0,n.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,n.jsx)(I.A,{className:"h-4 w-4"})," ",(0,n.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,n.jsxs)(x.$,{type:"submit",disabled:$,children:[$&&(0,n.jsx)(h.A,{className:"me-2 h-4 w-4 animate-spin"}),"تأكيد استلام الدفعة"]})]})})]})})})]})}let T=(0,c.createServerReference)("7f29b1f619814d2bb347b7568d9fef0db3672866b7",c.callServer,void 0,c.findSourceMapURL,"getInstallmentPayments"),G=(0,c.createServerReference)("400839afac1c721e8a0733096582359b8356e40214",c.callServer,void 0,c.findSourceMapURL,"deletePayment"),Q=(0,c.createServerReference)("40e90946cbd69c3cb9caefa3461c5f6eb19e516f47",c.callServer,void 0,c.findSourceMapURL,"sendInstallmentReminder");var Z=t(28127),X=t(73180),q=t(26333),K=t(50276);let Y=(0,c.createServerReference)("60ac99fd5fe70fb62fed80f68193cb25204f5a2c28",c.callServer,void 0,c.findSourceMapURL,"updatePayment");var ee=t(31120);let es=B.Ik({amount:B.au.number().positive("المبلغ يجب أن يكون أكبر من صفر."),date:B.p6({required_error:"تاريخ الدفع مطلوب"}),notes:B.Yj().optional()});function et(e){let{payment:s,onPaymentUpdated:t,children:r}=e,[l,c]=(0,a.useState)(!1),{toast:i}=(0,v.dj)(),d=(0,H.mN)({resolver:(0,O.u)(es),defaultValues:{amount:s.amount,date:(0,w.H)(s.date),notes:s.notes||""}});(0,a.useEffect)(()=>{l&&d.reset({amount:s.amount,date:(0,w.H)(s.date),notes:s.notes||""})},[l,s,d]);let{isSubmitting:o,control:m,handleSubmit:u}=d,j=async e=>{let n=await Y(s.id,{...e,date:e.date.toISOString()});n.success?(i({title:"تم تحديث الدفعة بنجاح"}),t(),c(!1)):i({title:"خطأ",description:n.error,variant:"destructive"})};return(0,n.jsxs)(M.lG,{open:l,onOpenChange:c,children:[(0,n.jsx)(M.zM,{asChild:!0,children:r}),(0,n.jsxs)(M.Cf,{children:[(0,n.jsxs)(M.c7,{children:[(0,n.jsx)(M.L3,{children:"تعديل الدفعة"}),(0,n.jsx)(M.rr,{children:"قم بتحديث تفاصيل هذه الدفعة. سيتم تعديل الأرصدة تلقائيًا."})]}),(0,n.jsx)(z.lV,{...d,children:(0,n.jsxs)("form",{onSubmit:u(j),className:"space-y-4",children:[(0,n.jsx)(z.zB,{control:m,name:"amount",render:e=>{let{field:t}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"المبلغ"}),(0,n.jsx)(z.MJ,{children:(0,n.jsx)(E.O,{currency:s.currency,value:t.value,onValueChange:e=>t.onChange(e||0)})}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsx)(z.zB,{control:m,name:"date",render:e=>{let{field:s}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"تاريخ الدفع"}),(0,n.jsxs)(q.AM,{children:[(0,n.jsx)(q.Wv,{asChild:!0,children:(0,n.jsx)(z.MJ,{children:(0,n.jsxs)(x.$,{variant:"outline",className:(0,S.cn)("w-full justify-start text-left font-normal",!s.value&&"text-muted-foreground"),children:[(0,n.jsx)(Z.A,{className:"mr-2 h-4 w-4"}),s.value?(0,N.GP)(s.value,"yyyy-MM-dd"):(0,n.jsx)("span",{children:"اختر تاريخًا"})]})})}),(0,n.jsx)(q.hl,{className:"w-auto p-0",align:"start",children:(0,n.jsx)(K.V,{mode:"single",selected:s.value,onSelect:s.onChange,initialFocus:!0})})]}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsx)(z.zB,{control:m,name:"notes",render:e=>{let{field:s}=e;return(0,n.jsxs)(z.eI,{children:[(0,n.jsx)(z.lR,{children:"ملاحظات (اختياري)"}),(0,n.jsx)(z.MJ,{children:(0,n.jsx)(ee.T,{...s})}),(0,n.jsx)(z.C5,{})]})}}),(0,n.jsx)(M.Es,{children:(0,n.jsxs)(x.$,{type:"submit",disabled:o,children:[o?(0,n.jsx)(h.A,{className:"me-2 h-4 w-4 animate-spin"}):(0,n.jsx)(X.A,{className:"me-2 h-4 w-4"}),"حفظ التعديلات"]})})]})})]})]})}var en=t(41962),ea=t(15239);function er(e){var s,t,a,r;let{subscription:l,settings:c,installments:i=[]}=e,d=(0,w.H)(l.purchaseDate),o=(0,w.H)(l.startDate),x=(0,en.P)(o,l.numberOfInstallments),m=l.unitPrice||0,u=l.quantity||1,h=l.discount||0,j=m*u,f=l.salePrice,p=l.paidAmount||0,g=f-p,v=(null==(s=c.theme)?void 0:s.invoice)||{};return(0,n.jsx)("div",{className:"bg-white p-4 sm:p-8 font-sans",dir:"rtl",children:(0,n.jsxs)("div",{className:"w-full max-w-4xl mx-auto",children:[(0,n.jsxs)("header",{className:"flex justify-between items-start pb-6 border-b-2",children:[(0,n.jsxs)("div",{className:"text-left",children:[(0,n.jsx)("h2",{className:"text-4xl font-bold uppercase",style:{color:v.titleColor||"#333"},children:"فاتورة"}),(0,n.jsxs)("p",{className:"text-sm mt-1",children:[(0,n.jsx)("strong",{children:"رقم الفاتورة:"})," ",(0,n.jsx)("span",{className:"font-mono",children:l.invoiceNumber})]}),(0,n.jsxs)("p",{className:"text-sm",children:[(0,n.jsx)("strong",{children:"تاريخ الفاتورة:"})," ",(0,n.jsx)("span",{className:"font-mono",children:(0,N.GP)(d,"yyyy-MM-dd")})]})]}),(0,n.jsxs)("div",{className:"text-right",children:[(null==(a=c.theme)||null==(t=a.assets)?void 0:t.invoice_logo)?(0,n.jsx)(ea.default,{src:c.theme.assets.invoice_logo,alt:v.companyName||"Company Logo",width:160,height:80,style:{objectFit:"contain"}}):(0,n.jsx)("h1",{className:"text-3xl font-bold text-gray-800",children:v.companyName||"Mudarib"}),(0,n.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:v.companyAddress})]})]}),(0,n.jsx)("section",{className:"mt-8 mb-8 flex justify-between gap-4",children:(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("p",{className:"text-gray-500",children:"فاتورة إلى:"}),(0,n.jsx)("p",{className:"text-lg font-bold text-gray-800",children:l.clientName}),(null==(r=l.client)?void 0:r.phone)&&(0,n.jsx)("p",{className:"text-sm text-gray-500",children:l.client.phone})]})}),(0,n.jsx)("section",{children:(0,n.jsxs)("table",{className:"w-full border-collapse text-sm",style:{borderCollapse:"collapse",direction:"rtl"},children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{style:{backgroundColor:v.headerColor||"#f3f4f6"},children:[(0,n.jsx)("th",{className:"p-3 font-bold text-gray-600 border text-right",style:{fontWeight:"bold"},children:"الوصف"}),(0,n.jsx)("th",{className:"p-3 font-bold text-gray-600 border w-24 text-center",style:{textAlign:"center",fontWeight:"bold"},children:"الكمية"}),(0,n.jsx)("th",{className:"p-3 font-bold text-gray-600 border w-32 text-center",style:{textAlign:"center",fontWeight:"bold"},children:"سعر الوحدة"}),(0,n.jsx)("th",{className:"p-3 font-bold text-gray-600 border w-32 text-center",style:{textAlign:"center",fontWeight:"bold"},children:"الخصم"}),(0,n.jsx)("th",{className:"p-3 font-bold text-gray-600 border w-32 text-center",style:{textAlign:"center",fontWeight:"bold"},children:"المجموع"})]})}),(0,n.jsx)("tbody",{children:(0,n.jsxs)("tr",{children:[(0,n.jsxs)("td",{className:"p-3 border align-top text-right",children:[(0,n.jsx)("p",{className:"font-bold",children:l.serviceName}),(0,n.jsxs)("p",{className:"text-xs text-gray-500 font-normal",children:["فترة الاشتراك من ",(0,N.GP)(o,"yyyy-MM-dd")," إلى ",(0,N.GP)(x,"yyyy-MM-dd"),"."]}),l.notes&&(0,n.jsx)("p",{className:"text-xs text-gray-400 mt-1 font-normal",children:l.notes})]}),(0,n.jsx)("td",{className:"p-3 border align-top font-mono",style:{textAlign:"center"},children:u}),(0,n.jsx)("td",{className:"p-3 border align-top font-mono",style:{textAlign:"center"},children:m.toFixed(2)}),(0,n.jsx)("td",{className:"p-3 border align-top font-mono",style:{textAlign:"center"},children:h.toFixed(2)}),(0,n.jsx)("td",{className:"p-3 border align-top font-mono",style:{textAlign:"center"},children:j.toFixed(2)})]})})]})}),i&&i.length>0&&(0,n.jsxs)("section",{className:"mt-8",children:[(0,n.jsx)("h3",{className:"font-bold text-lg text-right mb-2",style:{fontWeight:"bold"},children:"جدول الأقساط"}),(0,n.jsxs)("table",{className:"w-full border-collapse text-sm",style:{borderCollapse:"collapse",direction:"rtl"},children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{style:{backgroundColor:v.headerColor||"#f3f4f6"},children:[(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"تاريخ الاستحقاق"}),(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"المبلغ"}),(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"المسدد"}),(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"الخصم"}),(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"المتبقي"}),(0,n.jsx)("th",{className:"p-2 font-bold text-gray-600 border text-center",style:{textAlign:"center",fontWeight:"bold"},children:"الحالة"})]})}),(0,n.jsx)("tbody",{children:i.map(e=>{let s=(e.amount||0)-((e.paidAmount||0)+(e.discount||0));return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{className:"p-2 border text-center",style:{textAlign:"center"},children:(0,N.GP)((0,w.H)(e.dueDate),"yyyy-MM-dd")}),(0,n.jsxs)("td",{className:"p-2 border font-mono text-center",style:{textAlign:"center"},children:[(e.amount||0).toFixed(2)," ",e.currency]}),(0,n.jsxs)("td",{className:"p-2 border font-mono text-green-600 text-center",style:{textAlign:"center"},children:[(e.paidAmount||0).toFixed(2)," ",e.currency]}),(0,n.jsxs)("td",{className:"p-2 border font-mono text-orange-600 text-center",style:{textAlign:"center"},children:[(e.discount||0).toFixed(2)," ",e.currency]}),(0,n.jsxs)("td",{className:"p-2 border font-mono text-red-600 text-center",style:{textAlign:"center"},children:[s.toFixed(2)," ",e.currency]}),(0,n.jsx)("td",{className:(0,S.cn)("p-2 border font-bold text-center","Paid"===e.status?"text-green-600":"text-red-600"),style:{textAlign:"center",fontWeight:"bold"},children:"Paid"===e.status?"مدفوع":"غير مدفوع"})]},e.id)})})]})]}),(0,n.jsx)("section",{className:"mt-8 flex w-full justify-end",children:(0,n.jsxs)("div",{className:"w-full max-w-sm space-y-2 text-right",children:[(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("span",{className:"font-bold text-gray-600",children:"المجموع الفرعي:"}),(0,n.jsxs)("span",{className:"font-mono font-bold",children:[j.toFixed(2)," ",l.currency]})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("span",{className:"font-bold text-gray-600",children:"الخصم:"}),(0,n.jsxs)("span",{className:"font-mono font-bold text-red-500",children:["- ",h.toFixed(2)," ",l.currency]})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center border-t pt-2 font-bold text-base",children:[(0,n.jsx)("span",{children:"المجموع الإجمالي:"}),(0,n.jsxs)("span",{className:"font-mono",children:[f.toFixed(2)," ",l.currency]})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsx)("span",{className:"font-bold text-gray-600",children:"المدفوع:"}),(0,n.jsxs)("span",{className:"font-mono font-bold text-green-600",children:[p.toFixed(2)," ",l.currency]})]}),(0,n.jsxs)("div",{className:"flex justify-between items-center rounded-lg bg-primary/10 p-2 font-bold text-lg",children:[(0,n.jsx)("span",{children:"المبلغ المستحق:"}),(0,n.jsxs)("span",{className:"font-mono",children:[g.toFixed(2)," ",l.currency]})]})]})}),(0,n.jsxs)("footer",{className:"mt-12 border-t pt-6 text-xs text-gray-500",children:[v.footerText&&(0,n.jsx)("p",{className:"mb-4 text-right",children:v.footerText}),(0,n.jsx)("p",{className:"text-right",children:"إذا كان لديك أي استفسار بخصوص هذه الفاتورة، الرجاء التواصل معنا."}),(0,n.jsxs)("div",{className:"mt-2 flex justify-between items-end",children:[(0,n.jsxs)("div",{className:"text-left",children:[(0,n.jsxs)("p",{children:["الهاتف: ",v.companyPhone]}),(0,n.jsxs)("p",{children:["الموقع: ",v.companyWeb]})]}),(0,n.jsxs)("div",{className:"text-right",children:[(0,n.jsx)("p",{className:"font-semibold",children:v.companyName||"Mudarib"}),(0,n.jsx)("p",{children:v.companyAddress})]})]})]})]})})}var el=t(5225),ec=t(76251);let ei=(0,c.createServerReference)("7fbd1dd6c8c8f0af7b61f3a67d5d04b01b5dd3fc37",c.callServer,void 0,c.findSourceMapURL,"getSubscriptionInstallments");function ed(e){let{subscription:s}=e,[t,r]=(0,a.useState)(!1),{data:l,loaded:c}=(0,L.Z)(),i=null==l?void 0:l.settings,[d,o]=(0,a.useState)([]),[m,u]=(0,a.useState)(!1);return(0,a.useEffect)(()=>{t&&(u(!0),ei(s.id).then(o).finally(()=>u(!1)))},[t,s.id]),(0,n.jsxs)(M.lG,{open:t,onOpenChange:r,children:[(0,n.jsx)(M.zM,{asChild:!0,children:(0,n.jsxs)(C._2,{onSelect:e=>e.preventDefault(),children:[(0,n.jsx)(el.A,{className:"me-2 h-4 w-4"})," عرض الفاتورة"]})}),(0,n.jsxs)(M.Cf,{className:"max-w-4xl p-0",children:[(0,n.jsxs)(M.c7,{className:"p-4 border-b",children:[(0,n.jsx)(M.L3,{children:"فاتورة الاشتراك"}),(0,n.jsx)(M.rr,{children:"معاينة الفاتورة قبل الطباعة أو التصدير."})]}),(0,n.jsx)("div",{className:"max-h-[70vh] overflow-y-auto bg-muted/40 p-4",id:"invoice-print-area-".concat(s.id),children:c&&i&&!m?(0,n.jsx)(er,{subscription:s,settings:i,installments:d}):(0,n.jsx)("div",{className:"flex justify-center items-center h-96",children:(0,n.jsx)(h.A,{className:"h-8 w-8 animate-spin"})})}),(0,n.jsx)(M.Es,{className:"p-4 border-t",children:(0,n.jsxs)(x.$,{onClick:()=>{let e=document.getElementById("invoice-print-area-".concat(s.id));if(e){let s=document.body.innerHTML,t=e.innerHTML;document.body.innerHTML=t,window.print(),document.body.innerHTML=s,window.location.reload()}},disabled:!c||m,children:[(0,n.jsx)(ec.A,{className:"me-2 h-4 w-4"}),"طباعة"]})})]})]})}let eo=(0,c.createServerReference)("70a1966b164872145df93c00584df7a0b9768aea98",c.callServer,void 0,c.findSourceMapURL,"updateSubscriptionStatus"),ex=[{value:"Active",label:"نشط"},{value:"Suspended",label:"متوقف مؤقتًا"},{value:"Cancelled",label:"ملغي"}];function em(e){let{subscription:s,onStatusChange:t,children:r}=e,[l,c]=(0,a.useState)(!1),[i,d]=(0,a.useState)(s.status),[o,m]=(0,a.useState)(s.cancellationReason||""),[u,j]=(0,a.useState)(!1),{toast:f}=(0,v.dj)(),p="Cancelled"===i||"Suspended"===i,g=async()=>{j(!0);let e=await eo(s.id,i,o);e.success?(f({title:"تم تحديث حالة الاشتراك بنجاح"}),t(),c(!1)):f({title:"خطأ",description:e.error,variant:"destructive"}),j(!1)};return(0,n.jsxs)(M.lG,{open:l,onOpenChange:c,children:[(0,n.jsx)(M.zM,{asChild:!0,children:r}),(0,n.jsxs)(M.Cf,{children:[(0,n.jsxs)(M.c7,{children:[(0,n.jsx)(M.L3,{children:"تغيير حالة الاشتراك"}),(0,n.jsx)(M.rr,{children:"اختر الحالة الجديدة للاشتراك. سيتم تسجيل التاريخ والوقت تلقائيًا."})]}),(0,n.jsxs)("div",{className:"space-y-4 py-4",children:[(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{children:"الحالة الجديدة"}),(0,n.jsxs)(U.l6,{value:i,onValueChange:e=>d(e),children:[(0,n.jsx)(U.bq,{children:(0,n.jsx)(U.yv,{})}),(0,n.jsx)(U.gC,{children:ex.map(e=>(0,n.jsx)(U.eb,{value:e.value,children:e.label},e.value))})]})]}),p&&(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{children:"السبب (اختياري)"}),(0,n.jsx)(ee.T,{value:o,onChange:e=>m(e.target.value)})]})]}),(0,n.jsx)(M.Es,{children:(0,n.jsxs)(x.$,{onClick:g,disabled:u,children:[u&&(0,n.jsx)(h.A,{className:"me-2 h-4 w-4 animate-spin"}),"حفظ التغييرات"]})})]})]})}var eu=t(59007),eh=t(88964),ej=t(20146),ef=t(90109);function ep(){return null}var eg=t(3730);let ev=(e,s)=>null==e?"-":new Intl.NumberFormat("en-US").format(e)+" ".concat(s),eb={Active:"text-blue-600 bg-blue-100 border-blue-200 dark:bg-blue-900/50 dark:text-blue-300",Paid:"text-green-600 bg-green-100 border-green-200 dark:bg-green-900/50 dark:text-green-300",Cancelled:"text-gray-600 bg-gray-100 border-gray-200 dark:bg-gray-800/50 dark:text-gray-300",Suspended:"text-yellow-600 bg-yellow-100 border-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-300"},ey={Active:"نشط",Paid:"مدفوع بالكامل",Cancelled:"ملغي",Suspended:"متوقف"},eN={Paid:"text-green-600 bg-green-100 border-green-200",Unpaid:"text-red-600 bg-red-100 border-red-200"},ew={Paid:"مدفوع",Unpaid:"غير مدفوع"},eA=e=>{let{installment:s,subscription:t,onDataChange:r}=e,[l,c]=a.useState([]),[i,d]=a.useState(!1),[o,m]=a.useState(!1),{toast:u}=(0,v.dj)(),f=a.useCallback(async()=>{if(o)return void m(!1);d(!0);try{let e=await T(s.id);c(e),m(!0)}catch(e){u({title:"خطأ",description:"فشل تحميل دفعات القسط: ".concat(e.message),variant:"destructive"})}finally{d(!1)}},[s.id,u,o]),p=async()=>{if(!t.client)return void u({title:"خطأ",description:"بيانات العميل غير متوفرة لهذا الاشتراك.",variant:"destructive"});u({title:"جاري إرسال التذكير..."});let e=await Q({clientName:t.clientName,clientPhone:t.client.phone,serviceName:t.serviceName,amountDue:s.amount-(s.paidAmount||0)-(s.discount||0),currency:s.currency,dueDate:s.dueDate});e.success?u({title:"تم إرسال التذكير بنجاح"}):u({title:"فشل إرسال التذكير",description:e.message,variant:"destructive"})},g=async e=>{let s=await G(e);s.success?(u({title:"تم حذف الدفعة بنجاح"}),r()):u({title:"خطأ",description:s.error,variant:"destructive"})},C=(s.amount||0)-((s.paidAmount||0)+(s.discount||0));return(0,n.jsx)(eg.Nt,{asChild:!0,children:(0,n.jsxs)("tbody",{className:"bg-background",children:[(0,n.jsxs)(y.Hj,{children:[(0,n.jsx)(y.nA,{className:"p-0 text-center",children:(0,n.jsx)(eg.R6,{asChild:!0,children:(0,n.jsx)(x.$,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:f,children:(0,n.jsx)(eu.A,{className:(0,S.cn)("h-4 w-4 transition-transform",o&&"rotate-180")})})})}),(0,n.jsx)(y.nA,{children:(0,N.GP)((0,w.H)(s.dueDate),"yyyy-MM-dd")}),(0,n.jsx)(y.nA,{children:(0,n.jsx)(A.E,{className:(0,S.cn)(eN[s.status],"font-bold"),children:ew[s.status]})}),(0,n.jsx)(y.nA,{className:"font-mono",children:ev(s.amount,s.currency)}),(0,n.jsx)(y.nA,{className:"font-mono text-green-600",children:ev(s.paidAmount||0,s.currency)}),(0,n.jsx)(y.nA,{className:"font-mono text-orange-600",children:ev(s.discount||0,s.currency)}),(0,n.jsx)(y.nA,{className:"font-mono text-red-600",children:ev(C,s.currency)}),(0,n.jsx)(y.nA,{className:"text-left",children:(0,n.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,n.jsx)($,{installment:s,subscription:t,onPaymentSuccess:r,children:(0,n.jsx)(x.$,{size:"sm",variant:"secondary",disabled:"Paid"===s.status,children:"تسجيل دفعة"})}),(0,n.jsx)(x.$,{size:"sm",variant:"outline",onClick:e=>{e.stopPropagation(),p()},disabled:"Paid"===s.status,children:"إرسال تذكير"})]})})]}),(0,n.jsx)(eg.Ke,{asChild:!0,children:(0,n.jsx)(y.Hj,{children:(0,n.jsx)(y.nA,{colSpan:8,className:"p-2",children:i?(0,n.jsx)("div",{className:"flex justify-center items-center h-24",children:(0,n.jsx)(h.A,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):l.length>0?(0,n.jsxs)("div",{className:"p-2 bg-slate-50 dark:bg-slate-900 rounded-md",children:[(0,n.jsx)("h4",{className:"font-semibold text-sm mb-2",children:"الدفعات المسجلة:"}),(0,n.jsxs)(y.XI,{children:[(0,n.jsx)(y.A0,{children:(0,n.jsxs)(y.Hj,{children:[(0,n.jsx)(y.nd,{children:"تاريخ الدفع"}),(0,n.jsx)(y.nd,{children:"الموظف"}),(0,n.jsx)(y.nd,{children:"المبلغ"}),(0,n.jsx)(y.nd,{children:"الخصم"}),(0,n.jsx)(y.nd,{className:"text-center",children:"إجراءات"})]})}),(0,n.jsx)(y.BF,{children:l.map(e=>(0,n.jsxs)(y.Hj,{children:[(0,n.jsx)(y.nA,{children:(0,N.GP)((0,w.H)(e.date),"yyyy-MM-dd HH:mm")}),(0,n.jsx)(y.nA,{children:e.paidBy||"غير معروف"}),(0,n.jsx)(y.nA,{className:"font-mono",children:ev(e.amount,s.currency)}),(0,n.jsx)(y.nA,{className:"font-mono",children:ev(e.discount||0,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center",children:(0,n.jsxs)("div",{className:"flex items-center justify-center",children:[(0,n.jsx)(et,{payment:e,onPaymentUpdated:r,children:(0,n.jsx)(x.$,{variant:"ghost",size:"icon",className:"h-7 w-7 text-blue-600",children:(0,n.jsx)(eh.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(b.Lt,{children:[(0,n.jsx)(b.tv,{asChild:!0,children:(0,n.jsx)(x.$,{variant:"ghost",size:"icon",className:"h-7 w-7 text-destructive",children:(0,n.jsx)(j.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(b.EO,{children:[(0,n.jsxs)(b.wd,{children:[(0,n.jsx)(b.r7,{children:"هل أنت متأكد؟"}),(0,n.jsx)(b.$v,{children:"سيتم حذف هذه الدفعة وعكس تأثيرها المالي."})]}),(0,n.jsxs)(b.ck,{children:[(0,n.jsx)(b.Zr,{children:"إلغاء"}),(0,n.jsx)(b.Rx,{onClick:()=>g(e.id),className:(0,S.cn)((0,x.r)({variant:"destructive"})),children:"نعم، احذف"})]})]})]})]})})]},e.id))})]})]}):(0,n.jsx)("p",{className:"text-center text-sm text-muted-foreground p-4",children:"لا توجد دفعات مسجلة لهذا القسط."})})})})]})})},eS=e=>{let{subscription:s,allInstallments:t,onDataChange:r}=e,{toast:l}=(0,v.dj)(),[c,i]=a.useState(!1),d=async()=>{let e=await g(s.id);e.success?(l({title:"تم حذف الاشتراك بنجاح"}),r()):l({title:"خطأ",description:e.error,variant:"destructive"})},o=s.paidAmount||0,m=s.salePrice-o,u=m<=.01&&"Cancelled"!==s.status&&"Suspended"!==s.status?"Paid":s.status,h=(0,a.useMemo)(()=>Array.isArray(t)?t.filter(e=>e.subscriptionId===s.id).sort((e,s)=>new Date(e.dueDate).getTime()-new Date(s.dueDate).getTime()):[],[t,s.id]),N=h.reduce((e,s)=>e+(s.discount||0),0);return(0,n.jsx)(eg.Nt,{asChild:!0,children:(0,n.jsxs)("tbody",{className:"border-b",children:[(0,n.jsxs)(y.Hj,{"data-state":c?"open":"closed",onClick:()=>i(!c),className:"cursor-pointer",children:[(0,n.jsx)(y.nA,{children:(0,n.jsx)(eg.R6,{asChild:!0,children:(0,n.jsx)(x.$,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,n.jsx)(eu.A,{className:(0,S.cn)("h-4 w-4 transition-transform",c&&"rotate-180")})})})}),(0,n.jsx)(y.nA,{className:"font-semibold",children:s.invoiceNumber}),(0,n.jsx)(y.nA,{className:"font-semibold",children:s.serviceName}),(0,n.jsx)(y.nA,{children:s.clientName}),(0,n.jsx)(y.nA,{children:s.supplierName}),(0,n.jsx)(y.nA,{className:"text-center font-mono font-bold",children:ev(s.salePrice,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center font-mono font-bold text-green-700",children:ev(s.profit,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center font-mono font-bold text-green-600",children:ev(o-N,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center font-mono font-bold text-orange-600",children:ev(N,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center font-mono font-bold text-red-600",children:ev(m,s.currency)}),(0,n.jsx)(y.nA,{className:"text-center",children:(0,n.jsx)(A.E,{variant:"outline",className:(0,S.cn)("capitalize font-bold",eb[u]),children:ey[u]})}),(0,n.jsx)(y.nA,{className:"text-center",children:(0,n.jsxs)(C.rI,{children:[(0,n.jsx)(C.ty,{asChild:!0,children:(0,n.jsx)(x.$,{variant:"ghost",className:"h-8 w-8 p-0",onClick:e=>e.stopPropagation(),children:(0,n.jsx)(ej.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(C.SQ,{align:"end",children:[(0,n.jsx)(ep,{subscription:s,onSuccess:r,children:(0,n.jsxs)(C._2,{onSelect:e=>e.preventDefault(),children:[(0,n.jsx)(f.A,{className:"me-2 h-4 w-4"}),"إدارة الأقساط"]})}),(0,n.jsx)(ed,{subscription:s}),(0,n.jsx)(em,{subscription:s,onStatusChange:r,children:(0,n.jsxs)(C._2,{onSelect:e=>e.preventDefault(),children:[(0,n.jsx)(p.A,{className:"me-2 h-4 w-4"}),"تغيير الحالة"]})}),(0,n.jsx)(C.mB,{}),(0,n.jsxs)(b.Lt,{children:[(0,n.jsx)(b.tv,{asChild:!0,children:(0,n.jsxs)(C._2,{onSelect:e=>e.preventDefault(),className:"text-destructive focus:text-destructive",children:[(0,n.jsx)(j.A,{className:"me-2 h-4 w-4"}),"حذف"]})}),(0,n.jsxs)(b.EO,{children:[(0,n.jsxs)(b.wd,{children:[(0,n.jsx)(b.r7,{children:"هل أنت متأكد؟"}),(0,n.jsx)(b.$v,{children:"سيتم نقل الاشتراك إلى سجل المحذوفات."})]}),(0,n.jsxs)(b.ck,{children:[(0,n.jsx)(b.Zr,{children:"إلغاء"}),(0,n.jsx)(b.Rx,{onClick:e=>{e.stopPropagation(),d()},className:(0,S.cn)((0,x.r)({variant:"destructive"})),children:"نعم، احذف"})]})]})]})]})]})})]}),(0,n.jsx)(eg.Ke,{asChild:!0,children:(0,n.jsx)(y.Hj,{children:(0,n.jsx)(y.nA,{colSpan:12,className:"p-2 bg-muted/50",children:(0,n.jsxs)("div",{className:"p-4 bg-background rounded-md",children:[(0,n.jsx)("h4",{className:"font-semibold mb-2",children:"جدول الأقساط"}),(0,n.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,n.jsxs)(y.XI,{children:[(0,n.jsx)(y.A0,{children:(0,n.jsxs)(y.Hj,{children:[(0,n.jsx)(y.nd,{className:"w-12"}),(0,n.jsx)(y.nd,{children:"تاريخ الاستحقاق"}),(0,n.jsx)(y.nd,{children:"الحالة"}),(0,n.jsx)(y.nd,{children:"المبلغ"}),(0,n.jsx)(y.nd,{children:"المدفوع"}),(0,n.jsx)(y.nd,{children:"الخصم"}),(0,n.jsx)(y.nd,{children:"المتبقي"}),(0,n.jsx)(y.nd,{className:"text-left w-[240px]",children:"الإجراءات"})]})}),h.map(e=>(0,n.jsx)(eA,{installment:e,subscription:s,onDataChange:r},e.id))]})})]})})})})]})})};function eC(e){let{subscriptions:s,allInstallments:t,onDataChange:r}=e,[l,c]=a.useState(""),[i,d]=a.useState("all"),o=a.useMemo(()=>s.filter(e=>{let s=l.toLowerCase(),t=!l||e.serviceName.toLowerCase().includes(s)||e.clientName.toLowerCase().includes(s)||(e.supplierName||"").toLowerCase().includes(s)||(e.invoiceNumber||"").toLowerCase().includes(s),n=e.salePrice-(e.paidAmount||0)<=.01&&"Cancelled"!==e.status&&"Suspended"!==e.status?"Paid":e.status,a="all"===i||n===i;return t&&a}),[s,l,i]);return(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[(0,n.jsxs)("div",{className:"relative flex-grow",children:[(0,n.jsx)(ef.A,{className:"absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,n.jsx)(V.p,{placeholder:"بحث باسم الاشتراك، العميل، المورد، أو رقم الفاتورة...",value:l,onChange:e=>c(e.target.value),className:"pr-10"})]}),(0,n.jsxs)(U.l6,{value:i,onValueChange:e=>d(e),children:[(0,n.jsx)(U.bq,{className:"w-full sm:w-[180px]",children:(0,n.jsx)(U.yv,{})}),(0,n.jsxs)(U.gC,{children:[(0,n.jsx)(U.eb,{value:"all",children:"كل الحالات"}),Object.keys(ey).map(e=>(0,n.jsx)(U.eb,{value:e,children:ey[e]},e))]})]})]}),(0,n.jsx)("div",{className:"border rounded-lg overflow-x-auto",children:(0,n.jsxs)(y.XI,{children:[(0,n.jsx)(y.A0,{children:(0,n.jsxs)(y.Hj,{children:[(0,n.jsx)(y.nd,{className:"w-[50px]"}),(0,n.jsx)(y.nd,{className:"font-bold",children:"الفاتورة"}),(0,n.jsx)(y.nd,{className:"font-bold",children:"الاشتراك"}),(0,n.jsx)(y.nd,{className:"font-bold",children:"العميل"}),(0,n.jsx)(y.nd,{className:"font-bold",children:"المورد"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"إجمالي البيع"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"الربح"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"المدفوع"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"الخصم"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"المتبقي"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"الحالة"}),(0,n.jsx)(y.nd,{className:"text-center font-bold",children:"الإجراءات"})]})}),0===o.length?(0,n.jsx)(y.BF,{children:(0,n.jsx)(y.Hj,{children:(0,n.jsx)(y.nA,{colSpan:12,className:"h-24 text-center",children:"لا توجد اشتراكات تطابق البحث."})})}):o.map(e=>(0,n.jsx)(eS,{subscription:e,allInstallments:t,onDataChange:r},e.id))]})})]})}var eM=t(50898),eR=t(9573),eD=t(62593),eI=t(60406),ek=t(98039),eP=t(30940),eF=t(23639),eL=t(60013),e_=t(44846);let eB=e=>{let{title:s,description:t,icon:a,children:l,className:c}=e;return(0,n.jsxs)(r.Zp,{className:(0,S.cn)("flex flex-col",c),children:[(0,n.jsx)(r.aR,{children:(0,n.jsxs)("div",{className:"flex items-center gap-3",children:[(0,n.jsx)("div",{className:"p-3 bg-muted rounded-full",children:(0,n.jsx)(a,{className:"h-6 w-6 text-primary"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(r.ZB,{children:s}),(0,n.jsx)(r.BT,{children:t})]})]})}),(0,n.jsx)(r.Wu,{className:"flex-grow space-y-4",children:l})]})};function eO(e){var s,t,r,l;let{settings:c,onSettingsChanged:i}=e,[d,o]=(0,a.useState)((null==c?void 0:c.subscriptionSettings)||{}),[f,p]=(0,a.useState)(!1),[g,b]=(0,a.useState)({}),{toast:y}=(0,v.dj)(),{data:N}=(0,L.Z)();(0,a.useEffect)(()=>o((null==c?void 0:c.subscriptionSettings)||{}),[c]);let w=(0,a.useMemo)(()=>((null==N?void 0:N.suppliers)||[]).map(e=>({value:e.id,label:e.name})),[null==N?void 0:N.suppliers]),A=(0,a.useCallback)(e=>{var s;let t={};null!=e.defaultQuantity&&e.defaultQuantity<=0&&(t.defaultQuantity="الكمية يجب أن تكون أكبر من صفر"),null!=e.defaultInstallments&&e.defaultInstallments<=0&&(t.defaultInstallments="عدد الأقساط يجب أن يكون أكبر من صفر");let n=(null==(s=e.reminders)?void 0:s.daysBeforeDue)||[];return n.some((e,s)=>n.indexOf(e)!==s)&&(t.reminders="أيام التذكير يجب أن تكون مختلفة"),b(t),0===Object.keys(t).length},[]),S=(0,a.useCallback)(async()=>{if(!A(d))return void y({title:"خطأ في المدخلات",description:"تأكد من صحة الحقول قبل الحفظ.",variant:"destructive"});p(!0);try{(await (0,eP.X)({subscriptionSettings:d})).success?(y({title:"تم الحفظ",description:"تم حفظ إعدادات الاشتراكات بنجاح."}),i()):y({title:"خطأ",description:"تعذر حفظ الإعدادات.",variant:"destructive"})}catch(e){y({title:"خطأ غير متوقع",description:e.message||"حصل خطأ عند الحفظ.",variant:"destructive"})}finally{p(!1)}},[d,A,y,i]),C=(e,s)=>{o(t=>({...t,[e]:s}))},M=e=>{e.reminders||(e.reminders={enabled:!0,daysBeforeDue:[],sendTime:"09:00"}),Array.isArray(e.reminders.daysBeforeDue)||(e.reminders.daysBeforeDue=[])},R=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;o((0,eL.jM)(s=>{M(s),s.reminders.daysBeforeDue.push(e),s.reminders.daysBeforeDue=Array.from(new Set(s.reminders.daysBeforeDue)).sort((e,s)=>s-e)}))};return(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 items-start",children:[(0,n.jsx)(eB,{title:"الإعدادات الافتراضية",description:"لتسريع عملية إضافة اشتراك جديد.",icon:m.A,children:(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{className:"font-semibold",children:"المورد الافتراضي"}),(0,n.jsx)(eF.j,{options:w,value:d.defaultSupplier||"",onValueChange:e=>C("defaultSupplier",e),placeholder:"اختر موردًا..."})]}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{className:"font-semibold",children:"الكمية الافتراضية"}),(0,n.jsx)(E.O,{value:d.defaultQuantity,onValueChange:e=>C("defaultQuantity",e||1),"aria-label":"Default quantity"}),g.defaultQuantity&&(0,n.jsx)("p",{className:"text-xs text-destructive",children:g.defaultQuantity})]}),(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{className:"font-semibold",children:"عدد الأقساط الافتراضي"}),(0,n.jsx)(E.O,{value:d.defaultInstallments,onValueChange:e=>C("defaultInstallments",e||12),"aria-label":"Default installments"}),g.defaultInstallments&&(0,n.jsx)("p",{className:"text-xs text-destructive",children:g.defaultInstallments})]})]})]})}),(0,n.jsx)(eB,{title:"إشعارات وتذكيرات الأقساط",description:"إدارة التذكيرات التلقائية للأقساط.",icon:eR.A,children:(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[(0,n.jsx)(F.J,{htmlFor:"reminders-enabled",className:"font-semibold",children:"تفعيل الإشعارات التلقائية"}),(0,n.jsx)(e_.d,{id:"reminders-enabled",checked:null==(s=d.reminders)?void 0:s.enabled,onCheckedChange:e=>C("reminders",{...d.reminders,enabled:e})})]}),(0,n.jsxs)("div",{className:"space-y-3 p-3 border rounded-lg",children:[(0,n.jsxs)(F.J,{className:"font-semibold flex items-center gap-2",children:[(0,n.jsx)(eD.A,{className:"h-4 w-4"}),"توقيتات التذكير"]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(F.J,{htmlFor:"sendTime",className:"text-xs shrink-0",children:"وقت الإرسال:"}),(0,n.jsx)(V.p,{id:"sendTime",type:"time",value:(null==(t=d.reminders)?void 0:t.sendTime)||"09:00",onChange:e=>C("reminders",{...d.reminders,sendTime:e.target.value}),className:"h-8"})]}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)(F.J,{className:"text-xs",children:"أيام التذكير (قبل الاستحقاق)"}),((null==(r=d.reminders)?void 0:r.daysBeforeDue)||[]).map((e,s)=>(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-xs",children:"تذكير قبل"}),(0,n.jsx)(E.O,{className:"w-20 h-8",value:e,onValueChange:e=>{var t;!isNaN(t=Number(e||0))&&!(t<0)&&o((0,eL.jM)(e=>{M(e),e.reminders.daysBeforeDue[s]=Math.round(t),e.reminders.daysBeforeDue=Array.from(new Set(e.reminders.daysBeforeDue)).sort((e,s)=>s-e)}))},"aria-label":"reminder-".concat(s)}),(0,n.jsx)("span",{className:"text-xs",children:"أيام"}),(0,n.jsx)(x.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>{o((0,eL.jM)(e=>{M(e),e.reminders.daysBeforeDue.splice(s,1)}))},children:(0,n.jsx)(j.A,{className:"h-4 w-4"})})]},s)),(0,n.jsxs)(x.$,{variant:"outline",size:"sm",onClick:()=>R(1),children:[(0,n.jsx)(u.A,{className:"me-2 h-4 w-4"}),"إضافة يوم"]}),g.reminders&&(0,n.jsx)("p",{className:"text-xs text-destructive",children:g.reminders})]})]}),(0,n.jsxs)("div",{className:"space-y-3 p-3 border rounded-lg",children:[(0,n.jsxs)(F.J,{className:"font-semibold flex items-center gap-2",children:[(0,n.jsx)(eI.A,{className:"h-4 w-4"}),"إشعارات التأخير"]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("span",{className:"text-xs",children:"إرسال إشعار تأخير بعد"}),(0,n.jsx)(E.O,{className:"w-20 h-8",value:null==(l=d.reminders)?void 0:l.notifyAfterOverdueDays,onValueChange:e=>C("reminders",{...d.reminders,notifyAfterOverdueDays:e||1})}),(0,n.jsx)("span",{className:"text-xs",children:"أيام من الاستحقاق"})]})]})]})})]}),(0,n.jsx)(eB,{title:"الإعدادات المحاسبية",description:"تحديد حسابات الربط مع شجرة الحسابات.",icon:ek.A,children:(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{className:"font-bold",children:"حساب إيراد الاشتراكات"}),(0,n.jsx)(eF.j,{searchAction:"all",value:d.revenueAccountId||"",onValueChange:e=>C("revenueAccountId",e),placeholder:"اختر حساب الإيراد..."})]}),(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(F.J,{className:"font-bold",children:"حساب تكلفة الاشتراكات"}),(0,n.jsx)(eF.j,{searchAction:"all",value:d.costAccountId||"",onValueChange:e=>C("costAccountId",e),placeholder:"اختر حساب التكلفة..."})]})]})}),(0,n.jsx)("div",{className:"flex justify-end mt-6",children:(0,n.jsxs)(x.$,{onClick:S,disabled:f,size:"lg",children:[f&&(0,n.jsx)(h.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,n.jsx)(X.A,{className:"me-2 h-4 w-4"}),"حفظ كل التغييرات"]})})]})}var eH=t(66385);function ez(e){let{onSettingsChanged:s,children:t}=e,[r,l]=(0,a.useState)(!1),{data:c,loaded:i,fetchData:d}=(0,L.Z)(),[o,u]=(0,a.useState)({width:"1024px",height:"90vh"});return(0,a.useEffect)(()=>{r&&!i&&d()},[r,i,d]),(0,n.jsxs)(M.lG,{open:r,onOpenChange:l,children:[(0,n.jsx)(M.zM,{asChild:!0,children:t}),(0,n.jsxs)(M.Cf,{className:"p-0 flex flex-col",style:{maxWidth:o.width,width:"95vw",height:o.height},children:[(0,n.jsxs)(M.c7,{className:"p-4 flex flex-row items-center justify-between border-b",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)(M.L3,{className:"flex items-center gap-2",children:[(0,n.jsx)(m.A,{className:"h-5 w-5"}),"إعدادات الاشتراكات"]}),(0,n.jsx)(M.rr,{children:"تحديد الإعدادات الافتراضية عند إنشاء اشتراك جديد لتسهيل وتسريع عملية إدخال البيانات."})]}),(0,n.jsx)(eH.A,{dialogKey:"add_subscription",onDimensionsChange:u,children:(0,n.jsx)(x.$,{variant:"ghost",size:"icon",children:(0,n.jsx)(m.A,{className:"h-5 w-5"})})})]}),(0,n.jsx)("div",{className:"flex-grow overflow-y-auto",children:(0,n.jsx)("div",{className:"p-6",children:i&&c?(0,n.jsx)(eO,{settings:c.settings,onSettingsChanged:()=>{s(),l(!1)}}):(0,n.jsx)("div",{className:"flex justify-center p-8",children:(0,n.jsx)(h.A,{className:"animate-spin"})})})})]})]})}function eE(e){let{initialSubscriptions:s,initialInstallments:t,onDataChange:r}=e,[l,c]=(0,a.useState)(s),[i,d]=(0,a.useState)(t),[o,j]=(0,a.useState)(!1),{toast:f}=(0,v.dj)();(0,a.useEffect)(()=>{c(s)},[s]),(0,a.useEffect)(()=>{d(t)},[t]);let p=()=>{r()};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex items-center justify-end gap-2 mb-4",children:[(0,n.jsx)(ez,{onSettingsChanged:p,children:(0,n.jsxs)(x.$,{variant:"outline",children:[(0,n.jsx)(m.A,{className:"me-2 h-4 w-4"})," الإعدادات"]})}),(0,n.jsx)(eM.A,{onSubscriptionAdded:p,children:(0,n.jsxs)(x.$,{children:[(0,n.jsx)(u.A,{className:"me-2 h-4 w-4"})," إضافة اشتراك"]})})]}),o?(0,n.jsx)("div",{className:"flex justify-center items-center h-64",children:(0,n.jsx)(h.A,{className:"h-8 w-8 animate-spin"})}):(0,n.jsx)(eC,{subscriptions:l,allInstallments:i,onDataChange:p})]})}var eU=t(20243);function eV(){let[e,s]=(0,a.useState)([]),[t,r]=(0,a.useState)([]),[c,x]=(0,a.useState)(!0),[m,u]=(0,a.useState)(null),h=(0,a.useCallback)(async()=>{x(!0);try{let[e,t]=await Promise.all([i(),d()]);s(e),r(t)}catch(e){u(e.message||"Failed to load data")}finally{x(!1)}},[]);return((0,a.useEffect)(()=>{h()},[h]),c)?(0,n.jsx)(eU.E,{className:"h-96 w-full"}):m?(0,n.jsxs)(o.Fc,{variant:"destructive",children:[(0,n.jsx)(l.A,{className:"h-4 w-4"}),(0,n.jsx)(o.XL,{children:"حدث خطأ!"}),(0,n.jsx)(o.TN,{children:m})]}):(0,n.jsx)(eE,{initialSubscriptions:e,initialInstallments:t,onDataChange:h})}function eJ(){return(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"px-0 sm:px-6",children:[(0,n.jsx)("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight",children:"إدارة الاشتراكات"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"عرض وإدارة جميع الاشتراكات الدورية في مكان واحد."})]}),(0,n.jsx)(r.Zp,{children:(0,n.jsx)(r.Wu,{className:"pt-6",children:(0,n.jsx)(a.Suspense,{fallback:(0,n.jsx)(eU.E,{className:"h-96 w-full"}),children:(0,n.jsx)(eV,{})})})})]})}},88917:(e,s,t)=>{"use strict";t.d(s,{I:()=>a});var n=t(30926);let a=(0,n.createServerReference)("7f156258846f24d01f7193780d90bff0896769f3dc",n.callServer,void 0,n.findSourceMapURL,"getSubscriptionById")}},e=>{e.O(0,[9135,7210,4909,9625,315,5111,4127,9967,1374,783,4223,8994,43,84,13,2612,5672,5239,7116,9239,4762,2500,898,9434,8441,1255,7358],()=>e(e.s=4942)),_N_E=e.O()}]);