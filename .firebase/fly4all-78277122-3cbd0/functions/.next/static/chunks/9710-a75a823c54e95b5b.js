"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9710],{4731:(e,s,n)=>{n.d(s,{A:()=>ei});var r=n(95155),a=n(12115),t=n(20063),l=n(30926);let i=(0,l.createServerReference)("7ffb585af41918dddb19e9e747514fc75eda9f07ca",l.callServer,void 0,l.findSourceMapURL,"getBookings"),c=(0,l.createServerReference)("4003d79e56aa7f3ece852d1ba7ff3516e60cce27d6",l.callServer,void 0,l.findSourceMapURL,"getVisaBookingById");var d=n(88917),o=n(58236),x=n(76385);let m=(0,l.createServerReference)("7fe304717562da7e993bf1bc3e43f26d6024716c28",l.callServer,void 0,l.findSourceMapURL,"getRemittances");var u=n(75660),h=n(81937),j=n(18413),p=n(50898),g=n(3998),v=n(51834),f=n(15894),b=n(74640),N=n(28127),y=n(13630),I=n(22452),S=n(92033),A=n(54879),C=n(22544),w=n(66942),D=n(41052),k=n(65142),M=n(26333),U=n(50276),R=n(64269),P=n(19056),B=n(14223),V=n(87270),J=n(3730),z=n(6259),E=n(30024),T=n(49507),L=n(23639);let Y=A.Ik({fromDate:A.p6({required_error:"تاريخ البدء مطلوب."}),toDate:A.p6({required_error:"تاريخ الانتهاء مطلوب."})}),q=A.Ik({clientId:A.Yj().min(1,{message:"اسم الشركة مطلوب."}),partnerId:A.Yj().min(1,{message:"اسم الشريك مطلوب."}),tickets:A.au.number().int().nonnegative().default(0),visas:A.au.number().int().nonnegative().default(0),hotels:A.au.number().int().nonnegative().default(0),groups:A.au.number().int().nonnegative().default(0)}),F=e=>{var s;let{entryData:n,allCompanyOptions:a,partnerOptions:t,onSave:l,onCancel:i}=e,c=(0,C.mN)({resolver:(0,w.u)(q),defaultValues:{clientId:n.clientId||"",partnerId:(null==(s=t.find(e=>e.value===n.partnerId))?void 0:s.value)||"",tickets:n.tickets||0,visas:n.visas||0,hotels:n.hotels||0,groups:n.groups||0}});return(0,r.jsx)(D.lV,{...c,children:(0,r.jsxs)("form",{onSubmit:c.handleSubmit(l),className:"p-4 bg-muted/50 rounded-lg space-y-4",children:[(0,r.jsxs)("h4",{className:"font-semibold text-base mb-2",children:["تعديل بيانات: ",n.companyName]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,r.jsx)(D.zB,{control:c.control,name:"clientId",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الشركة المصدرة للسكمنت"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(L.j,{options:a,value:s.value,onValueChange:s.onChange,placeholder:"ابحث عن شركة..."})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:c.control,name:"partnerId",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الشريك"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(L.j,{options:t,value:s.value,onValueChange:s.onChange,placeholder:"ابحث عن شريك..."})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:c.control,name:"tickets",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"التذاكر"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:c.control,name:"visas",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الفيزا"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:c.control,name:"hotels",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الفنادق"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:c.control,name:"groups",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الكروبات"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}})]}),(0,r.jsxs)("div",{className:"flex justify-end items-center gap-2",children:[(0,r.jsx)(g.$,{type:"button",variant:"ghost",onClick:i,children:"إلغاء"}),(0,r.jsxs)(g.$,{type:"submit",children:[(0,r.jsx)(b.A,{className:"me-2 h-4 w-4"})," تحديث البيانات"]})]})]})})};function H(e){let{existingPeriod:s,clients:n,suppliers:t,onSuccess:l}=e,[i,c]=(0,a.useState)(!1),{toast:d}=(0,f.dj)(),[o,x]=(0,a.useState)(!1),[m,u]=(0,a.useState)([]),[h,j]=(0,a.useState)(null),p=(0,a.useMemo)(()=>n.filter(e=>"company"===e.type).map(e=>({value:e.id,label:e.name})),[n]),A=(0,a.useMemo)(()=>Array.from(new Map([...n,...t].map(e=>[e.id,e])).values()).map(e=>{let s="";return"client"===e.relationType?s="عميل: ":"supplier"===e.relationType?s="مورد: ":"both"===e.relationType&&(s="عميل ومورد: "),{value:e.id,label:"".concat(s).concat(e.name)}}),[n,t]),[H,O]=(0,a.useState)(!1),[$,Q]=(0,a.useState)(!1),_=(0,C.mN)({resolver:(0,w.u)(Y),defaultValues:{fromDate:(0,P.H)(s.fromDate),toDate:(0,P.H)(s.toDate)}}),G=(0,C.mN)({resolver:(0,w.u)(q)});(0,a.useEffect)(()=>{i?(_.reset({fromDate:(0,P.H)(s.fromDate),toDate:(0,P.H)(s.toDate)}),u(s.entries.map(e=>{let{fromDate:s,toDate:n,...r}=e;return r}))):(G.reset({}),u([]),j(null))},[i,s,_,G]);let Z=(e,s)=>{let r=s||{ticketProfitPercentage:50,visaProfitPercentage:100,hotelProfitPercentage:100,groupProfitPercentage:100,alrawdatainSharePercentage:50},a=e.tickets*(r.ticketProfitPercentage/100),t=e.visas*(r.visaProfitPercentage/100),l=t+e.hotels*(r.hotelProfitPercentage/100)+e.groups*(r.groupProfitPercentage/100),i=a+l,c=((null==s?void 0:s.alrawdatainSharePercentage)||50)/100*i,d=n.find(s=>s.id===e.clientId),o=A.find(s=>s.value===e.partnerId);return{...e,ticketProfits:a,otherProfits:l,total:i,alrawdatainShare:c,partnerShare:i-c,companyName:(null==d?void 0:d.name)||"",partnerId:(null==o?void 0:o.value.split("-")[1])||"",partnerName:(null==o?void 0:o.label)||""}},K=async()=>{let e=await _.trigger()?_.getValues():null;if(!e)return void d({title:"الرجاء تحديد فترة محاسبية صحيحة",variant:"destructive"});if(0===m.length){await (0,E.O)(s.fromDate,s.toDate),d({title:"تم حذف الفترة",description:"تم حذف الفترة المحاسبية لعدم وجود سجلات."}),c(!1),await l();return}x(!0);try{await (0,E.O)(s.fromDate,s.toDate);let n=m.map(s=>{let{id:n,...r}=s;return{...r,fromDate:(0,B.GP)(e.fromDate,"yyyy-MM-dd"),toDate:(0,B.GP)(e.toDate,"yyyy-MM-dd")}});await (0,T.v)(n),d({title:"تم حفظ بيانات الفترة بنجاح"}),c(!1),await l()}catch(e){d({title:"خطأ",description:e.message||"لم يتم حفظ البيانات.",variant:"destructive"})}finally{x(!1)}};return(0,r.jsxs)(v.lG,{open:i,onOpenChange:c,children:[(0,r.jsx)(v.zM,{asChild:!0,children:(0,r.jsxs)(z._2,{onSelect:e=>e.preventDefault(),children:[(0,r.jsx)(b.A,{className:"me-2 h-4 w-4"}),"تعديل الفترة"]})}),(0,r.jsxs)(v.Cf,{className:"sm:max-w-4xl max-h-[90vh] flex flex-col",children:[(0,r.jsxs)(v.c7,{children:[(0,r.jsx)(v.L3,{children:"تعديل سجل سكمنت"}),(0,r.jsx)(v.rr,{children:"عدّل بيانات الفترة، ثم أضف أو عدّل الشركات، ثم احفظ الفترة كاملة."})]}),(0,r.jsxs)("div",{className:"flex-grow overflow-auto pr-6 -mr-6 space-y-4",children:[(0,r.jsxs)("div",{className:"p-4 border rounded-lg bg-background/50 sticky top-0 z-10",children:[(0,r.jsx)("h3",{className:"font-semibold text-base mb-2",children:"الخطوة 1: تعديل الفترة المحاسبية"}),(0,r.jsx)(D.lV,{..._,children:(0,r.jsxs)("form",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-start",children:[(0,r.jsx)(D.zB,{control:_.control,name:"fromDate",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"من تاريخ"}),(0,r.jsxs)(M.AM,{open:H,onOpenChange:O,children:[(0,r.jsx)(M.Wv,{asChild:!0,children:(0,r.jsx)(D.MJ,{children:(0,r.jsxs)(g.$,{variant:"outline",className:(0,R.cn)("w-full justify-start text-left font-normal",!s.value&&"text-muted-foreground"),children:[s.value?(0,B.GP)(s.value,"yyyy-MM-dd"):(0,r.jsx)("span",{children:"اختر تاريخاً"}),(0,r.jsx)(N.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,r.jsx)(M.hl,{className:"w-auto p-0",align:"start",children:(0,r.jsx)(U.V,{mode:"single",selected:s.value,onSelect:e=>{e&&s.onChange(e),O(!1)},initialFocus:!0})})]}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:_.control,name:"toDate",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"إلى تاريخ"}),(0,r.jsxs)(M.AM,{open:$,onOpenChange:Q,children:[(0,r.jsx)(M.Wv,{asChild:!0,children:(0,r.jsx)(D.MJ,{children:(0,r.jsxs)(g.$,{variant:"outline",className:(0,R.cn)("w-full justify-start text-left font-normal",!s.value&&"text-muted-foreground"),children:[s.value?(0,B.GP)(s.value,"yyyy-MM-dd"):(0,r.jsx)("span",{children:"اختر تاريخاً"}),(0,r.jsx)(N.A,{className:"ms-auto h-4 w-4 opacity-50"})]})})}),(0,r.jsx)(M.hl,{className:"w-auto p-0",align:"start",children:(0,r.jsx)(U.V,{mode:"single",selected:s.value,onSelect:e=>{e&&s.onChange(e),Q(!1)},initialFocus:!0})})]}),(0,r.jsx)(D.C5,{})]})}})]})})]}),(0,r.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,r.jsxs)("h3",{className:"font-semibold text-base mb-2",children:["الخطوة 2: الشركات المضافة لهذه الفترة (",m.length,")"]}),(0,r.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,r.jsxs)(V.XI,{children:[(0,r.jsx)(V.A0,{children:(0,r.jsxs)(V.Hj,{children:[(0,r.jsx)(V.nd,{children:"الشركة"}),(0,r.jsx)(V.nd,{children:"إجمالي الربح"}),(0,r.jsx)(V.nd,{children:"حصة الروضتين"}),(0,r.jsx)(V.nd,{children:"حصة الشريك"}),(0,r.jsx)(V.nd,{className:"w-[100px] text-center",children:"الإجراءات"})]})}),(0,r.jsx)(V.BF,{children:0===m.length?(0,r.jsx)(V.Hj,{children:(0,r.jsx)(V.nA,{colSpan:5,className:"text-center h-24",children:"لا توجد سجلات. سيتم حذف الفترة عند الحفظ."})}):m.map((e,s)=>(0,r.jsx)(J.Nt,{asChild:!0,open:h===s,onOpenChange:()=>j(e=>e===s?null:s),children:(0,r.jsxs)("tbody",{className:"border-t",children:[(0,r.jsxs)(V.Hj,{className:"cursor-pointer",onClick:()=>j(e=>e===s?null:s),children:[(0,r.jsx)(V.nA,{className:"font-semibold",children:e.companyName}),(0,r.jsx)(V.nA,{className:"font-mono",children:e.total.toFixed(2)}),(0,r.jsx)(V.nA,{className:"font-mono text-green-600",children:e.alrawdatainShare.toFixed(2)}),(0,r.jsx)(V.nA,{className:"font-mono text-blue-600",children:e.partnerShare.toFixed(2)}),(0,r.jsxs)(V.nA,{className:"text-center space-x-1",children:[(0,r.jsx)(g.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",children:(0,r.jsx)(b.A,{className:"h-4 w-4"})}),(0,r.jsx)(g.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:e=>{e.stopPropagation(),u(e=>e.filter((e,n)=>n!==s))},children:(0,r.jsx)(y.A,{className:"h-4 w-4"})})]})]}),(0,r.jsx)(J.Ke,{asChild:!0,children:(0,r.jsx)(V.Hj,{children:(0,r.jsx)(V.nA,{colSpan:5,className:"p-0",children:(0,r.jsx)(F,{entryData:e,allCompanyOptions:p,partnerOptions:A,onSave:e=>((e,s)=>{let n=Z(s),r=[...m];r[e]={...r[e],...n},u(r),d({title:"تم تحديث الشركة",description:"تم تحديث بيانات ".concat(n.companyName,".")}),j(null)})(s,e),onCancel:()=>j(null)})})})})]})},e.id||s))})]})})]}),(0,r.jsxs)("div",{className:"p-4 border rounded-lg",children:[(0,r.jsx)("h3",{className:"font-semibold text-base mb-2",children:"الخطوة 3: إضافة شركة جديدة"}),(0,r.jsx)(D.lV,{...G,children:(0,r.jsxs)("form",{onSubmit:G.handleSubmit(e=>{let s=n.find(s=>s.id===e.clientId),r=Z(e,null==s?void 0:s.segmentSettings);u(e=>[...e,{id:"new-".concat(Date.now()),...r}]),d({title:"تمت إضافة الشركة",description:"تمت إضافة ".concat(r.companyName," إلى الفترة الحالية.")}),G.reset({clientId:"",partnerId:"",tickets:0,visas:0,hotels:0,groups:0})}),className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,r.jsx)(D.zB,{control:G.control,name:"clientId",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الشركة المصدرة للسكمنت"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(L.j,{options:p,value:s.value,onValueChange:s.onChange,placeholder:"ابحث عن شركة..."})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:G.control,name:"partnerId",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الشريك"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(L.j,{options:A,value:s.value,onValueChange:s.onChange,placeholder:"ابحث عن شريك..."})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:G.control,name:"tickets",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"التذاكر"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:G.control,name:"visas",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الفيزا"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:G.control,name:"hotels",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الفنادق"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}}),(0,r.jsx)(D.zB,{control:G.control,name:"groups",render:e=>{let{field:s}=e;return(0,r.jsxs)(D.eI,{children:[(0,r.jsx)(D.lR,{children:"الكروبات"}),(0,r.jsx)(D.MJ,{children:(0,r.jsx)(k.p,{type:"number",...s})}),(0,r.jsx)(D.C5,{})]})}})]}),(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsxs)(g.$,{type:"submit",children:[(0,r.jsx)(I.A,{className:"me-2 h-4 w-4"})," إضافة للفترة"]})})]})})]})]}),(0,r.jsx)(v.Es,{className:"sticky bottom-0 bg-background pt-4 border-t",children:(0,r.jsxs)(g.$,{type:"button",onClick:K,disabled:o,className:"w-full sm:w-auto",children:[o&&(0,r.jsx)(S.A,{className:"me-2 h-4 w-4 animate-spin"}),"حفظ التعديلات (",m.length," سجلات)"]})})]})]})}var O=n(36715),$=n(35700),Q=n(11186),_=n(59007),G=n(20146),Z=n(88964),K=n(14271),W=n(5273),X=n(86948),ee=n(60013),es=n(98053);let en=e=>{let{title:s,value:n}=e;return(0,r.jsxs)("div",{className:"bg-muted/50 border p-4 rounded-lg text-center",children:[(0,r.jsx)("p",{className:"text-sm text-muted-foreground font-bold",children:s}),(0,r.jsx)("p",{className:"text-2xl font-bold",children:n})]})},er=e=>{var s;let{period:n,partners:t,onDataChange:l,index:i}=e,[c,d]=(0,a.useState)([]),[o,x]=(0,a.useState)(!1),[m,u]=(0,a.useState)(!1),{toast:h}=(0,f.dj)(),j=(0,a.useCallback)(async()=>{if(m){x(!0);try{let e=await (0,O.k)(n.id),s=(0,ee.jM)(e,e=>{e.forEach(e=>{if(!e.partnerName){let s=t.find(s=>s.id===e.partnerId);s&&(e.partnerName=s.name)}})});d(s)}catch(e){console.error("Failed to fetch or enrich shares",e),h({title:"خطأ",description:"فشل تحميل تفاصيل الحصص.",variant:"destructive"})}finally{x(!1)}}},[m,n.id,t,h]),p=async()=>{if(n.fromSystem)return;let e=await (0,$.D)(n.id);e.success?(h({title:"تم حذف الفترة اليدوية بنجاح"}),l()):h({title:"خطأ",description:e.error,variant:"destructive"})};(0,a.useEffect)(()=>{m&&j()},[m,j]);let v=n.notes||(n.fromSystem?"أرباح شهر ".concat(n.id):"فترة يدوية"),b=n.fromSystem?(0,B.GP)((0,P.H)("".concat(n.id,"-01")),"yyyy-MM-dd"):n.fromDate,N=n.fromSystem?"-":n.toDate,I=(null==(s=t.find(e=>e.id===n.sourceAccountId))?void 0:s.name)||n.sourceAccountId||"غير محدد";return(0,r.jsx)(J.Nt,{asChild:!0,open:m,onOpenChange:u,children:(0,r.jsxs)("tbody",{className:"border-t",children:[(0,r.jsxs)(V.Hj,{className:"cursor-pointer",onClick:()=>u(!m),children:[(0,r.jsx)(V.nA,{className:"p-1 text-center",children:(0,r.jsx)(J.R6,{asChild:!0,children:(0,r.jsx)(g.$,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,r.jsx)(_.A,{className:(0,R.cn)("h-4 w-4 transition-transform",m&&"rotate-180")})})})}),(0,r.jsx)(V.nA,{className:"font-mono text-xs text-center p-2",children:n.invoiceNumber||"N/A"}),(0,r.jsx)(V.nA,{className:"p-2",children:v.split(" | ")[0]}),(0,r.jsx)(V.nA,{className:"font-mono text-xs text-center p-2",children:b}),(0,r.jsx)(V.nA,{className:"font-mono text-xs text-center p-2",children:N}),(0,r.jsx)(V.nA,{className:"font-semibold text-center p-2",children:I}),(0,r.jsx)(V.nA,{className:"font-mono text-xs text-center p-2",children:n.createdAt?(0,B.GP)((0,P.H)(n.createdAt),"yyyy-MM-dd hh:mm a"):"-"}),(0,r.jsx)(V.nA,{className:"p-2 text-center",children:n.userName||"غير معروف"}),(0,r.jsxs)(V.nA,{className:"text-right font-mono font-bold p-2",children:[n.totalProfit.toLocaleString()," ",n.currency||"USD"]}),(0,r.jsx)(V.nA,{className:"p-1 text-center",children:!n.fromSystem&&(0,r.jsxs)(z.rI,{children:[(0,r.jsx)(z.ty,{asChild:!0,children:(0,r.jsx)(g.$,{variant:"ghost",size:"icon",onClick:e=>e.stopPropagation(),children:(0,r.jsx)(G.A,{className:"h-4 w-4"})})}),(0,r.jsxs)(z.SQ,{children:[(0,r.jsx)(W.A,{period:n,partners:t,onSuccess:l,isEditing:!0,children:(0,r.jsxs)(z._2,{onSelect:e=>e.preventDefault(),children:[(0,r.jsx)(Z.A,{className:"me-2 h-4 w-4"})," تعديل الفترة"]})}),(0,r.jsxs)(es.Lt,{children:[(0,r.jsx)(es.tv,{asChild:!0,children:(0,r.jsxs)(z._2,{onSelect:e=>e.preventDefault(),className:"text-destructive focus:text-destructive",children:[(0,r.jsx)(y.A,{className:"me-2 h-4 w-4"})," حذف الفترة"]})}),(0,r.jsxs)(es.EO,{children:[(0,r.jsxs)(es.wd,{children:[(0,r.jsx)(es.r7,{children:"هل أنت متأكد؟"}),(0,r.jsx)(es.$v,{children:"سيتم حذف هذه الفترة اليدوية وكل توزيعاتها."})]}),(0,r.jsxs)(es.ck,{children:[(0,r.jsx)(es.Zr,{children:"إلغاء"}),(0,r.jsx)(es.Rx,{onClick:e=>{e.stopPropagation(),p()},className:(0,R.cn)((0,g.r)({variant:"destructive"})),children:"نعم، احذف"})]})]})]})]})]})})]}),(0,r.jsx)(J.Ke,{asChild:!0,children:(0,r.jsx)(V.Hj,{children:(0,r.jsx)(V.nA,{colSpan:10,className:"p-0",children:(0,r.jsx)("div",{className:"p-2 bg-muted/20",children:o?(0,r.jsx)("div",{className:"flex justify-center p-8",children:(0,r.jsx)(S.A,{className:"animate-spin h-6 w-6"})}):(0,r.jsx)(K.A,{shares:c,partners:t,onDataChange:()=>{j(),l()},totalProfit:n.totalProfit,currency:n.currency||"USD",isManual:!n.fromSystem,monthId:n.id})})})})})]})})};function ea(e){let{initialMonthlyProfits:s,partners:n,onDataChange:t}=e,[l,i]=(0,a.useState)(s),[c,d]=(0,a.useState)("all");(0,a.useEffect)(()=>{i(s)},[s]);let o=(0,a.useMemo)(()=>"all"===c?l:l.filter(e=>e.fromSystem===("system"===c)),[l,c]),{totalDistributedProfit:x,totalCompanyShare:m,grandTotal:u}=(0,a.useMemo)(()=>{let e=0,s=0;return l.forEach(n=>{e+=n.totalProfit,Array.isArray(n.partners)&&(s+=n.partners.reduce((e,s)=>e+s.amount,0))}),{grandTotal:e,totalDistributedProfit:s,totalCompanyShare:e-s}},[l]);return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,r.jsx)(en,{title:"\uD83D\uDCB0 إجمالي صافي الأرباح",value:"".concat(u.toLocaleString()," USD")}),(0,r.jsx)(en,{title:"\uD83D\uDCCA إجمالي حصص الشركاء الموزعة",value:"".concat(x.toLocaleString()," USD")}),(0,r.jsx)(en,{title:"\uD83C\uDFE2 إجمالي حصة الشركة",value:"".concat(m.toLocaleString()," USD")})]}),(0,r.jsxs)(X.Zp,{children:[(0,r.jsxs)(X.aR,{className:"flex flex-row justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)(X.ZB,{children:"الفترات المحاسبية للأرباح"}),(0,r.jsx)(X.BT,{children:"انقر على أي فترة لعرض توزيع حصصها."})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)(Q.l6,{value:c,onValueChange:e=>d(e),children:[(0,r.jsx)(Q.bq,{className:"w-[150px]",children:(0,r.jsx)(Q.yv,{})}),(0,r.jsxs)(Q.gC,{children:[(0,r.jsx)(Q.eb,{value:"all",children:"الكل"}),(0,r.jsx)(Q.eb,{value:"system",children:"تلقائي"}),(0,r.jsx)(Q.eb,{value:"manual",children:"يدوي"})]})]}),(0,r.jsx)(W.A,{partners:n,onSuccess:t,children:(0,r.jsxs)(g.$,{children:[(0,r.jsx)(I.A,{className:"me-2 h-4 w-4"})," إضافة توزيع يدوي"]})})]})]}),(0,r.jsx)(X.Wu,{children:(0,r.jsx)("div",{className:"border rounded-lg overflow-x-auto",children:(0,r.jsxs)(V.XI,{children:[(0,r.jsx)(V.A0,{children:(0,r.jsxs)(V.Hj,{children:[(0,r.jsx)(V.nd,{className:"w-[50px] p-2"}),(0,r.jsx)(V.nd,{className:"p-2",children:"رقم الفاتورة"}),(0,r.jsx)(V.nd,{className:"p-2",children:"الوصف"}),(0,r.jsx)(V.nd,{className:"p-2",children:"من"}),(0,r.jsx)(V.nd,{className:"p-2",children:"إلى"}),(0,r.jsx)(V.nd,{className:"p-2",children:"مصدر الربح"}),(0,r.jsx)(V.nd,{className:"p-2",children:"تاريخ الإنشاء"}),(0,r.jsx)(V.nd,{className:"p-2",children:"الموظف"}),(0,r.jsx)(V.nd,{className:"text-right p-2",children:"إجمالي الربح"}),(0,r.jsx)(V.nd,{className:"text-center p-2",children:"الإجراءات"})]})}),o.map((e,s)=>(0,r.jsx)(er,{period:e,partners:n,index:s,onDataChange:t},e.id))]})})})]})]})}var et=n(81450),el=n(31318);function ei(e){let{voucher:s,isOpen:n,onClose:l}=e,g=(0,t.useRouter)(),[v,f]=(0,a.useState)(null),[b,N]=(0,a.useState)(!1);(0,a.useEffect)(()=>{(async()=>{if(!n||!(null==s?void 0:s.sourceType)||!(null==s?void 0:s.sourceId))return f(null);N(!0);let e=null;try{switch(s.sourceType){case"booking":{let{bookings:n}=await i({limit:1e3});e=n.find(e=>e.id===s.sourceId);break}case"visa":e=await c(s.sourceId);break;case"subscription":e=await (0,d.I)(s.sourceId);break;case"segment":e=(await (0,x.L)()).find(e=>e.id===s.sourceId);break;case"profit-sharing":e=(await (0,o.r)()).find(e=>e.id===s.sourceId);break;case"remittance":e=(await m()).find(e=>e.id===s.sourceId);break;case"exchange_transaction":case"exchange_payment":{let{accounts:n}=await (0,u.r)();e={batch:{id:s.sourceId,...s.originalData,details:[s.originalData],entryType:s.sourceType},exchanges:n};break}default:g.push("/accounts/vouchers/".concat(s.id,"/edit"));return}f(e)}catch(e){console.error("Failed to fetch data for editing:",e)}finally{N(!1)}})()},[n,s,g]);let y=()=>{l()};if(!n||!s||!v||b)return null;switch(s.sourceType){case"booking":return(0,r.jsx)(h.A,{isEditing:!0,booking:v,onBookingUpdated:y,children:(0,r.jsx)("div",{})});case"visa":return(0,r.jsx)(j.A,{booking:v,onBookingUpdated:y});case"subscription":return(0,r.jsx)(p.A,{isEditing:!0,initialData:v,onSubscriptionUpdated:y,children:(0,r.jsx)("div",{})});case"segment":return(0,r.jsx)(H,{existingPeriod:v,clients:[],suppliers:[],onSuccess:y});case"profit-sharing":return(0,r.jsx)(ea,{period:v,partners:[],onSuccess:y});case"remittance":return(0,r.jsx)(et.A,{isEditing:!0,initialData:v,onSaveSuccess:y,children:(0,r.jsx)("div",{})});case"exchange_transaction":case"exchange_payment":return(0,r.jsx)(el.A,{batch:v.batch,exchanges:v.exchanges,onSuccess:y,children:(0,r.jsx)("div",{})});default:return null}}},12052:(e,s,n)=>{n.d(s,{Q:()=>a});var r=n(30926);let a=(0,r.createServerReference)("40b3f399476b2e0c0084bb235048022f7151d8d61a",r.callServer,void 0,r.findSourceMapURL,"deleteVoucher")},18413:(e,s,n)=>{n.d(s,{A:()=>o});var r=n(95155),a=n(12115),t=n(3998),l=n(51834),i=n(74640),c=n(93685),d=n(19056);function o(e){let{booking:s,onBookingUpdated:n}=e,[o,x]=(0,a.useState)(!1),m={...s,submissionDate:s.submissionDate?(0,d.H)(s.submissionDate):new Date};return(0,r.jsxs)(l.lG,{open:o,onOpenChange:x,children:[(0,r.jsx)(l.zM,{asChild:!0,children:(0,r.jsx)(t.$,{variant:"ghost",size:"icon",className:"text-blue-600 h-8 w-8",children:(0,r.jsx)(i.A,{className:"h-4 w-4"})})}),(0,r.jsxs)(l.Cf,{className:"sm:max-w-4xl p-0",children:[(0,r.jsxs)(l.c7,{className:"bg-primary text-primary-foreground p-4 rounded-t-lg",children:[(0,r.jsxs)(l.L3,{children:["تعديل طلب الفيزا (الفاتورة: ",s.invoiceNumber,")"]}),(0,r.jsx)(l.rr,{className:"text-primary-foreground/80",children:"قم بتحديث تفاصيل الطلب هنا."})]}),(0,r.jsx)("div",{className:"max-h-[80vh] overflow-y-auto p-6",children:(0,r.jsx)(c.A,{isEditing:!0,initialData:m,onBookingUpdated:e=>{n(e),x(!1)}})})]})]})}},30024:(e,s,n)=>{n.d(s,{O:()=>a});var r=n(30926);let a=(0,r.createServerReference)("607e850594ea411b5e11f09fc4d3f42888c31e8a99",r.callServer,void 0,r.findSourceMapURL,"deleteSegmentPeriod")},31318:(e,s,n)=>{n.d(s,{A:()=>l});var r=n(95155);n(12115);var a=n(98090),t=n(1402);function l(e){let{batch:s,exchanges:n,onSuccess:l,children:i}=e;return"transaction"===s.entryType?(0,r.jsx)(a.A,{exchangeId:s.exchangeId||"",exchanges:n,onSuccess:l,isEditing:!0,initialData:s,children:i}):"payment"===s.entryType?(0,r.jsx)(t.A,{exchangeId:s.exchangeId||"",exchanges:n,onSuccess:l,isEditing:!0,initialData:s,children:i}):(0,r.jsx)(r.Fragment,{children:i})}},35040:(e,s,n)=>{n.d(s,{A:()=>x});var r=n(95155),a=n(98039),t=n(94374),l=n(82863),i=n(94972),c=n(64269);let d=(e,s)=>{if(.01>Math.abs(e))return"0.00 ".concat(s);let n=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e);return"".concat(n," ").concat(s)},o=e=>{let{title:s,usd:n,iqd:a,className:t,icon:l}=e;return(0,r.jsxs)("div",{className:(0,c.cn)("text-center p-2 rounded-lg bg-background",t),children:[(0,r.jsxs)("p",{className:"text-xs font-bold text-muted-foreground flex items-center justify-center gap-1",children:[(0,r.jsx)(l,{className:"h-4 w-4"}),s]}),(0,r.jsx)("p",{className:(0,c.cn)("font-bold font-mono text-sm",n<0?"text-red-500":""),children:d(n,"USD")}),(0,r.jsx)("p",{className:(0,c.cn)("font-bold font-mono text-xs text-muted-foreground",a<0?"text-red-500/80":""),children:d(a,"IQD")})]})};function x(e){let{report:s}=e;return(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-3 w-full",children:[(0,r.jsx)(o,{title:"الرصيد الافتتاحي",usd:s.openingBalanceUSD,iqd:s.openingBalanceIQD,className:"border-gray-500/30",icon:a.A}),(0,r.jsx)(o,{title:"إجمالي الدائن",usd:s.totalCreditUSD,iqd:s.totalCreditIQD,className:"border-green-500/30 text-green-600",icon:t.A}),(0,r.jsx)(o,{title:"إجمالي المدين",usd:s.totalDebitUSD,iqd:s.totalDebitIQD,className:"border-red-500/30 text-red-600",icon:l.A}),(0,r.jsx)(o,{title:"الرصيد الختامي",usd:s.finalBalanceUSD,iqd:s.finalBalanceIQD,className:"border-blue-500/30 text-blue-600",icon:i.A})]})}},40625:(e,s,n)=>{n.d(s,{Q:()=>a});var r=n(30926);let a=(0,r.createServerReference)("408c79ddd0d0a9122724301d14534a0975eed69018",r.callServer,void 0,r.findSourceMapURL,"addRemittance")},63192:(e,s,n)=>{n.d(s,{h:()=>a});var r=n(30926);let a=(0,r.createServerReference)("402c7b78446472945608a53a3ef0be184327c2a5fe",r.callServer,void 0,r.findSourceMapURL,"getAccountStatement")},76385:(e,s,n)=>{n.d(s,{L:()=>a});var r=n(30926);let a=(0,r.createServerReference)("403ab84bcb8381bf290b99f5595e7f53fbfe6fdc2c",r.callServer,void 0,r.findSourceMapURL,"getSegments")},81450:(e,s,n)=>{n.d(s,{A:()=>R});var r=n(95155),a=n(12115),t=n(51834),l=n(22544),i=n(66942),c=n(54879),d=n(3998),o=n(76444),x=n(31120),m=n(11186),u=n(92033),h=n(27314),j=n(94972),p=n(44381),g=n(73180),v=n(15894),f=n(23639),b=n(30926);let N=(0,b.createServerReference)("60c7862a4ca16493782c4d556b1c72f9ee8d90ed17",b.callServer,void 0,b.findSourceMapURL,"updateRemittance");var y=n(40625),I=n(41052),S=n(97916),A=n(64269),C=n(5470),w=n(23451);let D=c.Ik({companyName:c.Yj().min(1,"اسم الشركة مطلوب"),officeName:c.Yj().min(1,"اسم المكتب مطلوب"),method:c.Yj().min(1,"طريقة التحويل مطلوبة"),assignedToUid:c.Yj().min(1,"المخول بالاستلام مطلوب"),boxId:c.Yj().min(1,"الصندوق المستلم مطلوب"),totalAmountUsd:c.au.number().min(0).default(0),totalAmountIqd:c.au.number().min(0).default(0),distributions:c.g1(c.au.number().min(0)),notes:c.Yj().optional()}).refine(e=>e.totalAmountUsd>0||e.totalAmountIqd>0,{message:"يجب إدخال مبلغ للحوالة إما بالدولار أو بالدينار.",path:["totalAmountUsd"]}),k=e=>{let{currency:s,className:n,...a}=e;return(0,r.jsx)(S.O,{currency:s,className:(0,A.cn)("text-right",n),currencyClassName:(0,A.cn)("USD"===s?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...a})};function M(e){var s,n,c;let{settings:b,onSaveSuccess:S,isEditing:A=!1,initialData:M}=e,{toast:U}=(0,v.dj)(),{data:R,loaded:P}=(0,C.Z)(),{user:B}=(0,w.A)(),V=(0,l.mN)({resolver:(0,i.u)(D),defaultValues:A&&M?{...M,distributions:M.distribution||{}}:{totalAmountUsd:0,totalAmountIqd:0,distributions:{},boxId:B&&"role"in B?B.boxId:""}}),{register:J,formState:{errors:z,isSubmitting:E},setValue:T}=V,L=(0,a.useMemo)(()=>((null==R?void 0:R.users)||[]).map(e=>({value:e.uid,label:e.name})),[null==R?void 0:R.users]),Y=(0,a.useMemo)(()=>{var e,s;let n=V.watch("boxId");return(null==R||null==(s=R.boxes)||null==(e=s.find(e=>e.id===n))?void 0:e.name)||"غير محدد"},[V,null==R?void 0:R.boxes]);(0,a.useEffect)(()=>{A&&M?V.reset({...M,distributions:M.distribution||{}}):B&&"role"in B&&B.boxId&&V.setValue("boxId",B.boxId)},[B,V,A,M]);let q=async e=>{let s={companyName:e.companyName,officeName:e.officeName,method:e.method,assignedToUid:e.assignedToUid,boxId:e.boxId,totalAmountUsd:e.totalAmountUsd||0,totalAmountIqd:e.totalAmountIqd||0,distribution:e.distributions,notes:e.notes||""};if(A&&M){let e=await N(M.id,s);e.success?(U({title:"تم تحديث الحوالة بنجاح"}),S({...M,...s})):U({title:"خطأ",description:e.error,variant:"destructive"})}else{let e=await (0,y.Q)(s);e.success&&e.newRemittance?(U({title:"تمت إضافة الحوالة بنجاح"}),S(e.newRemittance),V.reset()):U({title:"خطأ",description:e.error,variant:"destructive"})}};return P&&R?(0,r.jsx)(I.lV,{...V,children:(0,r.jsxs)("form",{onSubmit:V.handleSubmit(q),className:"space-y-6",children:[(0,r.jsxs)("div",{className:"grid md:grid-cols-2 gap-x-6 gap-y-4",children:[(0,r.jsx)(I.zB,{control:V.control,name:"companyName",render:e=>{let{field:s}=e;return(0,r.jsxs)(I.eI,{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"الشركة المرسلة"}),(0,r.jsx)(I.MJ,{children:(0,r.jsx)(f.j,{searchAction:"all",value:s.value,onValueChange:s.onChange,placeholder:"ابحث عن شركة..."})}),(0,r.jsx)(I.C5,{})]})}}),(0,r.jsx)(I.zB,{control:V.control,name:"officeName",render:e=>{let{field:s}=e;return(0,r.jsxs)(I.eI,{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"المكتب"}),(0,r.jsxs)(m.l6,{onValueChange:s.onChange,value:s.value,children:[(0,r.jsx)(I.MJ,{children:(0,r.jsx)(m.bq,{children:(0,r.jsx)(m.yv,{placeholder:"اختر المكتب..."})})}),(0,r.jsx)(m.gC,{children:b.offices.map(e=>(0,r.jsx)(m.eb,{value:e,children:e},e))})]}),(0,r.jsx)(I.C5,{})]})}}),(0,r.jsx)(I.zB,{control:V.control,name:"method",render:e=>{let{field:s}=e;return(0,r.jsxs)(I.eI,{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"طريقة التحويل"}),(0,r.jsxs)(m.l6,{onValueChange:s.onChange,value:s.value,children:[(0,r.jsx)(I.MJ,{children:(0,r.jsx)(m.bq,{children:(0,r.jsx)(m.yv,{placeholder:"اختر الطريقة..."})})}),(0,r.jsx)(m.gC,{children:b.methods.map(e=>(0,r.jsx)(m.eb,{value:e,children:e},e))})]}),(0,r.jsx)(I.C5,{})]})}}),(0,r.jsx)(I.zB,{control:V.control,name:"assignedToUid",render:e=>{let{field:s}=e;return(0,r.jsxs)(I.eI,{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"المخول بالاستلام"}),(0,r.jsxs)(m.l6,{onValueChange:s.onChange,value:s.value,children:[(0,r.jsx)(I.MJ,{children:(0,r.jsx)(m.bq,{children:(0,r.jsx)(m.yv,{placeholder:"اختر موظفًا..."})})}),(0,r.jsx)(m.gC,{children:L.map(e=>(0,r.jsx)(m.eb,{value:e.value,children:e.label},e.value))})]}),(0,r.jsx)(I.C5,{})]})}})]}),(0,r.jsxs)("div",{className:"space-y-4 bg-muted/50 p-4 rounded-lg border",children:[(0,r.jsx)("h4",{className:"font-semibold",children:"توزيع مبالغ الحوالة"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"الإجمالي (USD)"}),(0,r.jsx)(l.xI,{control:V.control,name:"totalAmountUsd",render:e=>{let{field:s}=e;return(0,r.jsx)(k,{currency:"USD",...s,onValueChange:s.onChange})}}),(0,r.jsx)(I.C5,{children:null==(s=z.totalAmountUsd)?void 0:s.message})]}),(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"الإجمالي (IQD)"}),(0,r.jsx)(l.xI,{control:V.control,name:"totalAmountIqd",render:e=>{let{field:s}=e;return(0,r.jsx)(k,{currency:"IQD",...s,onValueChange:s.onChange})}})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[null==(n=b.distributionColumnsUsd)?void 0:n.map(e=>(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsxs)(o.J,{children:[e.label," (USD)"]}),(0,r.jsx)(l.xI,{control:V.control,name:"distributions.".concat(e.id,"_usd"),render:e=>{let{field:s}=e;return(0,r.jsx)(k,{currency:"USD",...s,onValueChange:s.onChange})}})]},e.id)),null==(c=b.distributionColumnsIqd)?void 0:c.map(e=>(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsxs)(o.J,{children:[e.label," (IQD)"]}),(0,r.jsx)(l.xI,{control:V.control,name:"distributions.".concat(e.id,"_iqd"),render:e=>{let{field:s}=e;return(0,r.jsx)(k,{currency:"IQD",...s,onValueChange:s.onChange})}})]},e.id))]})]}),(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsx)(o.J,{children:"ملاحظات"}),(0,r.jsx)(x.T,{...J("notes")})]}),(0,r.jsxs)(t.Es,{className:"pt-4 flex-col sm:flex-row gap-2 justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(h.A,{className:"h-4 w-4"})," ",(0,r.jsxs)("span",{children:["المستخدم: ",(null==B?void 0:B.name)||"..."]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(j.A,{className:"h-4 w-4"})," ",(0,r.jsxs)("span",{children:["الصندوق: ",Y]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(p.A,{className:"h-4 w-4"})," ",(0,r.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,r.jsxs)(d.$,{type:"submit",disabled:E,children:[E&&(0,r.jsx)(u.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,r.jsx)(g.A,{className:"me-2 h-4 w-4"}),A?"حفظ التعديلات":"حفظ الحوالة"]})]})]})}):(0,r.jsx)("div",{className:"flex justify-center items-center h-48",children:(0,r.jsx)(u.A,{className:"h-8 w-8 animate-spin"})})}var U=n(19056);function R(e){var s;let{onSaveSuccess:n,children:l,isEditing:i=!1,initialData:c}=e,[d,o]=(0,a.useState)(!1),{data:x,loaded:m,fetchData:h}=(0,C.Z)(),j=null==x||null==(s=x.settings)?void 0:s.remittanceSettings;(0,a.useEffect)(()=>{d&&!m&&h()},[d,m,h]);let p=(0,a.useMemo)(()=>{if(c)return{...c,createdAt:c.createdAt?(0,U.H)(c.createdAt):new Date,updatedAt:c.updatedAt?(0,U.H)(c.updatedAt):new Date,auditedAt:c.auditedAt?(0,U.H)(c.auditedAt):void 0,receivedAt:c.receivedAt?(0,U.H)(c.receivedAt):void 0}},[c]);return(0,r.jsxs)(t.lG,{open:d,onOpenChange:o,children:[(0,r.jsx)(t.zM,{asChild:!0,children:l}),(0,r.jsxs)(t.Cf,{className:"sm:max-w-4xl p-0",children:[(0,r.jsxs)(t.c7,{className:"bg-primary text-primary-foreground p-4 rounded-t-lg",children:[(0,r.jsx)(t.L3,{children:i?"تعديل بيانات الحوالة":"إضافة حوالة جديدة"}),(0,r.jsx)(t.rr,{className:"text-primary-foreground/80",children:i?"قم بتحديث تفاصيل الحوالة.":"أدخل جميع تفاصيل الحوالة هنا. سيتم حفظها وانتظار التدقيق."})]}),(0,r.jsx)("div",{className:"max-h-[80vh] overflow-y-auto p-6",children:m&&j?(0,r.jsx)(M,{settings:j,onSaveSuccess:e=>{n(e),o(!1)},isEditing:i,initialData:p}):(0,r.jsx)("div",{className:"flex justify-center items-center h-48",children:(0,r.jsx)(u.A,{className:"h-8 w-8 animate-spin"})})})]})]})}},88917:(e,s,n)=>{n.d(s,{I:()=>a});var r=n(30926);let a=(0,r.createServerReference)("7f156258846f24d01f7193780d90bff0896769f3dc",r.callServer,void 0,r.findSourceMapURL,"getSubscriptionById")},93685:(e,s,n)=>{n.d(s,{A:()=>B});var r=n(95155),a=n(12115),t=n(22544),l=n(66942),i=n(54879),c=n(3998),d=n(65142),o=n(76444),x=n(11186),m=n(87270),u=n(13630),h=n(22452),j=n(27314),p=n(94972),g=n(44381),v=n(92033),f=n(73180),b=n(30926);let N=(0,b.createServerReference)("60562fa6e2acf835f7f484086ad9e3f76c9be2ca55",b.callServer,void 0,b.findSourceMapURL,"updateVisaBooking"),y=(0,b.createServerReference)("409ab5f3a1d5afb4b4634875b66bd6864afda3323f",b.callServer,void 0,b.findSourceMapURL,"addVisaBooking");var I=n(23639),S=n(64269),A=n(15894),C=n(31120),w=n(27432),D=n(5470),k=n(23451),M=n(51834),U=n(97916);let R=i.Ik({id:i.Yj().optional(),name:i.Yj().min(1,"الاسم الكامل مطلوب"),passportNumber:i.Yj().optional(),applicationNumber:i.Yj().min(1,"رقم الطلب مطلوب"),visaType:i.Yj().min(1,"نوع الفيزا مطلوب"),bk:i.Yj().optional(),purchasePrice:i.Yj().or(i.ai()).transform(e=>Number(String(e).replace(/,/g,""))).refine(e=>e>=0,{message:"سعر الشراء يجب أن يكون 0 أو أكثر."}),salePrice:i.Yj().or(i.ai()).transform(e=>Number(String(e).replace(/,/g,""))).refine(e=>e>=0,{message:"سعر البيع يجب أن يكون 0 أو أكثر."})}),P=i.Ik({id:i.Yj().optional(),supplierId:i.Yj().min(1,"المورد مطلوب"),clientId:i.Yj().min(1,"العميل مطلوب"),submissionDate:i.p6({required_error:"تاريخ التقديم مطلوب"}),boxId:i.Yj().min(1,"الصندوق مطلوب"),currency:i.k5(["USD","IQD"]),notes:i.Yj().optional(),passengers:i.YO(R).min(1,"يجب إضافة مسافر واحد على الأقل")});function B(e){let{isEditing:s=!1,initialData:n,onBookingAdded:i,onBookingUpdated:b}=e,{toast:R}=(0,A.dj)(),{data:B}=(0,D.Z)(),{user:V}=(0,k.A)(),J=a.useMemo(()=>((null==B?void 0:B.clients)||[]).map(e=>({value:e.id,label:e.name})),[null==B?void 0:B.clients]),z=a.useMemo(()=>((null==B?void 0:B.suppliers)||[]).map(e=>({value:e.id,label:e.name})),[null==B?void 0:B.suppliers]),E=(0,t.mN)({resolver:(0,l.u)(P),defaultValues:s?n:{supplierId:"",clientId:"",submissionDate:new Date,boxId:"",currency:"USD",notes:"",passengers:[{name:"",passportNumber:"",applicationNumber:"",visaType:"",bk:"",purchasePrice:0,salePrice:0}]}});a.useEffect(()=>{V&&"role"in V&&V.boxId&&!s&&E.setValue("boxId",V.boxId)},[V,s,E]);let{control:T,handleSubmit:L,formState:{errors:Y,isSubmitting:q},setValue:F,watch:H}=E,{fields:O,append:$,remove:Q}=(0,t.jz)({control:T,name:"passengers"}),_=a.useMemo(()=>{var e,s;let n=E.watch("boxId");return(null==B||null==(s=B.boxes)||null==(e=s.find(e=>e.id===n))?void 0:e.name)||"غير محدد"},[E,null==B?void 0:B.boxes]),G=async e=>{var n,r;let a=null==B||null==(n=B.clients)?void 0:n.find(s=>s.id===e.clientId),t=null==B||null==(r=B.suppliers)?void 0:r.find(s=>s.id===e.supplierId),l={supplierId:e.supplierId,clientId:e.clientId,supplierName:(null==t?void 0:t.name)||e.supplierId,clientName:(null==a?void 0:a.name)||e.clientId,boxId:e.boxId,currency:e.currency,submissionDate:e.submissionDate.toISOString(),notes:e.notes||"",passengers:e.passengers.map(e=>({id:e.id||"temp-".concat(Math.random()),name:e.name,passportNumber:e.passportNumber||"",applicationNumber:e.applicationNumber,visaType:e.visaType,bk:e.bk||"",purchasePrice:e.purchasePrice,salePrice:e.salePrice}))};if(s&&e.id){let s=await N(e.id,l);s.success&&s.updatedBooking?(R({title:"تم تحديث الطلب بنجاح"}),b&&b(s.updatedBooking)):R({title:"خطأ في التحديث",description:s.error,variant:"destructive"})}else{let e=await y(l);e.success&&e.newBooking?(R({title:"تمت إضافة طلب الفيزا بنجاح"}),E.reset(),i&&i(e.newBooking)):R({title:"خطأ في الإضافة",description:e.error,variant:"destructive"})}};return(0,r.jsxs)("form",{onSubmit:L(G),className:"space-y-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-start p-4 border rounded-lg bg-muted/30",children:[(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"supplierId",children:"المورد"}),(0,r.jsx)(t.xI,{name:"supplierId",control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(I.j,{options:z,value:s.value,onValueChange:s.onChange,placeholder:"اختر موردًا..."})}}),Y.supplierId&&(0,r.jsx)("p",{className:"text-sm text-destructive h-4",children:Y.supplierId.message})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"clientId",children:"العميل"}),(0,r.jsx)(t.xI,{name:"clientId",control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(I.j,{options:J,value:s.value,onValueChange:s.onChange,placeholder:"اختر عميلاً..."})}}),Y.clientId&&(0,r.jsx)("p",{className:"text-sm text-destructive h-4",children:Y.clientId.message})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"submissionDate",children:"تاريخ التقديم"}),(0,r.jsx)(t.xI,{name:"submissionDate",control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(w.K,{date:s.value,setDate:s.onChange})}}),Y.submissionDate&&(0,r.jsx)("p",{className:"text-sm text-destructive h-4",children:Y.submissionDate.message})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"currency",children:"العملة"}),(0,r.jsx)(t.xI,{name:"currency",control:T,render:e=>{let{field:s}=e;return(0,r.jsxs)(x.l6,{onValueChange:s.onChange,value:s.value,children:[(0,r.jsx)(x.bq,{children:(0,r.jsx)(x.yv,{})}),(0,r.jsxs)(x.gC,{children:[(0,r.jsx)(x.eb,{value:"USD",children:"USD"}),(0,r.jsx)(x.eb,{value:"IQD",children:"IQD"})]})]})}})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"boxId",children:"الصندوق"}),(0,r.jsx)(t.xI,{name:"boxId",control:T,render:e=>{let{field:s}=e;return(0,r.jsxs)(x.l6,{onValueChange:s.onChange,value:s.value,children:[(0,r.jsx)(x.bq,{children:(0,r.jsx)(x.yv,{placeholder:"اختر صندوق..."})}),(0,r.jsx)(x.gC,{children:((null==B?void 0:B.boxes)||[]).map(e=>(0,r.jsx)(x.eb,{value:e.id,children:e.name},e.id))})]})}}),Y.boxId&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-1",children:Y.boxId.message})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)(o.J,{htmlFor:"notes",children:"ملاحظات"}),(0,r.jsx)(t.xI,{name:"notes",control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(C.T,{...s})}})]})]}),(0,r.jsxs)("div",{className:"overflow-x-auto border rounded-lg",children:[(0,r.jsxs)(m.XI,{children:[(0,r.jsx)(m.A0,{children:(0,r.jsxs)(m.Hj,{className:"bg-muted/50",children:[(0,r.jsx)(m.nd,{className:"p-2",children:"الاسم الكامل"}),(0,r.jsx)(m.nd,{className:"p-2",children:"رقم الجواز"}),(0,r.jsx)(m.nd,{className:"p-2",children:"رقم الطلب"}),(0,r.jsx)(m.nd,{className:"p-2",children:"نوع الفيزا"}),(0,r.jsx)(m.nd,{className:"p-2",children:"BK"}),(0,r.jsx)(m.nd,{className:"p-2",children:"سعر الشراء"}),(0,r.jsx)(m.nd,{className:"p-2",children:"سعر البيع"}),(0,r.jsx)(m.nd,{className:"p-2 w-[50px]"})]})}),(0,r.jsx)(m.BF,{children:O.map((e,s)=>{let n=H("currency");return(0,r.jsxs)(m.Hj,{children:[(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(d.p,{...E.register("passengers.".concat(s,".name"))})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(d.p,{...E.register("passengers.".concat(s,".passportNumber"))})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(d.p,{...E.register("passengers.".concat(s,".applicationNumber"))})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(d.p,{...E.register("passengers.".concat(s,".visaType"))})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(d.p,{...E.register("passengers.".concat(s,".bk"))})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(t.xI,{name:"passengers.".concat(s,".purchasePrice"),control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(U.O,{currency:n,currencyClassName:(0,S.cn)("USD"===n?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...s,onValueChange:s.onChange})}})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(t.xI,{name:"passengers.".concat(s,".salePrice"),control:T,render:e=>{let{field:s}=e;return(0,r.jsx)(U.O,{currency:n,currencyClassName:(0,S.cn)("USD"===n?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...s,onValueChange:s.onChange})}})}),(0,r.jsx)(m.nA,{className:"p-1",children:(0,r.jsx)(c.$,{variant:"ghost",size:"icon",onClick:()=>Q(s),disabled:O.length<=1,children:(0,r.jsx)(u.A,{className:"h-4 w-4 text-destructive"})})})]},e.id)})})]}),Y.passengers&&"object"==typeof Y.passengers&&"message"in Y.passengers&&(0,r.jsx)("p",{className:"text-sm text-destructive mt-2 p-2",children:Y.passengers.message})]}),(0,r.jsx)("div",{className:"flex justify-between items-center mt-4",children:(0,r.jsxs)(c.$,{type:"button",variant:"outline",onClick:()=>$({name:"",passportNumber:"",applicationNumber:"",visaType:"",bk:"",purchasePrice:0,salePrice:0}),children:[(0,r.jsx)(h.A,{className:"me-2 h-4 w-4"})," إضافة مسافر"]})}),(0,r.jsxs)(M.Es,{className:"flex-row items-center justify-between sticky bottom-0 bg-background border-t p-2 -mx-6 -mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(j.A,{className:"h-4 w-4 text-primary"})," ",(0,r.jsx)("span",{children:(null==V?void 0:V.name)||"..."})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(p.A,{className:"h-4 w-4 text-primary"})," ",(0,r.jsx)("span",{children:_})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)(g.A,{className:"h-4 w-4 text-primary"})," ",(0,r.jsx)("span",{children:"رقم الفاتورة: (تلقائي)"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(c.$,{type:"button",variant:"ghost",onClick:()=>E.reset(),children:"إلغاء"}),(0,r.jsxs)(c.$,{type:"submit",disabled:q,children:[q&&(0,r.jsx)(v.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,r.jsx)(f.A,{className:"me-2 h-4 w-4"}),s?"حفظ التعديلات":"حفظ الطلب"]})]})]})]})}}}]);