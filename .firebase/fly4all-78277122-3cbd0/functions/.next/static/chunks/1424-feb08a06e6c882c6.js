"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1424],{3730:(e,t,r)=>{r.d(t,{Ke:()=>l,Nt:()=>n,R6:()=>s});var a=r(57259);let n=a.bL,s=a.R6,l=a.Ke},6259:(e,t,r)=>{r.d(t,{M5:()=>p,SQ:()=>h,_2:()=>f,lv:()=>m,mB:()=>g,nV:()=>x,rI:()=>o,ty:()=>u});var a=r(95155),n=r(12115),s=r(47971),l=r(63263),i=r(72251),c=r(75797),d=r(64269);let o=s.bL,u=s.l9;s.YJ,s.ZL;let m=s.Pb;s.z6;let x=n.forwardRef((e,t)=>{let{className:r,inset:n,children:i,...c}=e;return(0,a.jsxs)(s.ZP,{ref:t,className:(0,d.cn)("flex cursor-default gap-2 select-none items-center rounded-md px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",n&&"pl-8",r),...c,children:[(0,a.jsx)(l.A,{className:"mr-auto h-4 w-4"}),i]})});x.displayName=s.ZP.displayName;let p=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)(s.G5,{ref:t,className:(0,d.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...n})});p.displayName=s.G5.displayName;let h=n.forwardRef((e,t)=>{let{className:r,sideOffset:n=4,...l}=e;return(0,a.jsx)(s.ZL,{children:(0,a.jsx)(s.UC,{ref:t,sideOffset:n,className:(0,d.cn)("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r),...l})})});h.displayName=s.UC.displayName;let f=n.forwardRef((e,t)=>{let{className:r,inset:n,...l}=e;return(0,a.jsx)(s.q7,{ref:t,className:(0,d.cn)("relative flex cursor-default select-none items-center gap-2 rounded-md px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",n&&"pl-8",r),...l})});f.displayName=s.q7.displayName,n.forwardRef((e,t)=>{let{className:r,children:n,checked:l,...c}=e;return(0,a.jsxs)(s.H_,{ref:t,className:(0,d.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pr-8 pl-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),checked:l,...c,children:[(0,a.jsx)("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.VF,{children:(0,a.jsx)(i.A,{className:"h-4 w-4"})})}),n]})}).displayName=s.H_.displayName,n.forwardRef((e,t)=>{let{className:r,children:n,...l}=e;return(0,a.jsxs)(s.hN,{ref:t,className:(0,d.cn)("relative flex cursor-default select-none items-center rounded-sm py-1.5 pr-8 pl-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...l,children:[(0,a.jsx)("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.VF,{children:(0,a.jsx)(c.A,{className:"h-2 w-2 fill-current"})})}),n]})}).displayName=s.hN.displayName,n.forwardRef((e,t)=>{let{className:r,inset:n,...l}=e;return(0,a.jsx)(s.JU,{ref:t,className:(0,d.cn)("px-2 py-1.5 text-sm font-semibold",n&&"pr-8",r),...l})}).displayName=s.JU.displayName;let g=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)(s.wv,{ref:t,className:(0,d.cn)("-mx-1 my-1 h-px bg-muted",r),...n})});g.displayName=s.wv.displayName},13713:(e,t,r)=>{r.d(t,{C1:()=>i,LB:()=>c,lE:()=>d});var a=r(95155),n=r(12115),s=r(72251),l=r(64269);let i=n.forwardRef((e,t)=>{let{className:r,children:n,initialStep:s,steps:i,activeStep:c,...d}=e;return(0,a.jsx)("div",{ref:t,className:(0,l.cn)("flex w-full flex-row justify-between gap-x-2",r),...d,children:n})});i.displayName="Stepper";let c=n.forwardRef((e,t)=>{let{className:r,label:n,isCompleted:i,isActive:c,isOptional:d,icon:o,isLast:u,...m}=e;return(0,a.jsxs)("div",{ref:t,className:(0,l.cn)("flex flex-1 items-center gap-x-2",r),...m,children:[(0,a.jsx)("div",{className:"flex items-center",children:(0,a.jsx)("div",{className:(0,l.cn)("flex h-8 w-8 items-center justify-center rounded-full text-lg font-bold ring-2 transition-colors",c?"bg-primary text-primary-foreground ring-primary":i?"bg-secondary text-secondary-foreground ring-secondary":"bg-muted text-muted-foreground ring-muted"),children:i?(0,a.jsx)(s.A,{}):o})}),(0,a.jsx)("div",{className:"hidden md:flex flex-col",children:(0,a.jsx)("h3",{className:(0,l.cn)("font-medium transition-colors",c?"text-primary":"text-muted-foreground"),children:n})}),!u&&(0,a.jsx)("div",{className:"h-px w-full flex-1 bg-border transition-colors","aria-hidden":"true"})]})});c.displayName="StepperItem";let d=e=>{let{initialStep:t=0,steps:r}=e,[a,s]=n.useState(t),l=n.useCallback(()=>{s(e=>e<r.length-1?e+1:e)},[r.length]),i=n.useCallback(()=>{s(e=>e>0?e-1:e)},[]),c=n.useCallback(()=>{s(t)},[t]),d=a===r.length-1;return{activeStep:a,setActiveStep:s,goToNextStep:l,goToPreviousStep:i,resetSteps:c,isDisabledStep:0===a,isLastStep:d}}},28984:(e,t,r)=>{r.d(t,{A:()=>G});var a=r(95155),n=r(12115),s=r(11929),l=r(3998),i=r(51834),c=r(86948),d=r(76444),o=r(11186),u=r(44846),m=r(64269),x=r(15894),p=r(5470),h=r(97916),f=r(23639),g=r(49507),j=r(12941),v=r(93169),b=r(57461),N=r(6943),y=r(74640),w=r(41165),P=r(13630),I=r(92634),S=r(92033),C=r(73180),k=r(19056),A=r(14223),F=r(22544),R=r(54879),D=r(66942),V=r(27432),M=r(87270),z=r(23451),T=r(41052),E=r(13713),_=r(3730),O=r(30926);let B=(0,O.createServerReference)("40f3e2b0ca2e561c506ffb1575ff80c4dac60766e4",O.callServer,void 0,O.findSourceMapURL,"getNextVoucherNumber"),Y=R.Ik({id:R.Yj(),clientId:R.Yj().min(1,{message:"اسم الشركة مطلوب."}),clientName:R.Yj().min(1),tickets:R.au.number().int().nonnegative().default(0),visas:R.au.number().int().nonnegative().default(0),hotels:R.au.number().int().nonnegative().default(0),groups:R.au.number().int().nonnegative().default(0),notes:R.Yj().optional(),ticketProfitType:R.k5(["fixed","percentage"]).default("percentage"),ticketProfitValue:R.au.number().min(0).default(50),visaProfitType:R.k5(["fixed","percentage"]).default("percentage"),visaProfitValue:R.au.number().min(0).default(100),hotelProfitType:R.k5(["fixed","percentage"]).default("percentage"),hotelProfitValue:R.au.number().min(0).default(100),groupProfitType:R.k5(["fixed","percentage"]).default("percentage"),groupProfitValue:R.au.number().min(0).default(100)}),Z=R.Ik({id:R.Yj(),partnerId:R.Yj().min(1,"اختر شريكاً."),partnerName:R.Yj(),partnerInvoiceNumber:R.Yj(),percentage:R.au.number().min(0,"النسبة يجب أن تكون موجبة.").max(100,"النسبة لا تتجاوز 100."),amount:R.au.number()}),H=R.Ik({periodInvoiceNumber:R.Yj().optional(),fromDate:R.p6({required_error:"تاريخ البدء مطلوب."}).nullable(),toDate:R.p6({required_error:"تاريخ الانتهاء مطلوب."}).nullable(),entryDate:R.p6({required_error:"تاريخ الإضافة مطلوب."}),currency:R.Yj().min(1,"اختر العملة."),hasPartner:R.zM().default(!1),alrawdatainSharePercentage:R.au.number().min(0).max(100).default(100),partners:R.YO(Z).optional(),summaryEntries:R.YO(R.bz()).min(1,"يجب إضافة شركة واحدة على الأقل.")});function J(e,t,r){return e&&r?"fixed"===t?e*r:r/100*e:0}function L(e,t){return[J(e.tickets,e.ticketProfitType||"percentage",e.ticketProfitValue||50),J(e.visas,e.visaProfitType||"percentage",e.visaProfitValue||100),J(e.hotels,e.hotelProfitType||"percentage",e.hotelProfitValue||100),J(e.groups,e.groupProfitType||"percentage",e.groupProfitValue||100)].reduce((e,t)=>e+t,0)}let U=e=>{let{label:t,icon:r,color:s,countField:l,typeField:i,valueField:u}=e,{control:x,watch:p}=(0,F.xW)(),f=p(l),g=p(i),j=p(u),v=(0,n.useMemo)(()=>J(f,g,j),[f,g,j]),b=(0,F.xW)().watch("currency");return(0,a.jsxs)(c.Zp,{className:"shadow-sm overflow-hidden",style:{borderColor:"hsl(var(--".concat(s,"))")},children:[(0,a.jsxs)(c.aR,{className:"p-2 flex flex-row items-center justify-between space-y-0 text-white",style:{backgroundColor:"hsl(var(--".concat(s,"))")},children:[(0,a.jsxs)(c.ZB,{className:"text-xs font-bold flex items-center gap-1.5",children:[(0,a.jsx)(r,{className:"h-4 w-4"}),t]}),(0,a.jsx)("div",{className:"text-xs font-bold font-mono px-1.5 py-0.5 bg-background/20 rounded-md",children:v.toFixed(2)})]}),(0,a.jsxs)(c.Wu,{className:"p-2 pt-1 space-y-1",children:[(0,a.jsx)(F.xI,{control:x,name:l,render:e=>{let{field:t}=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)(d.J,{className:"sr-only",children:"العدد"}),(0,a.jsx)(h.O,{...t,onValueChange:e=>t.onChange(e||0),placeholder:"العدد",className:"h-8 text-center font-semibold text-sm"})]})}}),(0,a.jsxs)("div",{className:"flex gap-1",children:[(0,a.jsx)(F.xI,{control:x,name:i,render:e=>{let{field:t}=e;return(0,a.jsx)(T.eI,{children:(0,a.jsxs)(o.l6,{value:t.value,onValueChange:t.onChange,children:[(0,a.jsx)(o.bq,{className:"h-7 w-16 text-xs",children:(0,a.jsx)(o.yv,{})}),(0,a.jsxs)(o.gC,{children:[(0,a.jsx)(o.eb,{value:"percentage",children:"%"}),(0,a.jsx)(o.eb,{value:"fixed",children:"$"})]})]})})}}),(0,a.jsx)(F.xI,{control:x,name:u,render:e=>{let{field:t}=e;return(0,a.jsx)(h.O,{currency:b,currencyClassName:(0,m.cn)("USD"===b?"bg-accent text-accent-foreground":"bg-primary text-primary-foreground"),...t,onValueChange:e=>t.onChange(e||0),placeholder:"القيمة",className:"h-7 text-xs"})}})]})]})]})},W=(0,n.forwardRef)((e,t)=>{let{onAdd:r,allCompanyOptions:i,partnerOptions:o,editingEntry:u,onCancelEdit:m}=e,{getValues:x}=(0,F.xW)(),[p,h]=(0,n.useState)("(تلقائي)"),g=(0,F.mN)({resolver:(0,D.u)(Y)}),{reset:P,control:I,handleSubmit:S,watch:C,setValue:k}=g,A=(0,n.useCallback)(async()=>{h(await B("COMP"))},[]);n.useEffect(()=>{var e;let t={id:(0,s.A)(),clientId:"",clientName:"",tickets:0,visas:0,hotels:0,groups:0,notes:"",ticketProfitType:"percentage",ticketProfitValue:50,visaProfitType:"percentage",visaProfitValue:100,hotelProfitType:"percentage",hotelProfitValue:100,groupProfitType:"percentage",groupProfitValue:100},r=(null==u?void 0:u.clientId)?null==(e=i.find(e=>e.value===u.clientId))?void 0:e.settings:{};P({...t,...r,...u||{}}),u?h(u.companyInvoiceNumber):A()},[u,P,i,A]),(0,n.useImperativeHandle)(t,()=>({resetForm:()=>{P({id:(0,s.A)(),clientId:"",clientName:"",tickets:0,visas:0,hotels:0,groups:0,notes:""}),A()}}),[P,A]);let R=C(),V=C("clientId");(0,n.useEffect)(()=>{let e=i.find(e=>e.value===V);e&&(k("clientName",e.label),e.settings&&Object.entries(e.settings).forEach(e=>{let[t,r]=e;k(t,r)}))},[V,i,k]);let M=(0,n.useMemo)(()=>{var e;return L(R,null==(e=i.find(e=>e.value===R.clientId))?void 0:e.settings)},[R,i]),z=async e=>{var t;let{hasPartner:a,alrawdatainSharePercentage:n,partners:l}=x(),c=L(e,null==(t=i.find(t=>t.value===e.clientId))?void 0:t.settings),d=a?c*(100-(n||0))/100:0,o=await Promise.all((l||[]).map(async e=>{let t=await B("PARTNER");return{partnerId:e.partnerId,partnerName:e.partnerName,partnerInvoiceNumber:t,share:d*(e.percentage/100)}}));r({...e,companyInvoiceNumber:p,total:c,alrawdatainShare:c-d,partnerShare:d,partnerShares:o}),P({id:(0,s.A)(),clientId:"",clientName:"",tickets:0,visas:0,hotels:0,groups:0,notes:""}),A(),m()};return(0,a.jsx)(F.Op,{...g,children:(0,a.jsx)("div",{className:"space-y-3",children:(0,a.jsxs)(c.Zp,{className:"border rounded-lg shadow-sm border-primary/40",children:[(0,a.jsxs)(c.aR,{className:"p-2 flex flex-row items-center justify-between bg-muted/30",children:[(0,a.jsx)(c.ZB,{className:"text-base font-semibold",children:u?"تعديل - فاتورة: ".concat(p):"إدخال شركة - فاتورة: ".concat(p)}),(0,a.jsxs)("div",{className:"font-mono text-sm text-blue-600 font-bold",children:["ربح الشركة: ",M.toFixed(2)]})]}),(0,a.jsxs)(c.Wu,{className:"space-y-3 p-3",children:[(0,a.jsx)(F.xI,{control:I,name:"clientId",render:e=>{var t;let{field:r,fieldState:n}=e;return(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)(d.J,{children:"الشركة المصدرة للسكمنت"}),(0,a.jsx)(f.j,{options:i,value:r.value,onValueChange:r.onChange,placeholder:"ابحث/اختر..."}),(0,a.jsx)("p",{className:"text-xs text-destructive h-3",children:null==(t=n.error)?void 0:t.message})]})}}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[(0,a.jsx)(U,{label:"تذاكر",icon:j.A,color:"primary",countField:"tickets",typeField:"ticketProfitType",valueField:"ticketProfitValue"}),(0,a.jsx)(U,{label:"فيزا",icon:v.A,color:"accent",countField:"visas",typeField:"visaProfitType",valueField:"visaProfitValue"}),(0,a.jsx)(U,{label:"فنادق",icon:b.A,color:"primary",countField:"hotels",typeField:"hotelProfitType",valueField:"hotelProfitValue"}),(0,a.jsx)(U,{label:"كروبات",icon:N.A,color:"accent",countField:"groups",typeField:"groupProfitType",valueField:"groupProfitValue"})]}),(0,a.jsx)("div",{className:"flex justify-center pt-2",children:(0,a.jsxs)(l.$,{type:"button",onClick:S(z),className:"w-full md:w-1/2",children:[u?(0,a.jsx)(y.A,{className:"me-2 h-4 w-4"}):(0,a.jsx)(w.A,{className:"me-2 h-4 w-4"}),u?"تحديث الشركة":"إضافة إلى الفترة"]})})]})]})})})});W.displayName="AddCompanyToSegmentForm";let $=e=>{let{onRemove:t,onEdit:r}=e,{watch:n}=(0,F.xW)(),s=n("summaryEntries"),{user:i}=(0,z.A)();return s&&0!==s.length?(0,a.jsxs)(c.Zp,{className:"border border-muted shadow-sm",children:[(0,a.jsx)(c.aR,{className:"p-3 flex items-center justify-between bg-muted/20 rounded-t-md",children:(0,a.jsxs)(c.ZB,{className:"text-base font-semibold",children:["الشركات المضافة (",s.length,")"]})}),(0,a.jsx)(c.Wu,{className:"p-0",children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(M.XI,{children:[(0,a.jsx)(M.A0,{className:"bg-muted/40",children:(0,a.jsxs)(M.Hj,{children:[(0,a.jsx)(M.nd,{className:"text-center",children:"رقم فاتورة الشركة"}),(0,a.jsx)(M.nd,{children:"الشركة المصدرة للسكمنت"}),(0,a.jsx)(M.nd,{children:"الشركاء (مع أرقام فواتيرهم)"}),(0,a.jsx)(M.nd,{className:"text-center",children:"إجمالي المبلغ"}),(0,a.jsx)(M.nd,{className:"text-center",children:"حصة الروضتين"}),(0,a.jsx)(M.nd,{className:"text-center",children:"حصة الشركاء"}),(0,a.jsx)(M.nd,{className:"text-center",children:"موظف الإدخال"}),(0,a.jsx)(M.nd,{className:"text-center w-[110px]",children:"الإجراءات"})]})}),(0,a.jsx)(M.BF,{children:s.map((e,n)=>(0,a.jsxs)(M.Hj,{children:[(0,a.jsx)(M.nA,{className:"text-center font-mono",children:e.companyInvoiceNumber||"(تلقائي)"}),(0,a.jsx)(M.nA,{className:"font-semibold text-sm",children:e.clientName||"غير محدد"}),(0,a.jsx)(M.nA,{className:"text-xs text-muted-foreground",children:e.partnerShares&&e.partnerShares.length>0?e.partnerShares.map(e=>"".concat(e.partnerName," (").concat(e.partnerInvoiceNumber,")")).join("، "):"لا يوجد شركاء"}),(0,a.jsx)(M.nA,{className:"text-center font-mono",children:Number(e.total||0).toFixed(2)}),(0,a.jsx)(M.nA,{className:"text-center font-mono text-green-600",children:Number(e.alrawdatainShare||0).toFixed(2)}),(0,a.jsx)(M.nA,{className:"text-center font-mono text-blue-600",children:Number(e.partnerShare||0).toFixed(2)}),(0,a.jsx)(M.nA,{className:"text-center text-sm",children:(null==i?void 0:i.name)||"غير محدد"}),(0,a.jsxs)(M.nA,{className:"text-center space-x-1 rtl:space-x-reverse",children:[(0,a.jsx)(l.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",title:"تعديل",onClick:()=>r(n),children:(0,a.jsx)(y.A,{className:"h-4 w-4"})}),(0,a.jsx)(l.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",title:"حذف",onClick:()=>t(n),children:(0,a.jsx)(P.A,{className:"h-4 w-4"})})]})]},e.id))})]})})})]}):(0,a.jsx)("div",{className:"text-center text-muted-foreground py-8 border-2 border-dashed rounded-lg",children:"لم يتم إضافة أي شركات إلى الفترة حتى الآن."})},q=e=>{let{title:t,value:r,currency:n,className:s}=e;return(0,a.jsxs)("div",{className:(0,m.cn)("p-2 rounded-lg text-center border",s),children:[(0,a.jsx)("p",{className:"text-xs font-semibold text-muted-foreground",children:t}),(0,a.jsxs)("p",{className:"font-mono font-bold text-lg",children:[r.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",n]})]})};function G(e){let{clients:t,suppliers:r,onSuccess:c,isEditing:j=!1,existingPeriod:v,children:b}=e,{toast:N}=(0,x.dj)(),[w,R]=(0,n.useState)(!1),[O,Y]=(0,n.useState)(!1),Z=n.useRef(null),[J,L]=(0,n.useState)(null),{data:U,fetchData:G}=(0,p.Z)(),{user:K}=(0,z.A)(),[X,Q]=(0,n.useState)(""),[ee,et]=(0,n.useState)(""),[er,ea]=(0,n.useState)(null),en=(0,F.mN)({resolver:(0,D.u)(H)}),{control:es,handleSubmit:el,watch:ei,setValue:ec,formState:{errors:ed},trigger:eo,reset:eu,getValues:em}=en,{fields:ex,append:ep,remove:eh,update:ef}=(0,F.jz)({control:en.control,name:"summaryEntries"}),{fields:eg,append:ej,remove:ev,update:eb}=(0,F.jz)({control:en.control,name:"partners"}),eN=ei(),ey=(0,n.useMemo)(()=>t.filter(e=>"company"===e.type).map(e=>({value:e.id,label:e.name,settings:e.segmentSettings})),[t]),ew=(0,n.useMemo)(()=>Array.from(new Map([...t,...r].map(e=>[e.id,e])).values()).map(e=>{let t="";return"client"===e.relationType?t="عميل: ":"supplier"===e.relationType?t="مورد: ":"both"===e.relationType&&(t="عميل ومورد: "),{value:e.id,label:"".concat(t).concat(e.name)}}),[t,r]),eP=(0,n.useMemo)(()=>{var e,t;return(null==U||null==(t=U.settings)||null==(e=t.currencySettings)?void 0:e.currencies)||[]},[U]);(0,n.useMemo)(()=>{var e,t;return K&&"boxId"in K&&K.boxId&&(null==U||null==(t=U.boxes)||null==(e=t.find(e=>e.id===K.boxId))?void 0:e.name)||"غير محدد"},[K,null==U?void 0:U.boxes]);let{activeStep:eI,goToNextStep:eS,goToPreviousStep:eC,resetSteps:ek,isDisabledStep:eA,isLastStep:eF}=(0,E.lE)({initialStep:0,steps:[{label:"الفترة"},{label:"الشركات"},{label:"التوزيع"},{label:"حفظ"}]});(0,n.useEffect)(()=>{if(w){var e,t,r,a;let n={periodInvoiceNumber:"(تلقائي)",fromDate:null,toDate:null,entryDate:new Date,currency:(null==U||null==(t=U.settings)||null==(e=t.currencySettings)?void 0:e.defaultCurrency)||"USD",hasPartner:!1,alrawdatainSharePercentage:(null==U||null==(a=U.settings)||null==(r=a.segmentSettings)?void 0:r.alrawdatainSharePercentage)||100,partners:[],summaryEntries:[]};j&&v?eu({...n,fromDate:(0,k.H)(v.fromDate),toDate:(0,k.H)(v.toDate),summaryEntries:v.entries}):eu(n),L(null),ek()}},[w,j,v,eu,U,ek]);let eR=(0,n.useMemo)(()=>(ex||[]).reduce((e,t)=>e+(t.total||0),0),[ex]),{totalPartnerPercentage:eD,alrawdatainSharePercentage:eV,alrawdatainShareAmount:eM,amountForPartners:ez,distributedToPartners:eT,remainderForPartners:eE}=(0,n.useMemo)(()=>{let e=eN.hasPartner?Number(eN.alrawdatainSharePercentage)||0:100,t=(eN.partners||[]).reduce((e,t)=>e+(Number(t.percentage)||0),0),r=e/100*eR,a=eR-r,n=(eN.partners||[]).reduce((e,t)=>e+a*((t.percentage||0)/100),0);return{totalPartnerPercentage:t,alrawdatainSharePercentage:e,alrawdatainShareAmount:r,amountForPartners:a,distributedToPartners:n,remainderForPartners:a-n}},[eR,eN.hasPartner,eN.alrawdatainSharePercentage,eN.partners]),e_=(0,n.useMemo)(()=>(Number(ee)||0)/100*ez,[ee,ez]),eO=async e=>{if(0===ex.length)return void N({title:"لا توجد سجلات للحفظ",variant:"destructive"});if(e.hasPartner&&Math.abs(eD-100)>.01)return void N({title:"خطأ في توزيع حصص الشركاء",description:"مجموع نسب الشركاء يجب أن يكون 100% تمامًا من المبلغ المتاح لهم. المجموع الحالي: ".concat(eD.toFixed(2),"%"),variant:"destructive"});Y(!0);try{let t=ex.map(t=>({...t,entryDate:(0,A.GP)(e.entryDate,"yyyy-MM-dd"),fromDate:(0,A.GP)(e.fromDate,"yyyy-MM-dd"),toDate:(0,A.GP)(e.toDate,"yyyy-MM-dd"),currency:e.currency,hasPartner:e.hasPartner,alrawdatainSharePercentage:e.alrawdatainSharePercentage,partnerShares:(e.partners||[]).map(e=>({partnerId:e.partnerId,partnerName:e.partnerName,partnerInvoiceNumber:e.partnerInvoiceNumber,share:t.partnerShare*(e.percentage/100)}))})),r=await (0,g.v)(t,j?null==v?void 0:v.periodId:void 0);if(!r.success)throw Error(r.error);N({title:"تم حفظ بيانات الفترة بنجاح"}),R(!1),await c()}catch(e){N({title:"خطأ",description:e.message||"لم يتم حفظ البيانات.",variant:"destructive"})}finally{Y(!1)}},eB=async()=>{var e;if(!X||!ee)return void N({title:"الرجاء تحديد الشريك والنسبة",variant:"destructive"});let t=Number(ee);if(isNaN(t)||t<=0)return void N({title:"النسبة يجب أن تكون رقمًا موجبًا",variant:"destructive"});let r=em("partners")||[],a=null!==er&&(null==(e=r[er])?void 0:e.percentage)||0,n=r.reduce((e,t)=>e+t.percentage,0)-a;if(n+t>100.01)return void N({title:"لا يمكن تجاوز 100%",description:"إجمالي النسب الحالية: ".concat(n.toFixed(2),"%"),variant:"destructive"});let s=ew.find(e=>e.value===X);if(!s)return void N({title:"الشريك المختار غير صالح",variant:"destructive"});let l=null!==er?eg[er].partnerInvoiceNumber:await B("PARTNER"),i={id:null!==er?eg[er].id:"new-".concat(Date.now()),partnerId:s.value.split("-")[1]||s.value,partnerName:s.label,partnerInvoiceNumber:l,percentage:t,amount:ez*t/100};null!==er?(eb(er,i),ea(null)):ej(i),Q(""),et("")},eY=eN.hasPartner&&Math.abs(eD-100)>.01;return(0,a.jsxs)(i.lG,{open:w,onOpenChange:R,children:[(0,a.jsx)(i.zM,{asChild:!0,children:b}),(0,a.jsxs)(i.Cf,{className:"sm:max-w-7xl max-h-[90vh] flex flex-col",children:[(0,a.jsx)(i.c7,{children:(0,a.jsx)(i.L3,{children:j?"تعديل سجل سكمنت":"إضافة سجل سكمنت جديد"})}),(0,a.jsx)(F.Op,{...en,children:(0,a.jsxs)("form",{onSubmit:el(eO),className:"flex flex-col flex-grow overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex-grow overflow-y-auto -mx-6 px-6 space-y-6 pb-4",children:[(0,a.jsxs)(_.Nt,{defaultOpen:!0,className:"p-4 border rounded-lg space-y-6 bg-background/50",children:[(0,a.jsx)(_.R6,{asChild:!0,children:(0,a.jsxs)("h3",{className:"font-semibold text-base cursor-pointer",children:["الفترة وتوزيع الحصص - فاتورة عامة: ",eN.periodInvoiceNumber]})}),(0,a.jsxs)(_.Ke,{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(0,a.jsx)(T.zB,{control:en.control,name:"fromDate",render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"من تاريخ"}),(0,a.jsx)(V.K,{date:t.value,setDate:t.onChange})]})}}),(0,a.jsx)(T.zB,{control:en.control,name:"toDate",render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"إلى تاريخ"}),(0,a.jsx)(V.K,{date:t.value,setDate:t.onChange})]})}}),(0,a.jsx)(T.zB,{control:en.control,name:"entryDate",render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"تاريخ الإضافة"}),(0,a.jsx)(V.K,{date:t.value,setDate:t.onChange})]})}}),(0,a.jsx)(T.zB,{control:en.control,name:"currency",render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{children:[(0,a.jsx)(T.lR,{children:"العملة"}),(0,a.jsxs)(o.l6,{onValueChange:t.onChange,value:t.value,children:[(0,a.jsx)(T.MJ,{children:(0,a.jsx)(o.bq,{children:(0,a.jsx)(o.yv,{})})}),(0,a.jsx)(o.gC,{children:eP.map(e=>(0,a.jsx)(o.eb,{value:e.code,children:e.name},e.code))})]})]})}})]}),(0,a.jsx)("div",{className:"pt-4 border-t mt-4",children:(0,a.jsxs)("div",{className:"space-y-5",children:[(0,a.jsx)("div",{className:"flex items-center justify-between border-b pb-2",children:(0,a.jsx)(T.zB,{control:en.control,name:"hasPartner",render:e=>{let{field:t}=e;return(0,a.jsxs)(T.eI,{className:"flex items-center gap-3",children:[(0,a.jsx)(T.lR,{className:"font-semibold text-base",children:"هل يوجد شركاء في الربح؟"}),(0,a.jsx)(T.MJ,{children:(0,a.jsx)(u.d,{checked:t.value,onCheckedChange:t.onChange})})]})}})}),eN.hasPartner&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[(0,a.jsx)(q,{title:"حصة الروضتين",value:eV,currency:"%",className:"bg-green-50 text-green-700 border-green-200"}),(0,a.jsx)(q,{title:"المتاح للشركاء",value:100-eV,currency:"%",className:"bg-blue-50 text-blue-700 border-blue-200"}),(0,a.jsx)(q,{title:"الموزع للشركاء",value:eD,currency:"%",className:"bg-amber-50 text-amber-700 border-amber-200"}),(0,a.jsx)(q,{title:"المتبقي للتوزيع",value:100-eD,currency:"%",className:(0,m.cn)("border",Math.abs(100-eD)>.01?"bg-red-50 text-red-700 border-red-300":"bg-gray-50 text-gray-600 border-gray-200")})]}),(0,a.jsxs)("div",{className:"p-3 border rounded-lg bg-muted/10 space-y-3",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3 items-end",children:[(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsx)(d.J,{children:"نسبة الروضتين (%)"}),(0,a.jsx)(F.xI,{control:en.control,name:"alrawdatainSharePercentage",render:e=>{let{field:t}=e;return(0,a.jsx)(h.O,{...t,onValueChange:e=>t.onChange(e||0),className:"h-9 text-center"})}})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsx)(d.J,{children:"الشريك"}),(0,a.jsx)(f.j,{options:ew,value:X,onValueChange:Q,placeholder:"اختر الشريك..."})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsx)(d.J,{children:"النسبة (%)"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(h.O,{value:ee,onValueChange:et,className:"h-9 pe-7 text-center"}),(0,a.jsx)(I.A,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"})]})]}),(0,a.jsx)(l.$,{type:"button",onClick:eB,className:"h-9 w-full md:w-auto",children:null!==er?"تحديث":"إضافة"})]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground text-end",children:["الحصة المحسوبة: ",(0,a.jsx)("span",{className:"font-bold text-blue-600 font-mono ms-1",children:e_.toFixed(2)})]})]}),(0,a.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,a.jsxs)(M.XI,{children:[(0,a.jsx)(M.A0,{className:"bg-muted/30",children:(0,a.jsxs)(M.Hj,{children:[(0,a.jsx)(M.nd,{children:"فاتورة الشريك"}),(0,a.jsx)(M.nd,{children:"الشريك"}),(0,a.jsx)(M.nd,{className:"text-center",children:"النسبة"}),(0,a.jsx)(M.nd,{className:"w-24 text-center",children:"الإجراءات"})]})}),(0,a.jsx)(M.BF,{children:0===eg.length?(0,a.jsx)(M.Hj,{children:(0,a.jsx)(M.nA,{colSpan:4,className:"text-center text-muted-foreground py-4",children:"لا يوجد شركاء مضافون بعد"})}):eg.map((e,t)=>(0,a.jsxs)(M.Hj,{children:[(0,a.jsx)(M.nA,{className:"font-mono",children:e.partnerInvoiceNumber}),(0,a.jsx)(M.nA,{children:e.partnerName}),(0,a.jsxs)(M.nA,{className:"text-center font-mono",children:[Number(e.percentage).toFixed(2),"%"]}),(0,a.jsxs)(M.nA,{className:"text-center",children:[(0,a.jsx)(l.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",onClick:()=>(e=>{var t;let r=eg[e];ea(e),Q((null==(t=ew.find(e=>e.value.endsWith(r.partnerId)))?void 0:t.value)||""),et(r.percentage)})(t),children:(0,a.jsx)(y.A,{className:"h-4 w-4"})}),(0,a.jsx)(l.$,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>ev(t),children:(0,a.jsx)(P.A,{className:"h-4 w-4"})})]})]},e.id))})]})})]})]})})]})]}),(0,a.jsx)("div",{className:(0,m.cn)(eY&&"opacity-50 pointer-events-none"),children:(0,a.jsx)(W,{ref:Z,onAdd:e=>{var t;if(J){let t=ex.findIndex(e=>e.id===J.id);t>-1&&ef(t,{...ex[t],...e,id:ex[t].id}),L(null)}else ep({...e,id:(0,s.A)(),createdBy:null==K?void 0:K.name});null==(t=Z.current)||t.resetForm()},editingEntry:J,onCancelEdit:()=>L(null),allCompanyOptions:ey,partnerOptions:ew})}),(0,a.jsx)("div",{className:(0,m.cn)(eY&&"opacity-50 pointer-events-none"),children:(0,a.jsx)($,{onRemove:e=>eh(e),onEdit:e=>L(ex[e])})})]}),(0,a.jsxs)(i.Es,{className:"pt-4 border-t flex-row items-center justify-between sticky bottom-0 bg-background mt-auto",children:[(0,a.jsxs)("div",{className:"flex flex-wrap gap-x-4 gap-y-2 text-xs text-muted-foreground",children:[(0,a.jsx)(q,{title:"إجمالي الربح",value:eR,currency:eN.currency}),(0,a.jsx)(q,{title:"حصة الروضتين",value:eM,currency:eN.currency,className:"text-green-600"}),(0,a.jsx)(q,{title:"حصة الشركاء",value:ez,currency:eN.currency,className:"text-blue-600"}),(0,a.jsx)(q,{title:"المتبقي",value:eE,currency:eN.currency,className:(0,m.cn)(Math.abs(eE)>.01&&"text-destructive")})]}),(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsxs)(l.$,{type:"submit",disabled:O||0===ex.length,children:[O&&(0,a.jsx)(S.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,a.jsx)(C.A,{className:"me-2 h-4 w-4"}),"حفظ بيانات الفترة (",ex.length," سجلات)"]})})]})]})})]})]})}},49507:(e,t,r)=>{r.d(t,{v:()=>n});var a=r(30926);let n=(0,a.createServerReference)("60e78d426fd8219914cf72d1a693001c780eb7a14f",a.callServer,void 0,a.findSourceMapURL,"addSegmentEntries")}}]);