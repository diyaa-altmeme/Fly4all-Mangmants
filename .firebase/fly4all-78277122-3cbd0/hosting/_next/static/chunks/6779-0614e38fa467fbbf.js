"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6779],{1402:(e,a,n)=>{n.d(a,{A:()=>k});var l=n(95155),r=n(12115),s=n(3998),t=n(51834),i=n(22452),c=n(92033),d=n(73180),o=n(11929),m=n(15894),u=n(28127),x=n(88964),h=n(13630),g=n(87270),j=n(65142),p=n(11186),y=n(97916),v=n(30926);let N=(0,v.createServerReference)("7003bafa516cae88838b2870c227bb8f7b1ef595ec",v.callServer,void 0,v.findSourceMapURL,"savePayments");var f=n(86948),b=n(76444),S=n(11647),C=n(64269),A=n(5470),w=n(26333),D=n(50276),U=n(14223);let I="lastPaymentExchangeRate",E=(0,r.forwardRef)((e,a)=>{var n,t,c,v,E,J;let{exchangeId:k,exchanges:M,onSuccess:O,isEditing:R=!1,initialData:F=[],batchId:T,onStagedEntriesChange:$,onSummaryChange:V}=e,{data:L}=(0,A.Z)(),{toast:Z}=(0,m.dj)(),[z,H]=(0,r.useState)([]),[P,B]=(0,r.useState)(null),[G,W]=(0,r.useState)(k),_=(null==L||null==(t=L.settings)||null==(n=t.currencySettings)?void 0:n.defaultCurrency)||"USD",q={paidTo:"",type:"payment",intermediary:"",originalCurrency:_,originalAmount:"",rate:(null==L||null==(v=L.settings)||null==(c=v.currencySettings)?void 0:c.exchangeRates.USD_IQD)||1,date:new Date().toISOString().slice(0,10),note:""},[Q,X]=(0,r.useState)(q),[K,Y]=(0,r.useState)(!1),[ee,ea]=(0,r.useState)(!1);(0,r.useEffect)(()=>{$(z.length)},[z,$]);let en=(0,r.useMemo)(()=>z.reduce((e,a)=>{let n=a.originalCurrency,l=Number(a.originalAmount)||0,r="payment"===a.type?l:-l,s="USD"===a.originalCurrency?r:r/(Number(a.rate)||1);return e[n]||(e[n]=0),e[n]+=r,e.totalUSD=(e.totalUSD||0)+s,e},{}),[z]);(0,r.useEffect)(()=>{V(en)},[en,V]),(0,r.useEffect)(()=>{let e=localStorage.getItem(I);e&&X(a=>({...a,rate:parseFloat(e)}))},[]),(0,r.useEffect)(()=>{if(R){var e;H(F.map(e=>({id:e.id||(0,o.A)(),paidTo:e.paidTo||"",type:e.type||"payment",intermediary:e.intermediary||"",originalCurrency:e.originalCurrency||_,originalAmount:e.originalAmount||"",rate:e.rate||1,date:e.date||new Date().toISOString().slice(0,10),note:e.note||""}))),W((null==(e=F[0])?void 0:e.exchangeId)||k)}},[R,F,_,k]);let el=(e,a)=>{X(n=>({...n,[e]:a}))},er=async()=>{if(!G)return Z({title:"اختر بورصة أولاً",variant:"destructive"}),null;if(0===z.length)return null;Y(!0);try{let e=z.map(e=>({paidTo:e.paidTo,type:e.type,intermediary:e.intermediary,originalCurrency:e.originalCurrency,originalAmount:Number(e.originalAmount),rate:Number(e.rate)||1,date:e.date,note:e.note})),a=await N(G,e,T);if(!a.success||!a.batch)throw Error(a.error);return Z({title:"تم ".concat(R?"تحديث":"حفظ"," التسديدات بنجاح")}),H([]),a.batch}catch(e){return Z({title:"خطأ",description:e.message,variant:"destructive"}),null}finally{Y(!1)}};(0,r.useImperativeHandle)(a,()=>({handleSave:er,isSaving:K,summary:en}));let es="USD"===Q.originalCurrency?Number(Q.originalAmount):Number(Q.originalAmount)/(Number(Q.rate)||1),et=(null==L||null==(J=L.settings)||null==(E=J.currencySettings)?void 0:E.currencies)||[];return(0,l.jsxs)("div",{className:"h-full flex flex-col gap-4",children:[(0,l.jsxs)(f.Zp,{children:[(0,l.jsx)(f.aR,{children:(0,l.jsx)(f.ZB,{className:"text-lg",children:P?"تعديل تسديد":"إضافة تسديد جديد للقائمة"})}),(0,l.jsxs)(f.Wu,{className:"space-y-3",children:[R&&(0,l.jsxs)("div",{className:"space-y-1.5 max-w-sm",children:[(0,l.jsx)(b.J,{children:"تغيير البورصة"}),(0,l.jsxs)(p.l6,{value:G,onValueChange:W,children:[(0,l.jsx)(p.bq,{children:(0,l.jsx)(p.yv,{placeholder:"اختر بورصة..."})}),(0,l.jsx)(p.gC,{children:M.map(e=>(0,l.jsx)(p.eb,{value:e.id,children:e.name},e.id))})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-end",children:[(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"نوع الدفعة"}),(0,l.jsxs)(p.l6,{value:Q.type,onValueChange:e=>el("type",e),children:[(0,l.jsx)(p.bq,{children:(0,l.jsx)(p.yv,{})}),(0,l.jsxs)(p.gC,{children:[(0,l.jsx)(p.eb,{value:"payment",children:"تسديد (لنا)"}),(0,l.jsx)(p.eb,{value:"receipt",children:"قبض (علينا)"})]})]})]}),(0,l.jsxs)("div",{className:"md:col-span-3 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"payment"===Q.type?"تم التسديد إلى":"تم القبض من"}),(0,l.jsx)(j.p,{placeholder:"الطرف...",value:Q.paidTo,onChange:e=>el("paidTo",e.target.value)})]}),(0,l.jsxs)("div",{className:"md:col-span-3 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"الوسيط"}),(0,l.jsx)(j.p,{placeholder:"الوسيط",value:Q.intermediary,onChange:e=>el("intermediary",e.target.value)})]}),(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"العملة"}),(0,l.jsxs)(p.l6,{value:Q.originalCurrency,onValueChange:e=>el("originalCurrency",e),children:[(0,l.jsx)(p.bq,{children:(0,l.jsx)(p.yv,{})}),(0,l.jsx)(p.gC,{children:et.map(e=>(0,l.jsx)(p.eb,{value:e.code,children:e.code},e.code))})]})]}),(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"payment"===Q.type?"المبلغ المدفوع":"المبلغ المستلم"}),(0,l.jsx)(y.O,{placeholder:"المبلغ",value:Q.originalAmount,onValueChange:e=>el("originalAmount",e||"")})]}),(0,l.jsxs)("div",{className:(0,C.cn)("md:col-span-2 space-y-1.5","USD"===Q.originalCurrency&&"invisible"),children:[(0,l.jsx)(b.J,{children:"سعر الصرف"}),(0,l.jsx)(y.O,{placeholder:"سعر الصرف",value:Q.rate,onValueChange:e=>el("rate",e||"")})]}),"USD"!==Q.originalCurrency&&(0,l.jsxs)("div",{className:"md:col-span-3 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"المعادل بالدولار"}),(0,l.jsx)(j.p,{value:es.toFixed(2),readOnly:!0,disabled:!0,className:"font-mono text-right"})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[2fr,1fr,100px] gap-3 items-end",children:[(0,l.jsxs)("div",{className:"space-y-1.5",children:[(0,l.jsx)(b.J,{children:"ملاحظة"}),(0,l.jsx)(j.p,{placeholder:"ملاحظة",value:Q.note,onChange:e=>el("note",e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-1.5",children:[(0,l.jsx)(b.J,{children:"التاريخ"}),(0,l.jsxs)(w.AM,{open:ee,onOpenChange:ea,children:[(0,l.jsx)(w.Wv,{asChild:!0,children:(0,l.jsxs)(s.$,{variant:"outline",className:(0,C.cn)("w-full justify-start text-left font-normal",!Q.date&&"text-muted-foreground"),children:[Q.date?(0,U.GP)(new Date(Q.date),"yyyy-MM-dd"):(0,l.jsx)("span",{children:"اختر تاريخ"}),(0,l.jsx)(u.A,{className:"ms-auto h-4 w-4 opacity-50"})]})}),(0,l.jsx)(w.hl,{className:"w-auto p-0",align:"start",children:(0,l.jsx)(D.V,{mode:"single",selected:new Date(Q.date),onSelect:e=>{e&&el("date",(0,U.GP)(e,"yyyy-MM-dd")),ea(!1)}})})]})]}),(0,l.jsxs)(s.$,{onClick:()=>{if(!Q.paidTo||!Q.originalAmount)return void Z({title:"بيانات ناقصة",description:"الرجاء إدخال الطرف والمبلغ.",variant:"destructive"});P?(H(e=>e.map(e=>e.id===P?{...Q,id:P}:e)),B(null),Z({title:"تم تحديث التسديد"})):H(e=>[...e,{id:(0,o.A)(),...Q}]),Q.rate&&localStorage.setItem(I,String(Q.rate)),X({...q,rate:Q.rate,date:Q.date})},className:"w-full",children:[P?(0,l.jsx)(d.A,{className:"me-2 h-4 w-4"}):(0,l.jsx)(i.A,{className:"me-2 h-4 w-4"}),P?"تحديث":"إضافة"]})]})]})]}),(0,l.jsxs)(f.Zp,{className:"flex-grow flex flex-col",children:[(0,l.jsx)(f.aR,{children:(0,l.jsxs)(f.ZB,{className:"text-lg",children:["التسديدات المضافة (",z.length,")"]})}),(0,l.jsx)(f.Wu,{className:"flex-grow overflow-y-auto",children:(0,l.jsx)("div",{className:"border rounded-md",children:(0,l.jsxs)(g.XI,{children:[(0,l.jsx)(g.A0,{children:(0,l.jsxs)(g.Hj,{children:[(0,l.jsx)(g.nd,{className:"w-[80px]",children:"النوع"}),(0,l.jsx)(g.nd,{children:"الطرف"}),(0,l.jsx)(g.nd,{children:"الوسيط"}),(0,l.jsx)(g.nd,{children:"المبلغ الأصلي"}),(0,l.jsx)(g.nd,{children:"سعر الصرف"}),(0,l.jsx)(g.nd,{children:"المعادل بالدولار"}),(0,l.jsx)(g.nd,{children:"التاريخ"}),(0,l.jsx)(g.nd,{children:"ملاحظات"}),(0,l.jsx)(g.nd,{className:"w-24 text-center",children:"الإجراءات"})]})}),(0,l.jsxs)(g.BF,{children:[0===z.length&&(0,l.jsx)(g.Hj,{children:(0,l.jsx)(g.nA,{colSpan:9,className:"h-24 text-center",children:"لم تتم إضافة أي تسديدات بعد."})}),z.map(e=>{let a="USD"===e.originalCurrency?Number(e.originalAmount):Number(e.originalAmount)/(Number(e.rate)||1),n="receipt"===e.type?-a:a;return(0,l.jsxs)(g.Hj,{className:(0,C.cn)("bg-background",P===e.id&&"bg-primary/10"),children:[(0,l.jsx)(g.nA,{children:(0,l.jsx)(S.E,{variant:"receipt"===e.type?"default":"destructive",className:(0,C.cn)("payment"===e.type?"bg-blue-500":"bg-green-500"),children:"receipt"===e.type?"قبض":"دفع"})}),(0,l.jsx)(g.nA,{className:"font-semibold",children:e.paidTo}),(0,l.jsx)(g.nA,{children:e.intermediary}),(0,l.jsxs)(g.nA,{className:"font-mono text-right",children:[Number(e.originalAmount).toLocaleString()," ",e.originalCurrency]}),(0,l.jsx)(g.nA,{className:"font-mono text-right",children:"USD"!==e.originalCurrency?e.rate:"-"}),(0,l.jsxs)(g.nA,{className:"font-mono font-bold text-right",children:[n.toFixed(2)," USD"]}),(0,l.jsx)(g.nA,{children:e.date}),(0,l.jsx)(g.nA,{children:e.note}),(0,l.jsxs)(g.nA,{className:"text-center",children:[(0,l.jsx)(s.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",onClick:()=>(e=>{B(e.id),X({paidTo:e.paidTo,type:e.type,intermediary:e.intermediary,originalCurrency:e.originalCurrency,originalAmount:e.originalAmount,rate:e.rate,date:e.date,note:e.note})})(e),children:(0,l.jsx)(x.A,{className:"h-4 w-4"})}),(0,l.jsx)(s.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>{var a;return a=e.id,void H(e=>e.filter(e=>e.id!==a))},children:(0,l.jsx)(h.A,{className:"h-4 w-4"})})]})]},e.id)})]})]})})})]})]})});E.displayName="AddPaymentsForm";var J=n(20583);function k(e){var a,n;let{exchangeId:o,exchanges:u,onSuccess:x,isEditing:h=!1,initialData:g,children:j}=e,[p,y]=(0,r.useState)(!1),{themeSettings:v}=(0,J.A)(),{toast:N}=(0,m.dj)(),f=r.useRef(null),[b,S]=(0,r.useState)(0),[C,A]=(0,r.useState)({}),w=(null==v||null==(a=v.light)?void 0:a.accent)?"hsl(".concat(v.light.accent,")"):"hsl(var(--accent))",D=async()=>{if(f.current){y(!1),N({title:"جاري ".concat(h?"تحديث":"حفظ"," التسديدات...")});let e=await f.current.handleSave();e&&x(e)}},U=(null==(n=f.current)?void 0:n.isSaving)||!1;return(0,l.jsxs)(t.lG,{open:p,onOpenChange:y,children:[(0,l.jsx)(t.zM,{asChild:!0,children:j||(0,l.jsxs)(s.$,{variant:"secondary",children:[(0,l.jsx)(i.A,{className:"me-2 h-4 w-4"}),"إضافة تسديد"]})}),(0,l.jsxs)(t.Cf,{className:"max-w-6xl h-[90vh] flex flex-col p-0",children:[(0,l.jsx)(t.c7,{className:"p-4 rounded-t-lg",style:{backgroundColor:w,color:"white"},children:(0,l.jsx)(t.L3,{className:"text-white",children:h?"تعديل دفعة التسديد: ".concat(null==g?void 0:g.invoiceNumber):"إدخال تسديدات جديدة للبورصة"})}),(0,l.jsx)("div",{className:"flex-grow overflow-y-auto px-2 sm:px-6 py-2",children:(0,l.jsx)(E,{ref:f,exchangeId:o,exchanges:u,onSuccess:e=>{x(e),y(!1)},isEditing:h,initialData:(null==g?void 0:g.details)||[],batchId:null==g?void 0:g.id,onStagedEntriesChange:S,onSummaryChange:A})}),(0,l.jsxs)(t.Es,{className:"p-2 sm:p-4 border-t flex-col sm:flex-row justify-between items-center bg-background",children:[(0,l.jsx)("div",{className:"flex-grow w-full",children:b>0&&(0,l.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,l.jsx)("h4",{className:"font-semibold text-sm",children:"الملخص:"}),Object.entries(C).filter(e=>{let[a]=e;return"totalUSD"!==a}).map(e=>{let[a,n]=e;return(0,l.jsxs)("div",{className:"p-2 bg-muted rounded-md text-center",children:[(0,l.jsxs)("p",{className:"text-xs text-muted-foreground",children:["مجموع ",a]}),(0,l.jsx)("p",{className:"font-mono font-bold text-xs",children:Number(n).toLocaleString()})]},a)}),(0,l.jsxs)("div",{className:"p-2 bg-primary/10 rounded-md text-center border border-primary/50",children:[(0,l.jsx)("p",{className:"text-xs text-primary font-bold",children:"الإجمالي المعادل"}),(0,l.jsxs)("p",{className:"font-mono font-bold text-primary text-sm",children:[(C.totalUSD||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]})}),(0,l.jsxs)(s.$,{onClick:D,disabled:U||0===b,className:"w-full sm:w-auto",size:"lg",children:[U&&(0,l.jsx)(c.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,l.jsx)(d.A,{className:"me-2 h-4 w-4"}),h?"حفظ كل التعديلات":"حفظ (".concat(b,") تسديدات")]})]})]})]})}},98090:(e,a,n)=>{n.d(a,{A:()=>k});var l=n(95155),r=n(12115),s=n(3998),t=n(51834),i=n(22452),c=n(92033),d=n(73180),o=n(11929),m=n(15894),u=n(28127),x=n(88964),h=n(13630),g=n(87270),j=n(65142),p=n(11186),y=n(97916),v=n(30926);let N=(0,v.createServerReference)("704baf0749912d6e636a66524e43f80ce5c8454d38",v.callServer,void 0,v.findSourceMapURL,"saveTransactions");var f=n(86948),b=n(76444),S=n(64269),C=n(5470),A=n(26333),w=n(50276),D=n(14223);let U="lastExchangeRate",I="lastExchangeCurrency",E=(0,r.forwardRef)((e,a)=>{var n,t,c,v;let{exchangeId:E,exchanges:J,onSuccess:k,isEditing:M=!1,initialData:O=[],batchId:R,onStagedEntriesChange:F,onSummaryChange:T}=e,{data:$}=(0,C.Z)(),{toast:V}=(0,m.dj)(),[L,Z]=(0,r.useState)([]),[z,H]=(0,r.useState)(null),[P,B]=(0,r.useState)(E),G=(null==$||null==(t=$.settings)||null==(n=t.currencySettings)?void 0:n.defaultCurrency)||"USD",W=()=>{var e,a;return{partyName:"",originalCurrency:localStorage.getItem(I)||G,originalAmount:"",rate:parseFloat(localStorage.getItem(U)||String((null==$||null==(a=$.settings)||null==(e=a.currencySettings)?void 0:e.exchangeRates.USD_IQD)||1)),date:new Date().toISOString().slice(0,10),note:""}},[_,q]=(0,r.useState)(W()),[Q,X]=(0,r.useState)(!1),[K,Y]=(0,r.useState)(!1);(0,r.useEffect)(()=>{F(L.length)},[L,F]);let ee=(0,r.useMemo)(()=>L.reduce((e,a)=>{let n=a.originalCurrency,l=-(Number(a.originalAmount)||0),r="USD"===a.originalCurrency?l:l/(Number(a.rate)||1);return e[n]||(e[n]=0),e[n]+=l,e.totalUSD=(e.totalUSD||0)+r,e},{}),[L]);(0,r.useEffect)(()=>{T(ee)},[ee,T]),(0,r.useEffect)(()=>{if(M){var e;Z(O.map(e=>({id:e.id||(0,o.A)(),partyName:e.partyName||"",originalCurrency:e.originalCurrency||G,originalAmount:e.originalAmount||"",rate:e.rate||1,date:e.date||new Date().toISOString().slice(0,10),note:e.note||""}))),B((null==(e=O[0])?void 0:e.exchangeId)||E)}},[M,O,G,E]);let ea=(e,a)=>{q(n=>({...n,[e]:a}))},en=async()=>{if(!P)return V({title:"اختر بورصة أولاً",variant:"destructive"}),null;if(0===L.length)return null;X(!0);try{let e=L.map(e=>({partyName:e.partyName,originalCurrency:e.originalCurrency,originalAmount:Number(e.originalAmount),rate:Number(e.rate)||1,date:e.date,note:e.note})),a=await N(P,e,R);if(!a.success||!a.batch)throw Error(a.error);return V({title:"تم ".concat(M?"تحديث":"حفظ"," المعاملات بنجاح")}),Z([]),a.batch}catch(e){return V({title:"خطأ",description:e.message,variant:"destructive"}),null}finally{X(!1)}};(0,r.useImperativeHandle)(a,()=>({handleSave:en,isSaving:Q,summary:ee}));let el="USD"===_.originalCurrency?Number(_.originalAmount):Number(_.originalAmount)/(Number(_.rate)||1),er=(null==$||null==(v=$.settings)||null==(c=v.currencySettings)?void 0:c.currencies)||[];return(0,l.jsxs)("div",{className:"h-full flex flex-col gap-4",children:[(0,l.jsxs)(f.Zp,{children:[(0,l.jsx)(f.aR,{children:(0,l.jsx)(f.ZB,{className:"text-lg",children:z?"تعديل معاملة":"إضافة معاملة جديدة للقائمة"})}),(0,l.jsxs)(f.Wu,{className:"space-y-3",children:[M&&(0,l.jsxs)("div",{className:"space-y-1.5 max-w-sm",children:[(0,l.jsx)(b.J,{children:"تغيير البورصة"}),(0,l.jsxs)(p.l6,{value:P,onValueChange:B,children:[(0,l.jsx)(p.bq,{children:(0,l.jsx)(p.yv,{placeholder:"اختر بورصة..."})}),(0,l.jsx)(p.gC,{children:J.map(e=>(0,l.jsx)(p.eb,{value:e.id,children:e.name},e.id))})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-4 items-end",children:[(0,l.jsxs)("div",{className:"md:col-span-4 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"الطرف"}),(0,l.jsx)(j.p,{placeholder:"الطرف الآخر في المعاملة",value:_.partyName,onChange:e=>ea("partyName",e.target.value)})]}),(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"العملة"}),(0,l.jsxs)(p.l6,{value:_.originalCurrency,onValueChange:e=>ea("originalCurrency",e),children:[(0,l.jsx)(p.bq,{children:(0,l.jsx)(p.yv,{})}),(0,l.jsx)(p.gC,{children:er.map(e=>(0,l.jsx)(p.eb,{value:e.code,children:e.code},e.code))})]})]}),(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"المبلغ"}),(0,l.jsx)(y.O,{placeholder:"المبلغ",value:_.originalAmount,onValueChange:e=>ea("originalAmount",e||"")})]}),(0,l.jsxs)("div",{className:(0,S.cn)("md:col-span-2 space-y-1.5","USD"===_.originalCurrency&&"invisible"),children:[(0,l.jsx)(b.J,{children:"سعر الصرف"}),(0,l.jsx)(y.O,{placeholder:"سعر الصرف",value:_.rate,onValueChange:e=>ea("rate",e||"")})]}),"USD"!==_.originalCurrency&&(0,l.jsxs)("div",{className:"md:col-span-2 space-y-1.5",children:[(0,l.jsx)(b.J,{children:"المعادل بالدولار"}),(0,l.jsx)(j.p,{value:el.toFixed(2),readOnly:!0,disabled:!0,className:"font-mono text-right"})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[2fr,1fr,100px] gap-3 items-end",children:[(0,l.jsxs)("div",{className:"space-y-1.5",children:[(0,l.jsx)(b.J,{children:"ملاحظة"}),(0,l.jsx)(j.p,{placeholder:"ملاحظة",value:_.note,onChange:e=>ea("note",e.target.value)})]}),(0,l.jsxs)("div",{className:"space-y-1.5",children:[(0,l.jsx)(b.J,{children:"التاريخ"}),(0,l.jsxs)(A.AM,{open:K,onOpenChange:Y,children:[(0,l.jsx)(A.Wv,{asChild:!0,children:(0,l.jsxs)(s.$,{variant:"outline",className:(0,S.cn)("w-full justify-start text-left font-normal",!_.date&&"text-muted-foreground"),children:[_.date?(0,D.GP)(new Date(_.date),"yyyy-MM-dd"):(0,l.jsx)("span",{children:"اختر تاريخ"}),(0,l.jsx)(u.A,{className:"ms-auto h-4 w-4 opacity-50"})]})}),(0,l.jsx)(A.hl,{className:"w-auto p-0",align:"start",children:(0,l.jsx)(w.V,{mode:"single",selected:new Date(_.date),onSelect:e=>{e&&ea("date",(0,D.GP)(e,"yyyy-MM-dd")),Y(!1)}})})]})]}),(0,l.jsxs)(s.$,{onClick:()=>{if(!_.partyName||!_.originalAmount)return void V({title:"بيانات ناقصة",description:"الرجاء إدخال اسم الطرف والمبلغ.",variant:"destructive"});z?(Z(e=>e.map(e=>e.id===z?{..._,id:z}:e)),H(null),V({title:"تم تحديث المعاملة"})):Z(e=>[...e,{id:(0,o.A)(),..._}]),_.rate&&localStorage.setItem(U,String(_.rate)),_.originalCurrency&&localStorage.setItem(I,_.originalCurrency),q(e=>({...W(),rate:e.rate,date:e.date,originalCurrency:e.originalCurrency}))},className:"w-full",children:[z?(0,l.jsx)(d.A,{className:"me-2 h-4 w-4"}):(0,l.jsx)(i.A,{className:"me-2 h-4 w-4"}),z?"تحديث":"إضافة"]})]})]})]}),(0,l.jsxs)(f.Zp,{className:"flex-grow flex flex-col",children:[(0,l.jsx)(f.aR,{children:(0,l.jsxs)(f.ZB,{className:"text-lg",children:["المعاملات المضافة (",L.length,")"]})}),(0,l.jsx)(f.Wu,{className:"flex-grow overflow-y-auto",children:(0,l.jsx)("div",{className:"border rounded-md",children:(0,l.jsxs)(g.XI,{children:[(0,l.jsx)(g.A0,{children:(0,l.jsxs)(g.Hj,{children:[(0,l.jsx)(g.nd,{children:"الطرف"}),(0,l.jsx)(g.nd,{children:"المبلغ الأصلي"}),(0,l.jsx)(g.nd,{children:"سعر الصرف"}),(0,l.jsx)(g.nd,{children:"المعادل بالدولار"}),(0,l.jsx)(g.nd,{children:"التاريخ"}),(0,l.jsx)(g.nd,{children:"ملاحظات"}),(0,l.jsx)(g.nd,{className:"w-24 text-center",children:"الإجراءات"})]})}),(0,l.jsxs)(g.BF,{children:[0===L.length&&(0,l.jsx)(g.Hj,{children:(0,l.jsx)(g.nA,{colSpan:7,className:"h-24 text-center",children:"لم تتم إضافة أي معاملات بعد."})}),L.map(e=>{let a="USD"===e.originalCurrency?Number(e.originalAmount):Number(e.originalAmount)/(Number(e.rate)||1);return(0,l.jsxs)(g.Hj,{className:(0,S.cn)(z===e.id&&"bg-primary/10"),children:[(0,l.jsx)(g.nA,{className:"font-semibold",children:e.partyName}),(0,l.jsxs)(g.nA,{className:"font-mono text-right",children:[Number(e.originalAmount).toLocaleString()," ",e.originalCurrency]}),(0,l.jsx)(g.nA,{className:"font-mono text-right",children:"USD"!==e.originalCurrency?e.rate:"-"}),(0,l.jsxs)(g.nA,{className:"font-mono font-bold text-right",children:[(-a).toFixed(2)," USD"]}),(0,l.jsx)(g.nA,{children:e.date}),(0,l.jsx)(g.nA,{children:e.note}),(0,l.jsxs)(g.nA,{className:"text-center",children:[(0,l.jsx)(s.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-blue-600",onClick:()=>(e=>{H(e.id),q({partyName:e.partyName,originalCurrency:e.originalCurrency,originalAmount:e.originalAmount,rate:e.rate,date:e.date,note:e.note})})(e),children:(0,l.jsx)(x.A,{className:"h-4 w-4"})}),(0,l.jsx)(s.$,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive",onClick:()=>{var a;return a=e.id,void Z(e=>e.filter(e=>e.id!==a))},children:(0,l.jsx)(h.A,{className:"h-4 w-4"})})]})]},e.id)})]})]})})})]})]})});E.displayName="AddTransactionsForm";var J=n(20583);function k(e){var a,n;let{exchangeId:o,exchanges:u,onSuccess:x,isEditing:h=!1,initialData:g,children:j}=e,[p,y]=(0,r.useState)(!1),{themeSettings:v}=(0,J.A)(),{toast:N}=(0,m.dj)(),f=r.useRef(null),[b,S]=(0,r.useState)(0),[C,A]=(0,r.useState)({}),w=(null==v||null==(a=v.light)?void 0:a.primary)?"hsl(".concat(v.light.primary,")"):"hsl(var(--primary))",D=async()=>{if(f.current){y(!1),N({title:"جاري ".concat(h?"تحديث":"حفظ"," المعاملات...")});let e=await f.current.handleSave();e&&x(e)}},U=(null==(n=f.current)?void 0:n.isSaving)||!1;return(0,l.jsxs)(t.lG,{open:p,onOpenChange:y,children:[(0,l.jsx)(t.zM,{asChild:!0,children:j||(0,l.jsxs)(s.$,{children:[(0,l.jsx)(i.A,{className:"me-2 h-4 w-4"}),"إضافة معاملة"]})}),(0,l.jsxs)(t.Cf,{className:"max-w-6xl h-[90vh] flex flex-col p-0",children:[(0,l.jsx)(t.c7,{className:"p-4 rounded-t-lg",style:{backgroundColor:w,color:"white"},children:(0,l.jsx)(t.L3,{className:"text-white",children:h?"تعديل دفعة المعاملات: ".concat(null==g?void 0:g.invoiceNumber):"إدخال معاملات جديدة للبورصة"})}),(0,l.jsx)("div",{className:"flex-grow overflow-y-auto px-2 sm:px-6 py-2",children:(0,l.jsx)(E,{ref:f,exchangeId:o,exchanges:u,onSuccess:e=>{x(e),y(!1)},isEditing:h,initialData:(null==g?void 0:g.details)||[],batchId:null==g?void 0:g.id,onStagedEntriesChange:S,onSummaryChange:A})}),(0,l.jsxs)(t.Es,{className:"p-2 sm:p-4 border-t flex-col sm:flex-row justify-between items-center bg-background",children:[(0,l.jsx)("div",{className:"flex-grow w-full",children:b>0&&(0,l.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,l.jsx)("h4",{className:"font-semibold text-sm",children:"الملخص:"}),Object.entries(C).filter(e=>{let[a]=e;return"totalUSD"!==a}).map(e=>{let[a,n]=e;return(0,l.jsxs)("div",{className:"p-2 bg-muted rounded-md text-center",children:[(0,l.jsxs)("p",{className:"text-xs text-muted-foreground",children:["مجموع ",a]}),(0,l.jsx)("p",{className:"font-mono font-bold text-xs",children:Number(n).toLocaleString()})]},a)}),(0,l.jsxs)("div",{className:"p-2 bg-primary/10 rounded-md text-center border border-primary/50",children:[(0,l.jsx)("p",{className:"text-xs text-primary font-bold",children:"الإجمالي المعادل"}),(0,l.jsxs)("p",{className:"font-mono font-bold text-primary text-sm",children:[(C.totalUSD||0).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," USD"]})]})]})}),(0,l.jsxs)(s.$,{onClick:D,disabled:U||0===b,className:"w-full sm:w-auto",size:"lg",children:[U&&(0,l.jsx)(c.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,l.jsx)(d.A,{className:"me-2 h-4 w-4"}),h?"حفظ كل التعديلات":"حفظ (".concat(b,") معاملات")]})]})]})]})}}}]);