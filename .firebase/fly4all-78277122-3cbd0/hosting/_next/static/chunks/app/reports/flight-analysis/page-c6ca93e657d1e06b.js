(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[670],{5470:(e,s,t)=>{"use strict";t.d(s,{Z:()=>h,z:()=>m});var n=t(95155),a=t(12115),r=t(9012),l=t(80187),i=t(35656),d=t(96133),c=t(23451),o=t(75660);let x=(0,a.createContext)({data:null,loaded:!1,fetchData:async()=>{},refreshData:async()=>{}}),m=e=>{let{children:s}=e,[t,m]=(0,a.useState)(null),[h,u]=(0,a.useState)(!1),[p,j]=(0,a.useState)(!1),{user:f,loading:g}=(0,c.A)(),N=(0,a.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!p&&(!h||e)){j(!0);try{let[e,s,t,n,a]=await Promise.all([(0,r.L)({all:!0,includeInactive:!1,relationType:"all"}),(0,l.c)(),(0,i.l)({all:!0}),(0,d.m)(),(0,o.r)()]),c=e.clients,x=c.filter(e=>"client"===e.relationType||"both"===e.relationType),h=c.filter(e=>"supplier"===e.relationType||"both"===e.relationType),p=a.accounts||[];m({clients:x,suppliers:h,boxes:s,users:t,exchanges:p,settings:n}),u(!0)}catch(e){console.error("Failed to load initial voucher navigation data:",e)}finally{j(!1)}}},[p,h]);(0,a.useEffect)(()=>{g||!f||"isClient"in f&&f.isClient||N()},[f,g,N]);let v=(0,a.useCallback)(async()=>{await N(!0)},[N]);return(0,n.jsx)(x.Provider,{value:{data:t,loaded:h,fetchData:N,refreshData:v},children:s})},h=()=>{let e=(0,a.useContext)(x);if(void 0===e)throw Error("useVoucherNav must be used within a VoucherNavProvider");return e}},9012:(e,s,t)=>{"use strict";t.d(s,{L:()=>a});var n=t(30926);let a=(0,n.createServerReference)("400e621b7f78c4800cffc85d668ca10cd73eb6853c",n.callServer,void 0,n.findSourceMapURL,"getClients")},11186:(e,s,t)=>{"use strict";t.d(s,{bq:()=>m,eb:()=>j,gC:()=>p,l6:()=>o,yv:()=>x});var n=t(95155),a=t(12115),r=t(47887),l=t(59007),i=t(42614),d=t(72251),c=t(64269);let o=r.bL;r.YJ;let x=r.WT,m=a.forwardRef((e,s)=>{let{className:t,children:a,...i}=e;return(0,n.jsxs)(r.l9,{ref:s,className:(0,c.cn)("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",t),...i,children:[a,(0,n.jsx)(r.In,{asChild:!0,children:(0,n.jsx)(l.A,{className:"h-4 w-4 opacity-50"})})]})});m.displayName=r.l9.displayName;let h=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.PP,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",t),...a,children:(0,n.jsx)(i.A,{className:"h-4 w-4"})})});h.displayName=r.PP.displayName;let u=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.wn,{ref:s,className:(0,c.cn)("flex cursor-default items-center justify-center py-1",t),...a,children:(0,n.jsx)(l.A,{className:"h-4 w-4"})})});u.displayName=r.wn.displayName;let p=a.forwardRef((e,s)=>{let{className:t,children:a,position:l="popper",...i}=e;return(0,n.jsx)(r.ZL,{children:(0,n.jsxs)(r.UC,{ref:s,className:(0,c.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2","popper"===l&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:l,...i,children:[(0,n.jsx)(h,{}),(0,n.jsx)(r.LM,{className:(0,c.cn)("p-1","popper"===l&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:a}),(0,n.jsx)(u,{})]})})});p.displayName=r.UC.displayName,a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.JU,{ref:s,className:(0,c.cn)("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...a})}).displayName=r.JU.displayName;let j=a.forwardRef((e,s)=>{let{className:t,children:a,...l}=e;return(0,n.jsxs)(r.q7,{ref:s,className:(0,c.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",t),...l,children:[(0,n.jsx)("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,n.jsx)(r.VF,{children:(0,n.jsx)(d.A,{className:"h-4 w-4"})})}),(0,n.jsx)(r.p4,{children:a})]})});j.displayName=r.q7.displayName,a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.wv,{ref:s,className:(0,c.cn)("-mx-1 my-1 h-px bg-muted",t),...a})}).displayName=r.wv.displayName},11647:(e,s,t)=>{"use strict";t.d(s,{E:()=>i});var n=t(95155);t(12115);var a=t(83101),r=t(64269);let l=(0,a.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function i(e){let{className:s,variant:t,...a}=e;return(0,n.jsx)("span",{className:(0,r.cn)(l({variant:t}),s),...a})}},13496:(e,s,t)=>{"use strict";t.d(s,{$m:()=>o,As:()=>c,nD:()=>d,ub:()=>x});var n=t(95155),a=t(12115),r=t(58609),l=t(59007),i=t(64269);let d=r.bL,c=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.q7,{ref:s,className:(0,i.cn)("border-b",t),...a})});c.displayName="AccordionItem";let o=a.forwardRef((e,s)=>{let{className:t,children:a,...d}=e;return(0,n.jsx)(r.Y9,{className:"flex",children:(0,n.jsxs)(r.l9,{ref:s,className:(0,i.cn)("flex flex-1 items-center justify-between py-4 font-medium transition-all hover:no-underline data-[state=open]:text-primary [&[data-state=open]>svg]:rotate-180",t),...d,children:[a,(0,n.jsx)(l.A,{className:"h-4 w-4 shrink-0 transition-transform duration-200"})]})})});o.displayName=r.l9.displayName;let x=a.forwardRef((e,s)=>{let{className:t,children:a,...l}=e;return(0,n.jsx)(r.UC,{ref:s,className:"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down",...l,children:(0,n.jsx)("div",{className:(0,i.cn)("pb-4 pt-0",t),children:a})})});x.displayName=r.UC.displayName},32383:()=>{},35656:(e,s,t)=>{"use strict";t.d(s,{l:()=>a});var n=t(30926);let a=(0,n.createServerReference)("40290c8e8678ea3c7dc08bc14a2b21bf84ced558a3",n.callServer,void 0,n.findSourceMapURL,"getUsers")},46767:(e,s,t)=>{"use strict";t.d(s,{Bc:()=>i,ZI:()=>o,k$:()=>c,m_:()=>d});var n=t(95155),a=t(12115),r=t(47520),l=t(64269);let i=r.Kq,d=r.bL,c=r.l9,o=a.forwardRef((e,s)=>{let{className:t,sideOffset:a=4,...i}=e;return(0,n.jsx)(r.UC,{ref:s,sideOffset:a,className:(0,l.cn)("z-50 whitespace-nowrap rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...i})});o.displayName=r.UC.displayName},50732:(e,s,t)=>{"use strict";t.d(s,{d:()=>a});var n=t(12115);function a(e,s){let[t,a]=(0,n.useState)(e);return(0,n.useEffect)(()=>{let t=setTimeout(()=>{a(e)},s);return()=>{clearTimeout(t)}},[e,s]),t}},51834:(e,s,t)=>{"use strict";t.d(s,{Cf:()=>h,Es:()=>p,HM:()=>x,L3:()=>j,c7:()=>u,lG:()=>d,rr:()=>f,zM:()=>c});var n=t(95155),a=t(12115),r=t(89511),l=t(26615),i=t(64269);let d=r.bL,c=r.l9,o=r.ZL,x=r.bm,m=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.hJ,{ref:s,className:(0,i.cn)("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...a})});m.displayName=r.hJ.displayName;let h=a.forwardRef((e,s)=>{let{className:t,children:a,showCloseButton:d=!0,...c}=e;return(0,n.jsxs)(o,{children:[(0,n.jsx)(m,{}),(0,n.jsxs)(r.UC,{ref:s,className:(0,i.cn)("fixed left-1/2 top-1/2 z-50 grid w-full max-w-lg -translate-x-1/2 -translate-y-1/2 gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),onOpenAutoFocus:e=>e.preventDefault(),...c,children:[a,d&&(0,n.jsxs)(r.bm,{className:"absolute left-4 top-4 rounded-full p-1.5 opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground bg-muted hover:bg-muted/80",children:[(0,n.jsx)(l.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});h.displayName=r.UC.displayName;let u=e=>{let{className:s,...t}=e;return(0,n.jsx)("div",{className:(0,i.cn)("flex flex-col space-y-1.5 text-center sm:text-right",s),...t})};u.displayName="DialogHeader";let p=e=>{let{className:s,...t}=e;return(0,n.jsx)("div",{className:(0,i.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2 rtl:space-x-reverse",s),...t})};p.displayName="DialogFooter";let j=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.hE,{ref:s,className:(0,i.cn)("text-lg font-semibold leading-none tracking-tight",t),...a})});j.displayName=r.hE.displayName;let f=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.VY,{ref:s,className:(0,i.cn)("text-sm text-muted-foreground",t),...a})});f.displayName=r.VY.displayName},53774:(e,s,t)=>{"use strict";t.d(s,{T:()=>m});var n=t(95155),a=t(17878),r=t(63263),l=t(51190),i=t(39285),d=t(64269),c=t(3998),o=t(11186),x=t(20063);function m(e){let{table:s,className:t,totalRows:m}=e,h=(0,x.useRouter)(),u=(0,x.usePathname)(),p=(0,x.useSearchParams)(),j=void 0!==m,f=s.getState().pagination.pageIndex,g=s.getState().pagination.pageSize,N=j?Math.ceil(m/g):s.getPageCount(),v=j?f>0:s.getCanPreviousPage();j||s.getCanNextPage();let b=j?e=>{let s=new URLSearchParams(p.toString());s.set("page",(e+1).toString()),h.push("".concat(u,"?").concat(s.toString()))}:s.setPageIndex;return(0,n.jsxs)("div",{className:(0,d.cn)("flex flex-col-reverse items-center justify-between gap-4 sm:flex-row sm:gap-6 lg:gap-8",t),children:[(0,n.jsxs)("div",{className:"flex-1 text-sm text-muted-foreground",children:[s.getFilteredSelectedRowModel().rows.length," من"," ",j?m:s.getFilteredRowModel().rows.length," صفوف مختارة."]}),(0,n.jsxs)("div",{className:"flex flex-col-reverse items-center gap-4 sm:flex-row sm:gap-6 lg:gap-8",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-2 space-x-reverse",children:[(0,n.jsx)("p",{className:"text-sm font-medium",children:"صفوف لكل صفحة"}),(0,n.jsxs)(o.l6,{value:"".concat(g),onValueChange:e=>{var t;t=Number(e),j?(e=>{let s=new URLSearchParams(p.toString());s.set("limit",e.toString()),s.set("page","1"),h.push("".concat(u,"?").concat(s.toString()))})(t):s.setPageSize(t)},children:[(0,n.jsx)(o.bq,{className:"h-8 w-[70px]",children:(0,n.jsx)(o.yv,{placeholder:g})}),(0,n.jsx)(o.gC,{side:"top",children:[5,10,15,20,30,50].map(e=>(0,n.jsx)(o.eb,{value:"".concat(e),children:e},e))})]})]}),(0,n.jsxs)("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium",children:["صفحة ",f+1," من"," ",N]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2 space-x-reverse",children:[(0,n.jsxs)(c.$,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>b(0),disabled:!v,children:[(0,n.jsx)("span",{className:"sr-only",children:"Go to first page"}),(0,n.jsx)(a.A,{className:"h-4 w-4"})]}),(0,n.jsxs)(c.$,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>s.previousPage(),disabled:!s.getCanPreviousPage(),children:[(0,n.jsx)("span",{className:"sr-only",children:"Go to previous page"}),(0,n.jsx)(r.A,{className:"h-4 w-4"})]}),(0,n.jsxs)(c.$,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>s.nextPage(),disabled:!s.getCanNextPage(),children:[(0,n.jsx)("span",{className:"sr-only",children:"Go to next page"}),(0,n.jsx)(l.A,{className:"h-4 w-4"})]}),(0,n.jsxs)(c.$,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>s.setPageIndex(s.getPageCount()-1),disabled:!s.getCanNextPage(),children:[(0,n.jsx)("span",{className:"sr-only",children:"Go to last page"}),(0,n.jsx)(i.A,{className:"h-4 w-4"})]})]})]})]})}},65142:(e,s,t)=>{"use strict";t.d(s,{p:()=>l});var n=t(95155),a=t(12115),r=t(64269);let l=a.forwardRef((e,s)=>{let{className:t,type:a,...l}=e;return(0,n.jsx)("input",{type:a,className:(0,r.cn)("flex h-10 w-full rounded-lg border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:s,...l})});l.displayName="Input"},66730:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>eS});var n=t(95155),a=t(12115),r=t(86948),l=t(4246),i=t(3998),d=t(65142),c=t(76444),o=t(87270),x=t(58772),m=t(53489),h=t(32810),u=t(28127),p=t(62593),j=t(6943),f=t(40671),g=t(33173),N=t(54550),v=t(92033),b=t(73180),y=t(15894),w=t(51834),A=t(30926);let C=(0,A.createServerReference)("40e3c8292a4f0b84d05a9c4ad934c059de920dc94d",A.callServer,void 0,A.findSourceMapURL,"saveFlightReport");var S=t(5470);function R(e){let{onSaveSuccess:s,children:t}=e,[A,R]=(0,a.useState)([]),[D,k]=(0,a.useState)(""),[_,M]=(0,a.useState)({date:"",time:"",route:""}),[T,F]=(0,a.useState)(!1),[P,I]=(0,a.useState)(""),[H,L]=(0,a.useState)(!1),{toast:U}=(0,y.dj)(),{data:E,loaded:z}=(0,S.Z)(),[$,B]=(0,a.useState)(""),O=a.useMemo(()=>((null==E?void 0:E.suppliers)||[]).map(e=>({value:e.id,label:e.name})),[null==E?void 0:E.suppliers]),G=e=>{if("number"==typeof e&&e>1){let s=new Date(Math.round((e-25569)*864e5));return isNaN(s.getTime())?null:s}if("string"==typeof e){let s=new Date(e.replace(/(\d{4})\/(\d{2})\/(\d{2})/,"$1-$2-$3"));if(!isNaN(s.getTime()))return s}return null},W=(0,a.useCallback)(e=>{var s;let t=null==(s=e.target.files)?void 0:s[0];if(!t)return;k(t.name),I("Reading file...");let n=new FileReader;n.onload=e=>{try{var s;let t=new Uint8Array(null==(s=e.target)?void 0:s.result),n=l.LF(t,{type:"array",cellDates:!0}),a=n.SheetNames[0],r=n.Sheets[a],i=String(l.Wp.sheet_to_json(r,{header:1})[1][1]||""),d=String(l.Wp.sheet_to_json(r,{header:1})[1][2]||""),c=(e=>{if(!e)return"";let s=G(e);return s?s.toISOString().split("T")[0]:String(e).split(" ")[0]})(d),o=(e=>{if(!e)return"";let s=G(e);if(s){if("number"==typeof e&&e<1&&e>0){let s=Math.round(86400*e),t=Math.floor(s/3600),n=Math.floor(s%3600/60);return"".concat(String(t).padStart(2,"0"),":").concat(String(n).padStart(2,"0"))}if("00:00:00 GMT+0000 (Coordinated Universal Time)"!==s.toTimeString())return s.toTimeString().split(" ")[0].substring(0,5)}let t=String(e).split(" ");return t.length>1&&/^\d{1,2}:\d{2}/.test(t[1])?t[1].substring(0,5):""})(d);M({route:i,date:c,time:o});let x=l.Wp.sheet_to_json(r,{range:4}),m=(e,s)=>{let t=e[0]||{};return Object.keys(t).find(e=>s.test(e.toLowerCase()))},h=x[0]||{},u=m([h],/booking reference|حجز/i),p=m([h],/pnr \/ class/i),j=m([h],/passenger|الاسم|اسم المسافر/i),f=m([h],/first name|first_name|الاسم الاول/i),g=m([h],/last name|last_name|الكنية/i),N=m([h],/payable \(pp\)|payable/i),v=m([h],/gender|الجنس/i);if(!N)return void U({title:"أعمدة مطلوبة مفقودة",description:"لم يتم العثور على عمود السعر (Payable (pp)).",variant:"destructive"});let b="",y="",w=x.map(e=>{let s="N/A",t=f&&e[f]||"",n=g&&e[g]||"";t&&n?s="".concat(t," ").concat(n).trim():j&&(s=e[j]||"N/A");let a=u&&e[u]?String(e[u]):b,r=p&&e[p]?String(e[p]):y;return a&&(b=a),r&&(y=r),{bookingReference:b,pnrClass:y,name:s,payable:(e=>{if(null==e)return 0;let s=parseFloat(String(e).replace(/[^0-9.-]+/g,""));return isNaN(s)?0:s})(e[N]),route:i,flightDate:c,flightTime:o,gender:v?String(e[v]||""):"",firstName:t,lastName:n}}).filter(e=>e.name&&""!==e.name.trim()&&"N/A"!==e.name),A=new Map,C={};w.forEach(e=>{var s,t;let n=e.bookingReference||e.pnrClass,a="".concat(n,"-").concat(e.name.toLowerCase().trim());if(!n)return;C[n]||(C[n]={pnr:e.pnrClass,bookingReference:e.bookingReference,paxCount:0,totalPayable:0,passengers:[]});let r=A.has(a);C[n].passengers.push({...e,name:r?"(نفس مسافر رحلة ".concat(null==(s=A.get(a))?void 0:s.flightDate," ").concat(null==(t=A.get(a))?void 0:t.flightTime,")"):e.name}),r||(A.set(a,{flightDate:e.flightDate,flightTime:e.flightTime}),C[n].totalPayable+=e.payable),C[n].paxCount++}),R(Object.values(C)),I("File loaded. Found ".concat(w.length," passengers in ").concat(Object.keys(C).length," PNRs."))}catch(e){I("Error reading file: ".concat(e.message)),U({title:"Error Reading File",description:e.message,variant:"destructive"})}},n.readAsArrayBuffer(t)},[U]),{paxCount:V,totalRevenue:Z,payDistribution:J,tripTypeCounts:X}=(0,a.useMemo)(()=>{let e=0,s=0,t={},n={};A.forEach(a=>{a.passengers.forEach(a=>{let r="".concat(a.pnrClass,"-").concat(a.name.toLowerCase().trim());if(n[r]=(n[r]||0)+1,1===n[r]){let e=a.payable||0;s+=e,t[e]||(t[e]={count:0,subtotal:0}),t[e].count++,t[e].subtotal+=e}e++})});let a=0,r=0,l=new Set;return Object.keys(n).forEach(e=>{l.has(e)||(n[e]>1?r++:a++,l.add(e))}),{paxCount:e,totalRevenue:s,payDistribution:Object.entries(t).map(e=>{let[s,t]=e;return{amount:parseFloat(s),...t}}),tripTypeCounts:{oneWay:a,roundTrip:r}}},[A]),q=async()=>{F(!0);let e=O.find(e=>e.value===$),t={fileName:D,flightDate:_.date,flightTime:_.time,route:_.route,supplierName:(null==e?void 0:e.label)||"تحليل",paxCount:V,totalRevenue:Z,pnrGroups:A,passengers:A.flatMap(e=>e.passengers),payDistribution:J,tripTypeCounts:X,filteredRevenue:0,totalDiscount:0},n=await C(t);n.success?(U({title:"تم حفظ التقرير بنجاح"}),s(),L(!1)):n.error&&U({title:"خطأ",description:n.error,variant:"destructive"}),F(!1)};return(0,n.jsxs)(w.lG,{open:H,onOpenChange:L,children:[(0,n.jsx)(w.zM,{asChild:!0,children:t}),(0,n.jsxs)(w.Cf,{className:"max-w-7xl h-[90vh] flex flex-col",children:[(0,n.jsxs)(w.c7,{children:[(0,n.jsx)(w.L3,{children:"محلل بيانات الطيران"}),(0,n.jsx)(w.rr,{children:"ارفع ملف Excel الخاص بالرحلات لتحليل البيانات واستخراج الملخصات بشكل تلقائي."})]}),(0,n.jsxs)("div",{className:"flex-grow overflow-y-auto pr-6 -mr-6 space-y-4",children:[(0,n.jsx)(r.Zp,{children:(0,n.jsxs)(r.Wu,{className:"pt-6 flex flex-col items-center gap-4",children:[(0,n.jsx)(c.J,{htmlFor:"file-upload-dialog",className:"w-full max-w-lg cursor-pointer",children:(0,n.jsxs)("div",{className:"border-2 border-dashed rounded-lg p-8 text-center hover:border-primary transition-colors",children:[(0,n.jsx)(x.A,{className:"mx-auto h-12 w-12 text-muted-foreground"}),(0,n.jsx)("p",{className:"mt-4 font-semibold",children:"انقر لرفع ملف أو قم بسحبه هنا"}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"الملفات المدعومة: .xlsx, .xls"})]})}),(0,n.jsx)(d.p,{id:"file-upload-dialog",type:"file",accept:".xlsx,.xls",onChange:W,className:"hidden"}),D&&(0,n.jsxs)("div",{className:"text-sm text-slate-500 mt-2",children:["الملف المحمل: ",D]})]})}),A.length>0&&(0,n.jsx)("div",{className:"space-y-6",children:(0,n.jsxs)(r.Zp,{children:[(0,n.jsxs)(r.aR,{className:"flex flex-row justify-between items-center",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)(r.ZB,{children:"النتائج المستخرجة"}),(0,n.jsxs)(r.BT,{children:["تم تحليل ",V," مسافر."]})]}),(0,n.jsx)("div",{className:"flex items-center gap-2",children:(0,n.jsxs)(i.$,{variant:"outline",onClick:()=>{let e=A.flatMap(e=>e.passengers.map(e=>({"Booking Reference":e.bookingReference,"PNR / Class":e.pnrClass,"First Name":e.firstName,"Last Name":e.lastName,"Full Name":e.name,Gender:e.gender,Payable:e.payable}))),s=[["الوجهة",_.route],["التاريخ",_.date],["الوقت",_.time],["عدد المسافرين",V],["الإيراد الكلي",Z.toFixed(2)]],t=l.Wp.aoa_to_sheet(s),n=l.Wp.json_to_sheet(e),a=l.Wp.book_new();l.Wp.book_append_sheet(a,t,"ملخص الرحلة"),l.Wp.book_append_sheet(a,n,"تفاصيل المسافرين"),l._h(a,"flight_report_details.xlsx")},children:[(0,n.jsx)(m.A,{className:"me-2 h-4 w-4"}),"تصدير النتائج"]})})]}),(0,n.jsx)(r.Wu,{children:(0,n.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h4",{className:"font-bold mb-2",children:"ملخص الرحلة"}),(0,n.jsx)(o.XI,{children:(0,n.jsxs)(o.BF,{children:[(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(h.A,{className:"h-4 w-4 text-primary"}),"الوجهة"]}),(0,n.jsx)(o.nA,{children:_.route})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(u.A,{className:"h-4 w-4 text-primary"}),"تاريخ الرحلة"]}),(0,n.jsx)(o.nA,{children:_.date})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(p.A,{className:"h-4 w-4 text-primary"}),"وقت الرحلة"]}),(0,n.jsx)(o.nA,{children:_.time})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(j.A,{className:"h-4 w-4 text-primary"}),"عدد المسافرين"]}),(0,n.jsx)(o.nA,{children:V})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(f.A,{className:"h-4 w-4 text-primary"}),"الإيراد الكلي"]}),(0,n.jsxs)(o.nA,{className:"font-mono",children:[Z.toFixed(2)," USD"]})]})]})}),(0,n.jsx)("h4",{className:"font-bold mb-2 mt-4",children:"ملخص نوع الرحلة"}),(0,n.jsx)(o.XI,{children:(0,n.jsxs)(o.BF,{children:[(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(g.A,{className:"h-4 w-4 text-blue-500"}),"ذهاب فقط"]}),(0,n.jsx)(o.nA,{className:"font-bold",children:X.oneWay})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{className:"font-bold flex items-center gap-2",children:[(0,n.jsx)(N.A,{className:"h-4 w-4 text-green-500"}),"ذهاب وعودة"]}),(0,n.jsx)(o.nA,{className:"font-bold",children:X.roundTrip})]})]})})]}),(0,n.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("h4",{className:"font-bold mb-2",children:"ملخص الأسعار"}),(0,n.jsx)("div",{className:"max-h-60 overflow-y-auto border rounded-lg",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"السعر"}),(0,n.jsx)(o.nd,{children:"العدد"}),(0,n.jsx)(o.nd,{className:"text-right",children:"الإجمالي"})]})}),(0,n.jsx)(o.BF,{children:J.map(e=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsxs)(o.nA,{children:[e.amount," USD"]}),(0,n.jsx)(o.nA,{children:e.count}),(0,n.jsxs)(o.nA,{className:"font-mono text-right",children:[e.subtotal.toFixed(2)," USD"]})]},e.amount))}),(0,n.jsx)(o.Gg,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{className:"font-bold",children:"المجموع"}),(0,n.jsx)(o.nA,{className:"font-bold font-mono",children:V}),(0,n.jsxs)(o.nA,{className:"font-bold font-mono text-right",children:[Z.toFixed(2)," USD"]})]})})]})})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h4",{className:"font-bold mb-2",children:"توزيع الحجوزات"}),(0,n.jsx)("div",{className:"max-h-60 overflow-y-auto border rounded-lg",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"المرجع"}),(0,n.jsx)(o.nd,{children:"الركاب"}),(0,n.jsx)(o.nd,{className:"text-right",children:"الإجمالي"})]})}),(0,n.jsx)(o.BF,{children:A.map((e,s)=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{className:"font-mono",children:e.pnr||e.bookingReference}),(0,n.jsx)(o.nA,{children:e.paxCount}),(0,n.jsx)(o.nA,{className:"font-mono text-right",children:e.totalPayable.toFixed(2)})]},s))})]})})]})]}),(0,n.jsxs)("div",{className:"lg:col-span-2",children:[(0,n.jsx)("h4",{className:"font-bold mb-2",children:"تفاصيل المسافرين"}),(0,n.jsx)("div",{className:"max-h-80 overflow-y-auto border rounded-lg",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"Booking Reference"}),(0,n.jsx)(o.nd,{children:"PNR / Class"}),(0,n.jsx)(o.nd,{children:"Full Name"}),(0,n.jsx)(o.nd,{children:"Gender"}),(0,n.jsx)(o.nd,{className:"text-right",children:"Payable"})]})}),(0,n.jsx)(o.BF,{children:A.flatMap(e=>e.passengers).map((e,s)=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:e.bookingReference}),(0,n.jsx)(o.nA,{children:e.pnrClass}),(0,n.jsx)(o.nA,{children:e.name}),(0,n.jsx)(o.nA,{children:e.gender}),(0,n.jsx)(o.nA,{className:"font-mono text-right",children:e.payable.toFixed(2)})]},s))})]})})]})]})})]})})]}),(0,n.jsxs)(w.Es,{children:[(0,n.jsx)(w.HM,{asChild:!0,children:(0,n.jsx)(i.$,{variant:"ghost",children:"إلغاء"})}),(0,n.jsxs)(i.$,{onClick:q,disabled:T||0===A.length,children:[T?(0,n.jsx)(v.A,{className:"me-2 h-4 w-4 animate-spin"}):(0,n.jsx)(b.A,{className:"me-2 h-4 w-4"})," حفظ النتائج"]})]})]})]})}var D=t(3730),k=t(46767),_=t(73457),M=t(11647),T=t(8992),F=t(13630),P=t(59007),I=t(60406),H=t(18527),L=t(20146),U=t(52240),E=t(41165),z=t(90043),$=t(60013),B=t(64269),O=t(14223),G=t(19056),W=t(19456),V=t(97916);let Z=(0,A.createServerReference)("78a8754dc047ed50c9c7bb185ed3ad0a79b3755f58",A.callServer,void 0,A.findSourceMapURL,"updateManualDiscount"),J=(0,A.createServerReference)("40f54af95455474c6797db53b51dec407d05484277",A.callServer,void 0,A.findSourceMapURL,"deleteFlightReport"),X=(0,A.createServerReference)("60e1aafb0ecafed63ad832743da622104cdf70c1e0",A.callServer,void 0,A.findSourceMapURL,"updateFlightReportSelection");var q=t(98053),Y=t(50909),K=t(31120),Q=t(86259),ee=t(13496),es=t(6259);let et=e=>"number"!=typeof e||isNaN(e)?"$0.00":"$".concat(e.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})),en=e=>{let{report:s}=e;return s.payDistribution&&0!==s.payDistribution.length?(0,n.jsxs)(w.lG,{children:[(0,n.jsx)(w.zM,{asChild:!0,children:(0,n.jsx)("button",{className:"w-full text-center hover:underline font-mono font-bold",children:et(s.totalRevenue)})}),(0,n.jsxs)(w.Cf,{className:"sm:max-w-md",children:[(0,n.jsxs)(w.c7,{children:[(0,n.jsxs)(w.L3,{children:["ملخص الأسعار لملف: ",s.fileName]}),(0,n.jsx)(w.rr,{children:"توزيع الركاب حسب سعر التذكرة."})]}),(0,n.jsx)("div",{className:"max-h-80 overflow-y-auto border rounded-md",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"السعر"}),(0,n.jsx)(o.nd,{children:"عدد الركاب"}),(0,n.jsx)(o.nd,{className:"text-right",children:"الإجمالي"})]})}),(0,n.jsx)(o.BF,{children:s.payDistribution.map((e,s)=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:et(e.amount)}),(0,n.jsx)(o.nA,{children:e.count}),(0,n.jsx)(o.nA,{className:"text-right font-mono",children:et(e.subtotal)})]},s))}),(0,n.jsx)(o.Gg,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{className:"font-bold",children:"المجموع"}),(0,n.jsx)(o.nA,{className:"font-bold",children:s.paxCount}),(0,n.jsx)(o.nA,{className:"text-right font-bold",children:et(s.totalRevenue)})]})})]})})]})]}):null},ea=e=>{let{report:s,children:t,defaultOpen:l}=e,i=(s.passengers||[]).filter(e=>"RETURN"===e.tripType),d=s.manualDiscount||{type:"fixed",value:0},c=(0,a.useMemo)(()=>{if("fixed"===d.type)return d.value||0;if("per_passenger"===d.type){let e=(s.passengers||[]).reduce((e,s)=>{let t=s.passengerType||"Adult";return e[t]=(e[t]||0)+1,e},{}),t=(e.Adult||0)*(d.perAdult||0);return t+(e.Child||0)*(d.perChild||0)+(e.Infant||0)*(d.perInfant||0)}return 0},[d,s.passengers]);return(0,n.jsxs)(w.lG,{children:[(0,n.jsx)(w.zM,{asChild:!0,children:t}),(0,n.jsxs)(w.Cf,{className:"sm:max-w-3xl",children:[(0,n.jsx)(w.c7,{children:(0,n.jsxs)(w.L3,{children:["تفاصيل الخصم لملف: ",s.fileName]})}),(0,n.jsxs)("div",{className:"py-4 space-y-4",children:[(0,n.jsxs)(r.Zp,{children:[(0,n.jsx)(r.aR,{className:"pb-2",children:(0,n.jsx)(r.ZB,{className:"text-base",children:"ملخص مالي"})}),(0,n.jsxs)(r.Wu,{className:"space-y-2 text-sm",children:[(0,n.jsxs)("div",{className:"flex justify-between font-medium",children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"الإجمالي الأصلي:"}),(0,n.jsx)("span",{className:"font-mono",children:et(s.totalRevenue)})]}),(0,n.jsxs)("div",{className:"flex justify-between font-medium",children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"خصم العودة:"}),(0,n.jsxs)("span",{className:"font-mono text-orange-600",children:["- ",et(s.totalDiscount)]})]}),(0,n.jsxs)("div",{className:"flex justify-between font-medium",children:[(0,n.jsx)("span",{className:"text-muted-foreground",children:"خصم يدوي:"}),(0,n.jsxs)("span",{className:"font-mono text-red-600",children:["- ",et(c)]})]}),(0,n.jsx)(Q.Separator,{}),(0,n.jsxs)("div",{className:"flex justify-between font-bold text-base",children:[(0,n.jsx)("span",{className:"text-primary",children:"الصافي النهائي:"}),(0,n.jsx)("span",{className:"font-mono text-primary",children:et(s.filteredRevenue)})]})]})]}),(0,n.jsxs)(ee.nD,{type:"single",collapsible:!0,className:"w-full space-y-2",defaultValue:l,children:[(0,n.jsxs)(ee.As,{value:"auto",className:"border rounded-lg bg-background",children:[(0,n.jsx)(ee.$m,{className:"font-semibold px-4 py-3 hover:no-underline",children:"الخصم التلقائي (خصم العودة)"}),(0,n.jsx)(ee.ub,{className:"p-4 border-t",children:0===i.length?(0,n.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"لا يوجد خصم عودة تلقائي."}):(0,n.jsx)("div",{className:"max-h-60 overflow-y-auto",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"المسافر"}),(0,n.jsx)(o.nd,{children:"تاريخ الذهاب"}),(0,n.jsx)(o.nd,{children:"تاريخ العودة"}),(0,n.jsx)(o.nd,{className:"text-right",children:"المبلغ المخصوم"})]})}),(0,n.jsx)(o.BF,{children:i.map((e,t)=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:e.name}),(0,n.jsx)(o.nA,{children:e.departureDate?(0,O.GP)((0,G.H)(e.departureDate),"yyyy-MM-dd"):"-"}),(0,n.jsx)(o.nA,{children:s.flightDate?(0,O.GP)((0,G.H)(s.flightDate),"yyyy-MM-dd"):"-"}),(0,n.jsxs)(o.nA,{className:"text-right font-mono text-red-500",children:["- ",et(e.payable)]})]},t))})]})})})]}),(0,n.jsxs)(ee.As,{value:"manual",className:"border rounded-lg bg-background",children:[(0,n.jsx)(ee.$m,{className:"font-semibold px-4 py-3 hover:no-underline",children:"الخصم اليدوي"}),(0,n.jsx)(ee.ub,{className:"p-4 border-t",children:0!==c||s.manualDiscountNotes?(0,n.jsxs)("div",{className:"space-y-4",children:["per_passenger"===d.type?(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"الفئة"}),(0,n.jsx)(o.nd,{children:"العدد"}),(0,n.jsx)(o.nd,{children:"خصم الفرد"}),(0,n.jsx)(o.nd,{className:"text-right",children:"الإجمالي"})]})}),(0,n.jsxs)(o.BF,{children:[(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:"بالغ"}),(0,n.jsx)(o.nA,{children:(s.passengers||[]).filter(e=>"Adult"===e.passengerType).length}),(0,n.jsx)(o.nA,{children:et(d.perAdult)}),(0,n.jsx)(o.nA,{className:"text-right",children:et((d.perAdult||0)*(s.passengers||[]).filter(e=>"Adult"===e.passengerType).length)})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:"طفل"}),(0,n.jsx)(o.nA,{children:(s.passengers||[]).filter(e=>"Child"===e.passengerType).length}),(0,n.jsx)(o.nA,{children:et(d.perChild)}),(0,n.jsx)(o.nA,{className:"text-right",children:et((d.perChild||0)*(s.passengers||[]).filter(e=>"Child"===e.passengerType).length)})]}),(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:"رضيع"}),(0,n.jsx)(o.nA,{children:(s.passengers||[]).filter(e=>"Infant"===e.passengerType).length}),(0,n.jsx)(o.nA,{children:et(d.perInfant)}),(0,n.jsx)(o.nA,{className:"text-right",children:et((d.perInfant||0)*(s.passengers||[]).filter(e=>"Infant"===e.passengerType).length)})]})]}),(0,n.jsx)(o.Gg,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{colSpan:3,className:"font-bold",children:"المجموع"}),(0,n.jsx)(o.nA,{className:"text-right font-bold",children:et(c)})]})})]}):(0,n.jsxs)("p",{className:"font-semibold text-center p-4",children:["مبلغ ثابت: ",(0,n.jsx)("span",{className:"font-mono text-red-500",children:et(c)})]}),s.manualDiscountNotes&&(0,n.jsxs)("p",{className:"text-sm text-muted-foreground mt-2 border-t pt-2",children:[(0,n.jsx)("b",{children:"ملاحظات:"})," ",s.manualDiscountNotes]})]}):(0,n.jsx)("p",{className:"text-sm text-muted-foreground text-center py-4",children:"لا يوجد خصم يدوي."})})]})]})]})]})]})},er=e=>{let{report:s,onSaveSuccess:t}=e,[r,l]=(0,a.useState)(!1),[d,o]=(0,a.useState)(s.manualDiscount||{type:"fixed",value:0}),[x,m]=(0,a.useState)(s.manualDiscountNotes||""),[h,u]=(0,a.useState)(!1),{toast:p}=(0,y.dj)(),j=(0,a.useMemo)(()=>(s.passengers||[]).reduce((e,s)=>{let t=s.passengerType||"Adult";return e[t]=(e[t]||0)+1,e},{}),[s.passengers]);(0,a.useEffect)(()=>{r&&(o(s.manualDiscount||{type:"fixed",value:0}),m(s.manualDiscountNotes||""))},[r,s]);let f=(0,a.useMemo)(()=>{if("fixed"===d.type)return d.value||0;if("per_passenger"===d.type){let e=(j.Adult||0)*(d.perAdult||0);return e+(j.Child||0)*(d.perChild||0)+(j.Infant||0)*(d.perInfant||0)}return 0},[d,j]),g=async()=>{u(!0);let e=await Z(s.id,f,x,d);e.success&&e.updatedReport?(p({title:"تم حفظ الخصم اليدوي"}),t(e.updatedReport),l(!1)):p({title:"خطأ",description:e.error,variant:"destructive"}),u(!1)},N=async()=>{u(!0);let e=await Z(s.id,0,"",void 0);e.success&&e.updatedReport?(p({title:"تم حذف الخصم اليدوي"}),t(e.updatedReport),l(!1)):p({title:"خطأ",description:e.error,variant:"destructive"}),u(!1)},A=(s.totalRevenue||0)-(s.totalDiscount||0);return(0,n.jsxs)(w.lG,{open:r,onOpenChange:l,children:[(0,n.jsx)(w.zM,{asChild:!0,children:(0,n.jsxs)(es._2,{onSelect:e=>e.preventDefault(),children:[(0,n.jsx)(T.A,{className:"me-2 h-4 w-4"})," إضافة / تعديل خصم يدوي"]})}),(0,n.jsxs)(w.Cf,{className:"sm:max-w-lg",children:[(0,n.jsxs)(w.c7,{children:[(0,n.jsx)(w.L3,{children:"إضافة/تعديل الخصم اليدوي"}),(0,n.jsx)(w.rr,{children:"اختر نوع الخصم وأدخل القيم. سيتم خصم المبلغ الإجمالي من صافي الربح."})]}),(0,n.jsxs)("div",{className:"py-4 space-y-4",children:[(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)("div",{className:"p-3 border rounded-lg text-center bg-muted/50",children:[(0,n.jsx)(c.J,{className:"text-xs text-muted-foreground",children:"الصافي قبل الخصم اليدوي"}),(0,n.jsx)("p",{className:"font-mono font-bold text-lg",children:et(A)})]}),(0,n.jsxs)("div",{className:"p-3 border rounded-lg text-center border-primary bg-primary/10",children:[(0,n.jsx)(c.J,{className:"text-xs text-primary",children:"الصافي الجديد بعد الخصم"}),(0,n.jsx)("p",{className:"font-mono font-bold text-lg text-primary",children:et(A-f)})]})]}),(0,n.jsxs)(Y.z,{value:d.type,onValueChange:e=>{"fixed"===e?o({type:"fixed",value:0}):o({type:"per_passenger",perAdult:0,perChild:0,perInfant:0})},className:"grid grid-cols-2 gap-4",children:[(0,n.jsxs)(c.J,{htmlFor:"type-fixed",className:(0,B.cn)("border rounded-md p-4 text-center cursor-pointer","fixed"===d.type&&"bg-accent text-accent-foreground ring-2 ring-accent"),children:[(0,n.jsx)(Y.C,{value:"fixed",id:"type-fixed",className:"sr-only"}),"مبلغ ثابت"]}),(0,n.jsxs)(c.J,{htmlFor:"type-per-passenger",className:(0,B.cn)("border rounded-md p-4 text-center cursor-pointer","per_passenger"===d.type&&"bg-accent text-accent-foreground ring-2 ring-accent"),children:[(0,n.jsx)(Y.C,{value:"per_passenger",id:"type-per-passenger",className:"sr-only"}),"خصم لكل مسافر"]})]}),"fixed"===d.type&&(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(c.J,{children:"مبلغ الخصم الإجمالي"}),(0,n.jsx)(V.O,{value:d.value,onValueChange:e=>o({type:"fixed",value:e||0})})]}),"per_passenger"===d.type&&(0,n.jsxs)("div",{className:"space-y-3 p-3 border rounded-md",children:[(0,n.jsx)("h4",{className:"font-semibold text-sm",children:"أدخل الخصم لكل فئة"}),(0,n.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2",children:[(0,n.jsx)(c.J,{children:"فئة المسافر"}),(0,n.jsx)(c.J,{children:"قيمة الخصم"}),(0,n.jsxs)("div",{className:"font-medium text-sm flex items-center gap-2",children:[j.Adult||0," ",(0,n.jsx)("span",{className:"text-muted-foreground",children:"بالغ"})]}),(0,n.jsx)(V.O,{value:d.perAdult,onValueChange:e=>o(s=>({...s,type:"per_passenger",perAdult:e||0}))}),(0,n.jsxs)("div",{className:"font-medium text-sm flex items-center gap-2",children:[j.Child||0," ",(0,n.jsx)("span",{className:"text-muted-foreground",children:"طفل"})]}),(0,n.jsx)(V.O,{value:d.perChild,onValueChange:e=>o(s=>({...s,type:"per_passenger",perChild:e||0}))}),(0,n.jsxs)("div",{className:"font-medium text-sm flex items-center gap-2",children:[j.Infant||0," ",(0,n.jsx)("span",{className:"text-muted-foreground",children:"رضيع"})]}),(0,n.jsx)(V.O,{value:d.perInfant,onValueChange:e=>o(s=>({...s,type:"per_passenger",perInfant:e||0}))})]})]}),(0,n.jsxs)("div",{className:"space-y-1.5",children:[(0,n.jsx)(c.J,{children:"ملاحظات (اختياري)"}),(0,n.jsx)(K.T,{value:x,onChange:e=>m(e.target.value)})]})]}),(0,n.jsxs)(w.Es,{className:"justify-between",children:[(0,n.jsxs)(i.$,{variant:"destructive",onClick:N,disabled:h,children:[h&&(0,n.jsx)(v.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,n.jsx)(F.A,{className:"me-2 h-4 w-4"}),"حذف الخصم"]}),(0,n.jsxs)(i.$,{onClick:g,disabled:h,children:[h&&(0,n.jsx)(v.A,{className:"me-2 h-4 w-4 animate-spin"}),(0,n.jsx)(b.A,{className:"me-2 h-4 w-4"}),"حفظ الخصم"]})]})]})]})},el=e=>{let{issues:s,open:t,onOpenChange:a,title:r}=e;if(!s||0===s.length)return null;let l="تم العثور على ".concat(s.length," مشكلة من هذا النوع.");return(0,n.jsx)(w.lG,{open:t,onOpenChange:a,children:(0,n.jsxs)(w.Cf,{className:"sm:max-w-4xl",children:[(0,n.jsxs)(w.c7,{children:[(0,n.jsx)(w.L3,{children:r}),(0,n.jsx)(w.rr,{children:l})]}),(0,n.jsx)("div",{className:"max-h-96 overflow-y-auto",children:(0,n.jsx)("div",{className:"space-y-4",children:s.map((e,s)=>(0,n.jsxs)("div",{className:"p-3 border rounded-md bg-muted/50",children:[(0,n.jsx)("p",{className:"font-semibold text-sm",children:e.description}),e.details&&Array.isArray(e.details)&&(0,n.jsx)("div",{className:"mt-2 text-xs text-muted-foreground",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"الملف"}),(0,n.jsx)(o.nd,{children:"المرجع"}),(0,n.jsx)(o.nd,{children:"PNR"}),(0,n.jsx)(o.nd,{children:"عدد المسافرين"}),(0,n.jsx)(o.nd,{children:"الوجهة"}),(0,n.jsx)(o.nd,{children:"نوع الرحلة"}),(0,n.jsx)(o.nd,{children:"التاريخ"}),(0,n.jsx)(o.nd,{children:"الوقت"})]})}),(0,n.jsx)(o.BF,{children:e.details.map((e,s)=>{let t=e.date,a=t instanceof Date?(0,O.GP)(t,"yyyy-MM-dd"):"string"==typeof t&&(0,W.f)((0,G.H)(t))?(0,O.GP)((0,G.H)(t),"yyyy-MM-dd"):t,r=(e=>{let s=["BGW","NJF","EBL","ISU","BSR"];if(!e||"string"!=typeof e)return null;let t=e.split(/ -> |-/).map(e=>e.trim().toUpperCase()),n=t[0],a=t[t.length-1];return s.includes(n)&&!s.includes(a)?"مغادرة من العراق":!s.includes(n)&&s.includes(a)?"رحلة عودة إلى العراق":null})(e.route);return(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:(0,n.jsx)(M.E,{variant:"secondary",children:e.fileName})}),(0,n.jsx)(o.nA,{className:"font-mono",children:e.bookingReference}),(0,n.jsx)(o.nA,{className:"font-mono",children:e.pnr}),(0,n.jsx)(o.nA,{className:"font-bold text-center",children:e.paxCount}),(0,n.jsx)(o.nA,{children:e.route}),(0,n.jsx)(o.nA,{children:(0,n.jsx)(M.E,{variant:"مغادرة من العراق"===r?"default":"outline",children:r})}),(0,n.jsx)(o.nA,{children:a}),(0,n.jsx)(o.nA,{children:e.time})]},s)})})]})})]},s))})})]})})},ei=e=>{var s,t,r;let{report:l,index:d,onSelectionChange:c,onDeleteReport:x,onUpdateReport:m}=e,[h,u]=(0,a.useState)(!1),[p,j]=a.useState(!1),[f,g]=a.useState(!1),[N,v]=a.useState(!1),{toast:b}=(0,y.dj)(),w=(null==(s=l.issues)?void 0:s.tripAnalysis)||[],A=(null==(t=l.issues)?void 0:t.duplicatePnr)||[],C=(null==(r=l.issues)?void 0:r.fileAnalysis)||[],S=w.length>0,R=A.length>0,k=C.length>0,T=async()=>{x(l.id);let e=await J(l.id);e.success?b({title:"تم الحذف بنجاح"}):b({title:"خطأ",description:e.error,variant:"destructive"})},U=async e=>{m((0,$.jM)(l,s=>{s.isSelectedForReconciliation=e})),c(l.id,e),(await X(l.id,e)).success||(b({title:"خطأ",description:"فشل تحديث حالة التحديد.",variant:"destructive"}),m(l),c(l.id,!e))};return(0,n.jsxs)(a.Fragment,{children:[(0,n.jsx)(el,{issues:w,open:p,onOpenChange:j,title:"تفاصيل رحلات الذهاب والعودة"}),(0,n.jsx)(el,{issues:A,open:f,onOpenChange:g,title:"تفاصيل الـ Booking References المكررة"}),(0,n.jsx)(el,{issues:C,open:N,onOpenChange:v,title:"تفاصيل الملفات المكررة"}),(0,n.jsx)(D.Nt,{asChild:!0,open:h,onOpenChange:u,children:(0,n.jsxs)("tbody",{className:"border-t bg-card",children:[(0,n.jsxs)(o.Hj,{"data-state":h?"open":"closed",children:[(0,n.jsx)(o.nA,{className:"text-center",children:d+1}),(0,n.jsx)(o.nA,{className:"text-center",children:(0,n.jsx)(_.S,{onCheckedChange:e=>U(!!e),checked:l.isSelectedForReconciliation})}),(0,n.jsx)(o.nA,{children:(0,n.jsx)(D.R6,{asChild:!0,children:(0,n.jsx)(i.$,{variant:"ghost",size:"icon",className:"h-8 w-8",children:(0,n.jsx)(P.A,{className:(0,B.cn)("h-4 w-4 transition-transform",h&&"rotate-180")})})})}),(0,n.jsx)(o.nA,{children:l.supplierName}),(0,n.jsx)(o.nA,{className:"font-semibold",children:l.route}),(0,n.jsx)(o.nA,{children:(0,W.f)((0,G.H)(l.flightDate))?(0,O.GP)((0,G.H)(l.flightDate),"yyyy-MM-dd"):l.flightDate}),(0,n.jsx)(o.nA,{className:"text-center",children:l.flightTime}),(0,n.jsx)(o.nA,{className:"text-center",children:l.paxCount}),(0,n.jsx)(o.nA,{className:"font-mono text-center",children:(0,n.jsx)(en,{report:l})}),(0,n.jsx)(o.nA,{className:"font-mono text-center text-orange-600",children:(0,n.jsx)(ea,{report:l,defaultOpen:"auto",children:(0,n.jsx)("button",{className:"w-full text-center hover:underline",children:et(l.totalDiscount)})})}),(0,n.jsx)(o.nA,{className:"font-mono text-center text-red-600",children:(0,n.jsx)(ea,{report:l,defaultOpen:"manual",children:(0,n.jsx)("button",{className:"w-full text-center hover:underline",children:et(l.manualDiscountValue)})})}),(0,n.jsx)(o.nA,{className:"font-mono text-center font-bold text-green-600",children:(0,n.jsx)(ea,{report:l,children:(0,n.jsxs)("button",{className:"w-full text-center hover:underline flex items-center justify-center gap-1",children:[k&&(0,n.jsx)(I.A,{className:"h-4 w-4 text-destructive"}),et(l.filteredRevenue)]})})}),(0,n.jsx)(o.nA,{className:"text-center",children:k?(0,n.jsxs)(i.$,{variant:"destructive",size:"sm",onClick:()=>v(!0),children:["مكرر (",C.length,")"]}):(0,n.jsxs)("div",{className:"flex items-center justify-center gap-2 font-semibold text-green-600",children:[(0,n.jsx)(H.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{children:"سليم"})]})}),(0,n.jsx)(o.nA,{className:"text-center",children:S?(0,n.jsxs)(i.$,{variant:"secondary",size:"sm",onClick:()=>j(!0),children:["ذهاب وعودة (",w.length,")"]}):(0,n.jsxs)("div",{className:"flex items-center justify-center gap-2 font-semibold text-green-600",children:[(0,n.jsx)(H.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{children:"سليم"})]})}),(0,n.jsx)(o.nA,{className:"text-center",children:R?(0,n.jsxs)(i.$,{variant:"destructive",size:"sm",onClick:()=>g(!0),children:["تكرار (",A.length,")"]}):(0,n.jsxs)("div",{className:"flex items-center justify-center gap-2 font-semibold text-green-600",children:[(0,n.jsx)(H.A,{className:"h-4 w-4"}),(0,n.jsx)("span",{children:"سليم"})]})}),(0,n.jsx)(o.nA,{className:"text-center",children:(0,n.jsxs)(es.rI,{children:[(0,n.jsx)(es.ty,{asChild:!0,children:(0,n.jsx)(i.$,{variant:"ghost",size:"icon",children:(0,n.jsx)(L.A,{className:"h-4 w-4"})})}),(0,n.jsxs)(es.SQ,{children:[(0,n.jsx)(er,{report:l,onSaveSuccess:m}),(0,n.jsxs)(q.Lt,{children:[(0,n.jsx)(q.tv,{asChild:!0,children:(0,n.jsxs)(es._2,{onSelect:e=>e.preventDefault(),className:"text-destructive focus:text-destructive",children:[(0,n.jsx)(F.A,{className:"me-2 h-4 w-4"}),"حذف التقرير"]})}),(0,n.jsxs)(q.EO,{children:[(0,n.jsxs)(q.wd,{children:[(0,n.jsx)(q.r7,{children:"هل أنت متأكد؟"}),(0,n.jsx)(q.$v,{children:"سيؤدي هذا الإجراء إلى حذف التقرير بشكل دائم."})]}),(0,n.jsxs)(q.ck,{children:[(0,n.jsx)(q.Zr,{children:"إلغاء"}),(0,n.jsx)(q.Rx,{onClick:T,className:(0,B.cn)((0,i.r)({variant:"destructive"})),children:"نعم، احذف"})]})]})]})]})]})})]}),(0,n.jsx)(D.Ke,{asChild:!0,children:(0,n.jsx)(o.Hj,{children:(0,n.jsx)(o.nA,{colSpan:16,className:"p-0",children:(0,n.jsxs)("div",{className:"p-4 bg-muted/50",children:[(0,n.jsx)("h4",{className:"font-bold mb-2",children:"تفاصيل المسافرين:"}),(0,n.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{children:"اسم المسافر"}),(0,n.jsx)(o.nd,{children:"رقم الجواز"}),(0,n.jsx)(o.nd,{children:"نوع المسافر"}),(0,n.jsx)(o.nd,{children:"نوع الرحلة"}),(0,n.jsx)(o.nd,{className:"text-right",children:"السعر"})]})}),(0,n.jsx)(o.BF,{children:(l.passengers||[]).map((e,s)=>(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nA,{children:e.name}),(0,n.jsx)(o.nA,{children:e.passportNumber||"-"}),(0,n.jsx)(o.nA,{children:(0,n.jsx)(M.E,{variant:"outline",children:e.passengerType||"Adult"})}),(0,n.jsx)(o.nA,{children:e.tripType}),(0,n.jsx)(o.nA,{className:"text-right font-mono",children:e.payable})]},e.name+s))})]})})]})})})})]})})]})},ed=e=>{let{column:s,sortDescriptor:t,setSortDescriptor:a,children:r}=e,l=t.column===s,d=l?t.direction:"descending";return(0,n.jsxs)(i.$,{variant:"ghost",onClick:()=>{a({column:s,direction:l&&"ascending"===d?"descending":"ascending"})},className:"px-1",children:[r,l&&("ascending"===d?(0,n.jsx)(U.A,{className:"ms-2 h-4 w-4"}):(0,n.jsx)(E.A,{className:"ms-2 h-4 w-4"})),!l&&(0,n.jsx)(z.A,{className:"ms-2 h-4 w-4 opacity-30"})]})},ec=()=>(0,n.jsx)(k.Bc,{children:(0,n.jsxs)(k.m_,{children:[(0,n.jsx)(k.k$,{asChild:!0,children:(0,n.jsx)(i.$,{variant:"ghost",size:"icon",className:"h-8 w-8 cursor-help",children:(0,n.jsx)(j.A,{className:"h-5 w-5"})})}),(0,n.jsx)(k.ZI,{children:(0,n.jsx)("p",{children:"تفاصيل المسافرين"})})]})});function eo(e){let{reports:s,sortDescriptor:t,setSortDescriptor:r,onSelectionChange:l,onUpdateReport:i,onDeleteReport:d}=e,[c,x]=a.useState(new Set);(0,a.useEffect)(()=>{l(s.filter(e=>c.has(e.id)))},[c,s,l]);let m=(e,s)=>{x((0,$.jM)(t=>{s?t.add(e):t.delete(e)}))};return(0,n.jsx)("div",{className:"border rounded-lg overflow-x-auto",children:(0,n.jsxs)(o.XI,{children:[(0,n.jsx)(o.A0,{children:(0,n.jsxs)(o.Hj,{children:[(0,n.jsx)(o.nd,{className:"w-[40px] text-center",children:"#"}),(0,n.jsx)(o.nd,{className:"w-[50px] text-center",children:(0,n.jsx)(_.S,{checked:s.length>0&&c.size===s.length,onCheckedChange:e=>{e?x(new Set(s.map(e=>e.id))):x(new Set)}})}),(0,n.jsx)(o.nd,{className:"w-[50px]",children:(0,n.jsx)(ec,{})}),(0,n.jsx)(o.nd,{children:(0,n.jsx)(ed,{column:"supplierName",sortDescriptor:t,setSortDescriptor:r,children:"المصدر"})}),(0,n.jsx)(o.nd,{children:(0,n.jsx)(ed,{column:"route",sortDescriptor:t,setSortDescriptor:r,children:"الوجهة"})}),(0,n.jsx)(o.nd,{children:(0,n.jsx)(ed,{column:"flightDate",sortDescriptor:t,setSortDescriptor:r,children:"تاريخ الرحلة"})}),(0,n.jsx)(o.nd,{className:"text-center",children:"الوقت"}),(0,n.jsx)(o.nd,{className:"text-center",children:(0,n.jsx)(ed,{column:"paxCount",sortDescriptor:t,setSortDescriptor:r,children:"ركاب"})}),(0,n.jsx)(o.nd,{className:"text-center",children:(0,n.jsx)(ed,{column:"totalRevenue",sortDescriptor:t,setSortDescriptor:r,children:"الإجمالي"})}),(0,n.jsx)(o.nd,{className:"text-center",children:(0,n.jsx)(ed,{column:"totalDiscount",sortDescriptor:t,setSortDescriptor:r,children:"خصم العودة"})}),(0,n.jsx)(o.nd,{className:"text-center",children:(0,n.jsx)(ed,{column:"manualDiscountValue",sortDescriptor:t,setSortDescriptor:r,children:"خصم يدوي"})}),(0,n.jsx)(o.nd,{className:"text-center",children:(0,n.jsx)(ed,{column:"filteredRevenue",sortDescriptor:t,setSortDescriptor:r,children:"الصافي"})}),(0,n.jsx)(o.nd,{className:"text-center",children:"تحليل الملف"}),(0,n.jsx)(o.nd,{className:"text-center",children:"تحليل الرحلة"}),(0,n.jsx)(o.nd,{className:"text-center",children:"تكرار الحجز"}),(0,n.jsx)(o.nd,{className:"text-center",children:"الإجراءات"})]})}),0===s.length?(0,n.jsx)(o.BF,{children:(0,n.jsx)(o.Hj,{children:(0,n.jsx)(o.nA,{colSpan:17,className:"h-24 text-center",children:"لا توجد تقارير لعرضها."})})}):s.map((e,s)=>(0,n.jsx)(ei,{report:e,index:s,onSelectionChange:m,onDeleteReport:d,onUpdateReport:i},e.id))]})})}var ex=t(20063),em=t(2546),eh=t(27314),eu=t(10193),ep=t(85584),ej=t(13381),ef=t(22452),eg=t(90109);let eN=(0,A.createServerReference)("00f74d83d197fb270f7f799b24d2f55a333dd66df2",A.callServer,void 0,A.findSourceMapURL,"runAdvancedFlightAudit");var ev=t(20243),eb=t(50732),ey=t(53774);let ew=e=>{let{title:s,value:t,currency:a,className:r}=e;return(0,n.jsxs)("div",{className:(0,B.cn)("text-center p-2 rounded-lg bg-background",r),children:[(0,n.jsx)("p",{className:"text-xs font-bold text-muted-foreground",children:s}),(0,n.jsxs)("p",{className:"font-bold font-mono text-sm",children:[t.toLocaleString(void 0,{minimumFractionDigits:0,maximumFractionDigits:0})," ",a]})]})},eA=e=>{let{title:s,summary:t,currency:a,className:l}=e;return(0,n.jsxs)(r.Zp,{className:(0,B.cn)("shadow-sm",l),children:[(0,n.jsx)(r.aR,{className:"p-3",children:(0,n.jsxs)(r.ZB,{className:"text-base text-center flex flex-col items-center justify-center gap-2",children:[(0,n.jsx)("span",{children:s}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)(M.E,{variant:"default",className:"text-base px-3 py-1",children:(0,n.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,n.jsx)(j.A,{className:"h-4 w-4"}),t.paxCount,t.returnPaxCount>0&&(0,n.jsxs)("span",{className:"text-xs",children:["(",t.paxCount-t.returnPaxCount," صافي)"]})]})}),(0,n.jsxs)("div",{className:"flex items-center gap-1 text-xs",children:["(",(0,n.jsx)(M.E,{variant:"secondary",className:"px-1.5 py-0.5",children:(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsx)(em.A,{className:"h-3 w-3"}),t.adults," ",t.returnAdults>0&&(0,n.jsxs)("span",{className:"text-xs",children:["(",t.adults-t.returnAdults,")"]})]})}),(0,n.jsx)(M.E,{variant:"secondary",className:"px-1.5 py-0.5",children:(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsx)(eh.A,{className:"h-3 w-3"}),t.children," ",t.returnChildren>0&&(0,n.jsxs)("span",{className:"text-xs",children:["(",t.children-t.returnChildren,")"]})]})}),(0,n.jsx)(M.E,{variant:"secondary",className:"px-1.5 py-0.5",children:(0,n.jsxs)("div",{className:"flex items-center gap-1",children:[(0,n.jsx)(eu.A,{className:"h-3 w-3"}),t.infants," ",t.returnInfants>0&&(0,n.jsxs)("span",{className:"text-xs",children:["(",t.infants-t.returnInfants,")"]})]})}),")"]})]})]})}),(0,n.jsxs)(r.Wu,{className:"p-3 grid grid-cols-2 lg:grid-cols-4 gap-2",children:[(0,n.jsx)(ew,{title:"الإجمالي",value:t.totalRevenue,currency:a}),(0,n.jsx)(ew,{title:"خصم العودة",value:t.totalDiscount,currency:a}),(0,n.jsx)(ew,{title:"خصم يدوي",value:t.manualDiscount,currency:a}),(0,n.jsx)(ew,{title:"الصافي",value:t.filteredRevenue,currency:a,className:"bg-green-50 dark:bg-green-950/30 text-green-800 dark:text-green-200"})]})]})};function eC(){(0,ex.useRouter)();let[e,s]=(0,a.useState)(""),t=(0,eb.d)(e,300),[c,o]=(0,a.useState)([]),[x,m]=(0,a.useState)([]),[h,u]=(0,a.useState)(!0),{toast:p}=(0,y.dj)(),[j,f]=a.useState({pageIndex:0,pageSize:5}),[g,N]=(0,a.useState)({column:"flightDate",direction:"descending"}),b=(0,a.useCallback)(async()=>{u(!0);try{let e=await eN();o(e)}catch(e){p({title:"خطأ",description:"فشل في تحميل بيانات تحليل الرحلات.",variant:"destructive"})}finally{u(!1)}},[p]);(0,a.useEffect)(()=>{b()},[b]);let w=(0,a.useMemo)(()=>[...c].sort((e,s)=>{let t,n;if("flightDate"===g.column){let a=e.flightDate||"",r=s.flightDate||"",l=(0,W.f)((0,G.H)(a))?(0,G.H)(a):new Date(0),i=(0,W.f)((0,G.H)(r))?(0,G.H)(r):new Date(0);t=l.getTime(),n=i.getTime()}else["totalRevenue","filteredRevenue","paxCount","supplierName","totalDiscount","manualDiscountValue"].includes(g.column),t=e[g.column],n=s[g.column];if(null==t)return 1;if(null==n)return -1;let a=0;return"string"==typeof t&&"string"==typeof n?a=t.localeCompare(n):"number"==typeof t&&"number"==typeof n&&(a=t-n),"descending"===g.direction?-a:a}),[c,g]),A=(0,a.useMemo)(()=>{let e=w;if(t){let s=t.toLowerCase();e=e.filter(e=>e.fileName.toLowerCase().includes(s)||e.route.toLowerCase().includes(s)||(e.supplierName||"").toLowerCase().includes(s)||e.pnrGroups.some(e=>e.pnr.toLowerCase().includes(s)||e.bookingReference.toLowerCase().includes(s)||e.passengers.some(e=>e.name.toLowerCase().includes(s))))}return e},[w,t]),C=(0,a.useMemo)(()=>{let{pageIndex:e,pageSize:s}=j,t=e*s;return A.slice(t,t+s)},[A,j]),S=e=>e.reduce((e,s)=>{e.totalRevenue+=s.totalRevenue||0,e.totalDiscount+=s.totalDiscount||0,e.manualDiscount+=s.manualDiscountValue||0,e.paxCount+=s.paxCount||0;let t=(s.passengers||[]).filter(e=>"RETURN"===e.tripType);e.returnPaxCount+=t.length;let n=(s.passengers||[]).reduce((e,s)=>{let t=s.passengerType||"Adult";return e[t]=(e[t]||0)+1,e},{});e.adults+=n.Adult||0,e.children+=n.Child||0,e.infants+=n.Infant||0;let a=t.reduce((e,s)=>{let t=s.passengerType||"Adult";return e[t]=(e[t]||0)+1,e},{});return e.returnAdults+=a.Adult||0,e.returnChildren+=a.Child||0,e.returnInfants+=a.Infant||0,e.filteredRevenue+=s.filteredRevenue||0,e},{totalRevenue:0,totalDiscount:0,manualDiscount:0,filteredRevenue:0,adults:0,children:0,infants:0,returnAdults:0,returnChildren:0,returnInfants:0,paxCount:0,returnPaxCount:0}),D=a.useMemo(()=>S(c),[c]),k=a.useMemo(()=>S(x),[x]);return(0,n.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,n.jsxs)(r.Zp,{children:[(0,n.jsx)(r.aR,{children:(0,n.jsx)(r.ZB,{children:"الملخص المالي"})}),(0,n.jsxs)(r.Wu,{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsx)(eA,{title:"الملخص الإجمالي",summary:D,currency:"USD"}),(0,n.jsx)(eA,{title:"ملخص المحدد",summary:k,currency:"USD",className:"border-primary"})]})]}),(0,n.jsxs)(r.Zp,{children:[(0,n.jsx)(r.aR,{children:(0,n.jsxs)("div",{className:"flex justify-between items-center",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)(r.ZB,{children:"أرشيف تقارير الرحلات"}),(0,n.jsx)(r.BT,{children:"استعراض وتحليل جميع الرحلات التي تم استيرادها إلى النظام."})]}),(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsxs)(i.$,{onClick:()=>{if(0===c.length)return void p({title:"لا توجد بيانات للتصدير",variant:"destructive"});let e=c.flatMap(e=>(e.passengers||[]).map(s=>({"ملف المصدر":e.fileName,"تاريخ الرحلة":e.flightDate,"وقت الرحلة":e.flightTime,الوجهة:e.route,المورد:e.supplierName,"Booking Reference":s.bookingReference,"PNR / Class":s.pnrClass,"اسم المسافر":s.name,"رقم الجواز":s.passportNumber,"نوع المسافر":s.passengerType,السعر:s.payable,"نوع الرحلة":"RETURN"===s.tripType?"عودة":"DEPARTURE"===s.tripType?"ذهاب وعودة":"ذهاب فقط","تاريخ الذهاب (للعودة)":"RETURN"===s.tripType?s.departureDate:"","السعر الفعلي":s.actualPrice,"الخصم التلقائي":e.totalDiscount||0,"الخصم اليدوي":e.manualDiscountValue||0,"الصافي النهائي":e.filteredRevenue||0})));if(0===e.length)return void p({title:"لا توجد بيانات مسافرين للتصدير",variant:"destructive"});let s=l.Wp.json_to_sheet(e),t=l.Wp.book_new();l.Wp.book_append_sheet(t,s,"تفاصيل الرحلات"),l._h(t,"Flight_Analysis_Comprehensive_".concat(new Date().toISOString().split("T")[0],".xlsx")),p({title:"تم التصدير الشامل بنجاح"})},variant:"outline",disabled:0===c.length,children:[(0,n.jsx)(ep.A,{className:"me-2 h-4 w-4"}),"تصدير شامل"]}),(0,n.jsxs)(i.$,{onClick:()=>{if(0===c.length)return void p({title:"لا توجد بيانات للتصدير",variant:"destructive"});let e=c.map(e=>({"اسم الملف":e.fileName,"تاريخ الرحلة":e.flightDate,الوجهة:e.route,المصدر:e.supplierName,"عدد الركاب":e.paxCount,الإجمالي:e.totalRevenue,"خصم العودة":e.totalDiscount,"خصم يدوي":e.manualDiscountValue,الصافي:e.filteredRevenue})),s=l.Wp.json_to_sheet(e),t=l.Wp.book_new();l.Wp.book_append_sheet(t,s,"ملخص الرحلات"),l._h(t,"Flight_Analysis_Summary_".concat(new Date().toISOString().split("T")[0],".xlsx")),p({title:"تم تصدير الملخص بنجاح"})},variant:"outline",disabled:0===c.length,children:[(0,n.jsx)(ep.A,{className:"me-2 h-4 w-4"}),"تصدير الملخص"]}),(0,n.jsxs)(i.$,{onClick:b,variant:"outline",disabled:h,children:[h?(0,n.jsx)(v.A,{className:"h-4 w-4 me-2 animate-spin"}):(0,n.jsx)(ej.A,{className:"h-4 w-4 me-2"}),"تحديث البيانات"]}),(0,n.jsx)(R,{onSaveSuccess:b,children:(0,n.jsxs)(i.$,{children:[(0,n.jsx)(ef.A,{className:"h-4 w-4 me-2"}),"رفع وتحليل ملف جديد"]})})]})]})}),(0,n.jsxs)(r.Wu,{children:[(0,n.jsxs)("div",{className:"mb-4 relative max-w-sm",children:[(0,n.jsx)(eg.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,n.jsx)(d.p,{placeholder:"بحث شامل...",className:"ps-10",value:e,onChange:e=>s(e.target.value)})]}),h?(0,n.jsx)(ev.E,{className:"h-96 w-full"}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eo,{reports:C,sortDescriptor:g,setSortDescriptor:N,onSelectionChange:m,onUpdateReport:e=>{o((0,$.jM)(s=>{let t=s.findIndex(s=>s.id===e.id);-1!==t&&(s[t]=e)}))},onDeleteReport:e=>{o((0,$.jM)(s=>s.filter(s=>s.id!==e)))}}),(0,n.jsx)(ey.T,{pageIndex:j.pageIndex,pageSize:j.pageSize,totalCount:A.length,onPageChange:e=>f(s=>({...s,pageIndex:e})),onPageSizeChange:e=>f({pageIndex:0,pageSize:e})})]})]})]})]})}function eS(){return(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"px-0 sm:px-6",children:[(0,n.jsx)("h1",{className:"text-2xl md:text-3xl font-bold tracking-tight",children:"تحليل بيانات الرحلات"}),(0,n.jsx)("p",{className:"text-muted-foreground",children:"أداة متقدمة لتحليل بيانات ملفات الرحلات، كشف التكرار، حساب الخصومات، وتدقيق الأرباح."})]}),(0,n.jsx)(eC,{})]})}},73457:(e,s,t)=>{"use strict";t.d(s,{S:()=>d});var n=t(95155),a=t(12115),r=t(38162),l=t(72251),i=t(64269);let d=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.bL,{ref:s,className:(0,i.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t),...a,children:(0,n.jsx)(r.C1,{className:(0,i.cn)("flex items-center justify-center text-current"),children:(0,n.jsx)(l.A,{className:"h-4 w-4"})})})});d.displayName=r.bL.displayName},75660:(e,s,t)=>{"use strict";t.d(s,{r:()=>a});var n=t(30926);let a=(0,n.createServerReference)("7fff34be9ad53d22bcedbe289fd19cffbcbb61a920",n.callServer,void 0,n.findSourceMapURL,"getExchanges")},76444:(e,s,t)=>{"use strict";t.d(s,{J:()=>c});var n=t(95155),a=t(12115),r=t(10489),l=t(83101),i=t(64269);let d=(0,l.F)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),c=a.forwardRef((e,s)=>{let{className:t,...a}=e;return(0,n.jsx)(r.b,{ref:s,className:(0,i.cn)(d(),t),...a})});c.displayName=r.b.displayName},80187:(e,s,t)=>{"use strict";t.d(s,{c:()=>a});var n=t(30926);let a=(0,n.createServerReference)("7f085acd10c7b589563e59e7e18d605a9cf6eb6b56",n.callServer,void 0,n.findSourceMapURL,"getBoxes")},83686:()=>{},86355:(e,s,t)=>{Promise.resolve().then(t.bind(t,66730))},96133:(e,s,t)=>{"use strict";t.d(s,{m:()=>a});var n=t(30926);let a=(0,n.createServerReference)("7fe3cedf8b5b39f6ca6561f08402f1ad7a82ecff97",n.callServer,void 0,n.findSourceMapURL,"getSettings")}},e=>{e.O(0,[9135,7210,3524,4909,9625,315,5111,4127,9967,1374,783,4223,8994,84,13,7116,9158,8318,4762,9434,8441,1255,7358],()=>e(e.s=86355)),_N_E=e.O()}]);