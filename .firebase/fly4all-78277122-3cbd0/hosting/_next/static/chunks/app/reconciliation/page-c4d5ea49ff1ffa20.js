(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9542],{11647:(e,r,t)=>{"use strict";t.d(r,{E:()=>i});var a=t(95155);t(12115);var l=t(83101),s=t(64269);let n=(0,l.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function i(e){let{className:r,variant:t,...l}=e;return(0,a.jsx)("span",{className:(0,s.cn)(n({variant:t}),r),...l})}},43495:(e,r,t)=>{Promise.resolve().then(t.bind(t,53954))},53954:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>k});var a=t(95155),l=t(12115),s=t(86948),n=t(3998),i=t(92033),c=t(74421),d=t(11636),o=t(60406),u=t(15894),m=t(64269);function f(e){let{title:r,description:t,onFileUpload:s,fileId:n,borderColorClass:i}=e,{toast:c}=(0,u.dj)(),f=(0,l.useCallback)(e=>{e&&e.length>0&&c({title:"وظيفة معطلة",description:"تم تعطيل تحميل ملفات Excel مؤقتًا بسبب ثغرة أمنية.",variant:"destructive"})},[c]),{getRootProps:p,getInputProps:x}=(0,d.VB)({onDrop:f,disabled:!0});return(0,a.jsxs)("div",{...p(),className:(0,m.cn)("border-2 border-dashed rounded-lg p-4 text-center cursor-not-allowed bg-muted/20 relative flex flex-col justify-center items-center h-full min-h-[160px]",i),children:[(0,a.jsx)("input",{...x(),id:n}),(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[(0,a.jsx)(o.A,{className:"h-8 w-8 text-destructive"}),(0,a.jsxs)("h3",{className:"mt-2 font-semibold text-sm",children:[r," (معطل)"]}),(0,a.jsx)("p",{className:"mt-1 text-xs",children:"هذه الميزة غير متاحة حاليا."})]})]})}var p=t(93736);let x={columnMapping:{company:{pnr:"BNR",ticketNumber:"Ticket",passengerName:"الاسم",price:"السعر"},supplier:{pnr:"PNR",ticketNumber:"Ticket Number",passengerName:"Passenger Name",price:"Price"}},matchingFields:[{id:"pnr",label:"BNR/PNR",enabled:!0,deletable:!1,dataType:"string",rule:{type:"exact"}},{id:"ticketNumber",label:"رقم التذكرة",enabled:!0,deletable:!1,dataType:"string",rule:{type:"exact"}},{id:"passengerName",label:"اسم المسافر",enabled:!0,deletable:!1,dataType:"string",rule:{type:"fuzzy",tolerance:85}},{id:"price",label:"السعر",enabled:!0,deletable:!1,dataType:"number",rule:{type:"numeric_diff",maxDiff:1}}],aggregation:{enabled:!1,aggregationKey:"pnr",aggregationValueField:"price"}},g=(e,r,t)=>{let a=!1,l=[],s=0;for(let n of t){if(!n.enabled)continue;let t=e[n.id],i=r[n.id];switch(n.rule.type){case"exact":if(String(t).toLowerCase()!==String(i).toLowerCase())return l.push("".concat(n.label,": (").concat(t," ≠ ").concat(i,")")),{match:!1,partial:!1,details:l,priceDifference:s};break;case"fuzzy":let c=String(t),d=String(i);if(!c||!d){if(c!==d)return l.push("".concat(n.label,": (").concat(c," ≠ ").concat(d,")")),{match:!1,partial:!1,details:l,priceDifference:s};break}let o=new p.A([d],{threshold:1-n.rule.tolerance/100,includeScore:!0}).search(c);if(0===o.length)return l.push("".concat(n.label,": (").concat(c," ≠ ").concat(d,")")),{match:!1,partial:!1,details:l,priceDifference:s};c.toLowerCase()!==d.toLowerCase()&&(a=!0,l.push("".concat(n.label,": ").concat(c," ≈ ").concat(d," (تشابه ").concat(((1-(o[0].score||0))*100).toFixed(0),"%)")));break;case"numeric_diff":let u=Number(t),m=Number(i),f=Math.abs(u-m);if(f>n.rule.maxDiff)return l.push("".concat(n.label,": |").concat(u," - ").concat(m,"| = ").concat(f.toFixed(2)," > ").concat(n.rule.maxDiff)),{match:!1,partial:!1,details:l,priceDifference:s};f>0&&(a=!0,l.push("".concat(n.label," فرق: ").concat(f.toFixed(2)))),"price"===n.id&&(s=u-m)}}return{match:!0,partial:a,details:l,priceDifference:s}},h=(e,r)=>0===r.length?e:e.filter(e=>r.every(r=>{let t=e[r.field],a=r.value;if(void 0===t)return!1;let l=parseFloat(t),s=parseFloat(a);switch(r.condition){case"equals":return String(t).toLowerCase()===String(a).toLowerCase();case"contains":return String(t).toLowerCase().includes(String(a).toLowerCase());case"greater_than":return!isNaN(l)&&!isNaN(s)&&l>s;case"less_than":return!isNaN(l)&&!isNaN(s)&&l<s;default:return!0}}));var b=t(87270),N=t(11647),j=t(50984),y=t(51846),v=t(8992);let w=(e,r)=>new Intl.NumberFormat("en-US",{style:"currency",currency:r}).format(e),S=e=>{let{title:r,value:t,icon:l,colorClass:n}=e;return(0,a.jsxs)(s.Zp,{className:(0,m.cn)("border-l-4",n),children:[(0,a.jsxs)(s.aR,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[(0,a.jsx)(s.ZB,{className:"text-sm font-medium",children:r}),(0,a.jsx)(l,{className:"h-4 w-4 text-muted-foreground"})]}),(0,a.jsx)(s.Wu,{children:(0,a.jsx)("div",{className:"text-2xl font-bold",children:t})})]})};function C(e){let{result:r,settings:t}=e;return(0,a.jsxs)(s.Zp,{children:[(0,a.jsxs)(s.aR,{children:[(0,a.jsx)(s.ZB,{children:"نتائج التدقيق والمطابقة"}),(0,a.jsxs)(s.BT,{children:["تمت مقارنة ",r.summary.totalCompanyRecords," سجلًا من النظام مع ",r.summary.totalSupplierRecords," سجلًا من المورد."]})]}),(0,a.jsxs)(s.Wu,{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[(0,a.jsx)(S,{title:"مطابق تمامًا",value:r.summary.matched,icon:j.A,colorClass:"border-green-500"}),(0,a.jsx)(S,{title:"مطابق جزئيًا",value:r.summary.partialMatch,icon:o.A,colorClass:"border-yellow-500"}),(0,a.jsx)(S,{title:"مفقود في النظام",value:r.summary.missingInCompany,icon:y.A,colorClass:"border-red-500"}),(0,a.jsx)(S,{title:"مفقود لدى المورد",value:r.summary.missingInSupplier,icon:y.A,colorClass:"border-orange-500"}),(0,a.jsx)(S,{title:"إجمالي فرق السعر",value:w(r.summary.totalPriceDifference,"USD"),icon:v.A,colorClass:"border-blue-500"})]}),(0,a.jsx)("div",{className:"border rounded-lg overflow-hidden",children:(0,a.jsxs)(b.XI,{children:[(0,a.jsx)(b.A0,{children:(0,a.jsxs)(b.Hj,{children:[(0,a.jsx)(b.nd,{children:"الحالة"}),t.matchingFields.filter(e=>e.enabled).map(e=>(0,a.jsx)(b.nd,{children:e.label},e.id)),(0,a.jsx)(b.nd,{children:"ملاحظات"})]})}),(0,a.jsx)(b.BF,{children:r.records.map((e,r)=>{var l;let s={MATCHED:{label:"مطابق",color:"bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200"},PARTIAL_MATCH:{label:"جزئي",color:"bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200"},MISSING_IN_COMPANY:{label:"مفقود بالنظام",color:"bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200"},MISSING_IN_SUPPLIER:{label:"مفقود بالمورد",color:"bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-200"}}[e.status]||{label:e.status,color:"bg-gray-200"};return(0,a.jsxs)(b.Hj,{children:[(0,a.jsx)(b.nA,{children:(0,a.jsx)(N.E,{className:s.color,children:s.label})}),t.matchingFields.filter(e=>e.enabled).map(r=>(0,a.jsx)(b.nA,{className:"font-mono text-xs",children:void 0!==e[r.id]?String(e[r.id]):"-"},r.id)),(0,a.jsxs)(b.nA,{className:"text-xs",children:[null==(l=e.details)?void 0:l.map((e,r)=>(0,a.jsx)("div",{children:e},r)),e.priceDifference?(0,a.jsxs)("div",{className:"font-bold",children:["فرق السعر: ",w(e.priceDifference,"USD")]}):null]})]},r)})})]})})]})]})}var R=t(30926);let A=(0,R.createServerReference)("40f95f8586e05ad9d55e5c56983d6c172c2ae61267",R.callServer,void 0,R.findSourceMapURL,"addReconciliationLog");var I=t(23451);function k(){let[e,r]=(0,l.useState)([]),[t,d]=(0,l.useState)([]),[o,p]=(0,l.useState)(x),[b,N]=(0,l.useState)(null),[j,y]=(0,l.useState)(!1),{toast:v}=(0,u.dj)(),{user:w}=(0,I.A)(),S=async()=>{if(0===e.length||0===t.length)return void v({title:"الرجاء رفع الملفين للمتابعة",variant:"destructive"});y(!0);try{let r=function(e,r,t,a){let l=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],{columnMapping:s,matchingFields:n,aggregation:i}=t,c=n.filter(e=>e.enabled),d=e.map(e=>(0,m.pY)(e,s.company,c,t.importFieldsSettings||{})),o=r.map(e=>(0,m.pY)(e,s.supplier,c,t.importFieldsSettings||{})),u=h(d,l),f=h(o,l),p=i.enabled?((e,r)=>{let{aggregationKey:t,aggregationValueField:a}=r.aggregation;return t&&a?Object.values(e.reduce((e,r)=>{let l=r[t];return l?(e[l]||(e[l]={...r,[a]:0}),e[l][a]+=r[a]):e[JSON.stringify(r)]=r,e},{})):e})(f,t):f,x=[],b=[],N=[];u.forEach(e=>{let r=-1,t=null;for(let a=0;a<p.length;a++){let l=g(e,p[a],c);if(l.match){if(!l.partial){r=a,t=l;break}t||(r=a,t=l)}}t?(p[r],t.partial?b.push({...e,status:"PARTIAL_MATCH",details:t.details,priceDifference:t.priceDifference}):x.push({...e,status:"MATCHED",details:[]}),p.splice(r,1)):N.push({...e,status:"MISSING_IN_SUPPLIER",details:["مفقود لدى المورد"]})});let j=p.map(e=>({...e,status:"MISSING_IN_COMPANY",details:["مفقود في نظامك"]})),y=[...x,...b,...j,...N].map(e=>{let r={status:e.status,details:e.notes,priceDifference:e.priceDifference};return c.forEach(t=>{r[t.id]=e[t.id]}),r});return{summary:{totalCompanyRecords:u.length,totalSupplierRecords:f.length,matched:x.length,partialMatch:b.length,missingInSupplier:N.length,missingInCompany:j.length,totalRecords:y.length,totalPriceDifference:b.reduce((e,r)=>e+(r.priceDifference||0),0)},records:y}}(e,t,o,"USD");N(r),v({title:"اكتملت المطابقة بنجاح"}),w&&await A({runAt:new Date().toISOString(),userId:w.uid,userName:w.name,settings:o,filters:[],currency:"USD",summary:r.summary})}catch(e){v({title:"خطأ في المطابقة",description:e.message,variant:"destructive"})}y(!1)};return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)(s.Zp,{children:[(0,a.jsxs)(s.aR,{children:[(0,a.jsx)(s.ZB,{children:"التدقيق الذكي (مطابقة الكشوفات)"}),(0,a.jsx)(s.BT,{children:"قارن بين كشف حسابك وكشف حساب المورد لكشف الفروقات وتحديد المعاملات المفقودة تلقائيًا."})]}),(0,a.jsxs)(s.Wu,{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,a.jsx)(f,{title:"ملف النظام (كشف حسابك)",description:"ارفع ملف Excel الذي تم تصديره من نظامك.",onFileUpload:r,fileId:"company-file",borderColorClass:"border-primary"}),(0,a.jsx)(f,{title:"ملف المورد (الكشف المقابل)",description:"ارفع ملف Excel الخاص بالمورد الذي تريد مطابقته.",onFileUpload:d,fileId:"supplier-file",borderColorClass:"border-accent"})]}),(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsxs)(n.$,{onClick:S,disabled:j||0===e.length||0===t.length,size:"lg",children:[j?(0,a.jsx)(i.A,{className:"me-2 h-5 w-5 animate-spin"}):(0,a.jsx)(c.A,{className:"me-2 h-5 w-5"}),"بدء المطابقة والتدقيق"]})})]})]}),j&&(0,a.jsx)("div",{className:"flex justify-center items-center h-40",children:(0,a.jsx)(i.A,{className:"h-10 w-10 animate-spin text-primary"})}),b&&(0,a.jsx)(C,{result:b,settings:o})]})}},86948:(e,r,t)=>{"use strict";t.d(r,{BT:()=>d,Wu:()=>o,ZB:()=>c,Zp:()=>n,aR:()=>i,wL:()=>u});var a=t(95155),l=t(12115),s=t(64269);let n=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("rounded-xl border bg-card text-card-foreground shadow-sm",t),...l})});n.displayName="Card";let i=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex flex-col space-y-1.5 p-4 sm:p-6 text-right",t),...l})});i.displayName="CardHeader";let c=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("h3",{ref:r,className:(0,s.cn)("text-lg sm:text-xl font-bold leading-none tracking-tight",t),...l})});c.displayName="CardTitle";let d=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("p",{ref:r,className:(0,s.cn)("text-sm text-muted-foreground",t),...l})});d.displayName="CardDescription";let o=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("p-4 sm:p-6 pt-0",t),...l})});o.displayName="CardContent";let u=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("div",{ref:r,className:(0,s.cn)("flex items-center p-4 sm:p-6 pt-0",t),...l})});u.displayName="CardFooter"},87270:(e,r,t)=>{"use strict";t.d(r,{A0:()=>i,BF:()=>c,Gg:()=>d,Hj:()=>o,XI:()=>n,nA:()=>m,nd:()=>u});var a=t(95155),l=t(12115),s=t(64269);let n=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("div",{className:"relative w-full overflow-auto",children:(0,a.jsx)("table",{ref:r,className:(0,s.cn)("w-full caption-bottom text-sm",t),...l})})});n.displayName="Table";let i=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("thead",{ref:r,className:(0,s.cn)("[&_tr]:border-b",t),...l})});i.displayName="TableHeader";let c=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("tbody",{ref:r,className:(0,s.cn)("[&_tr:last-child]:border-0",t),...l})});c.displayName="TableBody";let d=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("tfoot",{ref:r,className:(0,s.cn)("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",t),...l})});d.displayName="TableFooter";let o=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("tr",{ref:r,className:(0,s.cn)("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...l})});o.displayName="TableRow";let u=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("th",{ref:r,className:(0,s.cn)("h-12 px-4 text-right align-middle font-bold text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...l})});u.displayName="TableHead";let m=l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("td",{ref:r,className:(0,s.cn)("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...l})});m.displayName="TableCell",l.forwardRef((e,r)=>{let{className:t,...l}=e;return(0,a.jsx)("caption",{ref:r,className:(0,s.cn)("mt-4 text-sm text-muted-foreground",t),...l})}).displayName="TableCaption"}},e=>{e.O(0,[9135,7210,4909,9625,5111,1636,6426,4762,8441,1255,7358],()=>e(e.s=43495)),_N_E=e.O()}]);